<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script async src="{{{appclient}}}"></script>
    <link rel="stylesheet" type="text/css" href="styles/style.css" />
    <link rel="stylesheet" type="text/css" href="styles/modal.css" />
    <link rel="stylesheet" type="text/css" href="styles/filepreview.css" />
    <link rel="stylesheet" type="text/css" href="styles/assembly.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Add Quill CSS and JS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>


</head>

<body>

    <body>
        <!-- Add the loading overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="spinner"></div>
            <div class="spinner-text">Creating ticket...</div>
        </div>

        <!-- ...existing body content... -->
        <div class="tracker-form-container">
            <!-- Debug Button -->
            <div class="debug-container">
                <button id="debugFillForm" class="debug-button">
                    <i class="fas fa-magic"></i> Fill with Demo Data
                </button>
            </div>

            <div class="form-title">
                <h2><i class="fas fa-tools"></i> Assembly Rollover Tracker</h2>
            </div>

            <div class="back-button-container">
                <fw-button id="backButton" color="secondary" size="small"
                    style="cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"
                    onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                    <i class="fas fa-arrow-left" style="margin-right: 8px;"></i>Back to Tracker Templates
                </fw-button>
            </div>

            <form id="trackerForm">
                <div class="cards-container">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-pen-fancy fa-lg section-icon"></i>
                            <h3>SUBJECT</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="subject" class="required-field">Subject</label>
                                <input type="text" id="subject" name="subject" required>
                                <div class="hint"><i class="fas fa-info-circle"></i> Title for the BL Xcode removal
                                    request
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-clipboard-list fa-lg section-icon"></i>
                            <h3>ROLLOVER DETAILS</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="summaryEditor" class="required-field">BL Xcode Removal Request:</label>
                                <div class="quill-editor-container">
                                    <div id="summaryEditor" style="height: 120px; background-color: white;"></div>
                                    <textarea id="summary" name="summary" style="display: none;"></textarea>
                                </div>
                                <div class="hint"><i class="fas fa-info-circle"></i> Enter information about the BL
                                    Xcode
                                    removal request</div>
                            </div>

                            <div class="form-group">
                                <label for="districtName" class="required-field">District Name:</label>
                                <input type="text" id="districtName" name="districtName" required>
                                <div class="hint"><i class="fas fa-info-circle"></i> Name of the district</div>
                            </div>

                            <div class="form-group">
                                <label for="realm" class="required-field">Realm (Tech Admin Link):</label>
                                <input type="text" id="realm" name="realm" required>
                                <div class="hint"><i class="fas fa-info-circle"></i> Tech Admin Link for the district
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="effectiveDate" class="required-field">Effective Return Date:</label>
                                <div class="input-with-icon">
                                    <i class="fas fa-calendar-alt icon-prefix"></i>
                                    <input type="date" id="effectiveDate" name="effectiveDate" required>
                                </div>
                                <div class="hint"><i class="fas fa-info-circle"></i> Date when the codes should be
                                    removed
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="assemblyCodes" class="required-field">Assembly Codes To Be Removed:</label>
                                <textarea id="assemblyCodes" name="assemblyCodes" rows="4" required
                                    style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;"></textarea>
                                <div class="hint"><i class="fas fa-info-circle"></i> List of assembly codes that need to
                                    be
                                    removed</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-tasks fa-lg section-icon"></i>
                            <h3>TICKET PROPERTIES</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="email" class="required-field">Requester Email</label>
                                <div class="input-with-icon">
                                    <i class="fas fa-envelope icon-prefix"></i>
                                    <input type="email" id="email" name="email" required>
                                </div>
                                <div class="hint"><i class="fas fa-info-circle"></i> This ticket will be created by you
                                    (the
                                    logged-in agent)</div>
                                <div id="emailStatus" class="email-status"></div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="relatedTickets">Related Ticket IDs</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-link icon-prefix"></i>
                                        <input type="text" id="relatedTickets" name="relatedTickets">
                                    </div>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Comma-separated ticket IDs
                                        (e.g.,
                                        1,2,3)</div>
                                </div>

                                <div class="form-group">
                                    <label for="priority">Priority</label>
                                    <select id="priority" name="priority">
                                        <option value="1">Low</option>
                                        <option value="2">Medium</option>
                                        <option value="3">High</option>
                                        <option value="4">Urgent</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="status">Status</label>
                                    <select id="status" name="status">
                                        <option value="2">Open</option>
                                        <option value="3">Pending</option>
                                        <option value="4">Resolved</option>
                                        <option value="5">Closed</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="groupField">Group</label>
                                    <select id="groupField" name="groupField">
                                        <option>Loading groups...</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Select a support group</div>
                                </div>

                                <div class="form-group">
                                    <label for="agentField">Agent</label>
                                    <select id="agentField" name="agentField"></select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Select an agent</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-paperclip fa-lg section-icon"></i>
                            <h3>ATTACHMENTS</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <div class="attachment-input-container">
                                    <div class="custom-file-input">
                                        <div class="file-upload-btn">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <span>Choose files</span>
                                            <input type="file" id="screenshots" name="screenshots" multiple
                                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                                        </div>
                                    </div>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Upload files to include in the
                                        ticket (15MB total)</div>
                                </div>
                                <div id="screenshotPreview" class="screenshot-preview"></div>
                                <div id="attachmentCounter" class="attachment-counter"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: none;">
                    <textarea id="description" name="description"></textarea>
                </div>

                <div class="form-actions">
                    <fw-button id="cancelTracker" color="secondary" size="medium"
                        style="display: flex; justify-content: center; align-items: center;">
                        <i class="fas fa-times"></i> Cancel
                    </fw-button>
                    <fw-button id="createTracker" color="primary" type="submit" size="medium"
                        style="display: flex; justify-content: center; align-items: center;">
                        <i class="fas fa-check"></i> Create Tracker
                    </fw-button>
                </div>
            </form>
        </div>

        <script>
            console.log("Assembly rollover page loading");
            console.log("DOM ready state:", document.readyState);

            document.addEventListener('DOMContentLoaded', function () {
                // Wait for the Freshworks SDK to be available
                let initRetries = 0;
                const maxRetries = 30; // Increase max retries to ensure we have enough time
                const retryInterval = 200; // Milliseconds between retries

                // Store ticket data from parent
                let ticketData = {
                    isVip: false,
                    districtName: '',
                    currentTicketId: null,
                    requesterEmail: ''
                };

                // Initialize file input listener
                const fileInput = document.getElementById('screenshots');
                if (fileInput) {
                    fileInput.addEventListener('change', function (event) {
                        handleFileSelection(event);
                    });
                }

                // Handle file selection
                function handleFileSelection(event) {
                    const files = event.target.files;
                    const previewContainer = document.getElementById('screenshotPreview');

                    if (!previewContainer) return;

                    previewContainer.innerHTML = '';

                    if (files.length === 0) return;

                    // Store the files for form submission
                    aggregatedScreenshotFiles = Array.from(files);

                    // Add counter text
                    updateAttachmentCounter(files.length);

                    // Preview the files
                    Array.from(files).forEach((file, index) => {
                        const filePreview = createFilePreview(file, index);
                        previewContainer.appendChild(filePreview);
                    });
                }

                function updateAttachmentCounter(count) {
                    const counter = document.getElementById('attachmentCounter');
                    if (counter) {
                        counter.textContent = count > 0 ? `${count} file${count !== 1 ? 's' : ''} selected` : '';
                    }

                    // Update the attachment label
                    const screenshotsLabel = document.querySelector('label[for="screenshots"]');
                    if (screenshotsLabel) {
                        if (count > 0) {
                            screenshotsLabel.textContent = `Attachments (${count}):`;
                        } else {
                            screenshotsLabel.textContent = screenshotsLabel.getAttribute('data-original-text') || "Attachments:";
                        }
                    }
                }

                function createFilePreview(file, index) {
                    const fileContainer = document.createElement('div');
                    fileContainer.className = 'file-thumbnail';

                    // Determine if it's an image
                    const isImage = file.type.startsWith('image/');

                    if (isImage) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            fileContainer.innerHTML = `
                                <div class="thumbnail-container">
                                    <img src="${e.target.result}" alt="${file.name}">
                                </div>
                                <div class="file-filename">${file.name}</div>
                                <div class="file-remove" data-index="${index}">✕</div>
                            `;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        // For non-image files
                        let fileIcon = 'fa-file';
                        let fileTypeLabel = 'File';

                        // Determine file type icon
                        if (file.name.endsWith('.pdf')) {
                            fileIcon = 'fa-file-pdf';
                            fileTypeLabel = 'PDF';
                        }
                        else if (file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
                            fileIcon = 'fa-file-word';
                            fileTypeLabel = 'Document';
                        }
                        else if (file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) {
                            fileIcon = 'fa-file-excel';
                            fileTypeLabel = 'Spreadsheet';
                        }
                        else if (file.name.endsWith('.zip') || file.name.endsWith('.rar')) {
                            fileIcon = 'fa-file-archive';
                            fileTypeLabel = 'Archive';
                        }

                        fileContainer.innerHTML = `
                            <div class="thumbnail-container file-icon-container">
                                <i class="fas ${fileIcon} file-icon"></i>
                                <div class="file-type-label">${fileTypeLabel}</div>
                            </div>
                            <div class="file-filename">${file.name}</div>
                            <div class="file-remove" data-index="${index}">✕</div>
                        `;
                    }

                    // Add event handler for remove button
                    setTimeout(() => {
                        const removeBtn = fileContainer.querySelector('.file-remove');
                        if (removeBtn) {
                            removeBtn.addEventListener('click', function (e) {
                                e.stopPropagation();

                                // Remove from aggregated files array
                                aggregatedScreenshotFiles.splice(index, 1);

                                // Remove visual element
                                fileContainer.remove();

                                // Update counter
                                updateAttachmentCounter(aggregatedScreenshotFiles.length);
                            });
                        }
                    }, 100);

                    return fileContainer;
                }

                // Check if scripts are loaded properly
                function checkScriptsLoaded() {
                    // Log which scripts are available
                    console.log("Script availability check:", {
                        "app-client": typeof app !== 'undefined',
                        "client": typeof client !== 'undefined',
                        "frsh": typeof window.frsh !== 'undefined',
                        "quill": typeof Quill !== 'undefined'
                    });
                }

                // Retry logic with improved debugging
                function initializeClient() {
                    checkScriptsLoaded();

                    if (typeof client !== 'undefined') {
                        console.log("Found client object directly");
                        setupFormHandlers(client);
                    } else if (typeof app !== 'undefined') {
                        console.log("Found app object, initializing");
                        app.initialized().then(function (clientObj) {
                            console.log("App initialized successfully");
                            setupFormHandlers(clientObj);
                        }).catch(handleInitError);
                    } else if (typeof window.frsh !== 'undefined' && window.frsh.init) {
                        console.log("Found frsh object, initializing");
                        window.frsh.init().then(function (clientObj) {
                            console.log("Frsh initialized successfully");
                            setupFormHandlers(clientObj);
                        }).catch(handleInitError);
                    } else if (initRetries < maxRetries) {
                        initRetries++;
                        console.log(`Waiting for client to be available (attempt ${initRetries}/${maxRetries})...`);
                        setTimeout(initializeClient, retryInterval);
                    } else {
                        handleInitError(new Error(`Could not initialize client after ${maxRetries} attempts`));
                    }
                }

                function handleInitError(error) {
                    console.error("Modal initialization error:", error);
                    const container = document.querySelector('.tracker-form-container');
                    if (container) {
                        container.innerHTML = `<div class="error-card">
                        <h3>Failed to initialize app client</h3>
                        <p>Error details: ${error.message}</p>
                        <p>Please check the console for more information or refresh the page.</p>
                        <button onclick="location.reload()">Refresh Page</button>
                    </div>`;
                    }
                }

                // Initialize global variable for file storage
                let aggregatedScreenshotFiles = [];

                function setupFormHandlers(client) {
                    window.client = client;
                    console.log("Setting up form handlers with client:", client);

                    // Add global error handling for debugging
                    window.onerror = function (message, source, lineno, colno, error) {
                        console.error("Global error:", message, "at", source, lineno, colno, error);
                        return false;
                    };

                    // Add missing testClientConnection function
                    async function testClientConnection(client) {
                        try {
                            console.log("Testing client connection with data.get('domInfo')...");
                            try {
                                const domInfo = await client.data.get('domInfo');
                                console.log("DOM info retrieved successfully:", domInfo);
                                return true;
                            } catch (error) {
                                console.warn("Basic client test failed:", error);
                                console.log("Trying alternative method with instance.context()...");
                                try {
                                    const context = await client.instance.context();
                                    console.log("Context retrieved successfully:", context);
                                    return true;
                                } catch (error2) {
                                    console.error("All client tests failed:", error2);
                                    return false;
                                }
                            }
                        } catch (error) {
                            console.error("Error in testClientConnection:", error);
                            return false;
                        }
                    }

                    // Test the client functionality immediately
                    testClientConnection(client);

                    // Try to get ticket data from localStorage - FIX: Add null checks for all DOM manipulations
                    try {
                        const storedAssemblyData = localStorage.getItem('assembly-rolloverData');
                        if (storedAssemblyData) {
                            const assemblyData = JSON.parse(storedAssemblyData);
                            console.log("📦 Retrieved assembly data from localStorage:", assemblyData);

                            // Populate form fields with the retrieved data - FIX: Add null checks
                            const districtNameField = document.getElementById('districtName');
                            if (assemblyData.districtName && districtNameField) {
                                districtNameField.value = assemblyData.districtName;
                                districtNameField.style.backgroundColor = "#f0fff0"; // Light green
                                setTimeout(() => {
                                    districtNameField.style.backgroundColor = "";
                                }, 2000);
                                console.log("✅ Set district name from localStorage:", assemblyData.districtName);
                            }

                            // In assembly.html when retrieving data from localStorage - FIX: Add null checks
                            const priorityField = document.getElementById('priority');
                            if (assemblyData.priority && priorityField) {
                                priorityField.value = assemblyData.priority;
                                priorityField.style.backgroundColor = "#f0fff0"; // Light green
                                setTimeout(() => {
                                    priorityField.style.backgroundColor = "";
                                }, 2000);
                                console.log("✅ Set priority from localStorage:", priorityField.value);
                            }

                            // FIX: Check if vipStatus element exists before trying to set its value
                            const vipField = document.getElementById('vipStatus');
                            if (assemblyData.isVip !== undefined && vipField) {
                                vipField.value = assemblyData.isVip ? "Yes" : "No";
                                vipField.style.backgroundColor = assemblyData.isVip ? "#ffebee" : "#f0fff0"; // Red or green
                                setTimeout(() => {
                                    vipField.style.backgroundColor = "";
                                }, 2000);
                                console.log("✅ Set VIP status from localStorage:", vipField.value);
                            }

                            const relatedField = document.getElementById('relatedTickets');
                            if (assemblyData.currentTicketId && relatedField) {
                                relatedField.value = assemblyData.currentTicketId;
                                relatedField.style.backgroundColor = "#f0fff0"; // Light green
                                setTimeout(() => {
                                    relatedField.style.backgroundColor = "";
                                }, 2000);
                                console.log("✅ Set related ticket ID from localStorage:", relatedField.value);

                                // Try to get more ticket details using the ID
                                getSourceTicketDetails(assemblyData.currentTicketId).catch(error => {
                                    console.error("Error getting source ticket details:", error);
                                });
                            }

                            // Clean up - remove the data from localStorage to avoid stale data
                            localStorage.removeItem('assembly-rolloverData');
                        }
                    } catch (error) {
                        console.error("Error retrieving assembly data from localStorage:", error);
                    }

                    async function getLoggedInUserEmail() {
                        try {
                            console.log("Fetching agent email directly from modal");
                            const userData = await client.data.get("loggedInUser");
                            console.log("Agent data:", userData);
                            if (userData && userData.loggedInUser && userData.loggedInUser.contact && userData.loggedInUser.contact.email) {
                                const agentEmail = userData.loggedInUser.contact.email;
                                console.log("Found agent email:", agentEmail);

                                // FIX: Add null check before setting value
                                const emailField = document.getElementById('email');
                                if (emailField) {
                                    emailField.value = agentEmail;
                                }

                                // FIX: Add null check before updating innerHTML
                                const emailStatus = document.getElementById('emailStatus');
                                if (emailStatus) {
                                    emailStatus.innerHTML = `<span style="color: green">✓ Email loaded: ${agentEmail}</span>`;
                                }

                                return agentEmail;
                            } else {
                                console.warn("Could not get agent email from userData");

                                // FIX: Add null check before updating innerHTML
                                const emailStatus = document.getElementById('emailStatus');
                                if (emailStatus) {
                                    emailStatus.innerHTML = '<span style="color: orange">⚠️ Email not found in user data</span>';
                                }

                                return null;
                            }
                        } catch (error) {
                            console.error("Error getting logged-in user data:", error);

                            // FIX: Add null check before updating innerHTML
                            const emailStatus = document.getElementById('emailStatus');
                            if (emailStatus) {
                                emailStatus.innerHTML = '<span style="color: red">✗ Error loading email</span>';
                            }

                            return null;
                        }
                    }

                    // FIX: Add null check to getAssignedAgentEmail
                    async function getAssignedAgentEmail(ticketId) {
                        try {
                            const ticketResponse = await client.request.invokeTemplate("getTicketDetails", {
                                context: { ticketId: ticketId }
                            });
                            const ticketData = JSON.parse(ticketResponse.response);
                            console.log("Related ticket data:", ticketData);
                            if (!ticketData.responder_id) {
                                console.warn("Ticket doesn't have an assigned agent");
                                return null;
                            }
                            const agentResponse = await client.request.invokeTemplate("getAgentDetails", {
                                context: { agentId: ticketData.responder_id }
                            });
                            const agentData = JSON.parse(agentResponse.response);
                            console.log("Assigned agent data:", agentData);
                            if (agentData && agentData.contact && agentData.contact.email) {
                                console.log("Found assigned agent email:", agentData.contact.email);
                                const emailField = document.getElementById('email');
                                if (emailField) {
                                    emailField.value = agentData.contact.email;
                                }
                                const emailStatus = document.getElementById('emailStatus');
                                if (emailStatus) {
                                    emailStatus.innerHTML = `<span style="color: green">✓ Using assigned agent's email: ${agentData.contact.email}</span>`;
                                }
                                return agentData.contact.email;
                            } else {
                                console.warn("Could not get assigned agent email");
                                return null;
                            }
                        } catch (error) {
                            console.error("Error getting assigned agent email:", error);
                            return null;
                        }
                    }

                    // FIX: Add null checks to tryGetTicketIdFromUrlOrParent
                    async function tryGetTicketIdFromUrlOrParent() {
                        console.log("🔍 Attempting to get ticket ID from URL or parent");
                        let foundTicketId = null;

                        // First try to extract from URL if we're in a ticket context
                        try {
                            const url = window.location.href;
                            const ticketMatch = url.match(/\/tickets\/(\d+)/);
                            if (ticketMatch && ticketMatch[1]) {
                                foundTicketId = parseInt(ticketMatch[1]);
                                console.log(`🎯 Found ticket ID in URL: ${foundTicketId}`);

                                const relatedTickets = document.getElementById('relatedTickets');
                                if (foundTicketId && relatedTickets) {
                                    relatedTickets.value = foundTicketId;
                                    relatedTickets.style.backgroundColor = "#f0fff0"; // Light green
                                    setTimeout(() => {
                                        relatedTickets.style.backgroundColor = "";
                                    }, 2000);

                                    const sourceTicketData = await getSourceTicketDetails(foundTicketId);
                                    if (!sourceTicketData) {
                                        await getLoggedInUserEmail();
                                    }
                                }
                                return;
                            }
                        } catch (urlError) {
                            console.error("❌ Error extracting ticket ID from URL:", urlError);
                        }

                        // If no ticket ID found in URL, try to get from parent context
                        try {
                            console.log("🔄 Trying to get ticket ID from parent context");
                            await getLoggedInUserEmail();
                        } catch (parentError) {
                            console.error("❌ Error getting ticket ID from parent:", parentError);
                            await getLoggedInUserEmail();
                        }
                    }

                    // FIX: Add null checks to getSourceTicketDetails
                    async function getSourceTicketDetails(ticketId) {
                        console.log("🔍 Starting getSourceTicketDetails for ticket:", ticketId);

                        // Validate ticket ID
                        if (!ticketId || isNaN(parseInt(ticketId))) {
                            console.error("❌ Invalid ticket ID provided:", ticketId);
                            return null;
                        }

                        // Show loading state in the UI - FIX: Add null checks
                        const districtNameField = document.getElementById('districtName');
                        const relatedTicketsField = document.getElementById('relatedTickets');

                        if (districtNameField) {
                            districtNameField.placeholder = "Loading district info...";
                        }

                        if (relatedTicketsField) {
                            relatedTicketsField.style.backgroundColor = "#fff9c4"; // Light yellow background
                        }

                        try {
                            console.log("📡 Making API request for ticket details:", ticketId);
                            // Ensure we're using a valid ticket ID for the API call
                            const validTicketId = parseInt(ticketId);

                            const ticketResponse = await client.request.invokeTemplate("getTicketDetails", {
                                context: { ticketId: validTicketId }
                            });

                            if (!ticketResponse) {
                                throw new Error("Empty response received");
                            }

                            console.log("✅ Raw ticket response received:", ticketResponse);

                            // Parse the response
                            let ticketData;
                            try {
                                ticketData = JSON.parse(ticketResponse.response);
                            } catch (parseError) {
                                console.error("❌ Failed to parse ticket response:", parseError);
                                console.log("Raw response content:", ticketResponse.response);
                                throw new Error(`Parse error: ${parseError.message}`);
                            }

                            console.log("✅ Parsed ticket data:", ticketData);

                            // Check for expected data structure
                            if (!ticketData || typeof ticketData !== 'object') {
                                throw new Error("Ticket data is not an object");
                            }

                            // Extract and process custom fields
                            if (ticketData.custom_fields) {
                                console.log("📋 Custom fields found:", ticketData.custom_fields);

                                // Show all custom fields in console for debugging
                                Object.entries(ticketData.custom_fields).forEach(([key, value]) => {
                                    console.log(`  ${key}: ${value}`);
                                });

                                // Handle district field with flexible field matching
                                const districtFieldNames = [
                                    'cf_district509811', 'cf_district', 'district',
                                    'cf_school_district', 'cf_district_name', 'cf_school_district_name'
                                ];

                                // Try each possible district field name
                                let districtFound = false;
                                for (const fieldName of districtFieldNames) {
                                    if (ticketData.custom_fields[fieldName]) {
                                        const districtName = ticketData.custom_fields[fieldName];
                                        console.log(`✅ Found district name in field ${fieldName}:`, districtName);
                                        if (districtNameField) {
                                            districtNameField.value = districtName;
                                            districtNameField.style.backgroundColor = "#f0fff0"; // Light green background
                                            setTimeout(() => {
                                                districtNameField.style.backgroundColor = "";
                                            }, 2000);
                                        }
                                        districtFound = true;
                                        break;
                                    }
                                }

                                if (!districtFound) {
                                    console.log("⚠️ No district field found in custom fields");

                                    // Try to extract district from description as fallback
                                    if (ticketData.description) {
                                        // Try to find district in description using regex
                                        const districtPatterns = [
                                            /district\s*(?:name)?[:]\s*([^<\n\r,\.]+)/i,  // "District: Springfield"
                                            /district[: ]\s*([^<\n\r,\.]+)/i,             // "District Springfield"
                                            /from\s+([^<\n\r,\.]+)\s+district/i,          // "from Springfield district"
                                            /([^<\n\r,\.]+)\s+district/i                  // "Springfield district"
                                        ];

                                        for (const pattern of districtPatterns) {
                                            const match = ticketData.description.match(pattern);
                                            if (match && match[1]) {
                                                const extractedDistrict = match[1].trim();
                                                console.log("📝 Found district in description:", extractedDistrict);
                                                if (districtNameField) {
                                                    districtNameField.value = extractedDistrict;
                                                    districtNameField.style.backgroundColor = "#fff9c4"; // Light yellow background
                                                    setTimeout(() => {
                                                        districtNameField.style.backgroundColor = "";
                                                    }, 2000);
                                                }
                                                break;
                                            }
                                        }
                                    }
                                }

                                // Handle VIP field with flexible field matching
                                const vipFieldNames = [
                                    'cf_vip', 'vip', 'cf_vip_status', 'vip_customer',
                                    'cf_vip_client', 'cf_is_vip'
                                ];

                                let vipFound = false;
                                for (const fieldName of vipFieldNames) {
                                    if (ticketData.custom_fields[fieldName] !== undefined) {
                                        let isVip = false;
                                        const vipValue = ticketData.custom_fields[fieldName];

                                        // Handle different value types for VIP status
                                        if (typeof vipValue === 'boolean') {
                                            isVip = vipValue;
                                        } else if (typeof vipValue === 'string') {
                                            isVip = vipValue.toLowerCase() === 'yes' ||
                                                vipValue.toLowerCase() === 'true' ||
                                                vipValue === '1';
                                        } else if (typeof vipValue === 'number') {
                                            isVip = vipValue !== 0;
                                        }

                                        console.log(`✅ Found VIP status in field ${fieldName}:`, isVip, "Original value:", vipValue);
                                        const vipStatusField = document.getElementById('vipStatus');
                                        if (vipStatusField) {
                                            vipStatusField.value = isVip ? "Yes" : "No";
                                            vipStatusField.style.backgroundColor = isVip ? "#ffebee" : "#f0fff0"; // Red or green tint
                                            setTimeout(() => {
                                                vipStatusField.style.backgroundColor = "";
                                            }, 2000);
                                        }
                                        ticketData.isVip = isVip;
                                        vipFound = true;
                                        break;
                                    }
                                }

                                if (!vipFound) {
                                    console.log("⚠️ No VIP field found in custom fields");

                                    // Check for VIP keywords in ticket data
                                    const vipRegex = /\b(vip|very\s+important|priority\s+customer|high\s+value)\b/i;
                                    if ((ticketData.subject && vipRegex.test(ticketData.subject)) ||
                                        (ticketData.description && vipRegex.test(ticketData.description))) {
                                        console.log("📝 VIP keyword found in subject/description");
                                        const vipStatusField = document.getElementById('vipStatus');
                                        if (vipStatusField) {
                                            vipStatusField.value = "Yes";
                                            vipStatusField.style.backgroundColor = "#ffebee"; // Light red background
                                            setTimeout(() => {
                                                vipStatusField.style.backgroundColor = "";
                                            }, 2000);
                                        }
                                        ticketData.isVip = true;
                                    }
                                }
                            } else {
                                console.warn("⚠️ No custom_fields property found in ticket data");
                                if (districtNameField) {
                                    districtNameField.placeholder = "Enter district name";
                                }
                            }

                            // Return success with highlight on the ticket field - FIX: Add null check
                            if (relatedTicketsField) {
                                relatedTicketsField.style.backgroundColor = "#f0fff0"; // Light green background
                                setTimeout(() => {
                                    relatedTicketsField.style.backgroundColor = "";
                                }, 2000);
                            }

                            return ticketData;
                        } catch (error) {
                            console.error("❌ Error getting source ticket details:", error);
                            console.error("Error stack:", error.stack);

                            // FIX: Add null checks
                            if (districtNameField) {
                                districtNameField.placeholder = "Error loading district info";
                            }

                            if (relatedTicketsField) {
                                relatedTicketsField.style.backgroundColor = "#ffebee"; // Light red background
                                setTimeout(() => {
                                    relatedTicketsField.style.backgroundColor = "";
                                }, 2000);
                            }

                            return null;
                        }
                    }

                    // FIX: Add null checks for context handler
                    client.instance.context().then(async function (context) {
                        console.log("🌟 Modal context received:", context);
                        console.log("🔍 Context data direct access:", context.data);

                        // Try to print the full context for debugging
                        try {
                            console.log("🔄 Complete context stringified:", JSON.stringify(context));
                        } catch (e) {
                            console.log("⚠️ Could not stringify full context:", e.message);
                        }

                        // Default the related ticket field for user feedback - FIX: Add null check
                        const relatedTicketsField = document.getElementById('relatedTickets');
                        if (relatedTicketsField) {
                            relatedTicketsField.placeholder = "Enter ticket ID(s)";
                        }

                        if (context && context.data) {
                            // Extract ticket data from context with better logging
                            ticketData = {
                                isVip: context.data.isVip || false,
                                districtName: context.data.districtName || '',
                                currentTicketId: context.data.currentTicketId || null,
                                requesterEmail: context.data.requesterEmail || '',
                                ticketRequesterEmail: context.data.ticketRequesterEmail || ''
                            };
                            console.log("📦 Received ticket data from context:", ticketData);

                            // Set district name from context data - FIX: Add null check
                            const districtField = document.getElementById('districtName');
                            if (ticketData.districtName && districtField) {
                                districtField.value = ticketData.districtName;
                                districtField.style.backgroundColor = "#f0fff0";
                                setTimeout(() => { districtField.style.backgroundColor = ""; }, 2000);
                                console.log("✅ Set district name to:", districtField.value);
                            }

                            // Make sure we have a valid ticket ID and it's not zero or NaN
                            const ticketId = parseInt(ticketData.currentTicketId);
                            if (ticketId && !isNaN(ticketId) && ticketId > 0) {
                                console.log("🎯 Using valid currentTicketId from context:", ticketId);

                                // Auto-populate related ticket IDs with clear visual feedback - FIX: Add null check
                                if (relatedTicketsField) {
                                    relatedTicketsField.value = ticketId;
                                    relatedTicketsField.style.backgroundColor = "#f0fff0"; // Light green background
                                    setTimeout(() => {
                                        relatedTicketsField.style.backgroundColor = "";
                                    }, 2000); // Return to normal after 2 seconds
                                    console.log("✅ Set related ticket ID to:", relatedTicketsField.value);
                                }

                                // Get source ticket details for auto-population of district
                                try {
                                    const sourceTicketData = await getSourceTicketDetails(ticketId);
                                    console.log("📄 Returned source ticket data:", sourceTicketData);

                                    // If district name came in context data, use it as a fallback - FIX: Add null check
                                    const existingDistrictValue = districtField ? districtField.value : null;
                                    if (!existingDistrictValue && ticketData.districtName && districtField) {
                                        console.log("🏫 Using district name from context:", ticketData.districtName);
                                        districtField.value = ticketData.districtName;
                                        districtField.style.backgroundColor = "#fff9c4"; // Light yellow
                                        setTimeout(() => {
                                            districtField.style.backgroundColor = "";
                                        }, 2000);
                                    }

                                    // Set subject based on district name - FIX: Add null checks
                                    const subjectField = document.getElementById('subject');

                                    if (subjectField) {
                                        const districtValue = districtField ? districtField.value : '';
                                        if (districtValue) {
                                            subjectField.value = `BL Xcode Removal Request - ${districtValue}`;
                                        } else {
                                            subjectField.value = "BL Xcode Removal Request";
                                        }
                                    }

                                    const assignedAgentEmail = await getAssignedAgentEmail(ticketId);
                                    if (!assignedAgentEmail) {
                                        await getLoggedInUserEmail();
                                    }
                                } catch (detailsError) {
                                    console.error("❌ Error in getSourceTicketDetails:", detailsError);
                                    await getLoggedInUserEmail();
                                }
                            } else {
                                console.warn("⚠️ Invalid or missing currentTicketId in context:", ticketData.currentTicketId);
                                await tryGetTicketIdFromUrlOrParent();
                            }
                        } else {
                            console.log("ℹ️ No context data, trying to get ticket ID from URL");
                            await tryGetTicketIdFromUrlOrParent();
                        }

                        // Set today's date for effective return date - FIX: Add null check
                        const effectiveDateField = document.getElementById('effectiveDate');
                        if (effectiveDateField) {
                            const today = new Date();
                            // Set default date to 30 days from today
                            const defaultDate = new Date(today);
                            defaultDate.setDate(today.getDate() + 30);
                            effectiveDateField.value = defaultDate.toISOString().split('T')[0];
                        }

                    }).catch(async function (error) {
                        console.error("❌ Error getting modal context:", error);
                        await tryGetTicketIdFromUrlOrParent();
                        await getLoggedInUserEmail();

                        // Set default date to 30 days from today even on error - FIX: Add null check
                        const effectiveDateField = document.getElementById('effectiveDate');
                        if (effectiveDateField) {
                            const today = new Date();
                            const defaultDate = new Date(today);
                            defaultDate.setDate(today.getDate() + 30);
                            effectiveDateField.value = defaultDate.toISOString().split('T')[0];
                        }
                    });

                    // Initialize Quill editors for rich text fields - FIX: Check if elements exist first
                    let quillSummary = null;
                    const summaryEditor = document.getElementById('summaryEditor');
                    if (summaryEditor) {
                        quillSummary = new Quill("#summaryEditor", {
                            theme: "snow",
                            placeholder: "Enter information about the BL Xcode removal request..."
                        });
                    }

                    // Before form submission, copy Quill HTML into hidden textareas
                    const trackerForm = document.getElementById('trackerForm');
                    if (trackerForm) {
                        trackerForm.addEventListener('submit', async function (e) {
                            // Update hidden textareas with editor content
                            const summaryField = document.getElementById('summary');
                            if (quillSummary && summaryField) {
                                summaryField.value = quillSummary.root.innerHTML;
                            }
                            // Form submission continues with the normal flow
                        });
                    }

                    // Handle paste events on the Quill editor - FIX: Add null check
                    function handlePasteImage(e, quill) {
                        if (!quill) return;

                        const clipboardData = e.clipboardData || window.clipboardData;
                        if (!clipboardData) return;
                        const items = clipboardData.items;
                        if (!items) return;

                        for (let i = 0; i < items.length; i++) {
                            if (items[i].type.indexOf("image") !== -1) {
                                e.preventDefault();
                                const file = items[i].getAsFile();
                                uploadImageToImgbb(file)
                                    .then(url => {
                                        const range = quill.getSelection();
                                        quill.insertEmbed(range.index, 'image', url);
                                    })
                                    .catch(error => console.error("Image upload error:", error));
                                return;
                            }
                        }
                    }

                    // Attach paste listener on Quill editor - FIX: Add null check
                    if (quillSummary) {
                        quillSummary.root.addEventListener('paste', function (e) {
                            handlePasteImage(e, quillSummary);
                        });
                    }

                    // Add missing uploadImageToImgbb function
                    function uploadImageToImgbb(file) {
                        const formData = new FormData();
                        formData.append('image', file);
                        const IMGBB_API_KEY = "b3da8c974bc40dd87d896d84436dd76e";
                        return fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => response.json())
                            .then(result => {
                                if (result.success) {
                                    return result.data.display_url;
                                }
                                throw new Error("Image upload failed");
                            });
                    }

                    // Initialize the dropdowns when the form loads
                    fetchGroups();

                    // Add back button functionality - FIX: Add null check
                    const backButton = document.getElementById('backButton');
                    if (backButton) {
                        backButton.addEventListener('click', function () {
                            window.location.href = "template-selector.html";
                        });
                    }

                    // Add missing ticket creation functionality
                    trackerForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const createTrackerButton = document.getElementById('createTracker');
                        if (createTrackerButton) createTrackerButton.disabled = true;

                        // Show the loading overlay
                        const loadingOverlay = document.getElementById('loadingOverlay');
                        if (loadingOverlay) {
                            loadingOverlay.style.display = 'flex';
                        }

                        try {
                            // Check for required fields
                            const subject = document.getElementById('subject').value;
                            const summary = document.getElementById('summary').value;
                            const districtName = document.getElementById('districtName').value;
                            const realm = document.getElementById('realm').value;
                            const effectiveDate = document.getElementById('effectiveDate').value;
                            const assemblyCodes = document.getElementById('assemblyCodes').value;
                            const email = document.getElementById('email').value;

                            if (!subject || !summary || !districtName || !realm || !effectiveDate || !assemblyCodes || !email) {
                                alert("Please fill in all required fields");
                                if (createTrackerButton) createTrackerButton.disabled = false;
                                // Hide loading overlay on validation error
                                if (loadingOverlay) loadingOverlay.style.display = 'none';
                                return;
                            }

                            // Generate description HTML for the ticket
                            const description = generateDescription(
                                subject,
                                summary,
                                districtName,
                                realm,
                                effectiveDate,
                                assemblyCodes
                            );

                            // Get other ticket properties
                            const relatedTicketsStr = document.getElementById('relatedTickets').value;
                            const priority = document.getElementById('priority').value;
                            const status = document.getElementById('status').value;
                            const groupId = document.getElementById('groupField').value;
                            const agentId = document.getElementById('agentField').value;

                            // Parse related tickets
                            const relatedTicketIds = relatedTicketsStr.split(',')
                                .map(id => id.trim())
                                .filter(id => id !== '' && !isNaN(parseInt(id, 10)))
                                .map(id => parseInt(id, 10));

                            // Create ticket data - THIS PART WAS MISSING
                            const ticketData = {
                                email: email,
                                subject: subject,
                                description: description,
                                priority: parseInt(priority, 10),
                                status: parseInt(status, 10),
                                type: "Incident",
                                custom_fields: {
                                    cf_district: districtName || undefined
                                }
                            };

                            // Add related tickets if available
                            if (relatedTicketIds.length > 0) {
                                ticketData.related_ticket_ids = relatedTicketIds;
                            }

                            // Add group ID if selected
                            if (groupId) {
                                ticketData.group_id = parseInt(groupId, 10);
                            }

                            // Add agent ID if selected
                            if (agentId) {
                                ticketData.responder_id = parseInt(agentId, 10);
                            }

                            console.log("Creating ticket with data:", ticketData);

                            // Create the ticket
                            const createResponse = await client.request.invokeTemplate("createfdTicket", {
                                body: JSON.stringify(ticketData)
                            });

                            const newTicket = JSON.parse(createResponse.response);
                            console.log("Created ticket:", newTicket);
                            const newTicketId = newTicket.id;

                            if (!newTicketId) {
                                throw new Error("Failed to get ID of newly created ticket");
                            }

                            // Prepare for redirect - construct the ticket URL
                            const ticketUrl = `https://benchmarkeducationcompany.freshdesk.com/a/tickets/${newTicketId}`;

                            // Upload attachments if there are any
                            if (aggregatedScreenshotFiles.length > 0) {
                                try {
                                    // API credentials
                                    const subdomain = "benchmarkeducationcompany";
                                    const apiKey = "5TMgbcZdRFY70hSpEdj";

                                    // Create FormData for the attachment upload
                                    const formData = new FormData();
                                    formData.append('body', 'Additional attachments for assembly rollover');
                                    formData.append('private', 'true');

                                    // Add files to the form data
                                    for (let i = 0; i < aggregatedScreenshotFiles.length; i++) {
                                        const file = aggregatedScreenshotFiles[i];
                                        formData.append('attachments[]', file, file.name);
                                    }

                                    // Use XMLHttpRequest for direct API access
                                    const xhr = new XMLHttpRequest();
                                    xhr.open('POST', `https://${subdomain}.freshdesk.com/api/v2/tickets/${newTicketId}/notes`, true);
                                    xhr.setRequestHeader('Authorization', 'Basic ' + btoa(`${apiKey}:X`));

                                    // Handle response
                                    xhr.onload = function () {
                                        if (xhr.status >= 200 && xhr.status < 300) {
                                            console.log("Attachments added successfully:", xhr.responseText);
                                            client.interface.trigger("showNotify", {
                                                type: "success",
                                                message: `Assembly Rollover ticket #${newTicketId} created with attachments`
                                            });
                                        } else {
                                            console.error("Error uploading attachments:", xhr.status, xhr.responseText);
                                            client.interface.trigger("showNotify", {
                                                type: "warning",
                                                message: `Assembly Rollover ticket #${newTicketId} created, but attachments failed`
                                            });
                                        }

                                        // Always proceed with redirection and closing regardless of attachment outcome
                                        finishTicketCreation();
                                    };

                                    // Handle network errors
                                    xhr.onerror = function () {
                                        console.error("Network error during attachment upload");
                                        client.interface.trigger("showNotify", {
                                            type: "warning",
                                            message: `Assembly Rollover ticket #${newTicketId} created, but attachments failed due to network error`
                                        });

                                        // Still finish the process even on error
                                        finishTicketCreation();
                                    };

                                    // Send the form data
                                    xhr.send(formData);
                                    console.log("Attachment request sent via XMLHttpRequest");

                                    // Set a timeout as a fallback in case the XHR doesn't complete
                                    setTimeout(() => {
                                        if (loadingOverlay && loadingOverlay.style.display === 'flex') {
                                            console.warn("XHR timed out, forcing completion");
                                            finishTicketCreation();
                                        }
                                    }, 8000);

                                } catch (attachError) {
                                    console.error("Error handling attachments:", attachError);
                                    client.interface.trigger("showNotify", {
                                        type: "warning",
                                        message: `Assembly Rollover ticket #${newTicketId} created, but attachments failed: ${attachError.message}`
                                    });

                                    // Still finish the process even on error
                                    finishTicketCreation();
                                }
                            } else {
                                // No attachments, just close with success message
                                client.interface.trigger("showNotify", {
                                    type: "success",
                                    message: `Assembly Rollover ticket #${newTicketId} created successfully`
                                });

                                // Call the finish function for consistency
                                finishTicketCreation();
                            }

                            // Helper function to finish the ticket creation process
                            function finishTicketCreation() {
                                // Hide loading overlay
                                if (loadingOverlay) {
                                    loadingOverlay.style.display = 'none';
                                }

                                // Open the new ticket in a new tab
                                try {
                                    const ticketUrl = `https://benchmarkeducationcompany.freshdesk.com/a/tickets/${newTicketId}`;
                                    window.open(ticketUrl, '_blank');
                                } catch (navError) {
                                    console.error("Error opening ticket page:", navError);
                                }

                                // Close the current modal with a delay to ensure notifications are visible
                                try {
                                    setTimeout(() => {
                                        client.instance.close({ refreshTickets: true });
                                    }, 1000);
                                } catch (closeError) {
                                    console.error("Error closing modal:", closeError);
                                    // As a last resort, redirect to template selector
                                    setTimeout(() => {
                                        window.location.href = "template-selector.html";
                                    }, 1500);
                                }
                            }

                        } catch (error) {
                            console.error("Error creating ticket:", error);
                            client.interface.trigger("showNotify", {
                                type: "danger",
                                message: `Failed to create ticket: ${error.message}`
                            });

                            // Hide loading overlay on error
                            if (loadingOverlay) {
                                loadingOverlay.style.display = 'none';
                            }

                            if (createTrackerButton) {
                                createTrackerButton.disabled = false;
                            }
                        }
                    });

                    // Function to generate HTML description for the ticket
                    // Function to generate HTML description for the ticket
                    function generateDescription(subject, summary, districtName, realm, effectiveDate, assemblyCodes) {
                        // Format the effective date
                        let formattedDate = '';
                        if (effectiveDate) {
                            const date = new Date(effectiveDate);
                            formattedDate = date.toLocaleDateString('en-US', {
                                year: 'numeric', month: 'long', day: 'numeric'
                            });
                        }

                        let description = '';

                        // SUMMARY section
                        description += '<div style="color: #000000"><span style="text-decoration: underline; background-color: #c1e9d9;">SUMMARY</span></div>';
                        description += `<div>${subject}</div>`;

                        // Add blank space
                        description += '<div style="margin-bottom: 20px;"></div>';

                        // DESCRIPTION section
                        description += '<div style="color: #000000;"><span style="text-decoration: underline; background-color: #c1e9d9;">DESCRIPTION</span></div>';

                        // Check if summary is HTML (from Quill editor) and add it directly
                        if (summary) {
                            description += `${summary}<br><br>`;
                        }

                        // Add all the fields with proper spacing
                        description += `District Name: ${districtName || ''}<br>`;
                        description += `Realm (Tech Admin Link): ${realm || ''}<br>`;
                        description += `Effective Return Date: ${formattedDate || ''}<br>`;

                        // Add blank space
                        description += '<div style="margin-bottom: 20px;"></div>';

                        // ASSEMBLY CODES section
                        description += '<div style="color: #000000;"><span style="text-decoration: underline; background-color: #c1e9d9;">ASSEMBLY CODES TO BE REMOVED</span></div>';
                        description += `<div>${assemblyCodes.replace(/\n/g, '<br>')}</div>`;

                        return description;
                    }

                    // Add missing fetchGroups function
                    async function fetchGroups() {
                        try {
                            console.log("Fetching groups from Freshdesk API");
                            // Add a UI indicator that API is being called
                            const groupSelect = document.getElementById("groupField");
                            if (groupSelect) {
                                groupSelect.innerHTML = "<option>Loading groups...</option>";
                            }

                            try {
                                const response = await client.request.invokeTemplate("getGroups", {});

                                if (!response || !response.response) {
                                    throw new Error("Empty response from groups API");
                                }

                                const groups = JSON.parse(response.response);
                                console.log("Fetched groups:", groups);

                                if (groupSelect) {
                                    groupSelect.innerHTML = ""; // Clear existing options

                                    // Add a blank option
                                    const blankOption = document.createElement("option");
                                    blankOption.value = "";
                                    blankOption.textContent = "-- Select a Group --";
                                    groupSelect.appendChild(blankOption);

                                    groups.forEach(group => {
                                        const option = document.createElement("option");
                                        option.value = group.id;
                                        option.textContent = group.name;
                                        groupSelect.appendChild(option);

                                        // Set Escalations group as default
                                        if (group.id === 67000396680) {
                                            option.selected = true;
                                        }
                                    });
                                }

                                // After loading groups, always use the hardcoded agent list 
                                loadHardcodedAgents();
                            } catch (error) {
                                console.error("API error fetching groups:", error);
                                // Fall back to hardcoded groups
                                loadFallbackGroups();
                            }

                        } catch (error) {
                            console.error("Error in fetchGroups:", error);
                            // Fallback with hardcoded groups in case of API error
                            loadFallbackGroups();
                        }
                    }

                    // Add missing loadHardcodedAgents function
                    function loadHardcodedAgents() {
                        console.log("Loading hardcoded agents list");
                        const agents = [
                            { id: 67025683491, name: "Mohammad Azeem" },
                            { id: 67030529218, name: "Jordan Fields" },
                            { id: 67031011668, name: "Suriya Iqbal" },
                            { id: 67040597168, name: "Anson Li" },
                            { id: 67051499418, name: "Drita Lulgjuraj" }
                        ];

                        const agentSelect = document.getElementById("agentField");
                        if (agentSelect) {
                            agentSelect.innerHTML = ""; // Clear existing options

                            // Add a blank option
                            const blankOption = document.createElement("option");
                            blankOption.value = "";
                            blankOption.textContent = "-- Select an Agent --";
                            agentSelect.appendChild(blankOption);

                            agents.forEach(agent => {
                                const option = document.createElement("option");
                                option.value = agent.id;
                                option.textContent = agent.name;
                                agentSelect.appendChild(option);
                            });
                        }
                    }

                    // Add missing loadFallbackGroups function
                    function loadFallbackGroups() {
                        console.log("Using fallback groups data");
                        const groups = [
                            { id: 67000396680, name: "Escalations" },
                            { id: 67000396681, name: "Support" },
                            { id: 67000396682, name: "Technical" }
                        ];

                        const groupSelect = document.getElementById("groupField");
                        if (groupSelect) {
                            groupSelect.innerHTML = ""; // Clear existing options

                            // Add a blank option
                            const blankOption = document.createElement("option");
                            blankOption.value = "";
                            blankOption.textContent = "-- Select a Group --";
                            groupSelect.appendChild(blankOption);

                            groups.forEach(group => {
                                const option = document.createElement("option");
                                option.value = group.id;
                                option.textContent = group.name;
                                groupSelect.appendChild(option);

                                // Set Escalations group as default
                                if (group.id === 67000396680) {
                                    option.selected = true;
                                }
                            });
                        }

                        // Load fallback agents for the default group
                        loadHardcodedAgents();
                    }

                    // Add event handler for group dropdown
                    const groupField = document.getElementById('groupField');
                    if (groupField) {
                        groupField.addEventListener('change', function () {
                            console.log("Group selection changed to:", this.value);
                            // We'll always use the hardcoded agents regardless of group selection
                            loadHardcodedAgents();
                        });
                    }
                }

                // Start initialization with a short delay to ensure all scripts are loaded
                setTimeout(initializeClient, 500);
            });
        </script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                setTimeout(function () {
                    var createBtn = document.getElementById('createTracker');
                    if (createBtn) {
                        createBtn.onclick = function (e) {
                            e.preventDefault();
                            document.getElementById('trackerForm').dispatchEvent(new Event('submit'));
                        };
                    }
                    var cancelBtn = document.getElementById('cancelTracker');
                    if (cancelBtn) {
                        cancelBtn.onclick = function () {
                            if (window.client) {
                                window.client.instance.close();
                            }
                        };
                    }
                    console.log('Extra event handlers attached to buttons');
                }, 500);
            });
        </script>


    </body>

</html>