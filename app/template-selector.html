<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script async src="{{{appclient}}}"></script>
    <link rel="stylesheet" type="text/css" href="styles/style.css" />
    <link rel="stylesheet" type="text/css" href="styles/template-selector.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <title>Freshdesk Tracker Templates</title>
</head>

<body>
    <div class="container">
        <div class="page-title">
            <h1>Tracker Templates</h1>
            <p>Select a template to create a standardized support ticket for your issue category</p>
        </div>

        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="templateSearch" class="search-input" placeholder="Search templates...">
        </div>

        <div class="template-groups">
            <!-- CONTENT/EDITORIAL GROUP -->
            <div class="template-group">
                <div class="group-header collapsed">
                    <h2><i class="fas fa-book"></i> Content/Editorial <span class="template-count">1</span></h2>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="templates-container collapsed">
                    <div class="template-list">
                        <div class="template-item" data-template="sedcust">
                            <a href="#" class="template-link">
                                <i class="fas fa-file-alt"></i> Content/Editorial
                                <span class="badge badge-testing">Testing</span>
                            </a>
                            <div class="template-description">
                                Templates for Trackers regarding typos, grammatical errors, broken links, and
                                content-related issues.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="group-description">
                    Templates for Trackers regarding typos, grammatical errors, broken links, and content-related
                    issues. </div>
            </div>

            <!-- ASSEMBLY GROUP -->
            <div class="template-group">
                <div class="group-header collapsed">
                    <h2><i class="fas fa-tools"></i> Assembly <span class="template-count">2</span></h2>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="templates-container collapsed">
                    <div class="template-list">
                        <div class="template-item" data-template="assembly">
                            <a href="#" class="template-link">
                                <i class="fas fa-puzzle-piece"></i> Assembly
                                <span class="badge badge-testing">Testing</span>
                            </a>
                            <div class="template-description">
                                For assembly issues with components
                            </div>
                        </div>
                        <div class="template-item" data-template="assembly-rollover">
                            <a href="#" class="template-link">
                                <i class="fas fa-sync-alt"></i> Assembly Rollover
                                <span class="badge badge-testing">Testing</span>
                            </a>
                            <div class="template-description">
                                For program rollover issues
                            </div>
                        </div>
                    </div>
                </div>
                <div class="group-description">
                    Templates for Trackers regarding assembly codes and content availability in the library.
                </div>
            </div>

            <!-- SIM TRACKERS GROUP -->
            <div class="template-group">
                <div class="group-header collapsed">
                    <h2><i class="fas fa-chart-line"></i> SIM Trackers <span class="template-count">9</span></h2>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="templates-container collapsed">
                    <div class="template-list">
                        <div class="template-item" data-template="sim-assignment">
                            <a href="#" class="template-link">
                                <i class="fas fa-tasks"></i> SIM Assignment
                                <span class="badge badge-testing">Testing</span>
                            </a>
                            <div class="template-description">
                                For issues with SIM assignments
                            </div>
                        </div>
                        <div class="template-item" data-template="sim-assessment-reports">
                            <a href="#" class="template-link">
                                <i class="fas fa-chart-bar"></i> SIM Assessment Reports
                                <span class="badge badge-testing">Testing</span>
                            </a>
                            <div class="template-description">
                                For issues with assessment reports
                            </div>
                        </div>
                        <div class="template-item" data-template="sim-achievement-levels">
                            <a href="#" class="template-link">
                                <i class="fas fa-trophy"></i> SIM Achievement Levels
                                <span class="badge badge-testing">Testing</span>
                            </a>
                            <div class="template-description">
                                For issues with achievement levels functionality
                            </div>
                        </div>
                        <div class="template-item" data-template="sim-fsa">
                            <a href="#" class="template-link">
                                <i class="fas fa-check-circle"></i> SIM FSA
                                <span class="badge badge-testing">Testing</span>
                            </a>
                            <div class="template-description">
                                For issues with FSA functionality
                            </div>
                        </div>
                        <div class="template-item" data-template="sim-library-view">
                            <a href="#" class="template-link">
                                <i class="fas fa-book-open"></i> SIM Library View
                                <span class="badge badge-testing">Testing</span>
                            </a>
                            <div class="template-description">
                                For issues with the SIM library view
                            </div>
                        </div>
                        <div class="template-item" data-template="sim-orr">
                            <a href="#" class="template-link">
                                <i class="fas fa-file-signature"></i> SIM ORR
                                <span class="badge badge-development">Development</span>
                            </a>
                            <div class="template-description">
                                For issues with ORR functionality
                            </div>
                        </div>
                        <div class="template-item" data-template="sim-oral-reading-records">
                            <a href="#" class="template-link">
                                <i class="fas fa-book-reader"></i> SIM Oral Reading Records
                                <span class="badge badge-development">Development</span>
                            </a>
                            <div class="template-description">
                                For issues regarding Oral Reading Records functionality
                            </div>
                        </div>
                        <div class="template-item" data-template="sim-plan-teach">
                            <a href="#" class="template-link">
                                <i class="fas fa-chalkboard-teacher"></i> SIM Plan & Teach
                                <span class="badge badge-development">Development</span>
                            </a>
                            <div class="template-description">
                                For issues with Plan & Teach functionality
                            </div>
                        </div>
                        <div class="template-item" data-template="sim-reading-log">
                            <a href="#" class="template-link">
                                <i class="fas fa-book-reader"></i> SIM Reading Log
                                <span class="badge badge-development">Development</span>
                            </a>
                            <div class="template-description">
                                For issues with Reading Log functionality
                            </div>
                        </div>
                    </div>
                </div>
                <div class="group-description">
                    Templates for Trackers regarding SIM assignments, reports, reading logs, and other product
                    functionality issues.
                </div>
            </div>

            <!-- OTHER TEMPLATES GROUP -->
            <div class="template-group">
                <div class="group-header collapsed">
                    <h2><i class="fas fa-layer-group"></i> Other Templates <span class="template-count">4</span></h2>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="templates-container collapsed">
                    <div class="template-list">
                        <div class="template-item" data-template="feature-request">
                            <a href="#" class="template-link">
                                <i class="fas fa-lightbulb"></i> Feature Request
                                <span class="badge badge-development">Development</span>
                            </a>
                            <div class="template-description">
                                For new feature requests and enhancements
                            </div>
                        </div>
                        <div class="template-item" data-template="help-article">
                            <a href="#" class="template-link">
                                <i class="fas fa-question-circle"></i> Help Article
                                <span class="badge badge-development">Development</span>
                            </a>
                            <div class="template-description">
                                For requesting new help articles or updates to existing ones
                            </div>
                        </div>
                        <div class="template-item" data-template="student-transfer">
                            <a href="#" class="template-link">
                                <i class="fas fa-exchange-alt"></i> Student Transfer
                                <span class="badge badge-development">Development</span>
                            </a>
                            <div class="template-description">
                                For student transfer issues
                            </div>
                        </div>
                        <div class="template-item" data-template="timeout-extension">
                            <a href="#" class="template-link">
                                <i class="fas fa-hourglass-half"></i> Timeout Extension
                                <span class="badge badge-development">Development</span>
                            </a>
                            <div class="template-description">
                                For timeout extension requests
                            </div>
                        </div>
                    </div>
                </div>
                <div class="group-description">
                    Additional specialized templates for feature requests, help articles and more.
                </div>
            </div>

            <!-- BLANK TRACKER GROUP -->
            <div class="template-group">
                <div class="group-header collapsed">
                    <h2><i class="fas fa-file"></i> Blank Tracker <span class="template-count">1</span></h2>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="templates-container collapsed">
                    <div class="template-list">
                        <div class="template-item" data-template="blank">
                            <a href="#" class="template-link">
                                <i class="fas fa-file-alt"></i> Blank Tracker Template
                                <span class="badge badge-development">Development</span>
                            </a>
                            <div class="template-description">
                                A general-purpose tracker template with universal ticket properties.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="group-description">
                    A general-purpose tracker template with universal ticket properties.
                </div>
            </div>
        </div>

        <script>
            document.onreadystatechange = function () {
                if (document.readyState === 'complete') renderApp();

                function renderApp() {
                    const onInit = app.initialized();

                    onInit.then(function (_client) {
                        window.client = _client;
                        console.log("Template selector initialized successfully");

                        // Get current ticket details
                        client.data.get("ticket").then(function (ticketData) {
                            console.log("Retrieved ticket data:", ticketData);

                            // Store ticket data for templates to use
                            if (ticketData && ticketData.ticket) {
                                localStorage.setItem('ticketData', JSON.stringify(ticketData.ticket));
                            }

                            setupTemplateHandlers();

                        }).catch(function (error) {
                            console.error("Error getting ticket data:", error);
                            // Still set up click handlers even if ticket data fails
                            setupTemplateHandlers();
                        });
                    }).catch(function (error) {
                        console.error("Error initializing app:", error);
                        document.body.innerHTML = `
                            <div style="padding: 20px; background-color: #ffebee; color: #c62828; border-radius: 4px; margin: 10px;">
                                <h3>Initialization Error</h3>
                                <p>Failed to initialize template selector.</p>
                                <p>Error: ${error.message || "Unknown error"}</p>
                            </div>
                        `;
                    });
                }
            };

            // Function to set up handlers without ticket data
            function setupTemplateHandlers() {
                // Add click handlers to both the template item div and the anchor tag
                const templateItems = document.querySelectorAll('.template-item');
                templateItems.forEach(item => {
                    // Get the template type from the data attribute
                    const templateType = item.getAttribute('data-template');

                    // Get the link within this item
                    const link = item.querySelector('a.template-link');

                    // Add click handler to the entire item div
                    item.addEventListener('click', function (e) {
                        // Don't trigger if clicking on the link itself (let the link handle that)
                        if (e.target === link || link.contains(e.target)) {
                            return;
                        }
                        e.preventDefault();
                        console.log(`Div clicked for template: ${templateType}`);
                        if (templateType) {
                            selectTemplate(templateType);
                        } else {
                            console.warn("No template type found for clicked item");
                        }
                    });

                    // Also store the template type on the link for direct clicks
                    if (link) {
                        link.setAttribute('data-template-type', templateType);

                        // Add click handler to prevent default and use our navigation
                        link.addEventListener('click', function (e) {
                            e.preventDefault();
                            const linkTemplateType = this.getAttribute('data-template-type');
                            console.log(`Link clicked for template: ${linkTemplateType}`);
                            if (linkTemplateType) {
                                selectTemplate(linkTemplateType);
                            } else {
                                console.warn("No template type found for clicked link");
                            }
                        });
                    }
                });
            }

            // Function to select a template and navigate to the dynamic template
            function selectTemplate(templateType) {
                console.log(`Selected template: ${templateType}`);

                // First get current agent information
                client.data.get("loggedInUser").then(function (userData) {
                    console.log("Retrieved agent data:", userData);

                    // The email may be in different locations based on the Freshdesk API response
                    let agentEmail = '';
                    if (userData && userData.loggedInUser) {
                        // Try different possible locations for the email
                        if (userData.loggedInUser.email) {
                            agentEmail = userData.loggedInUser.email;
                        } else if (userData.loggedInUser.contact && userData.loggedInUser.contact.email) {
                            agentEmail = userData.loggedInUser.contact.email;
                        } else if (userData.loggedInUser.primary_email) {
                            agentEmail = userData.loggedInUser.primary_email;
                        }

                        // If we still don't have it, try to find it in the full object
                        if (!agentEmail) {
                            // Log the full structure for debugging
                            console.log("Full loggedInUser structure:", JSON.stringify(userData.loggedInUser));

                            // Use user in email field if available
                            if (userData.loggedInUser.user && userData.loggedInUser.user.email) {
                                agentEmail = userData.loggedInUser.user.email;
                            }
                        }
                    }

                    console.log("Extracted agent email:", agentEmail);

                    // Get stored ticket data
                    const ticketData = localStorage.getItem('ticketData');

                    if (ticketData) {
                        try {
                            const parsedData = JSON.parse(ticketData);
                            console.log(`Processing ticket data for ${templateType}:`, parsedData);

                            // Try to get the agent email from the ticket data if not found above
                            if (!agentEmail && parsedData.responder && parsedData.responder.email) {
                                agentEmail = parsedData.responder.email;
                                console.log("Using responder email from ticket:", agentEmail);
                            }

                            // Prepare data to pass to the template
                            const dataToPass = {
                                currentTicketId: parsedData.id,
                                isVip: false,
                                districtName: '',
                                requesterEmail: agentEmail,
                                priority: parsedData.priority || 2
                            };

                            // Add product type data if available in the ticket
                            if (parsedData.custom_fields && parsedData.custom_fields.cf_product_type) {
                                dataToPass.productType = parsedData.custom_fields.cf_product_type;
                                console.log(`Found product type in ticket:`, dataToPass.productType);
                            }

                            // Add product and product subsection data if available
                            if (parsedData.custom_fields && parsedData.custom_fields.cf_product) {
                                dataToPass.product = parsedData.custom_fields.cf_product;
                                console.log(`Found product in ticket:`, dataToPass.product);
                            }

                            if (parsedData.custom_fields && parsedData.custom_fields.cf_product_subsection) {
                                dataToPass.productSubsection = parsedData.custom_fields.cf_product_subsection;
                                console.log(`Found product subsection in ticket:`, dataToPass.productSubsection);
                            }

                            console.log("Setting requesterEmail to:", agentEmail);

                            // Process VIP status from custom fields
                            if (parsedData.custom_fields) {
                                const vipFields = ['cf_vip', 'vip', 'cf_vip_status', 'vip_customer', 'cf_vip_client', 'cf_is_vip'];
                                for (const field of vipFields) {
                                    if (parsedData.custom_fields[field] !== undefined) {
                                        const value = parsedData.custom_fields[field];
                                        dataToPass.isVip = (typeof value === 'boolean') ? value :
                                            (typeof value === 'string') ? (value.toLowerCase() === 'yes' || value.toLowerCase() === 'true') :
                                                (typeof value === 'number') ? (value !== 0) : false;
                                        break;
                                    }
                                }
                            }

                            // Get district name from custom fields
                            if (parsedData.custom_fields) {
                                if (parsedData.custom_fields.cf_district509811) {
                                    dataToPass.districtName = parsedData.custom_fields.cf_district509811;
                                    dataToPass.districtDropdownValue = parsedData.custom_fields.cf_district509811;
                                    console.log(`Found district name: ${dataToPass.districtName}`);
                                    console.log(`Set districtDropdownValue to: ${dataToPass.districtDropdownValue}`);
                                } else {
                                    console.log('District field cf_district509811 not found or empty');
                                }
                            }

                            // Handle subject formatting right here in selectTemplate
                            if (parsedData.isVip) {
                                // Force the subject format to include VIP at this point
                                const districtName = parsedData.districtName || '';
                                const formattedSubject = `VIP* ${districtName} | Custom Achievement Levels`;

                                // Store the pre-formatted subject in localStorage
                                dataToPass.formattedSubject = formattedSubject;
                                console.log(`Pre-formatted subject for VIP customer: "${formattedSubject}"`);
                            }

                            // Store the processed data in localStorage
                            localStorage.setItem(`${templateType}Data`, JSON.stringify(dataToPass));
                            console.log(`Stored ${templateType} data in localStorage:`, dataToPass);

                            // Navigate to the dynamic template
                            window.location.href = `dynamic-tracker.html?type=${templateType}`;

                        } catch (error) {
                            console.error("Error processing ticket data:", error);
                            // Default data with at least the email if there's an error
                            const dataToPass = {
                                currentTicketId: null,
                                isVip: false,
                                districtName: '',
                                requesterEmail: agentEmail,
                                priority: 2
                            };
                            localStorage.setItem(`${templateType}Data`, JSON.stringify(dataToPass));
                            window.location.href = `dynamic-tracker.html?type=${templateType}`;
                        }
                    } else {
                        // No ticket data but we still have agent data
                        const dataToPass = {
                            currentTicketId: null,
                            isVip: false,
                            districtName: '',
                            requesterEmail: agentEmail,
                            priority: 2
                        };
                        localStorage.setItem(`${templateType}Data`, JSON.stringify(dataToPass));
                        window.location.href = `dynamic-tracker.html?type=${templateType}`;
                    }
                }).catch(function (error) {
                    console.error("Error getting agent data:", error);
                    // Navigate to template with default data if agent data fails
                    window.location.href = `dynamic-tracker.html?type=${templateType}`;
                });
            }

            // Handle collapsible sections
            document.addEventListener('DOMContentLoaded', function () {
                // Handle collapsible sections
                const groupHeaders = document.querySelectorAll('.group-header');

                groupHeaders.forEach(header => {
                    header.addEventListener('click', function () {
                        // Toggle the collapsed class on the header
                        this.classList.toggle('collapsed');

                        // Find the associated container and toggle its collapsed class
                        const container = this.nextElementSibling;
                        container.classList.toggle('collapsed');
                    });
                });

                // Handle search functionality
                const searchInput = document.getElementById('templateSearch');

                searchInput.addEventListener('input', function () {
                    const searchTerm = this.value.toLowerCase();
                    const templateItems = document.querySelectorAll('.template-item');
                    const templateGroups = document.querySelectorAll('.template-group');

                    templateItems.forEach(item => {
                        const templateName = item.querySelector('.template-link').textContent.toLowerCase();
                        const templateDesc = item.querySelector('.template-description').textContent.toLowerCase();
                        const isMatch = templateName.includes(searchTerm) || templateDesc.includes(searchTerm);

                        item.style.display = isMatch ? 'block' : 'none';
                    });

                    // Show/hide groups based on whether they have any visible templates
                    templateGroups.forEach(group => {
                        const hasVisibleTemplates = [...group.querySelectorAll('.template-item')].some(item =>
                            item.style.display !== 'none'
                        );

                        group.style.display = hasVisibleTemplates ? 'block' : 'none';

                        // Expand groups with matches
                        if (hasVisibleTemplates && searchTerm) {
                            const header = group.querySelector('.group-header');
                            const container = group.querySelector('.templates-container');

                            header.classList.remove('collapsed');
                            container.classList.remove('collapsed');
                        }
                    });
                });
            });
        </script>
    </div>
</body>

</html>