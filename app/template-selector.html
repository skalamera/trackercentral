<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="frame-src 'self' https: d3h0owdjgzys62.cloudfront.net;">
    <script async src="{{{appclient}}}"></script>
    <link rel="stylesheet" type="text/css" href="styles/style.css" />
    <link rel="stylesheet" type="text/css" href="styles/template-selector.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>Freshdesk Tracker Templates</title>
    <style>
        /* 4th of July Fireworks Animation */
        .fireworks-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        .firework {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: explode 1.5s ease-out forwards;
            box-shadow: 0 0 10px currentColor;
        }

        @keyframes explode {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        .spark {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: sparkle 1.2s ease-out forwards;
            box-shadow: 0 0 8px currentColor, 0 0 15px currentColor;
        }

        @keyframes sparkle {
            0% {
                transform: translate(0, 0) scale(0);
                opacity: 1;
            }

            50% {
                transform: translate(var(--x), var(--y)) scale(1);
                opacity: 1;
            }

            100% {
                transform: translate(var(--x), var(--y)) scale(0.3);
                opacity: 0;
            }
        }

        /* Independence Day Theme - Dark night sky background */
        .independence-day-theme {
            background: linear-gradient(180deg, #001f3f 0%, #0a2540 50%, #1a3a52 100%);
        }

        .independence-day-theme .navbar {
            background: linear-gradient(90deg, #b22234 0%, #ffffff 50%, #3c3b6e 100%);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        /* White title for Independence Day theme */
        .independence-day-theme .navbar-title {
            color: #ffffff !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8), 0 0 20px rgba(255, 255, 255, 0.3);
            font-weight: bold;
            font-size: 1.8em;
            background: none;
            -webkit-text-fill-color: unset;
        }

        .independence-day-banner {
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            animation: fadeIn 1s ease-in;
            overflow: hidden;
            background: #001f3f;
            /* Dark blue background as fallback */
            position: relative;
            /* Force hardware acceleration for smoother rendering */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            will-change: transform;
            /* Ensure proper clipping on WebKit browsers */
            -webkit-mask-image: -webkit-radial-gradient(white, black);
            mask-image: radial-gradient(white, black);
        }

        /* Apply rounded corners directly to the image */
        .independence-day-banner img {
            border-radius: 15px;
            display: block;
            width: 100%;
            height: auto;
            /* Additional rendering optimization */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: smooth;
            /* Prevent subpixel rendering issues */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            /* Ensure the image respects the container's clipping */
            position: relative;
            z-index: 1;
        }

        /* Alternative approach: use pseudo-element for smoother corners */
        .independence-day-banner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid #001f3f;
            border-radius: 15px;
            pointer-events: none;
            z-index: 2;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Section headers for Independence Day theme (dark mode only) */
        .independence-day-theme .template-group .group-header {
            background: linear-gradient(135deg, rgba(178, 34, 52, 0.3) 0%, rgba(60, 59, 110, 0.3) 100%);
            border-left: 4px solid #b22234;
        }

        .independence-day-theme .template-group:nth-child(even) .group-header {
            background: linear-gradient(135deg, rgba(60, 59, 110, 0.3) 0%, rgba(178, 34, 52, 0.3) 100%);
            border-left: 4px solid #3c3b6e;
        }

        /* Ensure all text in headers is visible */
        .independence-day-theme .template-group .group-header h2,
        .independence-day-theme .template-group .group-header .template-count,
        .independence-day-theme .template-group .group-header .toggle-icon {
            color: #ffffff !important;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Add these styles in the head section */
        .navbar-item {
            transition: all 0.3s ease;
            border-radius: 4px;
            padding: 8px 12px;
        }

        .navbar-item i {
            color: inherit;
            margin-right: 8px;
        }

        .navbar-item:hover {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Dark mode hover styles */
        [data-theme="dark"] .navbar-item:hover {
            background-color: #2d2d2d;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        [data-theme="light"] .navbar-item,
        [data-theme="light"] .navbar-item i,
        [data-theme="light"] .navbar-item span {
            color: #000 !important;
        }

        #themeToggleBtn .fa-sun {
            color: #FFD600 !important;
        }

        #themeToggleBtn .fa-moon {
            color: #12344D !important;
        }

        #themeToggleBtn .dark-mode-text {
            color: #12344D !important;
        }

        /* Disabled theme toggle during Independence Day */
        .independence-day-theme #themeToggleBtn[disabled] {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        .independence-day-theme #themeToggleBtn[disabled] i,
        .independence-day-theme #themeToggleBtn[disabled] span {
            color: rgba(255, 255, 255, 0.5) !important;
        }

        /* Tracker Details Modal */
        .modal-controls {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--card-bg);
        }

        .filter-sort-controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-control,
        .sort-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-control label,
        .sort-control label {
            font-weight: 600;
            color: var(--text-color);
            white-space: nowrap;
        }

        .filter-control select,
        .sort-control select {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 14px;
            cursor: pointer;
        }

        .tracker-item {
            display: flex;
            flex-direction: column;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        .tracker-item:hover {
            background-color: var(--hover-bg);
        }

        .tracker-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .tracker-item-details {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 13px;
            color: var(--secondary-text);
        }

        .tracker-detail {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tracker-detail strong {
            font-weight: 600;
            color: var(--text-color);
        }

        .tracker-status {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
            background-color: var(--status-bg, #e0e0e0);
            color: var(--status-color, #333);
        }

        /* Status colors */
        .status-open {
            background-color: #4caf50;
            color: white;
        }

        .status-pending {
            background-color: #ff9800;
            color: white;
        }

        .status-waiting {
            background-color: #2196f3;
            color: white;
        }

        .status-in-progress {
            background-color: #9c27b0;
            color: white;
        }

        .status-escalated {
            background-color: #f44336;
            color: white;
        }

        .status-other {
            background-color: #607d8b;
            color: white;
        }

        /* Support Review Alert Button */
        .view-all-btn.support-review-alert {
            background: linear-gradient(135deg, #ff6b35, #ff8f00);
            color: #fff;
            font-weight: bold;
            border: 2px solid #ff6b35;
            box-shadow: 0 4px 8px rgba(255, 107, 53, 0.3);
            animation: pulseWarning 2s ease-in-out infinite;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .view-all-btn.support-review-alert:hover {
            background: linear-gradient(135deg, #ff5722, #ff6f00);
            color: #fff;
            border-color: #ff5722;
            box-shadow: 0 6px 12px rgba(255, 87, 34, 0.4);
            transform: translateY(-1px);
        }

        [data-theme="dark"] .view-all-btn.support-review-alert {
            background: linear-gradient(135deg, #ff7043, #ffa726);
            color: #fff;
            border-color: #ff7043;
            box-shadow: 0 4px 8px rgba(255, 112, 67, 0.4);
        }

        [data-theme="dark"] .view-all-btn.support-review-alert:hover {
            background: linear-gradient(135deg, #ff5722, #ff9800);
            color: #fff;
            border-color: #ff5722;
            box-shadow: 0 6px 12px rgba(255, 87, 34, 0.5);
        }

        @keyframes pulseWarning {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }

        /* Dark theme support review badge */
        [data-theme="dark"] .support-review-badge {
            background-color: #ffb300;
            color: #000;
        }

        /* Tickets that need review highlighting */
        .tracker-item.needs-review {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
        }

        [data-theme="dark"] .tracker-item.needs-review {
            background-color: #2d2a1f;
            border-left: 4px solid #ffb300;
            box-shadow: 0 2px 4px rgba(255, 179, 0, 0.3);
        }

        .tracker-needs-review {
            color: #ffc107;
            margin-left: 8px;
            font-size: 16px;
            animation: pulseReview 2s ease-in-out infinite;
        }

        [data-theme="dark"] .tracker-needs-review {
            color: #ffb300;
        }

        @keyframes pulseReview {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        /* Widget Settings Container and Button */
        .widget-settings-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }

        .widget-settings-btn-main {
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            color: var(--text-color);
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .widget-settings-btn-main:hover {
            background: var(--card-bg);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .widget-settings-btn-main i {
            font-size: 16px;
        }

        /* New Badge Styles */
        .new-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            font-size: 11px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(238, 90, 36, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 2px 4px rgba(238, 90, 36, 0.3);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 2px 8px rgba(238, 90, 36, 0.5);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 2px 4px rgba(238, 90, 36, 0.3);
            }
        }

        /* Adjust badge for dark mode */
        [data-theme="dark"] .new-badge {
            background: linear-gradient(135deg, #ff7979, #ff6348);
            box-shadow: 0 2px 4px rgba(255, 99, 72, 0.4);
        }

        /* Widget Settings Modal */
        .widget-settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .widget-settings-content {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        /* Dark mode modal background */
        [data-theme="dark"] .widget-settings-content {
            background: #1a202c;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .widget-settings-header {
            margin-bottom: 20px;
            text-align: center;
        }

        .widget-settings-header h3 {
            margin: 0 0 10px 0;
            color: var(--text-color);
            font-size: 24px;
        }

        .widget-settings-header p {
            margin: 0;
            color: var(--secondary-text);
            font-size: 14px;
        }

        .widget-option {
            background: var(--hover-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .widget-option:hover {
            border-color: #0ba87d;
            box-shadow: 0 2px 8px rgba(11, 168, 125, 0.1);
            transform: translateX(2px);
        }

        .widget-option.selected {
            border-color: #0ba87d;
            background: #e7f5ec;
            box-shadow: 0 0 0 3px rgba(11, 168, 125, 0.2);
        }

        /* Dark mode specific for selected widget option */
        [data-theme="dark"] .widget-option.selected {
            background: #1a3a2e;
            border-color: #4caf50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
        }

        /* Add a checkmark for selected option */
        .widget-option.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 15px;
            right: 15px;
            background: #0ba87d;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        [data-theme="dark"] .widget-option.selected::after {
            background: #4caf50;
        }

        /* Dark mode specific for widget options */
        [data-theme="dark"] .widget-option {
            background: #2d3748;
            border-color: #4a5568;
        }

        [data-theme="dark"] .widget-option:hover {
            background: #374151;
            border-color: #4caf50;
        }

        .widget-option-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .widget-option-title i {
            color: #0ba87d;
            font-size: 20px;
        }

        [data-theme="dark"] .widget-option-title i {
            color: #4caf50;
        }

        .widget-option.selected .widget-option-title i {
            color: #0ba87d;
        }

        [data-theme="dark"] .widget-option.selected .widget-option-title i {
            color: #66bb6a;
        }

        .widget-option-description {
            color: var(--secondary-text);
            font-size: 14px;
        }

        .widget-settings-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        .widget-settings-btn-action {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .widget-settings-btn-save {
            background: #0ba87d;
            color: white;
        }

        .widget-settings-btn-save:hover {
            background: #098f65;
        }

        .widget-settings-btn-cancel {
            background: var(--hover-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .widget-settings-btn-cancel:hover {
            background: var(--card-bg);
        }

        /* Simple widget styles */
        .simple-tracker-widget {
            margin: 20px 0;
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .simple-widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .simple-widget-header h3 {
            margin: 0;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .simple-widget-date {
            color: var(--secondary-text);
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="fireworks-container" id="fireworksContainer"></div>
    <div class="container">
        <!-- New Navbar -->
        <nav class="navbar">
            <div class="navbar-container">
                <div class="navbar-brand">
                    <h1 class="navbar-title">Tracker Central</h1>
                </div>
                <button class="navbar-toggle" id="navbarToggle">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
                <div class="navbar-menu" id="navbarMenu">
                    <a href="admin-settings.html" id="adminSettingsBtn" class="navbar-item" title="Admin Settings"
                        style="display: none;">
                        <i class="fas fa-sliders-h"></i>
                        <span>Admin Settings</span>
                    </a>
                    <a href="analytics.html" id="analyticsBtn" class="navbar-item" title="Analytics">
                        <i class="fas fa-chart-line"></i>
                        <span>Analytics</span>
                    </a>
                    <a href="https://benchmarkeducationcompany.freshdesk.com/a/solutions/articles/67000743925"
                        target="_blank" class="navbar-item" title="Tracker Central Docs">
                        <i class="fas fa-book-open"></i>
                        <span>Tracker Central Docs</span>
                    </a>
                    <button id="themeToggleBtn" class="navbar-item theme-toggle" title="Toggle Dark Mode">
                        <i class="fas fa-sun"></i>
                        <span>Light Mode</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- WIDGET SETTINGS BUTTON (Always visible) -->
        <div class="widget-settings-container">
            <button class="widget-settings-btn-main" id="mainWidgetSettingsBtn" title="Switch View">
                <i class="fas fa-exchange-alt"></i>
                <span id="widgetButtonText">Classic View</span>
            </button>
        </div>

        <!-- TRACKER WIDGETS CAROUSEL -->
        <div id="trackerWidgetsCarousel" class="tracker-widgets-carousel">
            <div class="carousel-container">
                <div class="carousel-track">
                    <!-- Today's Trackers Widget -->
                    <div class="carousel-slide active" data-widget="today">
                        <div class="tracker-counts-dashboard">
                            <div class="dashboard-header">
                                <div class="dashboard-title-row">
                                    <h3><i class="fas fa-chart-bar"></i> Today's Trackers <span id="trackerTotalCount"
                                            class="dashboard-count"></span></h3>
                                    <div class="dashboard-actions">
                                        <button class="view-all-btn" id="viewAllTrackersBtn" title="View all trackers">
                                            <i class="fas fa-list"></i> View All
                                        </button>
                                    </div>
                                </div>
                                <span id="dashboardDate" class="dashboard-date"></span>
                            </div>
                        </div>
                    </div>

                    <!-- My Trackers Widget -->
                    <div class="carousel-slide" data-widget="my">
                        <div class="tracker-counts-dashboard">
                            <div class="dashboard-header">
                                <div class="dashboard-title-row">
                                    <h3><i class="fas fa-user-tag"></i> My Trackers <span id="myTrackerCount"
                                            class="dashboard-count"></span></h3>
                                    <div class="dashboard-actions">
                                        <button class="view-all-btn" id="viewMyTrackersBtn" title="View my trackers">
                                            <i class="fas fa-list"></i> View All
                                        </button>
                                    </div>
                                </div>
                                <span class="dashboard-date">Unresolved trackers assigned to you</span>
                            </div>
                        </div>
                    </div>


                </div>
            </div>

            <!-- Navigation controls below carousel -->
            <div class="carousel-nav-container">
                <button class="carousel-nav carousel-prev" id="carouselPrev" aria-label="Previous widget">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="carousel-nav carousel-next" id="carouselNext" aria-label="Next widget">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Carousel indicators -->
            <div class="carousel-indicators">
                <button class="carousel-dot active" data-slide="0" aria-label="Go to Today's Trackers"></button>
                <button class="carousel-dot" data-slide="1" aria-label="Go to My Trackers"></button>
            </div>
        </div>

        <!-- SIMPLE TRACKER WIDGET (shown when user opts out of carousel) -->
        <div id="simpleTrackerWidget" class="simple-tracker-widget" style="display: none;">
            <div class="simple-widget-header">
                <div>
                    <h3><i class="fas fa-chart-bar"></i> Today's Trackers <span id="simpleTotalCount"
                            class="dashboard-count"></span></h3>
                    <span id="simpleDate" class="simple-widget-date"></span>
                </div>
                <div class="dashboard-actions">
                    <button class="view-all-btn" id="simpleViewAllBtn" title="View all trackers">
                        <i class="fas fa-list"></i> View All
                    </button>
                </div>
            </div>
        </div>

        <!-- WIDGET SETTINGS MODAL -->
        <div id="widgetSettingsModal" class="widget-settings-modal">
            <div class="widget-settings-content">
                <div class="widget-settings-header">
                    <h3>Widget Display Settings</h3>
                    <p>Choose how you'd like to view your tracker widgets</p>
                </div>

                <div class="widget-options">
                    <div class="widget-option selected" data-option="carousel">
                        <div class="widget-option-title">
                            <i class="fas fa-layer-group"></i>
                            Carousel View (New)
                        </div>
                        <div class="widget-option-description">
                            View all three widgets (Today's Trackers, My Trackers, and Backlogged) in an interactive
                            carousel
                        </div>
                    </div>

                    <div class="widget-option" data-option="classic">
                        <div class="widget-option-title">
                            <i class="fas fa-square"></i>
                            Classic View
                        </div>
                        <div class="widget-option-description">
                            Show only Today's Trackers widget in a simple, compact format
                        </div>
                    </div>
                </div>

                <div class="widget-settings-actions">
                    <button class="widget-settings-btn-action widget-settings-btn-cancel"
                        id="cancelWidgetSettings">Cancel</button>
                    <button class="widget-settings-btn-action widget-settings-btn-save" id="saveWidgetSettings">Save
                        Preference</button>
                </div>
            </div>
        </div>

        <!-- TRACKER DETAILS MODAL -->
        <div id="trackerDetailsModal" class="tracker-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle"><i class="fas fa-list"></i> <span>Today's Trackers</span></h3>
                    <button class="modal-close" id="closeTrackerModal">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Filter and Sort Controls -->
                    <div id="modalControls" class="modal-controls" style="display: none;">
                        <div class="filter-sort-controls">
                            <div class="filter-control">
                                <label for="statusFilter">Filter by Status:</label>
                                <select id="statusFilter">
                                    <option value="">All Statuses</option>
                                    <option value="2">Open</option>
                                    <option value="3">Pending</option>
                                    <option value="6">Waiting on Customer</option>
                                    <option value="8">Escalated</option>
                                    <option value="9">Dev in Progress</option>
                                    <option value="10">Waiting on Support</option>
                                    <option value="11">Resubmitted</option>
                                    <option value="14">Editorial in Progress</option>
                                    <option value="15">Closed in JIRA</option>
                                    <option value="22">Created in JIRA</option>
                                    <option value="23">Follow-up Required</option>
                                    <option value="25">Support Review</option>
                                    <option value="26">On Hold</option>
                                    <option value="29">Triage</option>
                                    <option value="30">Pending Jira</option>
                                    <option value="33">Bookings Meeting</option>
                                    <option value="36">Awaiting Internal Review</option>
                                    <option value="37">Support Ops Review</option>
                                </select>
                            </div>
                            <div class="sort-control">
                                <label for="sortBy">Sort by:</label>
                                <select id="sortBy">
                                    <option value="created_desc">Created Date (Newest First)</option>
                                    <option value="created_asc">Created Date (Oldest First)</option>
                                    <option value="updated_desc">Updated Date (Most Recent)</option>
                                    <option value="updated_asc">Updated Date (Least Recent)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="trackerDetailsList" class="tracker-details-list">
                        <!-- Tracker details will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MY DRAFTS SECTION -->
        <div id="myDraftsSection" class="my-drafts-section" style="display: none;">
            <div class="drafts-header">
                <div class="drafts-title-row">
                    <h2><i class="fas fa-save"></i> My Drafts <span id="draftsTotalCount"
                            class="dashboard-count"></span></h2>
                    <button class="drafts-toggle" id="draftsToggle" title="Collapse/Expand">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
            </div>
            <div id="draftsContent" class="drafts-content">
                <div id="draftsList" class="drafts-list">
                    <!-- Drafts will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Search Container -->
        <div class="search-container"> <i class="fas fa-search search-icon"></i> <input type="text" id="templateSearch"
                class="search-input" placeholder="Search templates..."> </div>
        <!-- Status area for displaying messages -->
        <div id="statusArea" style="display: none;"></div>
        <div class="template-groups">
            <!-- SEDCUST (CONTENT/EDITORIAL) GROUP -->
            <div class="template-group">
                <div class="group-header collapsed">
                    <h2><i class="fas fa-book"></i> SEDCUST (CONTENT/EDITORIAL) <span class="template-count">1</span>
                    </h2>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="templates-container collapsed">
                    <div class="template-list">
                        <div class="template-item" data-template="sedcust">
                            <a href="#" class="template-link">
                                <i class="fas fa-file-alt"></i> SEDCUST (CONTENT/EDITORIAL)

                            </a>
                            <div class="template-description">
                                <div class="issue-types">
                                    For issues regarding content errors, broken links, and other editorial concerns
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="group-description">

                    Open a tracker for the SEDCUST Team

                </div>
            </div>

            <!-- ASSEMBLY GROUP -->
            <div class="template-group">
                <div class="group-header collapsed">
                    <h2><i class="fas fa-tools"></i> ASSEMBLY <span class="template-count">2</span></h2>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="templates-container collapsed">
                    <div class="template-list">
                        <div class="template-item" data-template="assembly">
                            <a href="#" class="template-link">
                                <i class="fas fa-puzzle-piece"></i> ASSEMBLY

                            </a>
                            <div class="template-description">
                                For issues regarding missing content or resource availability in the district's
                                subscribed version </div>
                        </div>
                        <div class="template-item" data-template="assembly-rollover">
                            <a href="#" class="template-link">
                                <i class="fas fa-sync-alt"></i> ROLLOVER

                            </a>
                            <div class="template-description">
                                For requests regarding removing legacy assembly codes from a district. </div>
                        </div>
                    </div>
                </div>
                <div class="group-description">
                    Open a tracker for the Assembly Team
                </div>
            </div>

            <!-- SIM TRACKERS GROUP -->
            <div class="template-group">
                <div class="group-header collapsed">
                    <h2><i class="fa-solid fa-users-gear"></i> SIM <span class="template-count">9</span></h2>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="templates-container collapsed">
                    <div class="template-list">
                        <div class="template-item" data-template="sim-assignment">
                            <a href="#" class="template-link">
                                <i class="fas fa-tasks"></i> ASSIGNMENT/eASSESSMENT

                            </a>
                            <div class="template-description">
                                For issues regarding assignment and/or eAssessment functionality
                            </div>
                        </div>
                        <div class="template-item" data-template="sim-assessment-reports">
                            <a href="#" class="template-link">
                                <i class="fas fa-chart-bar"></i> REPORTS

                            </a>
                            <div class="template-description">
                                For issues regarding functionality of assessment reports</div>
                        </div>
                        <div class="template-item" data-template="sim-achievement-levels">
                            <a href="#" class="template-link">
                                <i class="fas fa-trophy"></i> ACHIEVEMENT LEVELS

                            </a>
                            <div class="template-description">
                                For districts who would like custom achievement levels to display in reports
                            </div>
                        </div>
                        <div class="template-item" data-template="sim-fsa">
                            <a href="#" class="template-link">
                                <i class="fas fa-check-circle"></i> FSA

                            </a>
                            <div class="template-description">
                                For issues regarding functionality of foundational skills assessment </div>
                        </div>
                        <div class="template-item" data-template="sim-library-view">
                            <a href="#" class="template-link">
                                <i class="fas fa-book-open"></i> LIBRARY VIEW

                            </a>
                            <div class="template-description">
                                For issues regarding functionality in the resource library </div>
                        </div>
                        <div class="template-item" data-template="sim-orr">
                            <a href="#" class="template-link">
                                <i class="fas fa-file-signature"></i> ORR

                            </a>
                            <div class="template-description">
                                For issues regarding functionality of oral reading records (ORR) </div>
                        </div>
                        <div class="template-item" data-template="sim-plan-teach">
                            <a href="#" class="template-link">
                                <i class="fas fa-chalkboard-teacher"></i> PLAN & TEACH

                            </a>
                            <div class="template-description">
                                For issues regarding the functionality of the Plan & Teach Tool
                            </div>
                        </div>
                        <div class="template-item" data-template="sim-reading-log">
                            <a href="#" class="template-link">
                                <i class="fas fa-book-reader"></i> READING LOG

                            </a>
                            <div class="template-description">
                                For issues regarding functionality of the Reading Log
                            </div>
                        </div>
                        <div class="template-item" data-template="sim-dashboard">
                            <a href="#" class="template-link">
                                <i class="fas fa-tachometer-alt"></i> DASHBOARD

                            </a>
                            <div class="template-description">
                                For issues regarding functionality of the dashboard
                            </div>
                        </div>
                    </div>
                </div>
                <div class="group-description">
                    Open a tracker for the SIM Team
                </div>
            </div>

            <!-- OTHER TEMPLATE GROUP -->
            <div class="template-group">
                <div class="group-header collapsed">
                    <h2><i class="fas fa-layer-group"></i> OTHER TEMPLATES <span class="template-count">4</span></h2>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="templates-container collapsed">
                    <div class="template-list">
                        <div class="template-item" data-template="dpt">
                            <a href="#" class="template-link">
                                <i class="fas fa-file-alt"></i> DPT (CUSTOMIZED eASSESSMENT)

                            </a>
                            <div class="template-description">
                                For requests to add districts to the District Preference Table for customized
                                eAssessments
                            </div>
                        </div>
                        <div class="template-item" data-template="feature-request">
                            <a href="#" class="template-link">
                                <i class="fas fa-lightbulb"></i> FEATURE REQUEST

                            </a>
                            <div class="template-description">
                                For requests regarding new functionality within Benchmark Universe
                            </div>
                        </div>
                        <div class="template-item" data-template="help-article">
                            <a href="#" class="template-link">
                                <i class="fas fa-question-circle"></i> HELP ARTICLE

                            </a>
                            <div class="template-description">
                                For issues regarding BU Help Articles
                            </div>
                        </div>
                        <div class="template-item" data-template="timeout-extension">
                            <a href="#" class="template-link">
                                <i class="fas fa-hourglass-half"></i> TIMEOUT EXTENSION

                            </a>
                            <div class="template-description">
                                For districts who would like an extended time out setting.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="group-description">
                    Additional specialized templates for feature requests, help articles and more.
                </div>
            </div>
        </div>

        <script>
            document.onreadystatechange = function () {
                if (document.readyState === 'complete') renderApp();

                function renderApp() {
                    const onInit = app.initialized();

                    onInit.then(function (_client) {
                        window.client = _client;
                        console.log("Template selector initialized successfully");

                        // Initialize dark mode
                        initTheme();

                        // Initialize navbar
                        initNavbar();

                        // Initialize drafts toggle
                        initDraftsToggle();

                        // Check and apply Independence Day theme
                        checkIndependenceDayTheme();

                        // Get current ticket details
                        client.data.get("ticket").then(function (ticketData) {
                            console.log("Retrieved ticket data:", ticketData);

                            // Store ticket data for templates to use
                            if (ticketData && ticketData.ticket) {
                                localStorage.setItem('ticketData', JSON.stringify(ticketData.ticket));
                            }

                            // Check if user is admin and show admin settings button if they are
                            checkAdminPermissions();

                            setupTemplateHandlers();
                            initializeDrafts();
                            loadAndDisplayTrackerCounts();
                            updateWidgetButtonText();

                        }).catch(function (error) {
                            console.error("Error getting ticket data:", error);
                            // Still set up click handlers even if ticket data fails
                            checkAdminPermissions();
                            setupTemplateHandlers();
                            initializeDrafts();
                            updateWidgetButtonText();
                        });
                    }).catch(function (error) {
                        console.error("Error initializing app:", error);
                        document.body.innerHTML = `
                            <div style="padding: 20px; background-color: #ffebee; color: #c62828; border-radius: 4px; margin: 10px;">
                                <h3>Initialization Error</h3>
                                <p>Failed to initialize template selector.</p>
                                <p>Error: ${error.message || "Unknown error"}</p>
                            </div>
                        `;
                    });
                }
            };

            // Initialize navbar functionality
            function initNavbar() {
                const navbarToggle = document.getElementById('navbarToggle');
                const navbarMenu = document.getElementById('navbarMenu');

                if (navbarToggle && navbarMenu) {
                    navbarToggle.addEventListener('click', function () {
                        navbarMenu.classList.toggle('active');
                        navbarToggle.classList.toggle('active');
                    });

                    // Close menu when clicking outside
                    document.addEventListener('click', function (event) {
                        if (!navbarToggle.contains(event.target) && !navbarMenu.contains(event.target)) {
                            navbarMenu.classList.remove('active');
                            navbarToggle.classList.remove('active');
                        }
                    });
                }
            }

            // Initialize drafts toggle functionality
            function initDraftsToggle() {
                const draftsToggle = document.getElementById('draftsToggle');
                const draftsContent = document.getElementById('draftsContent');
                const draftsSection = document.getElementById('myDraftsSection');

                if (draftsToggle && draftsContent && draftsSection) {
                    draftsToggle.addEventListener('click', function () {
                        const isCollapsed = draftsSection.classList.contains('collapsed');

                        if (isCollapsed) {
                            draftsSection.classList.remove('collapsed');
                            draftsToggle.innerHTML = '<i class="fas fa-chevron-down"></i>';
                            draftsToggle.title = 'Collapse';
                        } else {
                            draftsSection.classList.add('collapsed');
                            draftsToggle.innerHTML = '<i class="fas fa-chevron-down"></i>';
                            draftsToggle.title = 'Expand';
                        }
                    });
                }
            }

            // Initialize dark mode based on saved preference
            function initTheme() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
                updateThemeIcon(savedTheme);

                // Add event listener for theme toggle
                const themeToggleBtn = document.getElementById('themeToggleBtn');
                if (themeToggleBtn) {
                    themeToggleBtn.addEventListener('click', toggleTheme);
                }
            }

            // Toggle between light and dark mode
            function toggleTheme() {
                // Check if Independence Day theme is active
                if (document.body.classList.contains('independence-day-theme')) {
                    console.log('Theme switching disabled during Independence Day celebration');
                    return;
                }

                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);

                updateThemeIcon(newTheme);
                console.log(`Theme switched to ${newTheme} mode`);
            }

            // Update the theme toggle icon based on current theme
            function updateThemeIcon(theme) {
                const themeToggleBtn = document.getElementById('themeToggleBtn');
                if (themeToggleBtn) {
                    const icon = themeToggleBtn.querySelector('i');
                    const text = themeToggleBtn.querySelector('span');

                    if (theme === 'dark') {
                        icon.className = 'fas fa-sun';
                        text.textContent = 'Light Mode';
                        text.classList.remove('dark-mode-text');
                        themeToggleBtn.title = 'Switch to Light Mode';
                    } else {
                        icon.className = 'fas fa-moon';
                        text.textContent = 'Dark Mode';
                        text.classList.add('dark-mode-text');
                        themeToggleBtn.title = 'Switch to Dark Mode';
                    }
                }
            }

            // Check and apply Independence Day theme
            function checkIndependenceDayTheme() {
                // Check if Independence Day theme is enabled in settings
                client.db.get('independenceDayThemeEnabled')
                    .then(function (themeSetting) {
                        let isEnabled = false;

                        if (themeSetting !== null && themeSetting !== undefined) {
                            if (typeof themeSetting === 'boolean') {
                                isEnabled = themeSetting;
                            } else if (typeof themeSetting === 'object' && themeSetting.enabled !== undefined) {
                                isEnabled = themeSetting.enabled;
                            }
                        }

                        console.log('Independence Day theme enabled:', isEnabled);

                        if (isEnabled) {
                            // Save current theme preference before forcing dark mode
                            const currentTheme = document.documentElement.getAttribute('data-theme');
                            if (currentTheme !== 'dark') {
                                localStorage.setItem('theme-before-july4', currentTheme);
                            }

                            // Force dark mode for Independence Day theme
                            document.documentElement.setAttribute('data-theme', 'dark');
                            updateThemeIcon('dark');

                            // Disable theme toggle button
                            const themeToggleBtn = document.getElementById('themeToggleBtn');
                            if (themeToggleBtn) {
                                themeToggleBtn.disabled = true;
                                themeToggleBtn.style.opacity = '0.5';
                                themeToggleBtn.style.cursor = 'not-allowed';
                                themeToggleBtn.title = 'Theme switching disabled during Independence Day celebration';
                            }

                            applyIndependenceDayTheme();
                        } else {
                            // Restore previous theme preference if Independence Day theme is disabled
                            const previousTheme = localStorage.getItem('theme-before-july4');
                            if (previousTheme) {
                                document.documentElement.setAttribute('data-theme', previousTheme);
                                updateThemeIcon(previousTheme);
                                localStorage.removeItem('theme-before-july4');
                            }

                            // Re-enable theme toggle button
                            const themeToggleBtn = document.getElementById('themeToggleBtn');
                            if (themeToggleBtn) {
                                themeToggleBtn.disabled = false;
                                themeToggleBtn.style.opacity = '1';
                                themeToggleBtn.style.cursor = 'pointer';
                                themeToggleBtn.title = 'Toggle Dark Mode';
                            }
                        }
                    })
                    .catch(function (error) {
                        console.error('Error checking Independence Day theme setting:', error);
                        // Don't apply theme if there's an error
                    });
            }

            // Apply Independence Day theme and start fireworks
            function applyIndependenceDayTheme() {
                // Add theme class to body
                document.body.classList.add('independence-day-theme');

                // Add Independence Day banner
                const container = document.querySelector('.container');
                if (container) {
                    const banner = document.createElement('div');
                    banner.className = 'independence-day-banner';
                    banner.innerHTML = `
                        <img src="https://res.cloudinary.com/doznvxtja/image/upload/v1751273879/4thofjulybanner_ojdk7n.svg" 
                             alt="Happy Independence Day!">
                    `;
                    container.insertBefore(banner, container.firstChild);
                }

                // Start fireworks animation
                startFireworks();
            }

            // Create fireworks animation
            function startFireworks() {
                const colors = ['#ff0000', '#ffffff', '#0000ff', '#ffd700', '#ff69b4', '#00ff00'];
                const fireworksContainer = document.getElementById('fireworksContainer');

                if (!fireworksContainer) return;

                // Create fireworks periodically
                function createFirework() {
                    const x = Math.random() * window.innerWidth;
                    const y = Math.random() * (window.innerHeight * 0.6) + 50; // Upper 60% of screen, offset from top

                    const firework = document.createElement('div');
                    firework.className = 'firework';
                    firework.style.left = x + 'px';
                    firework.style.top = y + 'px';
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    firework.style.backgroundColor = color;
                    firework.style.color = color;

                    fireworksContainer.appendChild(firework);

                    // Create explosion effect
                    setTimeout(() => {
                        // Create more sparks for bigger explosion
                        for (let i = 0; i < 35; i++) {
                            const spark = document.createElement('div');
                            spark.className = 'spark';
                            spark.style.left = x + 'px';
                            spark.style.top = y + 'px';
                            const sparkColor = colors[Math.floor(Math.random() * colors.length)];
                            spark.style.backgroundColor = sparkColor;
                            spark.style.color = sparkColor;

                            // Random direction for each spark
                            const angle = (Math.PI * 2 * i) / 35;
                            const velocity = 80 + Math.random() * 150; // Increased velocity for bigger explosion
                            const vx = Math.cos(angle) * velocity + (Math.random() - 0.5) * 40;
                            const vy = Math.sin(angle) * velocity + (Math.random() - 0.5) * 40;

                            spark.style.setProperty('--x', vx + 'px');
                            spark.style.setProperty('--y', vy + 'px');

                            fireworksContainer.appendChild(spark);

                            // Remove spark after animation
                            setTimeout(() => {
                                spark.remove();
                            }, 1200);
                        }

                        // Remove the original firework
                        firework.remove();
                    }, 300);
                }

                // Create initial burst of fireworks
                for (let i = 0; i < 8; i++) {
                    setTimeout(createFirework, i * 150);
                }

                // Continue creating fireworks periodically with varied timing
                setInterval(() => {
                    createFirework();
                    // Sometimes create multiple fireworks at once
                    if (Math.random() > 0.6) {
                        setTimeout(createFirework, 200);
                    }
                    if (Math.random() > 0.8) {
                        setTimeout(createFirework, 400);
                    }
                }, 1500);
            }

            // Function to set up handlers without ticket data
            function setupTemplateHandlers() {
                // Add click handlers to both the template item div and the anchor tag
                const templateItems = document.querySelectorAll('.template-item');
                templateItems.forEach(item => {
                    // Get the template type from the data attribute
                    const templateType = item.getAttribute('data-template');

                    // Get the link within this item
                    const link = item.querySelector('a.template-link');

                    // Add click handler to the entire item div
                    item.addEventListener('click', function (e) {
                        // Don't trigger if clicking on the link itself (let the link handle that)
                        if (e.target === link || link.contains(e.target)) {
                            return;
                        }
                        e.preventDefault();
                        console.log(`Div clicked for template: ${templateType}`);
                        if (templateType) {
                            selectTemplate(templateType);
                        } else {
                            console.warn("No template type found for clicked item");
                        }
                    });

                    // Also store the template type on the link for direct clicks
                    if (link) {
                        link.setAttribute('data-template-type', templateType);

                        // Add click handler to prevent default and use our navigation
                        link.addEventListener('click', function (e) {
                            e.preventDefault();
                            const linkTemplateType = this.getAttribute('data-template-type');
                            console.log(`Link clicked for template: ${linkTemplateType}`);
                            if (linkTemplateType) {
                                selectTemplate(linkTemplateType);
                            } else {
                                console.warn("No template type found for clicked link");
                            }
                        });
                    }
                });
            }

            // Draft Management Functions
            function initializeDrafts() {
                console.log("Initializing drafts system");
                loadAndDisplayDrafts();
                setupDraftEventHandlers();
            }

            function loadAndDisplayDrafts() {
                const myDraftsSection = document.getElementById('myDraftsSection');
                const draftsList = document.getElementById('draftsList');
                const draftsTotalCount = document.getElementById('draftsTotalCount');

                if (!myDraftsSection || !draftsList) {
                    console.warn("Draft elements not found");
                    return;
                }

                try {
                    // Load utilities first
                    const utilityScripts = [
                        'utils/formatDate.js',
                        'utils/fieldPopulators.js',
                        'utils/versionFieldHandlers.js',
                        'utils/quillHelpers.js',
                        'utils/templateBase.js',
                        'utils/subjectLineFormatter.js'
                    ];

                    let loadedCount = 0;
                    const loadTrackerConfig = () => {
                        loadedCount++;
                        if (loadedCount === utilityScripts.length) {
                            // All utilities loaded, now set up template environment
                            window.TRACKER_CONFIGS_FROM_TEMPLATES = {};
                            if (typeof module === 'undefined') {
                                window.module = { exports: {} };
                            }

                            // Template files to load
                            const templateFiles = [
                                { key: 'assembly-rollover', path: 'templates/assembly/assembly-rollover.js' },
                                { key: 'assembly', path: 'templates/assembly/assembly.js' },
                                { key: 'sedcust', path: 'templates/sedcust/sedcust.js' },
                                { key: 'sim-assignment', path: 'templates/sim/assignment.js' },
                                { key: 'sim-assessment-reports', path: 'templates/sim/assessment-reports.js' },
                                { key: 'sim-achievement-levels', path: 'templates/sim/achievement-levels.js' },
                                { key: 'sim-fsa', path: 'templates/sim/fsa.js' },
                                { key: 'sim-library-view', path: 'templates/sim/library-view.js' },
                                { key: 'sim-orr', path: 'templates/sim/orr.js' },
                                { key: 'sim-plan-teach', path: 'templates/sim/plan-teach.js' },
                                { key: 'sim-reading-log', path: 'templates/sim/reading-log.js' },
                                { key: 'sim-dashboard', path: 'templates/sim/dashboard.js' },
                                { key: 'feature-request', path: 'templates/other/feature-request.js' },
                                { key: 'dpt', path: 'templates/other/dpt.js' },
                                { key: 'timeout-extension', path: 'templates/other/timeout-extension.js' },
                                { key: 'help-article', path: 'templates/other/help-article.js' }
                            ];

                            let templatesLoaded = 0;
                            const loadAllTemplatesAndTrackerConfig = () => {
                                templatesLoaded++;
                                if (templatesLoaded === templateFiles.length) {
                                    // All templates loaded, now load tracker config
                                    const script = document.createElement('script');
                                    script.src = 'tracker-config.js';
                                    script.onload = () => {
                                        // Now we can access the DraftManager
                                        if (window.draftManager) {
                                            const drafts = window.draftManager.getDraftsArray();
                                            console.log(`Found ${drafts.length} drafts`);

                                            if (drafts.length === 0) {
                                                myDraftsSection.style.display = 'none';
                                                return;
                                            }

                                            // Show drafts section
                                            myDraftsSection.style.display = 'block';

                                            // Update the count badge
                                            if (draftsTotalCount) {
                                                draftsTotalCount.textContent = drafts.length;
                                            }

                                            // Default to collapsed if there are drafts (but you can change this)
                                            // Since there are drafts, we'll leave it expanded by default
                                            // If you want it collapsed by default even with drafts, uncomment the next lines:
                                            // myDraftsSection.classList.add('collapsed');
                                            // document.getElementById('draftsToggle').innerHTML = '<i class="fas fa-chevron-right"></i>';

                                            // Populate drafts list
                                            draftsList.innerHTML = '';
                                            drafts.forEach(draft => {
                                                const draftElement = createDraftElement(draft);
                                                draftsList.appendChild(draftElement);
                                            });
                                        }
                                    };
                                    document.head.appendChild(script);
                                }
                            };

                            // Load all template files
                            templateFiles.forEach(template => {
                                const tempScript = document.createElement('script');
                                tempScript.src = template.path;
                                tempScript.onload = function () {
                                    // Capture the module.exports value for this template
                                    window.TRACKER_CONFIGS_FROM_TEMPLATES[template.key] = module.exports;
                                    module.exports = {}; // Reset for next template
                                    loadAllTemplatesAndTrackerConfig();
                                };
                                document.head.appendChild(tempScript);
                            });
                        }
                    };

                    // Load all utility scripts
                    utilityScripts.forEach(scriptSrc => {
                        const utilScript = document.createElement('script');
                        utilScript.src = scriptSrc;
                        utilScript.onload = loadTrackerConfig;
                        document.head.appendChild(utilScript);
                    });
                } catch (error) {
                    console.error('Error loading drafts:', error);
                }
            }

            function createDraftElement(draft) {
                const draftDiv = document.createElement('div');
                draftDiv.className = 'draft-item';
                draftDiv.setAttribute('data-draft-id', draft.id);

                // Get template config for display name
                const templateTitle = getTemplateDisplayName(draft.templateType);
                const formattedDate = new Date(draft.updatedAt).toLocaleDateString();
                const formattedTime = new Date(draft.updatedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                draftDiv.innerHTML = `
                    <div class="draft-header">
                        <div class="draft-info">
                            <div class="draft-name">${draft.name}</div>
                            <div class="draft-meta">
                                <span class="draft-template">${templateTitle}</span>
                                <span class="draft-date">Saved: ${formattedDate} at ${formattedTime}</span>
                            </div>
                        </div>
                        <div class="draft-actions">
                            <button class="draft-continue-btn" onclick="loadDraft('${draft.id}')" title="Continue editing">
                                <i class="fas fa-edit"></i> Continue
                            </button>
                            <button class="draft-delete-btn" onclick="deleteDraft('${draft.id}')" title="Delete draft">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;

                return draftDiv;
            }

            function getTemplateDisplayName(templateType) {
                const templateNames = {
                    'assembly': 'Assembly Tracker',
                    'assembly-rollover': 'Assembly Rollover',
                    'sedcust': 'SEDCUST (Content/Editorial)',
                    'feature-request': 'Feature Request',
                    'sim-assignment': 'SIM Assignment',
                    'sim-assessment-reports': 'SIM Assessment Reports',
                    'sim-achievement-levels': 'SIM Achievement Levels',
                    'sim-fsa': 'SIM FSA',
                    'sim-library-view': 'SIM Library View',
                    'sim-orr': 'SIM ORR',
                    'sim-plan-teach': 'SIM Plan & Teach',
                    'sim-reading-log': 'SIM Reading Log',
                    'sim-dashboard': 'SIM Dashboard',
                    'dpt': 'DPT (Customized eAssessment)',
                    'timeout-extension': 'Timeout Extension',
                    'help-article': 'Help Article'
                };
                return templateNames[templateType] || templateType;
            }

            function setupDraftEventHandlers() {
                // No additional event handlers needed currently
            }

            function loadDraft(draftId) {
                console.log(`Loading draft: ${draftId}`);
                try {
                    if (window.draftManager) {
                        const draft = window.draftManager.getDraft(draftId);
                        if (!draft) {
                            console.error('Draft not found');
                            if (window.client) {
                                client.interface.trigger("showNotify", {
                                    type: "danger",
                                    message: "Draft not found"
                                });
                            }
                            return;
                        }

                        // Store the draft info for later use
                        localStorage.setItem('loadingDraft', JSON.stringify({
                            draftId: draftId,
                            formData: draft.formData
                        }));

                        // Navigate to the tracker form with the correct template type
                        localStorage.setItem('selectedTemplate', draft.templateType);
                        window.location.href = `dynamic-tracker.html?type=${draft.templateType}`;
                    } else {
                        console.error('Draft system not available');
                        if (window.client) {
                            client.interface.trigger("showNotify", {
                                type: "danger",
                                message: "Draft system not available"
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error loading draft:', error);
                    if (window.client) {
                        client.interface.trigger("showNotify", {
                            type: "danger",
                            message: "Failed to load draft. Please try again."
                        });
                    }
                }
            }

            function deleteDraft(draftId) {
                console.log(`Deleting draft: ${draftId}`);
                if (!confirm('Are you sure you want to delete this draft?')) {
                    return;
                }

                try {
                    if (window.draftManager) {
                        const success = window.draftManager.deleteDraft(draftId);
                        if (success) {
                            // Remove the draft element from DOM
                            const draftElement = document.querySelector(`[data-draft-id="${draftId}"]`);
                            if (draftElement) {
                                draftElement.remove();
                            }

                            // Check if we need to hide the drafts section
                            const remainingDrafts = document.querySelectorAll('.draft-item');
                            if (remainingDrafts.length === 0) {
                                const myDraftsSection = document.getElementById('myDraftsSection');
                                if (myDraftsSection) {
                                    myDraftsSection.style.display = 'none';
                                }
                            } else {
                                // Update the count badge
                                const draftsTotalCount = document.getElementById('draftsTotalCount');
                                if (draftsTotalCount) {
                                    draftsTotalCount.textContent = remainingDrafts.length;
                                }
                            }

                            console.log('Draft deleted successfully');
                        } else {
                            console.error('Failed to delete draft');
                            if (window.client) {
                                client.interface.trigger("showNotify", {
                                    type: "danger",
                                    message: "Failed to delete draft"
                                });
                            }
                        }
                    } else {
                        console.error('Draft system not available');
                        if (window.client) {
                            client.interface.trigger("showNotify", {
                                type: "danger",
                                message: "Draft system not available"
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error deleting draft:', error);
                    if (window.client) {
                        client.interface.trigger("showNotify", {
                            type: "danger",
                            message: "Failed to delete draft. Please try again."
                        });
                    }
                }
            }

            // Make functions globally accessible
            window.loadDraft = loadDraft;
            window.deleteDraft = deleteDraft;

            // Widget preference functions
            function getWidgetPreference() {
                return localStorage.getItem('trackerWidgetPreference') || 'carousel';
            }

            function setWidgetPreference(preference) {
                localStorage.setItem('trackerWidgetPreference', preference);
            }

            // Update widget button text based on current preference
            function updateWidgetButtonText() {
                const buttonText = document.getElementById('widgetButtonText');
                if (buttonText) {
                    const currentPreference = getWidgetPreference();
                    // Show the opposite of current preference (what they'll switch TO)
                    if (currentPreference === 'carousel') {
                        buttonText.textContent = 'Classic View';
                    } else {
                        buttonText.innerHTML = 'Carousel View <span class="new-badge">New</span>';
                    }
                }
            }

            // Daily Tracker Counts Functions
            function loadAndDisplayTrackerCounts() {
                console.log("Loading daily tracker counts");

                if (!window.client) {
                    console.warn("Client not available for loading tracker counts");
                    return;
                }

                const today = getTodayDateString();
                const storageKey = `tracker-details-${today}`;

                // Update widget button text
                updateWidgetButtonText();

                // Load today's tracker details from Freshdesk storage
                client.db.get(storageKey)
                    .then(function (data) {
                        console.log(`Loaded tracker details for ${today}:`, data);
                        const trackers = data?.trackers || [];
                        displayTrackerCounts(trackers, today);
                    })
                    .catch(function (error) {
                        console.log(`No tracker details found for ${today} (this is normal if no trackers created today):`, error);
                        displayTrackerCounts([], today);
                    });
            }

            // Global variables for carousel
            let currentSlide = 0;  // Start at first widget (Today's Trackers)
            const totalSlides = 2;

            function displayTrackerCounts(trackers, date) {
                const preference = getWidgetPreference();
                const carousel = document.getElementById('trackerWidgetsCarousel');
                const simpleWidget = document.getElementById('simpleTrackerWidget');
                const dateElement = document.getElementById('dashboardDate');
                const trackerTotalCount = document.getElementById('trackerTotalCount');
                const viewAllBtn = document.getElementById('viewAllTrackersBtn');

                // Simple widget elements
                const simpleDateElement = document.getElementById('simpleDate');
                const simpleTotalCount = document.getElementById('simpleTotalCount');
                const simpleViewAllBtn = document.getElementById('simpleViewAllBtn');

                if (!carousel || !simpleWidget) {
                    console.warn("Widget elements not found");
                    return;
                }

                // Store trackers globally for the View All functionality
                window.todayTrackers = trackers;

                // Set the date - always use current date for "Today's Trackers"
                const today = new Date();
                const formattedDate = today.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Calculate total count
                const totalCount = trackers.length;

                // Show appropriate widget based on preference
                if (preference === 'classic') {
                    // Hide carousel, show simple widget
                    carousel.style.display = 'none';
                    simpleWidget.style.display = 'block';

                    // Update simple widget elements
                    if (simpleDateElement) simpleDateElement.textContent = formattedDate;
                    if (simpleTotalCount) simpleTotalCount.textContent = totalCount;
                    if (simpleViewAllBtn) {
                        simpleViewAllBtn.style.display = totalCount > 0 ? 'inline-flex' : 'none';
                    }
                } else {
                    // Show carousel, hide simple widget
                    carousel.style.display = 'block';
                    simpleWidget.style.display = 'none';

                    // Update carousel elements
                    if (dateElement) dateElement.textContent = formattedDate;
                    if (trackerTotalCount) trackerTotalCount.textContent = totalCount;
                    if (viewAllBtn) {
                        viewAllBtn.style.display = totalCount > 0 ? 'inline-flex' : 'none';
                    }

                    // Load data for other widgets in carousel
                    loadMyTrackers();

                    // Initialize carousel
                    initializeCarousel();
                }
            }

            // Carousel Functions
            function initializeCarousel() {
                const prevBtn = document.getElementById('carouselPrev');
                const nextBtn = document.getElementById('carouselNext');
                const dots = document.querySelectorAll('.carousel-dot');

                if (prevBtn) {
                    prevBtn.addEventListener('click', () => moveCarousel(-1));
                }

                if (nextBtn) {
                    nextBtn.addEventListener('click', () => moveCarousel(1));
                }

                dots.forEach((dot, index) => {
                    dot.addEventListener('click', () => goToSlide(index));
                });

                // Update carousel state
                updateCarousel();
            }

            function moveCarousel(direction) {
                currentSlide = (currentSlide + direction + totalSlides) % totalSlides;
                updateCarousel();
            }

            function goToSlide(index) {
                currentSlide = index;
                updateCarousel();
            }

            function updateCarousel() {
                const track = document.querySelector('.carousel-track');
                const slides = document.querySelectorAll('.carousel-slide');
                const dots = document.querySelectorAll('.carousel-dot');

                if (track) {
                    track.style.transform = `translateX(-${currentSlide * 100}%)`;
                }

                slides.forEach((slide, index) => {
                    slide.classList.toggle('active', index === currentSlide);
                });

                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === currentSlide);
                });
            }

            // Load My Trackers
            async function loadMyTrackers() {
                try {
                    if (!window.client) {
                        console.warn("Client not available for loading my trackers");
                        return;
                    }

                    // Get logged in user
                    const userData = await client.data.get("loggedInUser");
                    if (!userData || !userData.loggedInUser) {
                        console.warn("Could not get logged in user data");
                        updateMyTrackersDisplay(0);
                        return;
                    }

                    const userId = userData.loggedInUser.id;
                    console.log("Loading trackers for user ID:", userId);

                    // Convert userId to both string and number for comparison
                    const userIdStr = String(userId);
                    const userIdNum = parseInt(userId, 10);

                    try {
                        // Search for tickets assigned to current agent with unresolved statuses
                        // Including all unresolved statuses except: 4 (Resolved), 5 (Closed), 27 (Backlog), 28 (Closed - No Resolution)
                        const unresolved = [2, 3, 6, 8, 9, 10, 11, 14, 15, 22, 23, 25, 26, 29, 30, 33, 36, 37];
                        const statusFilter = unresolved.map(s => `status:${s}`).join(' OR ');

                        // Search ONLY for tracker tickets assigned to this agent
                        // Add tag:tracker to the initial search to reduce results
                        const filter = `agent_id:${userIdNum} AND tag:tracker AND (${statusFilter})`;
                        console.log("Searching for My Trackers with filter:", filter);
                        console.log("Status IDs included in search:", unresolved);

                        // Get ALL tickets using pagination
                        let allTickets = [];
                        let page = 1;
                        let hasMore = true;

                        while (hasMore) {
                            const requestContext = {
                                filter: filter,
                                page: page,
                                per_page: 100 // Maximum allowed by Freshdesk
                            };
                            console.log(`Requesting page ${page} with per_page: ${requestContext.per_page}`);

                            const response = await client.request.invokeTemplate("getTicketsByFilter", {
                                context: requestContext
                            });

                            const data = JSON.parse(response.response);
                            if (page === 1) {
                                console.log("My Trackers API response structure:", data);
                                console.log(`Total tickets available: ${data.total || 'unknown'}`);
                            }

                            // Handle different response formats from Freshdesk API
                            let pageTickets = [];
                            if (data && data.results && Array.isArray(data.results)) {
                                pageTickets = data.results;
                            } else if (data && data.tickets && Array.isArray(data.tickets)) {
                                pageTickets = data.tickets;
                            } else if (Array.isArray(data)) {
                                pageTickets = data;
                            }

                            // Check for duplicates before adding
                            const beforeCount = allTickets.length;
                            const existingIds = new Set(allTickets.map(t => t.id));
                            const newTickets = pageTickets.filter(ticket => !existingIds.has(ticket.id));
                            const duplicatesOnPage = pageTickets.length - newTickets.length;

                            allTickets = allTickets.concat(newTickets);
                            console.log(`Page ${page}: Retrieved ${pageTickets.length} tickets (${newTickets.length} new, ${duplicatesOnPage} duplicates) - total so far: ${allTickets.length}`);

                            // Check if there are more pages by comparing with total count
                            const totalAvailable = data.total || allTickets.length;
                            // Continue if we haven't fetched all tickets yet AND we got some tickets on this page
                            hasMore = allTickets.length < totalAvailable && pageTickets.length > 0;

                            page++;

                            // Safety limit to prevent infinite loops (with 100 per page, 10 pages = 1000 tickets)
                            if (page > 10) {
                                console.warn("Reached page limit of 10 (1000 tickets), stopping pagination");
                                hasMore = false;
                            }
                        }

                        let tickets = allTickets;
                        console.log(`Retrieved ${tickets.length} total tickets from all pages`);

                        // Log ticket count only
                        if (tickets.length > 0) {
                            console.log(`Found ${tickets.length} tickets in search results`);
                        }

                        // First, let's analyze all tickets before filtering
                        console.log("Analyzing all retrieved tickets before filtering:");
                        const statusCounts = {};
                        const tagCounts = {};
                        let trackersWithoutTag = 0;

                        tickets.forEach(ticket => {
                            // Count statuses
                            statusCounts[ticket.status] = (statusCounts[ticket.status] || 0) + 1;

                            // Count tags
                            if (ticket.tags && Array.isArray(ticket.tags)) {
                                ticket.tags.forEach(tag => {
                                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                                });
                            }

                            // Check if subject contains "tracker" but no tag
                            if (ticket.subject && ticket.subject.toLowerCase().includes('tracker') &&
                                (!ticket.tags || !ticket.tags.some(tag => tag === 'tracker' || tag.startsWith('tracker-')))) {
                                trackersWithoutTag++;
                            }
                        });

                        console.log("Status distribution:", statusCounts);
                        console.log("Tag distribution:", tagCounts);
                        console.log("Tickets with 'tracker' in subject but no tracker tag:", trackersWithoutTag);

                        // Filter for tracker tickets (already filtered by agent and status in the search)
                        const trackerTickets = tickets.filter((ticket, index) => {
                            // Check if it's a tracker ticket (has 'tracker' tag or tags starting with 'tracker-')
                            const isTracker = ticket.tags && Array.isArray(ticket.tags) &&
                                ticket.tags.some(tag => tag === 'tracker' || tag.startsWith('tracker-'));

                            // Enhanced debug logging for ALL tickets to understand the assignment issue
                            if (index < 10) {
                                console.log(`Ticket ${index + 1}:`, {
                                    id: ticket.id,
                                    subject: ticket.subject.substring(0, 50) + '...',
                                    status: ticket.status,
                                    responder_id: ticket.responder_id,
                                    agent_id: ticket.agent_id,
                                    assignee_id: ticket.assignee_id,
                                    requester_id: ticket.requester_id,
                                    created_by: ticket.created_by,
                                    tags: ticket.tags ? ticket.tags.join(', ') : 'No tags',
                                    isTracker: isTracker
                                });

                                // Special warning if ticket is not assigned to the expected user
                                if (ticket.responder_id != userIdNum && ticket.agent_id != userIdNum) {
                                    console.warn(`âš ï¸ Ticket ${ticket.id} is NOT assigned to user ${userIdNum}!`,
                                        `responder_id: ${ticket.responder_id}, agent_id: ${ticket.agent_id}`);
                                }
                            }

                            return isTracker;
                        });

                        // Remove duplicates based on ticket ID
                        const uniqueTrackers = [];
                        const seenIds = new Set();
                        const duplicateInfo = {};

                        trackerTickets.forEach(ticket => {
                            if (!seenIds.has(ticket.id)) {
                                seenIds.add(ticket.id);
                                uniqueTrackers.push(ticket);
                            } else {
                                // Track duplicate info
                                duplicateInfo[ticket.id] = (duplicateInfo[ticket.id] || 1) + 1;
                            }
                        });

                        window.myTrackers = uniqueTrackers;

                        console.log(`Found ${trackerTickets.length} tracker tickets (${uniqueTrackers.length} unique) assigned to user ${userId}`);

                        // Log duplicate information if any
                        if (Object.keys(duplicateInfo).length > 0) {
                            console.log('Duplicate tracker tickets found:', duplicateInfo);
                        }

                        // Log details of unique tracker tickets found
                        console.log('Unique tracker tickets:');
                        uniqueTrackers.forEach((ticket, index) => {
                            console.log(`  ${index + 1}. #${ticket.id}: ${ticket.subject} (Status: ${ticket.status}, Tags: ${ticket.tags ? ticket.tags.join(', ') : 'None'})`);
                        });
                        updateMyTrackersDisplay(window.myTrackers.length);
                    } catch (searchError) {
                        console.error("Error with ticket search, trying alternate approach:", searchError);

                        // Check if this is a field validation error
                        if (searchError.response && searchError.response.includes("invalid_field")) {
                            console.warn("The assignee_id field may not be supported in your Freshdesk instance. Trying alternative approaches...");
                        }

                        // If search fails, try getting all tracker tickets
                        try {
                            console.log("Trying simpler search for all tracker tickets...");
                            const simpleResponse = await client.request.invokeTemplate("getTicketsByFilter", {
                                context: {
                                    filter: `tag:tracker`
                                }
                            });

                            const data = JSON.parse(simpleResponse.response);
                            console.log("Fallback API response structure:", data);

                            // Handle different response formats from Freshdesk API
                            let tickets = [];
                            if (data && data.results && Array.isArray(data.results)) {
                                tickets = data.results;
                            } else if (data && data.tickets && Array.isArray(data.tickets)) {
                                tickets = data.tickets;
                            } else if (Array.isArray(data)) {
                                tickets = data;
                            }
                            console.log(`Retrieved ${tickets.length} tickets from fallback search`);

                            // Filter for tracker tickets assigned to user
                            window.myTrackers = tickets.filter(ticket => {
                                const hasTrackerTag = ticket.tags && Array.isArray(ticket.tags) &&
                                    ticket.tags.some(tag => tag === 'tracker' || tag.startsWith('tracker-'));

                                // TEMPORARY FIX: Also check for ESCALATED TO ASSEMBLY tag or specific patterns
                                const hasEscalatedTag = ticket.tags && Array.isArray(ticket.tags) &&
                                    ticket.tags.includes('ESCALATED TO ASSEMBLY');

                                // Check if subject indicates it's a tracker
                                const subjectPattern = ticket.subject && (
                                    ticket.subject.includes(' | ') ||
                                    ticket.subject.includes(' â€¢ ') ||
                                    /\b(VIP\*?|SIM|SEDCUST|Assembly)\b/i.test(ticket.subject)
                                );

                                const isTracker = hasTrackerTag || (hasEscalatedTag && subjectPattern);
                                // Check if assigned to current user
                                const isAssignedToUser = ticket.agent_id === userIdNum ||
                                    ticket.agent_id === userIdStr ||
                                    ticket.responder_id === userIdNum ||
                                    ticket.responder_id === userIdStr;
                                // Check if unresolved - exclude status 4 (Resolved), 5 (Closed), 27 (Backlog), 28 (Closed-No Resolution)
                                const resolvedStatuses = [4, 5, 27, 28];
                                const isUnresolved = !resolvedStatuses.includes(ticket.status);

                                return isTracker && isAssignedToUser && isUnresolved;
                            });

                            updateMyTrackersDisplay(window.myTrackers.length);
                        } catch (fallbackError) {
                            console.error("Fallback search also failed:", fallbackError);

                            // Final fallback: Try getting tickets directly without search
                            try {
                                console.log("Attempting to get tickets without search filter...");
                                // Try to get all tickets, or at least first page
                                const allTicketsResponse = await client.request.invokeTemplate("getAllTickets", {
                                    context: {}
                                });

                                const data = JSON.parse(allTicketsResponse.response);
                                console.log("All tickets response structure:", data);

                                let tickets = [];
                                if (data && data.results && Array.isArray(data.results)) {
                                    tickets = data.results;
                                } else if (data && data.tickets && Array.isArray(data.tickets)) {
                                    tickets = data.tickets;
                                } else if (Array.isArray(data)) {
                                    tickets = data;
                                }

                                // Filter client-side for user's tracker tickets
                                window.myTrackers = tickets.filter(ticket => {
                                    const isTracker = ticket.tags && Array.isArray(ticket.tags) &&
                                        ticket.tags.some(tag => tag === 'tracker' || tag.startsWith('tracker-'));
                                    const isAssignedToUser = ticket.agent_id === userIdNum ||
                                        ticket.agent_id === userIdStr ||
                                        ticket.responder_id === userIdNum ||
                                        ticket.responder_id === userIdStr;
                                    // Check if unresolved - exclude status 4 (Resolved), 5 (Closed), 27 (Backlog), 28 (Closed-No Resolution)
                                    const resolvedStatuses = [4, 5, 27, 28];
                                    const isUnresolved = !resolvedStatuses.includes(ticket.status);
                                    return isTracker && isAssignedToUser && isUnresolved;
                                });

                                console.log(`Found ${window.myTrackers.length} tracker tickets for user after client-side filtering`);
                                updateMyTrackersDisplay(window.myTrackers.length);
                            } catch (allTicketsError) {
                                console.error("Failed to get tickets without search:", allTicketsError);
                                window.myTrackers = [];
                                updateMyTrackersDisplay(0);
                            }
                        }
                    }
                } catch (error) {
                    console.error("Error loading my trackers:", error);
                    window.myTrackers = [];
                    updateMyTrackersDisplay(0);
                }
            }

            function updateMyTrackersDisplay(count) {
                const myTrackerCount = document.getElementById('myTrackerCount');
                const viewMyTrackersBtn = document.getElementById('viewMyTrackersBtn');

                if (myTrackerCount) {
                    myTrackerCount.textContent = count;
                }

                if (viewMyTrackersBtn && count > 0) {
                    // Check if any trackers have Support Review status (25 or 15)
                    const supportReviewCount = (window.myTrackers || []).filter(ticket =>
                        ticket.status === 25 || ticket.status === 15
                    ).length;

                    if (supportReviewCount > 0) {
                        // Replace button content with support review alert
                        viewMyTrackersBtn.className = 'view-all-btn support-review-alert';
                        viewMyTrackersBtn.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${supportReviewCount} Need Review`;
                        viewMyTrackersBtn.title = `${supportReviewCount} ticket${supportReviewCount > 1 ? 's' : ''} need${supportReviewCount === 1 ? 's' : ''} review - Click to view`;
                    } else {
                        // Reset to normal View All button
                        viewMyTrackersBtn.className = 'view-all-btn';
                        viewMyTrackersBtn.innerHTML = '<i class="fas fa-list"></i> View All';
                        viewMyTrackersBtn.title = 'View my trackers';
                    }

                    viewMyTrackersBtn.style.display = 'inline-flex';
                } else if (viewMyTrackersBtn) {
                    viewMyTrackersBtn.style.display = 'none';
                }
            }



            function getTemplateInfo() {
                return {
                    'assembly': { name: 'Assembly', icon: 'fas fa-puzzle-piece' },
                    'assembly-rollover': { name: 'Rollover', icon: 'fas fa-sync-alt' },
                    'sedcust': { name: 'SEDCUST', icon: 'fas fa-book' },
                    'sim-assignment': { name: 'SIM Assignment', icon: 'fas fa-tasks' },
                    'sim-assessment-reports': { name: 'SIM Reports', icon: 'fas fa-chart-bar' },
                    'sim-achievement-levels': { name: 'SIM Achievement', icon: 'fas fa-trophy' },
                    'sim-fsa': { name: 'SIM FSA', icon: 'fas fa-check-circle' },
                    'sim-library-view': { name: 'SIM Library', icon: 'fas fa-book-open' },
                    'sim-orr': { name: 'SIM ORR', icon: 'fas fa-file-signature' },
                    'sim-plan-teach': { name: 'SIM Plan & Teach', icon: 'fas fa-chalkboard-teacher' },
                    'sim-reading-log': { name: 'SIM Reading Log', icon: 'fas fa-book-reader' },
                    'sim-dashboard': { name: 'SIM Dashboard', icon: 'fas fa-tachometer-alt' },
                    'dpt': { name: 'DPT', icon: 'fas fa-file-alt' },
                    'feature-request': { name: 'Feature Request', icon: 'fas fa-lightbulb' },
                    'help-article': { name: 'Help Article', icon: 'fas fa-question-circle' },
                    'timeout-extension': { name: 'Timeout Extension', icon: 'fas fa-hourglass-half' }
                };
            }

            function getTodayDateString() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // Function to increment tracker count (called from dynamic tracker)
            function incrementTrackerCount(templateType, trackerId, subject) {
                console.log(`Adding tracker details for template: ${templateType}, ID: ${trackerId}, Subject: ${subject}`);

                if (!window.client) {
                    console.warn("Client not available for storing tracker details");
                    return;
                }

                const today = getTodayDateString();
                const storageKey = `tracker-details-${today}`;

                // Get current tracker details
                client.db.get(storageKey)
                    .then(function (data) {
                        const currentData = data || { trackers: [] };
                        const trackers = currentData.trackers || [];

                        // Add new tracker details
                        trackers.push({
                            id: trackerId,
                            subject: subject,
                            templateType: templateType,
                            timestamp: new Date().toISOString()
                        });

                        console.log(`Updated tracker details for ${today}:`, trackers);

                        // Save back to storage
                        return client.db.set(storageKey, { trackers: trackers });
                    })
                    .catch(function (error) {
                        // Handle 404 error when no record exists yet (first tracker of the day)
                        if (error.status === 404) {
                            console.log(`No existing record for ${today}, creating new one`);
                            const newData = {
                                trackers: [{
                                    id: trackerId,
                                    subject: subject,
                                    templateType: templateType,
                                    timestamp: new Date().toISOString()
                                }]
                            };

                            console.log(`Creating new tracker details record:`, newData);

                            // Create new record
                            return client.db.set(storageKey, newData);
                        } else {
                            // Re-throw other errors
                            throw error;
                        }
                    })
                    .then(function () {
                        console.log(`Successfully stored tracker details for ${templateType}`);
                    })
                    .catch(function (error) {
                        console.error(`Error storing tracker details:`, error);
                    });
            }

            // Make increment function globally accessible
            window.incrementTrackerCount = incrementTrackerCount;

            // Manual test function for debugging
            function testTrackerCount() {
                incrementTrackerCount('sedcust', '12345', 'Test District | SEDCUST Content Issue');
                setTimeout(() => {
                    loadAndDisplayTrackerCounts();
                }, 1000);
            }

            // Make test function globally accessible
            window.testTrackerCount = testTrackerCount;

            // Debug function to find all tracker tickets for current user regardless of status
            async function debugFindAllMyTrackers() {
                try {
                    console.log("DEBUG: Finding ALL tracker tickets for current user...");

                    const userData = await client.data.get("loggedInUser");
                    const userId = userData.loggedInUser.id;
                    const userIdNum = parseInt(userId, 10);

                    // Search for ALL tickets assigned to user (no status filter)
                    const filter = `agent_id:${userIdNum}`;
                    console.log("DEBUG: Searching with filter:", filter);

                    // Get ALL tickets using pagination
                    let allTickets = [];
                    let page = 1;
                    let hasMore = true;

                    while (hasMore) {
                        const response = await client.request.invokeTemplate("getTicketsByFilter", {
                            context: {
                                filter: filter,
                                page: page,
                                per_page: 100 // Maximum allowed by Freshdesk
                            }
                        });

                        const data = JSON.parse(response.response);
                        if (page === 1) {
                            console.log(`DEBUG: Total tickets available: ${data.total || 'unknown'}`);
                        }

                        let pageTickets = [];
                        if (data && data.results && Array.isArray(data.results)) {
                            pageTickets = data.results;
                        } else if (data && data.tickets && Array.isArray(data.tickets)) {
                            pageTickets = data.tickets;
                        } else if (Array.isArray(data)) {
                            pageTickets = data;
                        }

                        allTickets = allTickets.concat(pageTickets);
                        console.log(`DEBUG: Page ${page}: Retrieved ${pageTickets.length} tickets`);

                        // Check if there are more pages by comparing with total count
                        const totalAvailable = data.total || allTickets.length;
                        // Continue if we haven't fetched all tickets yet AND we got some tickets on this page
                        hasMore = allTickets.length < totalAvailable && pageTickets.length > 0;

                        page++;

                        if (page > 10) {
                            console.warn("DEBUG: Reached page limit of 10 (1000 tickets)");
                            hasMore = false;
                        }
                    }

                    let tickets = allTickets;
                    console.log(`DEBUG: Found ${tickets.length} total tickets for user`);

                    // Now filter for tracker tickets and analyze statuses
                    const trackerTickets = tickets.filter(ticket => {
                        return ticket.tags && Array.isArray(ticket.tags) &&
                            ticket.tags.some(tag => tag === 'tracker' || tag.startsWith('tracker-'));
                    });

                    console.log(`DEBUG: Found ${trackerTickets.length} tracker tickets total`);

                    // Analyze status distribution of tracker tickets
                    const statusDistribution = {};
                    trackerTickets.forEach(ticket => {
                        const status = ticket.status;
                        if (!statusDistribution[status]) {
                            statusDistribution[status] = { count: 0, tickets: [] };
                        }
                        statusDistribution[status].count++;
                        statusDistribution[status].tickets.push({
                            id: ticket.id,
                            subject: ticket.subject
                        });
                    });

                    console.log("DEBUG: Tracker tickets by status:", statusDistribution);

                    // Show which statuses are missing from the unresolved list
                    const unresolved = [2, 3, 6, 8, 9, 10, 11, 14, 15, 22, 23, 25, 26, 29, 30, 33, 36, 37];
                    const missingStatuses = Object.keys(statusDistribution)
                        .map(s => parseInt(s))
                        .filter(s => !unresolved.includes(s) && s !== 4 && s !== 5 && s !== 27 && s !== 28);

                    if (missingStatuses.length > 0) {
                        console.log("DEBUG: Missing status IDs that should be added to unresolved list:", missingStatuses);
                        console.log("DEBUG: Add these status IDs to the 'unresolved' array in loadMyTrackers function");
                    }

                    return trackerTickets;
                } catch (error) {
                    console.error("DEBUG: Error in debugFindAllMyTrackers:", error);
                }
            }

            // Make debug function globally accessible
            window.debugFindAllMyTrackers = debugFindAllMyTrackers;

            // Function to select a template and navigate to the dynamic template
            function selectTemplate(templateType) {
                console.log(`Selected template: ${templateType}`);

                // Clear any loading draft data since this is a fresh template selection
                localStorage.removeItem('loadingDraft');

                // First get current agent information
                client.data.get("loggedInUser").then(function (userData) {
                    console.log("Retrieved agent data:", userData);

                    // The email may be in different locations based on the Freshdesk API response
                    let agentEmail = '';
                    if (userData && userData.loggedInUser) {
                        // Try different possible locations for the email
                        if (userData.loggedInUser.email) {
                            agentEmail = userData.loggedInUser.email;
                        } else if (userData.loggedInUser.contact && userData.loggedInUser.contact.email) {
                            agentEmail = userData.loggedInUser.contact.email;
                        } else if (userData.loggedInUser.primary_email) {
                            agentEmail = userData.loggedInUser.primary_email;
                        }

                        // If we still don't have it, try to find it in the full object
                        if (!agentEmail) {
                            // Log the full structure for debugging
                            console.log("Full loggedInUser structure:", JSON.stringify(userData.loggedInUser));

                            // Use user in email field if available
                            if (userData.loggedInUser.user && userData.loggedInUser.user.email) {
                                agentEmail = userData.loggedInUser.user.email;
                            }
                        }
                    }

                    console.log("Extracted agent email:", agentEmail);

                    // Get stored ticket data
                    const ticketData = localStorage.getItem('ticketData');

                    if (ticketData) {
                        try {
                            const parsedData = JSON.parse(ticketData);
                            console.log(`Processing ticket data for ${templateType}:`, parsedData);

                            // Try to get the agent email from the ticket data if not found above
                            if (!agentEmail && parsedData.responder && parsedData.responder.email) {
                                agentEmail = parsedData.responder.email;
                                console.log("Using responder email from ticket:", agentEmail);
                            }

                            // Prepare data to pass to the template
                            const dataToPass = {
                                currentTicketId: parsedData.id,
                                isVip: false,
                                districtName: '',
                                requesterEmail: agentEmail,
                                priority: parsedData.priority || 2
                            };

                            // Add product type data if available in the ticket
                            if (parsedData.custom_fields && parsedData.custom_fields.cf_product_type) {
                                dataToPass.productType = parsedData.custom_fields.cf_product_type;
                                console.log(`Found product type in ticket:`, dataToPass.productType);
                            }

                            // Add product and product subsection data if available
                            if (parsedData.custom_fields && parsedData.custom_fields.cf_product) {
                                dataToPass.product = parsedData.custom_fields.cf_product;
                                console.log(`Found product in ticket:`, dataToPass.product);
                            }

                            if (parsedData.custom_fields && parsedData.custom_fields.cf_product_subsection) {
                                dataToPass.productSubsection = parsedData.custom_fields.cf_product_subsection;
                                console.log(`Found product subsection in ticket:`, dataToPass.productSubsection);
                            }

                            console.log("Setting requesterEmail to:", agentEmail);

                            // Process VIP status from custom fields
                            if (parsedData.custom_fields) {
                                const vipFields = ['cf_vip', 'vip', 'cf_vip_status', 'vip_customer', 'cf_vip_client', 'cf_is_vip'];
                                for (const field of vipFields) {
                                    if (parsedData.custom_fields[field] !== undefined) {
                                        const value = parsedData.custom_fields[field];
                                        dataToPass.isVip = (typeof value === 'boolean') ? value :
                                            (typeof value === 'string') ? (value.toLowerCase() === 'yes' || value.toLowerCase() === 'true') :
                                                (typeof value === 'number') ? (value !== 0) : false;
                                        break;
                                    }
                                }
                            }

                            // Get district name from custom fields
                            if (parsedData.custom_fields) {
                                if (parsedData.custom_fields.cf_district509811) {
                                    dataToPass.districtName = parsedData.custom_fields.cf_district509811;
                                    dataToPass.districtDropdownValue = parsedData.custom_fields.cf_district509811;
                                    console.log(`Found district name: ${dataToPass.districtName}`);
                                    console.log(`Set districtDropdownValue to: ${dataToPass.districtDropdownValue}`);
                                } else {
                                    console.log('District field cf_district509811 not found or empty');
                                }
                            }

                            // Handle subject formatting right here in selectTemplate
                            if (parsedData.isVip) {
                                // Force the subject format to include VIP at this point
                                const districtName = parsedData.districtName || '';
                                const formattedSubject = `VIP* ${districtName} | Custom Achievement Levels`;

                                // Store the pre-formatted subject in localStorage
                                dataToPass.formattedSubject = formattedSubject;
                                console.log(`Pre-formatted subject for VIP customer: "${formattedSubject}"`);
                            }

                            // Store the processed data in localStorage
                            localStorage.setItem(`${templateType}Data`, JSON.stringify(dataToPass));
                            console.log(`Stored ${templateType} data in localStorage:`, dataToPass);

                            // Navigate to the dynamic template
                            window.location.href = `dynamic-tracker.html?type=${templateType}`;

                        } catch (error) {
                            console.error("Error processing ticket data:", error);
                            // Default data with at least the email if there's an error
                            const dataToPass = {
                                currentTicketId: null,
                                isVip: false,
                                districtName: '',
                                requesterEmail: agentEmail,
                                priority: 2
                            };
                            localStorage.setItem(`${templateType}Data`, JSON.stringify(dataToPass));
                            window.location.href = `dynamic-tracker.html?type=${templateType}`;
                        }
                    } else {
                        // No ticket data but we still have agent data
                        const dataToPass = {
                            currentTicketId: null,
                            isVip: false,
                            districtName: '',
                            requesterEmail: agentEmail,
                            priority: 2
                        };
                        localStorage.setItem(`${templateType}Data`, JSON.stringify(dataToPass));
                        window.location.href = `dynamic-tracker.html?type=${templateType}`;
                    }
                }).catch(function (error) {
                    console.error("Error getting agent data:", error);
                    // Navigate to template with default data if agent data fails
                    window.location.href = `dynamic-tracker.html?type=${templateType}`;
                });
            }

            // Function to check if the current user has admin permissions
            function checkAdminPermissions() {
                try {
                    client.data.get("loggedInUser").then(function (userData) {
                        console.log("Checking admin permissions:", userData);

                        try {
                            // Check if user is admin - modify these conditions based on your actual admin criteria
                            let isAdmin = false;

                            if (userData && userData.loggedInUser) {
                                console.log("User data structure:", JSON.stringify(userData.loggedInUser));

                                // Check if user has admin role (adjust this based on your actual data structure)
                                if (userData.loggedInUser.role_type === "administrator" ||
                                    (userData.loggedInUser.role && userData.loggedInUser.role.name === "Administrator")) {
                                    isAdmin = true;
                                    console.log("Admin detected by role_type or role.name");
                                }

                                // Check for additional admin roles that might exist in Freshdesk
                                if (!isAdmin && userData.loggedInUser.roles) {
                                    // Check if user has any role containing "admin" in the name
                                    isAdmin = userData.loggedInUser.roles.some(role =>
                                        (role.name && role.name.toLowerCase().includes('admin')) ||
                                        (role.role_type && role.role_type.toLowerCase().includes('admin'))
                                    );
                                    if (isAdmin) console.log("Admin detected by roles array");
                                }

                                // If still not identified as admin, check for specific admin permissions
                                if (!isAdmin && userData.loggedInUser.agent_type === "full_access") {
                                    isAdmin = true;
                                    console.log("Admin detected by agent_type full_access");
                                }

                                // Check for view_admin ability in user abilities
                                if (!isAdmin && Array.isArray(userData.loggedInUser.abilities) &&
                                    userData.loggedInUser.abilities.includes("view_admin")) {
                                    isAdmin = true;
                                    console.log("Admin detected by view_admin ability");
                                }

                                // Admin access based on proper permissions only
                                console.log("Admin access based on proper user permissions");

                                console.log("Final admin determination:", isAdmin);
                            } else {
                                console.warn("loggedInUser data structure is not as expected:", userData);
                            }

                            // Show admin button if user is admin
                            if (isAdmin) {
                                const adminButton = document.getElementById('adminSettingsBtn');
                                if (adminButton) {
                                    adminButton.style.display = 'inline-block';
                                    console.log("Admin button display set to inline-block");
                                } else {
                                    console.warn("Admin button element not found");
                                }
                            }
                        } catch (innerError) {
                            console.error("Error processing user data:", innerError);
                            // Enable admin button as fallback in case of error
                            showAdminButtonAsFallback();
                        }
                    }).catch(function (error) {
                        console.error("Error getting loggedInUser data:", error);
                        // Enable admin button as fallback in case of error
                        showAdminButtonAsFallback();
                    });
                } catch (outerError) {
                    console.error("Critical error in checkAdminPermissions:", outerError);
                    // Enable admin button as fallback in case of error
                    showAdminButtonAsFallback();
                }
            }

            // Helper function to show admin button as fallback during errors
            function showAdminButtonAsFallback() {
                console.log("Error occurred during admin permission check");
                // Don't automatically show admin button on errors
                // This prevents unauthorized access due to errors
                console.log("Admin button remains hidden due to permission check failure");

                // Display a message about the error
                const statusArea = document.getElementById('statusArea');
                if (statusArea) {
                    statusArea.innerHTML = `
                        <div style="padding: 10px; background-color: #fff3e0; color: #e65100; border-radius: 4px; margin: 10px 0;">
                            <p>There was an error checking admin permissions. Please refresh the page or contact support if the issue persists.</p>
                        </div>
                    `;
                    statusArea.style.display = 'block';
                }
            }

            // Handle collapsible sections
            document.addEventListener('DOMContentLoaded', function () {
                // Handle collapsible sections
                const groupHeaders = document.querySelectorAll('.group-header');

                groupHeaders.forEach(header => {
                    header.addEventListener('click', function () {
                        // Toggle the collapsed class on the header
                        this.classList.toggle('collapsed');

                        // Find the associated container and toggle its collapsed class
                        const container = this.nextElementSibling;
                        container.classList.toggle('collapsed');
                    });
                });

                // Handle search functionality
                const searchInput = document.getElementById('templateSearch');

                searchInput.addEventListener('input', function () {
                    const searchTerm = this.value.toLowerCase();
                    const templateItems = document.querySelectorAll('.template-item');
                    const templateGroups = document.querySelectorAll('.template-group');

                    templateItems.forEach(item => {
                        const templateName = item.querySelector('.template-link').textContent.toLowerCase();
                        const templateDesc = item.querySelector('.template-description').textContent.toLowerCase();
                        const isMatch = templateName.includes(searchTerm) || templateDesc.includes(searchTerm);

                        item.style.display = isMatch ? 'block' : 'none';
                    });

                    // Show/hide groups based on whether they have any visible templates
                    templateGroups.forEach(group => {
                        const hasVisibleTemplates = [...group.querySelectorAll('.template-item')].some(item =>
                            item.style.display !== 'none'
                        );

                        group.style.display = hasVisibleTemplates ? 'block' : 'none';

                        // Expand groups with matches
                        if (hasVisibleTemplates && searchTerm) {
                            const header = group.querySelector('.group-header');
                            const container = group.querySelector('.templates-container');

                            header.classList.remove('collapsed');
                            container.classList.remove('collapsed');
                        }
                    });
                });
            });

            // Function to show tracker details modal
            function showTrackerDetails(widgetType = 'today') {
                const modal = document.getElementById('trackerDetailsModal');
                const detailsList = document.getElementById('trackerDetailsList');
                const modalTitleSpan = document.querySelector('#modalTitle span');
                const modalControls = document.getElementById('modalControls');

                if (!modal || !detailsList) {
                    console.error('Modal elements not found');
                    return;
                }

                // Clear existing content
                detailsList.innerHTML = '';

                // Show/hide controls based on widget type
                if (modalControls) {
                    modalControls.style.display = widgetType === 'my' ? 'block' : 'none';
                }

                // Get trackers based on widget type
                let trackers = [];
                let noTrackersMessage = '';

                switch (widgetType) {
                    case 'today':
                        trackers = window.todayTrackers || [];
                        modalTitleSpan.textContent = "Today's Trackers";
                        noTrackersMessage = 'No trackers created today.';
                        break;
                    case 'my':
                        trackers = window.myTrackers || [];
                        modalTitleSpan.textContent = 'My Trackers';
                        noTrackersMessage = 'No unresolved trackers assigned to you.';
                        break;

                }

                // Store original trackers and widget type for filtering/sorting
                window.modalTrackers = trackers;
                window.currentWidgetType = widgetType;

                // Display trackers
                displayTrackers(trackers, widgetType, noTrackersMessage);

                // Set up filter and sort event listeners
                if (widgetType === 'my') {
                    setupFilterAndSort();
                }

                // Show the modal
                modal.style.display = 'flex';
            }

            // Function to display trackers in the modal
            function displayTrackers(trackers, widgetType, noTrackersMessage) {
                const detailsList = document.getElementById('trackerDetailsList');
                detailsList.innerHTML = '';

                if (trackers.length === 0) {
                    detailsList.innerHTML = `<div class="no-trackers">${noTrackersMessage}</div>`;
                } else {
                    // Sort trackers to show tickets that need review first
                    if (widgetType === 'my') {
                        trackers = [...trackers].sort((a, b) => {
                            // Check if tickets need review (status 25 or 15)
                            const aNeedsReview = a.status === 25 || a.status === 15;
                            const bNeedsReview = b.status === 25 || b.status === 15;

                            // If one needs review and the other doesn't, prioritize the one that needs review
                            if (aNeedsReview && !bNeedsReview) return -1;
                            if (!aNeedsReview && bNeedsReview) return 1;

                            // Default sort by created date (newest first) for same review status
                            return new Date(b.created_at) - new Date(a.created_at);
                        });
                    }
                    // For today's trackers, group by template type
                    if (widgetType === 'today') {
                        const trackersByTemplate = {};
                        trackers.forEach(tracker => {
                            if (!trackersByTemplate[tracker.templateType]) {
                                trackersByTemplate[tracker.templateType] = [];
                            }
                            trackersByTemplate[tracker.templateType].push(tracker);
                        });

                        // Get template info for display
                        const templateInfo = getTemplateInfo();

                        // Create sections for each template type
                        Object.entries(trackersByTemplate).forEach(([templateType, templateTrackers]) => {
                            const info = templateInfo[templateType];
                            if (info) {
                                const section = document.createElement('div');
                                section.className = 'tracker-template-section';

                                const sectionHeader = document.createElement('h4');
                                sectionHeader.className = 'tracker-section-header';
                                sectionHeader.innerHTML = `<i class="${info.icon}"></i> ${info.name}`;
                                section.appendChild(sectionHeader);

                                const trackerList = document.createElement('div');
                                trackerList.className = 'tracker-list';

                                templateTrackers.forEach(tracker => {
                                    const trackerItem = createTrackerItem(tracker);
                                    trackerList.appendChild(trackerItem);
                                });

                                section.appendChild(trackerList);
                                detailsList.appendChild(section);
                            }
                        });
                    } else {
                        // For my trackers and backlog, show all in one list
                        const section = document.createElement('div');
                        section.className = 'tracker-template-section';

                        const trackerList = document.createElement('div');
                        trackerList.className = 'tracker-list';

                        trackers.forEach(tracker => {
                            const trackerItem = createTrackerItem(tracker, widgetType === 'my');
                            trackerList.appendChild(trackerItem);
                        });

                        section.appendChild(trackerList);
                        detailsList.appendChild(section);
                    }
                }
            }

            // Function to set up filter and sort event listeners
            function setupFilterAndSort() {
                const statusFilter = document.getElementById('statusFilter');
                const sortBy = document.getElementById('sortBy');

                if (statusFilter) {
                    statusFilter.removeEventListener('change', handleFilterSort);
                    statusFilter.addEventListener('change', handleFilterSort);
                }

                if (sortBy) {
                    sortBy.removeEventListener('change', handleFilterSort);
                    sortBy.addEventListener('change', handleFilterSort);
                }
            }

            // Function to handle filtering and sorting
            function handleFilterSort() {
                const statusFilter = document.getElementById('statusFilter');
                const sortBy = document.getElementById('sortBy');

                let filteredTrackers = [...window.modalTrackers];

                // Apply status filter
                if (statusFilter && statusFilter.value) {
                    filteredTrackers = filteredTrackers.filter(tracker =>
                        tracker.status == statusFilter.value
                    );
                }

                // Apply sorting with priority for tickets that need review
                filteredTrackers.sort((a, b) => {
                    // Check if tickets need review (status 25 or 15)
                    const aNeedsReview = a.status === 25 || a.status === 15;
                    const bNeedsReview = b.status === 25 || b.status === 15;

                    // If one needs review and the other doesn't, prioritize the one that needs review
                    if (aNeedsReview && !bNeedsReview) return -1;
                    if (!aNeedsReview && bNeedsReview) return 1;

                    // If both have the same review status, apply the selected sort criteria
                    if (sortBy && sortBy.value) {
                        switch (sortBy.value) {
                            case 'created_asc':
                                return new Date(a.created_at) - new Date(b.created_at);
                            case 'created_desc':
                                return new Date(b.created_at) - new Date(a.created_at);
                            case 'updated_asc':
                                return new Date(a.updated_at) - new Date(b.updated_at);
                            case 'updated_desc':
                                return new Date(b.updated_at) - new Date(a.updated_at);
                            default:
                                return 0;
                        }
                    }

                    // Default sort by created date (newest first) if no sort is selected
                    return new Date(b.created_at) - new Date(a.created_at);
                });

                // Display filtered and sorted trackers
                displayTrackers(filteredTrackers, window.currentWidgetType,
                    filteredTrackers.length === 0 ? 'No trackers match the selected filters.' : '');
            }

            // Helper function to create tracker item
            function createTrackerItem(tracker, showDetails = false) {
                const trackerItem = document.createElement('div');
                trackerItem.className = 'tracker-item';

                const timestamp = tracker.timestamp ?
                    new Date(tracker.timestamp).toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '';

                const ticketUrl = tracker.id ?
                    `https://techsupport.benchmarkeducation.com/a/tickets/${tracker.id}` :
                    '#';

                // Get status text and class
                const statusInfo = getStatusInfo(tracker.status);

                // Format dates
                const createdDate = tracker.created_at ?
                    new Date(tracker.created_at).toLocaleDateString() : 'N/A';
                const updatedDate = tracker.updated_at ?
                    new Date(tracker.updated_at).toLocaleDateString() : 'N/A';

                // Get district name from custom fields
                const districtName = tracker.custom_fields && tracker.custom_fields.cf_district509811 ?
                    tracker.custom_fields.cf_district509811 : 'N/A';

                // Check if this is a Support Review ticket
                const needsReview = tracker.status === 25 || tracker.status === 15;

                // Add highlighting class if ticket needs review
                if (needsReview) {
                    trackerItem.classList.add('needs-review');
                }

                if (showDetails) {
                    // Detailed view for My Trackers
                    trackerItem.innerHTML = `
                        <div class="tracker-item-header">
                            <div class="tracker-id">
                                <a href="${ticketUrl}" 
                                   target="_blank" 
                                   class="tracker-link">
                                    #${tracker.id || 'N/A'}
                                </a>
                                ${timestamp ? `<span class="tracker-time">${timestamp}</span>` : ''}
                                ${needsReview ? '<span class="tracker-needs-review" title="This ticket needs review"><i class="fas fa-exclamation-circle"></i></span>' : ''}
                            </div>
                            <span class="tracker-status ${statusInfo.className}">${statusInfo.text}</span>
                        </div>
                        <div class="tracker-subject">${tracker.subject || 'No subject'}</div>
                        <div class="tracker-item-details">
                            <div class="tracker-detail">
                                <strong>District:</strong> ${districtName}
                            </div>
                            <div class="tracker-detail">
                                <strong>Created:</strong> ${createdDate}
                            </div>
                            <div class="tracker-detail">
                                <strong>Updated:</strong> ${updatedDate}
                            </div>
                        </div>
                    `;
                } else {
                    // Simple view for other widgets
                    trackerItem.innerHTML = `
                        <div class="tracker-id">
                            <a href="${ticketUrl}" 
                               target="_blank" 
                               class="tracker-link">
                                #${tracker.id || 'N/A'}
                            </a>
                            ${timestamp ? `<span class="tracker-time">${timestamp}</span>` : ''}
                            ${needsReview && window.currentWidgetType === 'my' ? '<span class="tracker-needs-review" title="This ticket needs review"><i class="fas fa-exclamation-circle"></i></span>' : ''}
                        </div>
                        <div class="tracker-subject">${tracker.subject || 'No subject'}</div>
                    `;
                }

                return trackerItem;
            }

            // Helper function to get status info
            function getStatusInfo(statusId) {
                const statusMap = {
                    2: { text: 'Open', className: 'status-open' },
                    3: { text: 'Pending', className: 'status-pending' },
                    4: { text: 'Resolved', className: 'status-other' },
                    5: { text: 'Closed', className: 'status-other' },
                    6: { text: 'Waiting on Customer', className: 'status-waiting' },
                    8: { text: 'Escalated', className: 'status-escalated' },
                    9: { text: 'Dev in Progress', className: 'status-in-progress' },
                    10: { text: 'Waiting on Support', className: 'status-waiting' },
                    11: { text: 'Resubmitted', className: 'status-in-progress' },
                    14: { text: 'Editorial in Progress', className: 'status-in-progress' },
                    15: { text: 'Closed in JIRA', className: 'status-pending' },
                    22: { text: 'Created in JIRA', className: 'status-escalated' },
                    23: { text: 'Follow-up Required', className: 'status-pending' },
                    25: { text: 'Support Review', className: 'status-pending' },
                    26: { text: 'On Hold', className: 'status-waiting' },
                    27: { text: 'Backlog', className: 'status-other' },
                    28: { text: 'Closed - No Resolution', className: 'status-other' },
                    29: { text: 'Triage', className: 'status-pending' },
                    30: { text: 'Pending Jira', className: 'status-pending' },
                    33: { text: 'Bookings Meeting', className: 'status-pending' },
                    36: { text: 'Awaiting Internal Review', className: 'status-pending' },
                    37: { text: 'Support Ops Review', className: 'status-pending' }
                };

                return statusMap[statusId] || { text: 'Unknown', className: 'status-other' };
            }

            // Function to close tracker details modal
            function closeTrackerDetails() {
                const modal = document.getElementById('trackerDetailsModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            // Set up event listeners for View All and modal close
            document.addEventListener('DOMContentLoaded', function () {
                const viewAllBtn = document.getElementById('viewAllTrackersBtn');
                const viewMyTrackersBtn = document.getElementById('viewMyTrackersBtn');

                const closeModalBtn = document.getElementById('closeTrackerModal');
                const modal = document.getElementById('trackerDetailsModal');

                if (viewAllBtn) {
                    viewAllBtn.addEventListener('click', () => showTrackerDetails('today'));
                }

                if (viewMyTrackersBtn) {
                    viewMyTrackersBtn.addEventListener('click', () => showTrackerDetails('my'));
                }



                if (closeModalBtn) {
                    closeModalBtn.addEventListener('click', closeTrackerDetails);
                }

                // Close modal when clicking outside
                if (modal) {
                    modal.addEventListener('click', function (e) {
                        if (e.target === modal) {
                            closeTrackerDetails();
                        }
                    });
                }

                // Widget Settings Modal Handlers
                const mainWidgetSettingsBtn = document.getElementById('mainWidgetSettingsBtn');
                const widgetSettingsModal = document.getElementById('widgetSettingsModal');
                const widgetOptions = document.querySelectorAll('.widget-option');
                const saveWidgetSettingsBtn = document.getElementById('saveWidgetSettings');
                const cancelWidgetSettingsBtn = document.getElementById('cancelWidgetSettings');
                const simpleViewAllBtn = document.getElementById('simpleViewAllBtn');

                // Open widget settings modal
                function openWidgetSettings() {
                    if (widgetSettingsModal) {
                        widgetSettingsModal.style.display = 'flex';

                        // Set current preference as selected
                        const currentPreference = getWidgetPreference();
                        widgetOptions.forEach(option => {
                            const optionType = option.getAttribute('data-option');
                            option.classList.toggle('selected', optionType === currentPreference);
                        });
                    }
                }

                // Close widget settings modal
                function closeWidgetSettings() {
                    if (widgetSettingsModal) {
                        widgetSettingsModal.style.display = 'none';
                    }
                }

                // Widget settings button clicks - now toggles directly
                if (mainWidgetSettingsBtn) {
                    mainWidgetSettingsBtn.addEventListener('click', function () {
                        // Get current preference
                        const currentPreference = getWidgetPreference();
                        // Toggle to opposite preference
                        const newPreference = currentPreference === 'carousel' ? 'classic' : 'carousel';
                        // Save new preference
                        setWidgetPreference(newPreference);
                        // Reload page to apply changes
                        window.location.reload();
                    });
                }

                // Widget option selection
                widgetOptions.forEach(option => {
                    option.addEventListener('click', function () {
                        // Remove selected class from all options
                        widgetOptions.forEach(opt => opt.classList.remove('selected'));
                        // Add selected class to clicked option
                        this.classList.add('selected');
                    });
                });

                // Save widget settings
                if (saveWidgetSettingsBtn) {
                    saveWidgetSettingsBtn.addEventListener('click', function () {
                        const selectedOption = document.querySelector('.widget-option.selected');
                        if (selectedOption) {
                            const preference = selectedOption.getAttribute('data-option');
                            setWidgetPreference(preference);
                            closeWidgetSettings();

                            // Reload the page to apply new preference
                            window.location.reload();
                        }
                    });
                }

                // Cancel widget settings
                if (cancelWidgetSettingsBtn) {
                    cancelWidgetSettingsBtn.addEventListener('click', closeWidgetSettings);
                }

                // Close modal when clicking outside
                if (widgetSettingsModal) {
                    widgetSettingsModal.addEventListener('click', function (e) {
                        if (e.target === widgetSettingsModal) {
                            closeWidgetSettings();
                        }
                    });
                }

                // Simple widget View All button
                if (simpleViewAllBtn) {
                    simpleViewAllBtn.addEventListener('click', () => showTrackerDetails('today'));
                }
            });
        </script>
    </div>
    <div
        style="display: flex; justify-content: center; margin: 20px 0; border-top: 1px solid #e0e0e0; padding-top: 20px;">
        <a href="https://benchmarkeducation.freshstatus.io" id="freshstatus-badge-root" data-banner-style="highlighted">
            <img
                src="https://public-api.freshstatus.io/v1/public/badge.svg/?badge=12d6fa47-c8f2-4305-b002-9314f34695f8" />
        </a>
    </div>
    <!-- Freshdesk Status Widget Script -->
    <script type="module" src="https://cdn.freshstatus.io/widget/index.js"></script>
</body>

</html>