<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script async src="{{{appclient}}}"></script>
    <link rel="stylesheet" type="text/css" href="styles/style.css" />
    <link rel="stylesheet" type="text/css" href="styles/template-selector.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>Freshdesk Tracker Templates</title>
    <style>
        /* Add these styles in the head section */
        .navbar-item {
            transition: all 0.3s ease;
            border-radius: 4px;
            padding: 8px 12px;
        }

        .navbar-item i {
            color: inherit;
            margin-right: 8px;
        }

        .navbar-item:hover {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Dark mode hover styles */
        [data-theme="dark"] .navbar-item:hover {
            background-color: #2d2d2d;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        [data-theme="light"] .navbar-item,
        [data-theme="light"] .navbar-item i,
        [data-theme="light"] .navbar-item span {
            color: #000 !important;
        }

        #themeToggleBtn .fa-sun {
            color: #FFD600 !important;
        }

        #themeToggleBtn .fa-moon {
            color: #12344D !important;
        }

        #themeToggleBtn .dark-mode-text {
            color: #12344D !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- New Navbar -->
        <nav class="navbar">
            <div class="navbar-container">
                <div class="navbar-brand">
                    <h1 class="navbar-title">Tracker Central</h1>
                </div>
                <button class="navbar-toggle" id="navbarToggle">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
                <div class="navbar-menu" id="navbarMenu">
                    <a href="admin-settings.html" id="adminSettingsBtn" class="navbar-item" title="Admin Settings"
                        style="display: none;">
                        <i class="fas fa-sliders-h"></i>
                        <span>Admin Settings</span>
                    </a>
                    <button id="themeToggleBtn" class="navbar-item theme-toggle" title="Toggle Dark Mode">
                        <i class="fas fa-sun"></i>
                        <span>Light Mode</span>
                    </button>
                </div>
            </div>
        </nav> <!-- DAILY TRACKER COUNTS DASHBOARD -->
        <div id="trackerCountsDashboard" class="tracker-counts-dashboard" style="display: none;">
            <div class="dashboard-header">
                <div class="dashboard-title-row">
                    <h3><i class="fas fa-chart-bar"></i> Today's Trackers <span id="trackerTotalCount"
                            class="dashboard-count"></span></h3>
                    <div class="dashboard-actions">
                        <button class="view-all-btn" id="viewAllTrackersBtn" title="View all trackers">
                            <i class="fas fa-list"></i> View All
                        </button>
                    </div>
                </div>
                <span id="dashboardDate" class="dashboard-date"></span>
            </div>
        </div>

        <!-- TRACKER DETAILS MODAL -->
        <div id="trackerDetailsModal" class="tracker-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-list"></i> Today's Trackers</h3>
                    <button class="modal-close" id="closeTrackerModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="trackerDetailsList" class="tracker-details-list">
                        <!-- Tracker details will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MY DRAFTS SECTION -->
        <div id="myDraftsSection" class="my-drafts-section" style="display: none;">
            <div class="drafts-header">
                <div class="drafts-title-row">
                    <h2><i class="fas fa-save"></i> My Drafts <span id="draftsTotalCount"
                            class="dashboard-count"></span></h2>
                    <button class="drafts-toggle" id="draftsToggle" title="Collapse/Expand">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
            </div>
            <div id="draftsContent" class="drafts-content">
                <div id="draftsList" class="drafts-list">
                    <!-- Drafts will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Search Container -->
        <div class="search-container"> <i class="fas fa-search search-icon"></i> <input type="text" id="templateSearch"
                class="search-input" placeholder="Search templates..."> </div>
        <!-- Status area for displaying messages -->
        <div id="statusArea" style="display: none;"></div>
        <div class="template-groups">
            <!-- SEDCUST (CONTENT/EDITORIAL) GROUP -->
            <div class="template-group">
                <div class="group-header collapsed">
                    <h2><i class="fas fa-book"></i> SEDCUST (CONTENT/EDITORIAL) <span class="template-count">1</span>
                    </h2>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="templates-container collapsed">
                    <div class="template-list">
                        <div class="template-item" data-template="sedcust">
                            <a href="#" class="template-link">
                                <i class="fas fa-file-alt"></i> SEDCUST (CONTENT/EDITORIAL)

                            </a>
                            <div class="template-description">
                                <div class="issue-types">
                                    For issues regarding content errors, broken links, and other editorial concerns
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="group-description">

                    Open a tracker for the SEDCUST Team

                </div>
            </div>

            <!-- ASSEMBLY GROUP -->
            <div class="template-group">
                <div class="group-header collapsed">
                    <h2><i class="fas fa-tools"></i> ASSEMBLY <span class="template-count">2</span></h2>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="templates-container collapsed">
                    <div class="template-list">
                        <div class="template-item" data-template="assembly">
                            <a href="#" class="template-link">
                                <i class="fas fa-puzzle-piece"></i> ASSEMBLY

                            </a>
                            <div class="template-description">
                                For issues regarding missing content or resource availability in the district's
                                subscribed version </div>
                        </div>
                        <div class="template-item" data-template="assembly-rollover">
                            <a href="#" class="template-link">
                                <i class="fas fa-sync-alt"></i> ROLLOVER

                            </a>
                            <div class="template-description">
                                For requests regarding removing legacy assembly codes from a district. </div>
                        </div>
                    </div>
                </div>
                <div class="group-description">
                    Open a tracker for the Assembly Team
                </div>
            </div>

            <!-- SIM TRACKERS GROUP -->
            <div class="template-group">
                <div class="group-header collapsed">
                    <h2><i class="fa-solid fa-users-gear"></i> SIM <span class="template-count">9</span></h2>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="templates-container collapsed">
                    <div class="template-list">
                        <div class="template-item" data-template="sim-assignment">
                            <a href="#" class="template-link">
                                <i class="fas fa-tasks"></i> ASSIGNMENT/eASSESSMENT

                            </a>
                            <div class="template-description">
                                For issues regarding assignment and/or eAssessment functionality
                            </div>
                        </div>
                        <div class="template-item" data-template="sim-assessment-reports">
                            <a href="#" class="template-link">
                                <i class="fas fa-chart-bar"></i> REPORTS

                            </a>
                            <div class="template-description">
                                For issues regarding functionality of assessment reports</div>
                        </div>
                        <div class="template-item" data-template="sim-achievement-levels">
                            <a href="#" class="template-link">
                                <i class="fas fa-trophy"></i> ACHIEVEMENT LEVELS

                            </a>
                            <div class="template-description">
                                For districts who would like custom achievement levels to display in reports
                            </div>
                        </div>
                        <div class="template-item" data-template="sim-fsa">
                            <a href="#" class="template-link">
                                <i class="fas fa-check-circle"></i> FSA

                            </a>
                            <div class="template-description">
                                For issues regarding functionality of foundational skills assessment </div>
                        </div>
                        <div class="template-item" data-template="sim-library-view">
                            <a href="#" class="template-link">
                                <i class="fas fa-book-open"></i> LIBRARY VIEW

                            </a>
                            <div class="template-description">
                                For issues regarding functionality in the resource library </div>
                        </div>
                        <div class="template-item" data-template="sim-orr">
                            <a href="#" class="template-link">
                                <i class="fas fa-file-signature"></i> ORR

                            </a>
                            <div class="template-description">
                                For issues regarding functionality of oral reading records (ORR) </div>
                        </div>
                        <div class="template-item" data-template="sim-plan-teach">
                            <a href="#" class="template-link">
                                <i class="fas fa-chalkboard-teacher"></i> PLAN & TEACH

                            </a>
                            <div class="template-description">
                                For issues regarding the functionality of the Plan & Teach Tool
                            </div>
                        </div>
                        <div class="template-item" data-template="sim-reading-log">
                            <a href="#" class="template-link">
                                <i class="fas fa-book-reader"></i> READING LOG

                            </a>
                            <div class="template-description">
                                For issues regarding functionality of foundational skills assessment
                            </div>
                        </div>
                        <div class="template-item" data-template="sim-dashboard">
                            <a href="#" class="template-link">
                                <i class="fas fa-tachometer-alt"></i> DASHBOARD

                            </a>
                            <div class="template-description">
                                For issues regarding functionality of the dashboard
                            </div>
                        </div>
                    </div>
                </div>
                <div class="group-description">
                    Open a tracker for the SIM Team
                </div>
            </div>

            <!-- OTHER TEMPLATE GROUP -->
            <div class="template-group">
                <div class="group-header collapsed">
                    <h2><i class="fas fa-layer-group"></i> OTHER TEMPLATES <span class="template-count">4</span></h2>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="templates-container collapsed">
                    <div class="template-list">
                        <div class="template-item" data-template="dpt">
                            <a href="#" class="template-link">
                                <i class="fas fa-file-alt"></i> DPT (CUSTOMIZED eASSESSMENT)

                            </a>
                            <div class="template-description">
                                For requests to add districts to the District Preference Table for customized
                                eAssessments
                            </div>
                        </div>
                        <div class="template-item" data-template="feature-request">
                            <a href="#" class="template-link">
                                <i class="fas fa-lightbulb"></i> FEATURE REQUEST

                            </a>
                            <div class="template-description">
                                For requests regarding new functionality within Benchmark Universe
                            </div>
                        </div>
                        <div class="template-item" data-template="help-article">
                            <a href="#" class="template-link">
                                <i class="fas fa-question-circle"></i> HELP ARTICLE

                            </a>
                            <div class="template-description">
                                For issues regarding BU Help Articles
                            </div>
                        </div>
                        <div class="template-item" data-template="timeout-extension">
                            <a href="#" class="template-link">
                                <i class="fas fa-hourglass-half"></i> TIMEOUT EXTENSION

                            </a>
                            <div class="template-description">
                                For districts who would like an extended time out setting.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="group-description">
                    Additional specialized templates for feature requests, help articles and more.
                </div>
            </div>
        </div>

        <script>
            document.onreadystatechange = function () {
                if (document.readyState === 'complete') renderApp();

                function renderApp() {
                    const onInit = app.initialized();

                    onInit.then(function (_client) {
                        window.client = _client;
                        console.log("Template selector initialized successfully");

                        // Initialize dark mode
                        initTheme();

                        // Initialize navbar
                        initNavbar();

                        // Initialize drafts toggle
                        initDraftsToggle();

                        // Get current ticket details
                        client.data.get("ticket").then(function (ticketData) {
                            console.log("Retrieved ticket data:", ticketData);

                            // Store ticket data for templates to use
                            if (ticketData && ticketData.ticket) {
                                localStorage.setItem('ticketData', JSON.stringify(ticketData.ticket));
                            }

                            // Check if user is admin and show admin settings button if they are
                            checkAdminPermissions();

                            setupTemplateHandlers();
                            initializeDrafts();
                            loadAndDisplayTrackerCounts();

                        }).catch(function (error) {
                            console.error("Error getting ticket data:", error);
                            // Still set up click handlers even if ticket data fails
                            checkAdminPermissions();
                            setupTemplateHandlers();
                            initializeDrafts();
                        });
                    }).catch(function (error) {
                        console.error("Error initializing app:", error);
                        document.body.innerHTML = `
                            <div style="padding: 20px; background-color: #ffebee; color: #c62828; border-radius: 4px; margin: 10px;">
                                <h3>Initialization Error</h3>
                                <p>Failed to initialize template selector.</p>
                                <p>Error: ${error.message || "Unknown error"}</p>
                            </div>
                        `;
                    });
                }
            };

            // Initialize navbar functionality
            function initNavbar() {
                const navbarToggle = document.getElementById('navbarToggle');
                const navbarMenu = document.getElementById('navbarMenu');

                if (navbarToggle && navbarMenu) {
                    navbarToggle.addEventListener('click', function () {
                        navbarMenu.classList.toggle('active');
                        navbarToggle.classList.toggle('active');
                    });

                    // Close menu when clicking outside
                    document.addEventListener('click', function (event) {
                        if (!navbarToggle.contains(event.target) && !navbarMenu.contains(event.target)) {
                            navbarMenu.classList.remove('active');
                            navbarToggle.classList.remove('active');
                        }
                    });
                }
            }

            // Initialize drafts toggle functionality
            function initDraftsToggle() {
                const draftsToggle = document.getElementById('draftsToggle');
                const draftsContent = document.getElementById('draftsContent');
                const draftsSection = document.getElementById('myDraftsSection');

                if (draftsToggle && draftsContent && draftsSection) {
                    draftsToggle.addEventListener('click', function () {
                        const isCollapsed = draftsSection.classList.contains('collapsed');

                        if (isCollapsed) {
                            draftsSection.classList.remove('collapsed');
                            draftsToggle.innerHTML = '<i class="fas fa-chevron-down"></i>';
                            draftsToggle.title = 'Collapse';
                        } else {
                            draftsSection.classList.add('collapsed');
                            draftsToggle.innerHTML = '<i class="fas fa-chevron-down"></i>';
                            draftsToggle.title = 'Expand';
                        }
                    });
                }
            }

            // Initialize dark mode based on saved preference
            function initTheme() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
                updateThemeIcon(savedTheme);

                // Add event listener for theme toggle
                const themeToggleBtn = document.getElementById('themeToggleBtn');
                if (themeToggleBtn) {
                    themeToggleBtn.addEventListener('click', toggleTheme);
                }
            }

            // Toggle between light and dark mode
            function toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);

                updateThemeIcon(newTheme);
                console.log(`Theme switched to ${newTheme} mode`);
            }

            // Update the theme toggle icon based on current theme
            function updateThemeIcon(theme) {
                const themeToggleBtn = document.getElementById('themeToggleBtn');
                if (themeToggleBtn) {
                    const icon = themeToggleBtn.querySelector('i');
                    const text = themeToggleBtn.querySelector('span');

                    if (theme === 'dark') {
                        icon.className = 'fas fa-sun';
                        text.textContent = 'Light Mode';
                        text.classList.remove('dark-mode-text');
                        themeToggleBtn.title = 'Switch to Light Mode';
                    } else {
                        icon.className = 'fas fa-moon';
                        text.textContent = 'Dark Mode';
                        text.classList.add('dark-mode-text');
                        themeToggleBtn.title = 'Switch to Dark Mode';
                    }
                }
            }

            // Function to set up handlers without ticket data
            function setupTemplateHandlers() {
                // Add click handlers to both the template item div and the anchor tag
                const templateItems = document.querySelectorAll('.template-item');
                templateItems.forEach(item => {
                    // Get the template type from the data attribute
                    const templateType = item.getAttribute('data-template');

                    // Get the link within this item
                    const link = item.querySelector('a.template-link');

                    // Add click handler to the entire item div
                    item.addEventListener('click', function (e) {
                        // Don't trigger if clicking on the link itself (let the link handle that)
                        if (e.target === link || link.contains(e.target)) {
                            return;
                        }
                        e.preventDefault();
                        console.log(`Div clicked for template: ${templateType}`);
                        if (templateType) {
                            selectTemplate(templateType);
                        } else {
                            console.warn("No template type found for clicked item");
                        }
                    });

                    // Also store the template type on the link for direct clicks
                    if (link) {
                        link.setAttribute('data-template-type', templateType);

                        // Add click handler to prevent default and use our navigation
                        link.addEventListener('click', function (e) {
                            e.preventDefault();
                            const linkTemplateType = this.getAttribute('data-template-type');
                            console.log(`Link clicked for template: ${linkTemplateType}`);
                            if (linkTemplateType) {
                                selectTemplate(linkTemplateType);
                            } else {
                                console.warn("No template type found for clicked link");
                            }
                        });
                    }
                });
            }

            // Draft Management Functions
            function initializeDrafts() {
                console.log("Initializing drafts system");
                loadAndDisplayDrafts();
                setupDraftEventHandlers();
            }

            function loadAndDisplayDrafts() {
                const myDraftsSection = document.getElementById('myDraftsSection');
                const draftsList = document.getElementById('draftsList');
                const draftsTotalCount = document.getElementById('draftsTotalCount');

                if (!myDraftsSection || !draftsList) {
                    console.warn("Draft elements not found");
                    return;
                }

                try {
                    // Load tracker config first
                    const script = document.createElement('script');
                    script.src = 'tracker-config.js';
                    script.onload = () => {
                        // Now we can access the DraftManager
                        if (window.draftManager) {
                            const drafts = window.draftManager.getDraftsArray();
                            console.log(`Found ${drafts.length} drafts`);

                            if (drafts.length === 0) {
                                myDraftsSection.style.display = 'none';
                                return;
                            }

                            // Show drafts section
                            myDraftsSection.style.display = 'block';

                            // Update the count badge
                            if (draftsTotalCount) {
                                draftsTotalCount.textContent = drafts.length;
                            }

                            // Default to collapsed if there are drafts (but you can change this)
                            // Since there are drafts, we'll leave it expanded by default
                            // If you want it collapsed by default even with drafts, uncomment the next lines:
                            // myDraftsSection.classList.add('collapsed');
                            // document.getElementById('draftsToggle').innerHTML = '<i class="fas fa-chevron-right"></i>';

                            // Populate drafts list
                            draftsList.innerHTML = '';
                            drafts.forEach(draft => {
                                const draftElement = createDraftElement(draft);
                                draftsList.appendChild(draftElement);
                            });
                        }
                    };
                    document.head.appendChild(script);
                } catch (error) {
                    console.error('Error loading drafts:', error);
                }
            }

            function createDraftElement(draft) {
                const draftDiv = document.createElement('div');
                draftDiv.className = 'draft-item';
                draftDiv.setAttribute('data-draft-id', draft.id);

                // Get template config for display name
                const templateTitle = getTemplateDisplayName(draft.templateType);
                const formattedDate = new Date(draft.updatedAt).toLocaleDateString();
                const formattedTime = new Date(draft.updatedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                draftDiv.innerHTML = `
                    <div class="draft-header">
                        <div class="draft-info">
                            <div class="draft-name">${draft.name}</div>
                            <div class="draft-meta">
                                <span class="draft-template">${templateTitle}</span>
                                <span class="draft-date">Saved: ${formattedDate} at ${formattedTime}</span>
                            </div>
                        </div>
                        <div class="draft-actions">
                            <button class="draft-continue-btn" onclick="loadDraft('${draft.id}')" title="Continue editing">
                                <i class="fas fa-edit"></i> Continue
                            </button>
                            <button class="draft-delete-btn" onclick="deleteDraft('${draft.id}')" title="Delete draft">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;

                return draftDiv;
            }

            function getTemplateDisplayName(templateType) {
                const templateNames = {
                    'assembly': 'Assembly Tracker',
                    'assembly-rollover': 'Assembly Rollover',
                    'sedcust': 'SEDCUST (Content/Editorial)',
                    'feature-request': 'Feature Request',
                    'sim-assignment': 'SIM Assignment',
                    'sim-assessment-reports': 'SIM Assessment Reports',
                    'sim-achievement-levels': 'SIM Achievement Levels',
                    'sim-fsa': 'SIM FSA',
                    'sim-library-view': 'SIM Library View',
                    'sim-orr': 'SIM ORR',
                    'sim-plan-teach': 'SIM Plan & Teach',
                    'sim-reading-log': 'SIM Reading Log',
                    'sim-dashboard': 'SIM Dashboard',
                    'dpt': 'DPT (Customized eAssessment)',
                    'timeout-extension': 'Timeout Extension',
                    'help-article': 'Help Article'
                };
                return templateNames[templateType] || templateType;
            }

            function setupDraftEventHandlers() {
                // No additional event handlers needed currently
            }

            function loadDraft(draftId) {
                console.log(`Loading draft: ${draftId}`);
                try {
                    if (window.draftManager) {
                        const draft = window.draftManager.getDraft(draftId);
                        if (!draft) {
                            console.error('Draft not found');
                            if (window.client) {
                                client.interface.trigger("showNotify", {
                                    type: "danger",
                                    message: "Draft not found"
                                });
                            }
                            return;
                        }

                        // Store the draft info for later use
                        localStorage.setItem('loadingDraft', JSON.stringify({
                            draftId: draftId,
                            formData: draft.formData
                        }));

                        // Navigate to the tracker form with the correct template type
                        localStorage.setItem('selectedTemplate', draft.templateType);
                        window.location.href = `dynamic-tracker.html?type=${draft.templateType}`;
                    } else {
                        console.error('Draft system not available');
                        if (window.client) {
                            client.interface.trigger("showNotify", {
                                type: "danger",
                                message: "Draft system not available"
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error loading draft:', error);
                    if (window.client) {
                        client.interface.trigger("showNotify", {
                            type: "danger",
                            message: "Failed to load draft. Please try again."
                        });
                    }
                }
            }

            function deleteDraft(draftId) {
                console.log(`Deleting draft: ${draftId}`);
                if (!confirm('Are you sure you want to delete this draft?')) {
                    return;
                }

                try {
                    if (window.draftManager) {
                        const success = window.draftManager.deleteDraft(draftId);
                        if (success) {
                            // Remove the draft element from DOM
                            const draftElement = document.querySelector(`[data-draft-id="${draftId}"]`);
                            if (draftElement) {
                                draftElement.remove();
                            }

                            // Check if we need to hide the drafts section
                            const remainingDrafts = document.querySelectorAll('.draft-item');
                            if (remainingDrafts.length === 0) {
                                const myDraftsSection = document.getElementById('myDraftsSection');
                                if (myDraftsSection) {
                                    myDraftsSection.style.display = 'none';
                                }
                            } else {
                                // Update the count badge
                                const draftsTotalCount = document.getElementById('draftsTotalCount');
                                if (draftsTotalCount) {
                                    draftsTotalCount.textContent = remainingDrafts.length;
                                }
                            }

                            console.log('Draft deleted successfully');
                        } else {
                            console.error('Failed to delete draft');
                            if (window.client) {
                                client.interface.trigger("showNotify", {
                                    type: "danger",
                                    message: "Failed to delete draft"
                                });
                            }
                        }
                    } else {
                        console.error('Draft system not available');
                        if (window.client) {
                            client.interface.trigger("showNotify", {
                                type: "danger",
                                message: "Draft system not available"
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error deleting draft:', error);
                    if (window.client) {
                        client.interface.trigger("showNotify", {
                            type: "danger",
                            message: "Failed to delete draft. Please try again."
                        });
                    }
                }
            }

            // Make functions globally accessible
            window.loadDraft = loadDraft;
            window.deleteDraft = deleteDraft;

            // Daily Tracker Counts Functions
            function loadAndDisplayTrackerCounts() {
                console.log("Loading daily tracker counts");

                if (!window.client) {
                    console.warn("Client not available for loading tracker counts");
                    return;
                }

                const today = getTodayDateString();
                const storageKey = `tracker-details-${today}`;

                // Load today's tracker details from Freshdesk storage
                client.db.get(storageKey)
                    .then(function (data) {
                        console.log(`Loaded tracker details for ${today}:`, data);
                        const trackers = data?.trackers || [];
                        displayTrackerCounts(trackers, today);
                    })
                    .catch(function (error) {
                        console.log(`No tracker details found for ${today} (this is normal if no trackers created today):`, error);
                        displayTrackerCounts([], today);
                    });
            }

            function displayTrackerCounts(trackers, date) {
                const dashboard = document.getElementById('trackerCountsDashboard');
                const dateElement = document.getElementById('dashboardDate');
                const trackerTotalCount = document.getElementById('trackerTotalCount');
                const viewAllBtn = document.getElementById('viewAllTrackersBtn');

                if (!dashboard || !dateElement) {
                    console.warn("Dashboard elements not found");
                    return;
                }

                // Store trackers globally for the View All functionality
                window.todayTrackers = trackers;

                // Set the date
                const formattedDate = new Date(date).toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                dateElement.textContent = formattedDate;

                // Calculate total count
                const totalCount = trackers.length;

                // Update the count badge
                if (trackerTotalCount) {
                    trackerTotalCount.textContent = totalCount;
                }

                // Show/hide View All button based on whether there are trackers
                if (viewAllBtn) {
                    viewAllBtn.style.display = totalCount > 0 ? 'inline-flex' : 'none';
                }

                // Show the dashboard
                dashboard.style.display = 'block';
            }

            function getTemplateInfo() {
                return {
                    'assembly': { name: 'Assembly', icon: 'fas fa-puzzle-piece' },
                    'assembly-rollover': { name: 'Rollover', icon: 'fas fa-sync-alt' },
                    'sedcust': { name: 'SEDCUST', icon: 'fas fa-book' },
                    'sim-assignment': { name: 'SIM Assignment', icon: 'fas fa-tasks' },
                    'sim-assessment-reports': { name: 'SIM Reports', icon: 'fas fa-chart-bar' },
                    'sim-achievement-levels': { name: 'SIM Achievement', icon: 'fas fa-trophy' },
                    'sim-fsa': { name: 'SIM FSA', icon: 'fas fa-check-circle' },
                    'sim-library-view': { name: 'SIM Library', icon: 'fas fa-book-open' },
                    'sim-orr': { name: 'SIM ORR', icon: 'fas fa-file-signature' },
                    'sim-plan-teach': { name: 'SIM Plan & Teach', icon: 'fas fa-chalkboard-teacher' },
                    'sim-reading-log': { name: 'SIM Reading Log', icon: 'fas fa-book-reader' },
                    'sim-dashboard': { name: 'SIM Dashboard', icon: 'fas fa-tachometer-alt' },
                    'dpt': { name: 'DPT', icon: 'fas fa-file-alt' },
                    'feature-request': { name: 'Feature Request', icon: 'fas fa-lightbulb' },
                    'help-article': { name: 'Help Article', icon: 'fas fa-question-circle' },
                    'timeout-extension': { name: 'Timeout Extension', icon: 'fas fa-hourglass-half' }
                };
            }

            function getTodayDateString() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // Function to increment tracker count (called from dynamic tracker)
            function incrementTrackerCount(templateType, trackerId, subject) {
                console.log(`Adding tracker details for template: ${templateType}, ID: ${trackerId}, Subject: ${subject}`);

                if (!window.client) {
                    console.warn("Client not available for storing tracker details");
                    return;
                }

                const today = getTodayDateString();
                const storageKey = `tracker-details-${today}`;

                // Get current tracker details
                client.db.get(storageKey)
                    .then(function (data) {
                        const currentData = data || { trackers: [] };
                        const trackers = currentData.trackers || [];

                        // Add new tracker details
                        trackers.push({
                            id: trackerId,
                            subject: subject,
                            templateType: templateType,
                            timestamp: new Date().toISOString()
                        });

                        console.log(`Updated tracker details for ${today}:`, trackers);

                        // Save back to storage
                        return client.db.set(storageKey, { trackers: trackers });
                    })
                    .catch(function (error) {
                        // Handle 404 error when no record exists yet (first tracker of the day)
                        if (error.status === 404) {
                            console.log(`No existing record for ${today}, creating new one`);
                            const newData = {
                                trackers: [{
                                    id: trackerId,
                                    subject: subject,
                                    templateType: templateType,
                                    timestamp: new Date().toISOString()
                                }]
                            };

                            console.log(`Creating new tracker details record:`, newData);

                            // Create new record
                            return client.db.set(storageKey, newData);
                        } else {
                            // Re-throw other errors
                            throw error;
                        }
                    })
                    .then(function () {
                        console.log(`Successfully stored tracker details for ${templateType}`);
                    })
                    .catch(function (error) {
                        console.error(`Error storing tracker details:`, error);
                    });
            }

            // Make increment function globally accessible
            window.incrementTrackerCount = incrementTrackerCount;

            // Manual test function for debugging
            function testTrackerCount() {
                console.log("[DEBUG] Testing tracker count functionality");
                incrementTrackerCount('sedcust', '12345', 'Test District | SEDCUST Content Issue');
                setTimeout(() => {
                    loadAndDisplayTrackerCounts();
                }, 1000);
            }

            // Make test function globally accessible
            window.testTrackerCount = testTrackerCount;

            // Function to select a template and navigate to the dynamic template
            function selectTemplate(templateType) {
                console.log(`Selected template: ${templateType}`);

                // Clear any loading draft data since this is a fresh template selection
                localStorage.removeItem('loadingDraft');

                // First get current agent information
                client.data.get("loggedInUser").then(function (userData) {
                    console.log("Retrieved agent data:", userData);

                    // The email may be in different locations based on the Freshdesk API response
                    let agentEmail = '';
                    if (userData && userData.loggedInUser) {
                        // Try different possible locations for the email
                        if (userData.loggedInUser.email) {
                            agentEmail = userData.loggedInUser.email;
                        } else if (userData.loggedInUser.contact && userData.loggedInUser.contact.email) {
                            agentEmail = userData.loggedInUser.contact.email;
                        } else if (userData.loggedInUser.primary_email) {
                            agentEmail = userData.loggedInUser.primary_email;
                        }

                        // If we still don't have it, try to find it in the full object
                        if (!agentEmail) {
                            // Log the full structure for debugging
                            console.log("Full loggedInUser structure:", JSON.stringify(userData.loggedInUser));

                            // Use user in email field if available
                            if (userData.loggedInUser.user && userData.loggedInUser.user.email) {
                                agentEmail = userData.loggedInUser.user.email;
                            }
                        }
                    }

                    console.log("Extracted agent email:", agentEmail);

                    // Get stored ticket data
                    const ticketData = localStorage.getItem('ticketData');

                    if (ticketData) {
                        try {
                            const parsedData = JSON.parse(ticketData);
                            console.log(`Processing ticket data for ${templateType}:`, parsedData);

                            // Try to get the agent email from the ticket data if not found above
                            if (!agentEmail && parsedData.responder && parsedData.responder.email) {
                                agentEmail = parsedData.responder.email;
                                console.log("Using responder email from ticket:", agentEmail);
                            }

                            // Prepare data to pass to the template
                            const dataToPass = {
                                currentTicketId: parsedData.id,
                                isVip: false,
                                districtName: '',
                                requesterEmail: agentEmail,
                                priority: parsedData.priority || 2
                            };

                            // Add product type data if available in the ticket
                            if (parsedData.custom_fields && parsedData.custom_fields.cf_product_type) {
                                dataToPass.productType = parsedData.custom_fields.cf_product_type;
                                console.log(`Found product type in ticket:`, dataToPass.productType);
                            }

                            // Add product and product subsection data if available
                            if (parsedData.custom_fields && parsedData.custom_fields.cf_product) {
                                dataToPass.product = parsedData.custom_fields.cf_product;
                                console.log(`Found product in ticket:`, dataToPass.product);
                            }

                            if (parsedData.custom_fields && parsedData.custom_fields.cf_product_subsection) {
                                dataToPass.productSubsection = parsedData.custom_fields.cf_product_subsection;
                                console.log(`Found product subsection in ticket:`, dataToPass.productSubsection);
                            }

                            console.log("Setting requesterEmail to:", agentEmail);

                            // Process VIP status from custom fields
                            if (parsedData.custom_fields) {
                                const vipFields = ['cf_vip', 'vip', 'cf_vip_status', 'vip_customer', 'cf_vip_client', 'cf_is_vip'];
                                for (const field of vipFields) {
                                    if (parsedData.custom_fields[field] !== undefined) {
                                        const value = parsedData.custom_fields[field];
                                        dataToPass.isVip = (typeof value === 'boolean') ? value :
                                            (typeof value === 'string') ? (value.toLowerCase() === 'yes' || value.toLowerCase() === 'true') :
                                                (typeof value === 'number') ? (value !== 0) : false;
                                        break;
                                    }
                                }
                            }

                            // Get district name from custom fields
                            if (parsedData.custom_fields) {
                                if (parsedData.custom_fields.cf_district509811) {
                                    dataToPass.districtName = parsedData.custom_fields.cf_district509811;
                                    dataToPass.districtDropdownValue = parsedData.custom_fields.cf_district509811;
                                    console.log(`Found district name: ${dataToPass.districtName}`);
                                    console.log(`Set districtDropdownValue to: ${dataToPass.districtDropdownValue}`);
                                } else {
                                    console.log('District field cf_district509811 not found or empty');
                                }
                            }

                            // Handle subject formatting right here in selectTemplate
                            if (parsedData.isVip) {
                                // Force the subject format to include VIP at this point
                                const districtName = parsedData.districtName || '';
                                const formattedSubject = `VIP* ${districtName} | Custom Achievement Levels`;

                                // Store the pre-formatted subject in localStorage
                                dataToPass.formattedSubject = formattedSubject;
                                console.log(`Pre-formatted subject for VIP customer: "${formattedSubject}"`);
                            }

                            // Store the processed data in localStorage
                            localStorage.setItem(`${templateType}Data`, JSON.stringify(dataToPass));
                            console.log(`Stored ${templateType} data in localStorage:`, dataToPass);

                            // Navigate to the dynamic template
                            window.location.href = `dynamic-tracker.html?type=${templateType}`;

                        } catch (error) {
                            console.error("Error processing ticket data:", error);
                            // Default data with at least the email if there's an error
                            const dataToPass = {
                                currentTicketId: null,
                                isVip: false,
                                districtName: '',
                                requesterEmail: agentEmail,
                                priority: 2
                            };
                            localStorage.setItem(`${templateType}Data`, JSON.stringify(dataToPass));
                            window.location.href = `dynamic-tracker.html?type=${templateType}`;
                        }
                    } else {
                        // No ticket data but we still have agent data
                        const dataToPass = {
                            currentTicketId: null,
                            isVip: false,
                            districtName: '',
                            requesterEmail: agentEmail,
                            priority: 2
                        };
                        localStorage.setItem(`${templateType}Data`, JSON.stringify(dataToPass));
                        window.location.href = `dynamic-tracker.html?type=${templateType}`;
                    }
                }).catch(function (error) {
                    console.error("Error getting agent data:", error);
                    // Navigate to template with default data if agent data fails
                    window.location.href = `dynamic-tracker.html?type=${templateType}`;
                });
            }

            // Function to check if the current user has admin permissions
            function checkAdminPermissions() {
                try {
                    client.data.get("loggedInUser").then(function (userData) {
                        console.log("Checking admin permissions:", userData);

                        try {
                            // Check if user is admin - modify these conditions based on your actual admin criteria
                            let isAdmin = false;

                            if (userData && userData.loggedInUser) {
                                console.log("User data structure:", JSON.stringify(userData.loggedInUser));

                                // Check if user has admin role (adjust this based on your actual data structure)
                                if (userData.loggedInUser.role_type === "administrator" ||
                                    (userData.loggedInUser.role && userData.loggedInUser.role.name === "Administrator")) {
                                    isAdmin = true;
                                    console.log("Admin detected by role_type or role.name");
                                }

                                // Check for additional admin roles that might exist in Freshdesk
                                if (!isAdmin && userData.loggedInUser.roles) {
                                    // Check if user has any role containing "admin" in the name
                                    isAdmin = userData.loggedInUser.roles.some(role =>
                                        (role.name && role.name.toLowerCase().includes('admin')) ||
                                        (role.role_type && role.role_type.toLowerCase().includes('admin'))
                                    );
                                    if (isAdmin) console.log("Admin detected by roles array");
                                }

                                // If still not identified as admin, check for specific admin permissions
                                if (!isAdmin && userData.loggedInUser.agent_type === "full_access") {
                                    isAdmin = true;
                                    console.log("Admin detected by agent_type full_access");
                                }

                                // Check for view_admin ability in user abilities
                                if (!isAdmin && Array.isArray(userData.loggedInUser.abilities) &&
                                    userData.loggedInUser.abilities.includes("view_admin")) {
                                    isAdmin = true;
                                    console.log("Admin detected by view_admin ability");
                                }

                                // Admin access based on proper permissions only
                                console.log("Admin access based on proper user permissions");

                                console.log("Final admin determination:", isAdmin);
                            } else {
                                console.warn("loggedInUser data structure is not as expected:", userData);
                            }

                            // Show admin button if user is admin
                            if (isAdmin) {
                                const adminButton = document.getElementById('adminSettingsBtn');
                                if (adminButton) {
                                    adminButton.style.display = 'inline-block';
                                    console.log("Admin button display set to inline-block");
                                } else {
                                    console.warn("Admin button element not found");
                                }
                            }
                        } catch (innerError) {
                            console.error("Error processing user data:", innerError);
                            // Enable admin button as fallback in case of error
                            showAdminButtonAsFallback();
                        }
                    }).catch(function (error) {
                        console.error("Error getting loggedInUser data:", error);
                        // Enable admin button as fallback in case of error
                        showAdminButtonAsFallback();
                    });
                } catch (outerError) {
                    console.error("Critical error in checkAdminPermissions:", outerError);
                    // Enable admin button as fallback in case of error
                    showAdminButtonAsFallback();
                }
            }

            // Helper function to show admin button as fallback during errors
            function showAdminButtonAsFallback() {
                console.log("Error occurred during admin permission check");
                // Don't automatically show admin button on errors
                // This prevents unauthorized access due to errors
                console.log("Admin button remains hidden due to permission check failure");

                // Display a message about the error
                const statusArea = document.getElementById('statusArea');
                if (statusArea) {
                    statusArea.innerHTML = `
                        <div style="padding: 10px; background-color: #fff3e0; color: #e65100; border-radius: 4px; margin: 10px 0;">
                            <p>There was an error checking admin permissions. Please refresh the page or contact support if the issue persists.</p>
                        </div>
                    `;
                    statusArea.style.display = 'block';
                }
            }

            // Handle collapsible sections
            document.addEventListener('DOMContentLoaded', function () {
                // Handle collapsible sections
                const groupHeaders = document.querySelectorAll('.group-header');

                groupHeaders.forEach(header => {
                    header.addEventListener('click', function () {
                        // Toggle the collapsed class on the header
                        this.classList.toggle('collapsed');

                        // Find the associated container and toggle its collapsed class
                        const container = this.nextElementSibling;
                        container.classList.toggle('collapsed');
                    });
                });

                // Handle search functionality
                const searchInput = document.getElementById('templateSearch');

                searchInput.addEventListener('input', function () {
                    const searchTerm = this.value.toLowerCase();
                    const templateItems = document.querySelectorAll('.template-item');
                    const templateGroups = document.querySelectorAll('.template-group');

                    templateItems.forEach(item => {
                        const templateName = item.querySelector('.template-link').textContent.toLowerCase();
                        const templateDesc = item.querySelector('.template-description').textContent.toLowerCase();
                        const isMatch = templateName.includes(searchTerm) || templateDesc.includes(searchTerm);

                        item.style.display = isMatch ? 'block' : 'none';
                    });

                    // Show/hide groups based on whether they have any visible templates
                    templateGroups.forEach(group => {
                        const hasVisibleTemplates = [...group.querySelectorAll('.template-item')].some(item =>
                            item.style.display !== 'none'
                        );

                        group.style.display = hasVisibleTemplates ? 'block' : 'none';

                        // Expand groups with matches
                        if (hasVisibleTemplates && searchTerm) {
                            const header = group.querySelector('.group-header');
                            const container = group.querySelector('.templates-container');

                            header.classList.remove('collapsed');
                            container.classList.remove('collapsed');
                        }
                    });
                });
            });

            // Function to show tracker details modal
            function showTrackerDetails() {
                const modal = document.getElementById('trackerDetailsModal');
                const detailsList = document.getElementById('trackerDetailsList');

                if (!modal || !detailsList) {
                    console.error('Modal elements not found');
                    return;
                }

                // Clear existing content
                detailsList.innerHTML = '';

                // Get today's trackers
                const trackers = window.todayTrackers || [];

                if (trackers.length === 0) {
                    detailsList.innerHTML = '<div class="no-trackers">No trackers created today.</div>';
                } else {
                    // Group trackers by template type
                    const trackersByTemplate = {};
                    trackers.forEach(tracker => {
                        if (!trackersByTemplate[tracker.templateType]) {
                            trackersByTemplate[tracker.templateType] = [];
                        }
                        trackersByTemplate[tracker.templateType].push(tracker);
                    });

                    // Get template info for display
                    const templateInfo = getTemplateInfo();

                    // Create sections for each template type
                    Object.entries(trackersByTemplate).forEach(([templateType, templateTrackers]) => {
                        const info = templateInfo[templateType];
                        if (info) {
                            const section = document.createElement('div');
                            section.className = 'tracker-template-section';

                            const sectionHeader = document.createElement('h4');
                            sectionHeader.className = 'tracker-section-header';
                            sectionHeader.innerHTML = `<i class="${info.icon}"></i> ${info.name}`;
                            section.appendChild(sectionHeader);

                            const trackerList = document.createElement('div');
                            trackerList.className = 'tracker-list';

                            templateTrackers.forEach(tracker => {
                                const trackerItem = document.createElement('div');
                                trackerItem.className = 'tracker-item';

                                const timestamp = new Date(tracker.timestamp).toLocaleTimeString([], {
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });

                                trackerItem.innerHTML = `
                                    <div class="tracker-id">
                                        <a href="https://techsupport.benchmarkeducation.com/a/tickets/${tracker.id}" 
                                           target="_blank" 
                                           class="tracker-link">
                                            #${tracker.id}
                                        </a>
                                        <span class="tracker-time">${timestamp}</span>
                                    </div>
                                    <div class="tracker-subject">${tracker.subject}</div>
                                `;

                                trackerList.appendChild(trackerItem);
                            });

                            section.appendChild(trackerList);
                            detailsList.appendChild(section);
                        }
                    });
                }

                // Show the modal
                modal.style.display = 'flex';
            }

            // Function to close tracker details modal
            function closeTrackerDetails() {
                const modal = document.getElementById('trackerDetailsModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            // Set up event listeners for View All and modal close
            document.addEventListener('DOMContentLoaded', function () {
                const viewAllBtn = document.getElementById('viewAllTrackersBtn');
                const closeModalBtn = document.getElementById('closeTrackerModal');
                const modal = document.getElementById('trackerDetailsModal');

                if (viewAllBtn) {
                    viewAllBtn.addEventListener('click', showTrackerDetails);
                }

                if (closeModalBtn) {
                    closeModalBtn.addEventListener('click', closeTrackerDetails);
                }

                // Close modal when clicking outside
                if (modal) {
                    modal.addEventListener('click', function (e) {
                        if (e.target === modal) {
                            closeTrackerDetails();
                        }
                    });
                }
            });
        </script>
    </div>
    <div
        style="display: flex; justify-content: center; margin: 20px 0; border-top: 1px solid #e0e0e0; padding-top: 20px;">
        <a href="https://benchmarkeducation.freshstatus.io" id="freshstatus-badge-root" data-banner-style="highlighted">
            <img
                src="https://public-api.freshstatus.io/v1/public/badge.svg/?badge=12d6fa47-c8f2-4305-b002-9314f34695f8" />
        </a>
    </div>
    <!-- Freshdesk Status Widget Script -->
    <script type="module" src="https://cdn.freshstatus.io/widget/index.js"></script>
</body>

</html>