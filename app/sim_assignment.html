<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script async src="{{{appclient}}}"></script>
    <link rel="stylesheet" type="text/css" href="styles/style.css" />
    <link rel="stylesheet" type="text/css" href="styles/filepreview.css" />
    <link rel="stylesheet" type="text/css" href="styles/sim_assignment.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Add Quill CSS and JS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

</head>



<body>
    <!-- Add the loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="spinner-text">Creating ticket...</div>
    </div>

    <div class="tracker-form-container">
        <div class="tracker-form-container">
            <!-- Add Debug Button at the top -->
            <div class="debug-container">
                <button id="debugFillForm" class="debug-button">Fill Form with Demo Data</button>
            </div>
            <!-- Replace the existing form-title div -->
            <div class="form-title">
                <h2>SIM Assignment Tracker</h2>
            </div>

            <div class="back-button-container">
                <fw-button id="backButton" color="secondary" size="small"
                    style="cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"
                    onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                    <i class="fas fa-arrow-left" style="margin-right: 8px;"></i>Back to Tracker Templates
                </fw-button>
            </div>
            <form id="trackerForm">
                <div class="cards-container">
                    <!-- Subject card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-pen-fancy fa-lg section-icon"></i>
                            <h3>SUBJECT</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="subject" class="required-field">Subject</label>
                                <input type="text" id="subject" name="subject" required>
                                <div class="hint"><i class="fas fa-info-circle"></i> Format: VIP Status* District
                                    Name |
                                    Application
                                    - Specific Issue for User Role</div>
                            </div>

                            <div class="form-group">
                                <label for="vipStatus" class="required-field">VIP Status</label>
                                <select id="vipStatus" name="vipStatus">
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                                <div class="hint"><i class="fas fa-info-circle"></i> Is this a VIP customer?</div>
                            </div>

                            <div class="form-group">
                                <label for="districtName" class="required-field">District Name</label>
                                <input type="text" id="districtName" name="districtName" required
                                    placeholder="e.g. Fairfax">
                                <div class="hint"><i class="fas fa-info-circle"></i> Name of the district</div>
                            </div>

                            <div class="form-group">
                                <label for="application" class="required-field">Application</label>
                                <input type="text" id="application" name="application" required
                                    placeholder="e.g. Grade View">
                                <div class="hint"><i class="fas fa-info-circle"></i> The application or system
                                    related to
                                    this issue
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="specificIssue" class="required-field">Specific Issue</label>
                                <input type="text" id="specificIssue" name="specificIssue" required
                                    placeholder="e.g. Server Error Received">
                                <div class="hint"><i class="fas fa-info-circle"></i> Brief description of the
                                    specific issue
                                </div>
                            </div>

                            <!-- Removed the User Role field as requested -->
                        </div>
                    </div>

                    <!-- Issue Description card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-file-alt fa-lg section-icon"></i>
                            <h3>ISSUE DESCRIPTION</h3>
                        </div>
                        <div class="card-body">
                            <div class="quill-editor-container">
                                <div id="reportedIssueEditor" style="height: 150px; background-color: white;"></div>
                                <textarea id="reportedIssue" name="reportedIssue" style="display: none;"></textarea>
                            </div>
                            <div class="hint"><i class="fas fa-lightbulb"></i> Specific details outlining user
                                impact</div>

                            <div class="form-group">
                                <label for="xcodeInfo">Resource xcode:</label>
                                <input type="text" id="xcodeInfo" name="xcodeInfo">
                                <div class="hint"><i class="fas fa-info-circle"></i> Xcode for the resource if
                                    applicable
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="resourceTitle">Resource title:</label>
                                <input type="text" id="resourceTitle" name="resourceTitle">
                                <div class="hint"><i class="fas fa-info-circle"></i> Title of the resource</div>
                            </div>
                        </div>
                    </div>

                    <!-- Steps to Reproduce card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-list-ol fa-lg section-icon"></i>
                            <h3>STEPS TO REPRODUCE</h3>
                        </div>
                        <div class="card-body">
                            <div class="quill-editor-container">
                                <div id="stepsToReproduceEditor" style="height: 150px; background-color: white;">
                                </div>
                                <textarea id="stepsToReproduce" name="stepsToReproduce"
                                    style="display: none;"></textarea>
                            </div>
                            <div class="hint"><i class="fas fa-info-circle"></i> Numbered steps to reproduce the
                                issue</div>
                        </div>
                    </div>

                    <!-- Screenshots and Videos card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-images fa-lg section-icon"></i>
                            <h3>SCREENSHOTS and/or VIDEOS</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <div class="attachment-input-container">
                                    <div class="custom-file-input">
                                        <div class="file-upload-btn">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <span>Choose files</span>
                                            <input type="file" id="screenshots" name="screenshots" multiple
                                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                                        </div>
                                    </div>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Upload screenshots or
                                        videos
                                        (please
                                        include URL in screen capture)</div>
                                </div>
                                <div id="screenshotPreview" class="screenshot-preview"></div>
                                <div id="attachmentCounter" class="attachment-counter"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Impacted User Info card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-user fa-lg section-icon"></i>
                            <h3>IMPACTED USER INFO</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="username">Username:</label>
                                    <input type="text" id="username" name="username">
                                    <div class="hint"><i class="fas fa-info-circle"></i> Username of the affected
                                        user</div>
                                </div>

                                <div class="form-group">
                                    <label for="impactedRole">Role:</label>
                                    <select id="impactedRole" name="impactedRole">
                                        <option value="">-- Select --</option>
                                        <option value="Teacher">Teacher</option>
                                        <option value="Student">Student</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Other">Other</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Role of the impacted user
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="studentId">Student Internal ID:</label>
                                    <input type="text" id="studentId" name="studentId">
                                    <div class="hint"><i class="fas fa-info-circle"></i> If applicable</div>
                                </div>

                                <div class="form-group">
                                    <label for="techAdminLink">Tech Admin link:</label>
                                    <input type="text" id="techAdminLink" name="techAdminLink">
                                    <div class="hint"><i class="fas fa-info-circle"></i> Link to tech admin</div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="device">Device:</label>
                                    <input type="text" id="device" name="device">
                                    <div class="hint"><i class="fas fa-info-circle"></i> Device used when
                                        experiencing the
                                        issue
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="realm">Realm:</label>
                                    <input type="text" id="realm" name="realm">
                                    <div class="hint"><i class="fas fa-info-circle"></i> Realm information</div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="assignmentId">Assignment ID:</label>
                                    <input type="text" id="assignmentId" name="assignmentId">
                                    <div class="hint"><i class="fas fa-info-circle"></i> If applicable</div>
                                </div>

                                <div class="form-group">
                                    <label for="dateReported">Date Issue Reported:</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-calendar-alt icon-prefix"></i>
                                        <input type="date" id="dateReported" name="dateReported">
                                    </div>
                                    <div class="hint"><i class="fas fa-info-circle"></i> When the user reported this
                                        issue
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="harFile">HAR file attached:</label>
                                <select id="harFile" name="harFile">
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                                <div class="form-group" id="harReasonContainer" style="display: none;">
                                    <label for="harReason">Reason if not attached:</label>
                                    <input type="text" id="harReason" name="harReason">
                                </div>
                                <div class="hint"><i class="fas fa-info-circle"></i> HTTP Archive file to assist
                                    with
                                    troubleshooting</div>
                            </div>
                        </div>
                    </div>

                    <!-- Expected Results card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-clipboard-check fa-lg section-icon"></i>
                            <h3>EXPECTED RESULTS</h3>
                        </div>
                        <div class="card-body">
                            <div class="quill-editor-container">
                                <div id="expectedResultsEditor" style="height: 100px; background-color: white;">
                                </div>
                                <textarea id="expectedResults" name="expectedResults" style="display: none;"></textarea>
                            </div>
                            <div class="hint"><i class="fas fa-info-circle"></i> What should happen instead</div>
                        </div>
                    </div>

                    <!-- Ticket Properties card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-tasks fa-lg section-icon"></i>
                            <h3>TICKET PROPERTIES</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="email" class="required-field">Requester Email</label>
                                <div class="input-with-icon">
                                    <input type="email" id="email" name="email" required>
                                </div>
                                <div class="hint"><i class="fas fa-info-circle"></i> This ticket will be created by
                                    you (the
                                    logged-in agent)</div>
                                <div id="emailStatus" class="email-status"></div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="relatedTickets" class="required-field">Related Ticket IDs</label>
                                    <div class="input-with-icon">
                                        <input type="text" id="relatedTickets" name="relatedTickets" required>
                                    </div>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Comma-separated ticket IDs
                                        (e.g.,
                                        1,2,3)
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="priority">Priority</label>
                                    <select id="priority" name="priority">
                                        <option value="1">Low</option>
                                        <option value="2">Medium</option>
                                        <option value="3">High</option>
                                        <option value="4">Urgent</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Select ticket priority
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="status">Status</label>
                                    <select id="status" name="status">
                                        <option value="2">Open</option>
                                        <option value="3">Pending</option>
                                        <option value="4">Resolved</option>
                                        <option value="5">Closed</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Select ticket status</div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="groupField">Group</label>
                                    <select id="groupField" name="groupField">
                                        <option>Loading groups...</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Select a support group
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="agentField">Agent</label>
                                    <select id="agentField" name="agentField"></select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Select an agent</div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="districtField">District</label>
                                <input type="text" id="districtField" name="districtField" readonly>
                                <div class="hint"><i class="fas fa-info-circle"></i> Auto-populated from source
                                    ticket</div>
                            </div>

                            <!-- Add hidden product impacted field for compatibility -->
                            <div class="form-group" style="display: none;">
                                <label for="productImpacted">Application/Program Impacted:</label>
                                <input type="text" id="productImpacted" name="productImpacted" data-full-value="">
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: none;">
                    <textarea id="description" name="description"></textarea>
                </div>

                <div class="form-actions">
                    <fw-button id="cancelTracker" color="secondary" size="medium"
                        style="display: flex; justify-content: center; align-items: center;">
                        <i class="fas fa-times"></i> Cancel
                    </fw-button>
                    <fw-button id="createTracker" color="primary" type="submit" size="medium"
                        style="display: flex; justify-content: center; align-items: center;">
                        <i class="fas fa-check"></i> Create Tracker
                    </fw-button>
                </div>
            </form>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    // Call setupEventListeners function
                    setupEventListeners();

                    // Initialize Quill for rich text editors
                    let reportedIssueQuill = null;
                    let stepsToReproduceQuill = null;
                    let expectedResultsQuill = null;

                    try {
                        // Check if the elements exist before initializing Quill editors
                        if (document.getElementById('reportedIssueEditor')) {
                            reportedIssueQuill = new Quill('#reportedIssueEditor', {
                                theme: 'snow',
                                placeholder: 'Enter specific details outlining user impact...'
                            });
                        }

                        if (document.getElementById('stepsToReproduceEditor')) {
                            stepsToReproduceQuill = new Quill('#stepsToReproduceEditor', {
                                theme: 'snow',
                                placeholder: 'Enter steps to reproduce the issue...'
                            });
                        }

                        if (document.getElementById('expectedResultsEditor')) {
                            expectedResultsQuill = new Quill('#expectedResultsEditor', {
                                theme: 'snow',
                                placeholder: 'Enter what should happen instead...'
                            });
                        }

                        console.log("Quill editors initialized successfully");
                    } catch (err) {
                        console.error("Error initializing Quill editors:", err);
                    }

                    // Wait for the Freshworks SDK to be available
                    let initRetries = 0;
                    const maxRetries = 10;

                    // Store ticket data from parent
                    let ticketData = {
                        isVip: false,
                        districtName: '',
                        currentTicketId: null,
                        requesterEmail: ''
                    };

                    // Safely set up event listeners for elements that might not exist yet
                    function setupEventListeners() {
                        // Back button functionality - with error handling
                        const backButton = document.getElementById('backButton');
                        if (backButton) {
                            backButton.addEventListener('click', function () {
                                window.location.href = "template-selector.html";
                            });
                        } else {
                            console.warn("Back button element not found");
                        }

                        // Toggle visibility of HAR reason field - with error handling
                        const harFile = document.getElementById('harFile');
                        if (harFile) {
                            harFile.addEventListener('change', function () {
                                const harReasonContainer = document.getElementById('harReasonContainer');
                                if (harReasonContainer) {
                                    harReasonContainer.style.display = this.value === 'No' ? 'block' : 'none';
                                }
                            });
                        } else {
                            console.warn("HAR file element not found");
                        }

                        // Setup form debug button handler
                        const debugButton = document.getElementById('debugFillForm');
                        if (debugButton) {
                            debugButton.addEventListener('click', function (e) {
                                e.preventDefault();
                                if (typeof fillFormWithDemoData === 'function') {
                                    fillFormWithDemoData();
                                } else {
                                    console.warn("Fill form function not available yet");
                                }
                            });
                        }

                        // Setup Cancel and Create buttons
                        setTimeout(function () {
                            var createBtn = document.getElementById('createTracker');
                            if (createBtn) {
                                createBtn.onclick = function (e) {
                                    e.preventDefault();
                                    const form = document.getElementById('trackerForm');
                                    if (form) {
                                        form.dispatchEvent(new Event('submit'));
                                    }
                                };
                            }

                            var cancelBtn = document.getElementById('cancelTracker');
                            if (cancelBtn) {
                                cancelBtn.onclick = function () {
                                    if (window.client) {
                                        window.client.instance.close();
                                    }
                                };
                            }
                        }, 500);

                        // Check HAR dropdown status and set container visibility initially
                        const harReasonContainer = document.getElementById('harReasonContainer');
                        const harFileSelect = document.getElementById('harFile');
                        if (harReasonContainer && harFileSelect && harFileSelect.value === 'No') {
                            harReasonContainer.style.display = 'block';
                        }
                    }

                    function initializeClient() {
                        if (typeof client !== 'undefined') {
                            setupFormHandlers(client);
                        } else if (typeof app !== 'undefined') {
                            app.initialized().then(function (clientObj) {
                                setupFormHandlers(clientObj);
                            }).catch(handleInitError);
                        } else if (typeof window.frsh !== 'undefined' && window.frsh.init) {
                            window.frsh.init().then(function (clientObj) {
                                setupFormHandlers(clientObj);
                            }).catch(handleInitError);
                        } else if (initRetries < maxRetries) {
                            initRetries++;
                            setTimeout(initializeClient, 100);
                        } else {
                            handleInitError(new Error("Could not initialize client after multiple attempts"));
                        }
                    }

                    function handleInitError(error) {
                        console.error("Modal initialization error:", error);
                        const container = document.querySelector('.tracker-form-container');
                        if (container) {
                            container.innerHTML = '<div class="error-card">Failed to initialize app client. Please close and try again.</div>';
                        } else {
                            console.error("Could not find form container to display error message");
                        }
                    }

                    function setupFormHandlers(client) {
                        window.client = client;
                        console.log("Setting up form handlers");

                        // Safe element getter function
                        function safeGetElement(id) {
                            const element = document.getElementById(id);
                            if (!element) {
                                console.warn(`Element with id '${id}' not found`);
                            }
                            return element;
                        }

                        // Safe setter function for input values
                        function safeSetValue(elementId, value) {
                            const element = safeGetElement(elementId);
                            if (element) {
                                element.value = value;
                                return true;
                            }
                            return false;
                        }

                        // Safe setter function for HTML content
                        function safeSetHTML(elementId, html) {
                            const element = safeGetElement(elementId);
                            if (element) {
                                element.innerHTML = html;
                                return true;
                            }
                            return false;
                        }

                        // Safe function to add event listener
                        function safeAddListener(elementId, event, handler) {
                            const element = safeGetElement(elementId);
                            if (element) {
                                element.addEventListener(event, handler);
                                return true;
                            }
                            return false;
                        }

                        async function getLoggedInUserEmail() {
                            try {
                                console.log("Fetching agent email directly from modal");
                                const userData = await client.data.get("loggedInUser");
                                console.log("Agent data:", userData);

                                if (userData && userData.loggedInUser && userData.loggedInUser.contact && userData.loggedInUser.contact.email) {
                                    const agentEmail = userData.loggedInUser.contact.email;
                                    console.log("Found agent email:", agentEmail);

                                    safeSetValue('email', agentEmail);
                                    safeSetHTML('emailStatus', `<span style="color: green">✓ Email loaded: ${agentEmail}</span>`);

                                    return agentEmail;
                                } else {
                                    console.warn("Could not get agent email from userData");
                                    safeSetHTML('emailStatus', '<span style="color: orange">⚠️ Email not found in user data</span>');
                                    return null;
                                }
                            } catch (error) {
                                console.error("Error getting logged-in user data:", error);
                                safeSetHTML('emailStatus', '<span style="color: red">✗ Error loading email</span>');
                                return null;
                            }
                        }

                        // Other functions with similar error handling...

                        client.instance.context().then(async function (context) {
                            console.log("Modal context:", context);
                            if (context && context.data) {
                                ticketData = {
                                    isVip: context.data.isVip || false,
                                    districtName: context.data.districtName || '',
                                    currentTicketId: context.data.currentTicketId || null,
                                    requesterEmail: context.data.requesterEmail || '',
                                    ticketRequesterEmail: context.data.ticketRequesterEmail || '',
                                    priority: context.data.priority || 1
                                };
                                console.log("Received ticket data:", ticketData);

                                // Safely set form values
                                safePopulateDistrictField();

                                if (ticketData.currentTicketId) {
                                    safeSetValue('relatedTickets', ticketData.currentTicketId);
                                }

                                if (ticketData.priority) {
                                    safeSetValue('priority', ticketData.priority);
                                }

                                const today = new Date().toISOString().split('T')[0];
                                safeSetValue('dateReported', today);

                                if (ticketData.isVip) {
                                    safeSetValue('vipStatus', 'Yes');
                                }
                            } else {
                                console.log("No context data, fetching agent email directly");
                                await getLoggedInUserEmail();
                                safePopulateDistrictField();

                                const today = new Date().toISOString().split('T')[0];
                                safeSetValue('dateReported', today);
                            }

                            trySafelySetupSubjectGeneration();
                        }).catch(async function (error) {
                            console.error("Error getting modal context:", error);
                            await getLoggedInUserEmail();
                            safePopulateDistrictField();
                            trySafelySetupSubjectGeneration();
                        });

                        // Safe method for populating fields without throwing errors
                        function safePopulateDistrictField() {
                            try {
                                const districtNameEl = safeGetElement('districtName');
                                const districtFieldEl = safeGetElement('districtField');

                                if (!districtNameEl && !districtFieldEl) {
                                    console.warn("District name fields not found in the DOM");
                                    return;
                                }

                                // First check localStorage
                                const storedData = localStorage.getItem('sim_assignmentData') || localStorage.getItem('ticketData');

                                if (storedData) {
                                    try {
                                        const parsedData = JSON.parse(storedData);
                                        // Check if districtName is directly available
                                        if (parsedData.districtName) {
                                            if (districtNameEl) districtNameEl.value = parsedData.districtName;
                                            if (districtFieldEl) districtFieldEl.value = parsedData.districtName;
                                            console.log("Set district from localStorage:", parsedData.districtName);
                                            return;
                                        }

                                        // Check for district in custom fields
                                        if (parsedData.custom_fields) {
                                            const districtFields = [
                                                'cf_district509811', 'cf_district', 'district',
                                                'cf_school_district', 'cf_district_name'
                                            ];

                                            for (const field of districtFields) {
                                                if (parsedData.custom_fields[field]) {
                                                    const districtName = parsedData.custom_fields[field];
                                                    if (districtNameEl) districtNameEl.value = districtName;
                                                    if (districtFieldEl) districtFieldEl.value = districtName;
                                                    console.log(`Found district in field ${field}:`, districtName);
                                                    break;
                                                }
                                            }
                                        }
                                    } catch (error) {
                                        console.error("Error parsing stored data:", error);
                                    }
                                }

                                // Try to get from current ticket context if we have client and district fields
                                if (window.client && (
                                    (districtNameEl && !districtNameEl.value) ||
                                    (districtFieldEl && !districtFieldEl.value)
                                )) {
                                    client.data.get("ticket").then(function (ticketData) {
                                        if (ticketData && ticketData.ticket && ticketData.ticket.custom_fields) {
                                            const districtFields = [
                                                'cf_district509811', 'cf_district', 'district',
                                                'cf_school_district', 'cf_district_name'
                                            ];

                                            for (const field of districtFields) {
                                                if (ticketData.ticket.custom_fields[field]) {
                                                    const districtName = ticketData.ticket.custom_fields[field];
                                                    if (districtNameEl) districtNameEl.value = districtName;
                                                    if (districtFieldEl) districtFieldEl.value = districtName;
                                                    console.log(`Found district in ticket field ${field}:`, districtName);
                                                    break;
                                                }
                                            }
                                        }
                                    }).catch(function (error) {
                                        console.error("Error fetching ticket data:", error);
                                    });
                                }
                            } catch (error) {
                                console.error("Error populating district field:", error);
                            }
                        }

                        // Safe method for subject field generation
                        function trySafelySetupSubjectGeneration() {
                            try {
                                // Check if all required elements exist before setting up
                                const applicationEl = safeGetElement('application');
                                const specificIssueEl = safeGetElement('specificIssue');
                                const vipStatusEl = safeGetElement('vipStatus');
                                const districtNameEl = safeGetElement('districtName');
                                const subjectEl = safeGetElement('subject');

                                if (!applicationEl || !specificIssueEl ||
                                    !vipStatusEl || !districtNameEl || !subjectEl) {
                                    console.warn("Not all elements required for subject generation exist");
                                    return false;
                                }

                                // Set up event listeners for subject generation
                                applicationEl.addEventListener('input', generateSubject);
                                specificIssueEl.addEventListener('input', generateSubject);
                                vipStatusEl.addEventListener('change', generateSubject);
                                districtNameEl.addEventListener('input', generateSubject);

                                // Generate initial subject
                                generateSubject();
                                return true;
                            } catch (error) {
                                console.error("Error setting up subject generation:", error);
                                return false;
                            }
                        }

                        // Updated generateSubject function with proper error handling
                        function generateSubject() {
                            try {
                                const vipStatusEl = safeGetElement('vipStatus');
                                const districtNameEl = safeGetElement('districtName');
                                const applicationEl = safeGetElement('application');
                                const specificIssueEl = safeGetElement('specificIssue');
                                const subjectEl = safeGetElement('subject');

                                if (!vipStatusEl || !districtNameEl || !applicationEl ||
                                    !specificIssueEl || !subjectEl) {
                                    console.warn("Cannot find required fields for subject generation");
                                    return;
                                }

                                const vipStatus = vipStatusEl.value;
                                const districtName = districtNameEl.value.trim();
                                const application = applicationEl.value.trim();
                                const specificIssue = specificIssueEl.value.trim();

                                let subject = '';

                                if (vipStatus === 'Yes') {
                                    subject = 'VIP* ';
                                }

                                if (districtName) {
                                    subject += districtName;
                                }

                                if (application) {
                                    subject += ' | ' + application;
                                }

                                if (specificIssue) {
                                    subject += ' - ' + specificIssue;
                                }

                                // Removed the User Role part

                                subjectEl.value = subject;
                            } catch (error) {
                                console.error("Error generating subject:", error);
                            }
                        }

                        // Check if we need to initialize Quill editors that don't already exist
                        if (reportedIssueQuill === null && document.getElementById('reportedIssueEditor')) {
                            reportedIssueQuill = new Quill('#reportedIssueEditor', {
                                theme: 'snow',
                                placeholder: 'Enter specific details outlining user impact...'
                            });
                        }

                        if (stepsToReproduceQuill === null && document.getElementById('stepsToReproduceEditor')) {
                            stepsToReproduceQuill = new Quill('#stepsToReproduceEditor', {
                                theme: 'snow',
                                placeholder: 'Enter numbered steps to reproduce the issue...'
                            });
                        }

                        if (expectedResultsQuill === null && document.getElementById('expectedResultsEditor')) {
                            expectedResultsQuill = new Quill('#expectedResultsEditor', {
                                theme: 'snow',
                                placeholder: 'Enter what should happen instead...'
                            });
                        }

                        // Safely set up Quill submit handler
                        const trackerForm = safeGetElement('trackerForm');
                        if (trackerForm) {
                            trackerForm.addEventListener('submit', async function (e) {
                                e.preventDefault();

                                // Safely update hidden textareas with editor content
                                if (reportedIssueQuill && safeGetElement('reportedIssue')) {
                                    safeGetElement('reportedIssue').value = reportedIssueQuill.root.innerHTML;
                                }

                                if (stepsToReproduceQuill && safeGetElement('stepsToReproduce')) {
                                    safeGetElement('stepsToReproduce').value = stepsToReproduceQuill.root.innerHTML;
                                }

                                if (expectedResultsQuill && safeGetElement('expectedResults')) {
                                    safeGetElement('expectedResults').value = expectedResultsQuill.root.innerHTML;
                                }

                                // Handle form submission
                                handleSubmitForm(e);
                            });
                        }

                        // Add paste event handlers for Quill editors
                        function setupPasteHandlers() {
                            if (reportedIssueQuill) {
                                reportedIssueQuill.root.addEventListener('paste', function (e) {
                                    handlePasteImage(e, reportedIssueQuill);
                                });
                            }

                            if (stepsToReproduceQuill) {
                                stepsToReproduceQuill.root.addEventListener('paste', function (e) {
                                    handlePasteImage(e, stepsToReproduceQuill);
                                });
                            }

                            if (expectedResultsQuill) {
                                expectedResultsQuill.root.addEventListener('paste', function (e) {
                                    handlePasteImage(e, expectedResultsQuill);
                                });
                            }
                        }

                        // Set up paste handlers if Quill is initialized
                        setupPasteHandlers();

                        // Handle paste events for images
                        function handlePasteImage(e, quill) {
                            // Only proceed if we have clipboard data and quill
                            if (!quill) return;
                            const clipboardData = e.clipboardData || window.clipboardData;
                            if (!clipboardData) return;
                            const items = clipboardData.items;
                            if (!items) return;

                            // Look for image items
                            for (let i = 0; i < items.length; i++) {
                                if (items[i].type.indexOf("image") !== -1) {
                                    e.preventDefault();
                                    const file = items[i].getAsFile();
                                    uploadImageToImgbb(file)
                                        .then(url => {
                                            const range = quill.getSelection();
                                            if (range) {
                                                quill.insertEmbed(range.index, 'image', url);
                                            } else {
                                                quill.insertEmbed(0, 'image', url);
                                            }
                                        })
                                        .catch(error => console.error("Image upload error:", error));
                                    return;
                                }
                            }
                        }

                        // Helper: Upload an image file to ImgBB and return its URL
                        function uploadImageToImgbb(file) {
                            const formData = new FormData();
                            formData.append('image', file);
                            const IMGBB_API_KEY = "b3da8c974bc40dd87d896d84436dd76e";
                            return fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                                method: 'POST',
                                body: formData
                            })
                                .then(response => response.json())
                                .then(result => {
                                    if (result.success) {
                                        return result.data.display_url;
                                    }
                                    throw new Error("Image upload failed");
                                });
                        }


                        // Initialize needed API-based elements
                        try {
                            fetchGroups();
                            // Don't call functions that depend on elements that don't exist in this template
                            // For example, avoid calling fetchProductTypes() if the product selector doesn't exist
                            if (document.getElementById('productImpacted')) {
                                fetchProductTypes();
                            }
                        } catch (error) {
                            console.error("Error initializing API-based elements:", error);
                        }
                    }

                    // Start the client initialization process
                    initializeClient();
                });
                function setupFileUploadHandling() {
                    console.log("Setting up file upload handling");
                    let aggregatedScreenshotFiles = [];

                    // Safe element getter
                    function getElement(id) {
                        const element = document.getElementById(id);
                        if (!element) console.warn(`Element with id '${id}' not found`);
                        return element;
                    }

                    // File upload event listener
                    const screenshotsInput = getElement('screenshots');
                    if (screenshotsInput) {
                        screenshotsInput.addEventListener('change', function (e) {
                            console.log("File input change detected");
                            const previewContainer = getElement('screenshotPreview');

                            if (previewContainer && this.files.length > 0) {
                                console.log(`${this.files.length} files selected`);

                                // Add new files to our collection
                                for (let i = 0; i < this.files.length; i++) {
                                    aggregatedScreenshotFiles.push(this.files[i]);
                                }

                                // Clear the preview container
                                previewContainer.innerHTML = '';

                                // Create file summary
                                const summaryDiv = document.createElement('div');
                                summaryDiv.className = 'attachments-summary';

                                // Calculate total size
                                let totalSizeBytes = 0;
                                aggregatedScreenshotFiles.forEach(file => {
                                    totalSizeBytes += file.size;
                                });

                                // Format size for display
                                let formattedSize;
                                if (totalSizeBytes < 1024) {
                                    formattedSize = totalSizeBytes + ' B';
                                } else if (totalSizeBytes < 1024 * 1024) {
                                    formattedSize = (totalSizeBytes / 1024).toFixed(1) + ' KB';
                                } else {
                                    formattedSize = (totalSizeBytes / (1024 * 1024)).toFixed(2) + ' MB';
                                }

                                summaryDiv.innerHTML = `
                        <div class="attachments-count">
                            <strong>${aggregatedScreenshotFiles.length}</strong> file${aggregatedScreenshotFiles.length !== 1 ? 's' : ''} attached
                        </div>
                        <div class="attachments-size">Total: ${formattedSize}</div>
                    `;

                                previewContainer.appendChild(summaryDiv);

                                // Preview files
                                for (let i = 0; i < Math.min(aggregatedScreenshotFiles.length, 5); i++) {
                                    const file = aggregatedScreenshotFiles[i];
                                    const fileDiv = document.createElement('div');
                                    fileDiv.className = 'file-thumbnail';

                                    // Check if file is an image
                                    const isImage = file.type.match('image.*');

                                    if (isImage) {
                                        // Create image preview
                                        const reader = new FileReader();
                                        reader.onload = function (e) {
                                            fileDiv.innerHTML = `
                                    <div class="thumbnail-container">
                                        <img src="${e.target.result}" title="${file.name}" alt="${file.name}"/>
                                    </div>
                                    <div class="file-filename" title="${file.name}">${file.name}</div>
                                    <div class="file-size">${formatFileSize(file.size)}</div>
                                    <div class="file-remove" data-index="${i}">✕</div>
                                `;

                                            // Add remove button handler
                                            fileDiv.querySelector('.file-remove').addEventListener('click', function (e) {
                                                e.stopPropagation();
                                                removeFile(parseInt(this.dataset.index));
                                            });
                                        };
                                        reader.readAsDataURL(file);
                                    } else {
                                        // Create generic file preview
                                        fileDiv.innerHTML = `
                                <div class="thumbnail-container file-icon-container">
                                    <i class="fas fa-file file-icon"></i>
                                    <div class="file-type-label">File</div>
                                </div>
                                <div class="file-filename" title="${file.name}">${file.name}</div>
                                <div class="file-size">${formatFileSize(file.size)}</div>
                                <div class="file-remove" data-index="${i}">✕</div>
                            `;

                                        // Add remove button handler
                                        fileDiv.querySelector('.file-remove').addEventListener('click', function (e) {
                                            e.stopPropagation();
                                            removeFile(parseInt(this.dataset.index));
                                        });
                                    }

                                    previewContainer.appendChild(fileDiv);
                                }

                                // Add clear all button if there are files
                                if (aggregatedScreenshotFiles.length > 0) {
                                    const clearAllDiv = document.createElement('div');
                                    clearAllDiv.className = 'clear-files';
                                    clearAllDiv.innerHTML = `<button type="button">Clear All Attachments (${aggregatedScreenshotFiles.length})</button>`;
                                    clearAllDiv.querySelector('button').addEventListener('click', function () {
                                        clearAllFiles();
                                    });
                                    previewContainer.appendChild(clearAllDiv);
                                }

                                // Update counter
                                updateAttachmentCounter();

                                // Clear the file input so the same files can be selected again
                                this.value = '';
                            }
                        });
                    }

                    // Helper function to format file size
                    function formatFileSize(bytes) {
                        if (bytes < 1024) {
                            return bytes + ' B';
                        } else if (bytes < 1024 * 1024) {
                            return (bytes / 1024).toFixed(1) + ' KB';
                        } else {
                            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                        }
                    }

                    // Function to remove a file
                    function removeFile(index) {
                        if (index >= 0 && index < aggregatedScreenshotFiles.length) {
                            // Remove the file from collection
                            aggregatedScreenshotFiles.splice(index, 1);

                            // Update the UI
                            const previewContainer = getElement('screenshotPreview');
                            if (previewContainer) {
                                // Just rebuild the entire preview
                                const filesInput = getElement('screenshots');
                                if (filesInput) {
                                    const event = new Event('change');
                                    filesInput.dispatchEvent(event);
                                }
                            }
                        }
                    }

                    // Function to clear all files
                    function clearAllFiles() {
                        aggregatedScreenshotFiles = [];
                        const previewContainer = getElement('screenshotPreview');
                        if (previewContainer) {
                            previewContainer.innerHTML = '';
                        }
                        updateAttachmentCounter();
                    }

                    // Function to update attachment counter
                    function updateAttachmentCounter() {
                        const counter = getElement('attachmentCounter');
                        if (counter) {
                            if (aggregatedScreenshotFiles.length > 0) {
                                counter.textContent = `${aggregatedScreenshotFiles.length} file(s) selected`;
                                counter.style.display = 'block';
                            } else {
                                counter.style.display = 'none';
                            }
                        }
                    }

                    // Expose functions to window for use in the form handler
                    window.ticketFormHelpers = {
                        getAttachments: function () {
                            return aggregatedScreenshotFiles;
                        }
                    };
                }


                function enhanceTicketDataPopulation() {
                    console.log("Enhancing ticket data population");

                    // Load data from local storage first
                    function loadTicketDataFromStorage() {
                        try {
                            // Check different possible storage keys
                            const possibleKeys = [
                                'sim_assignmentData',
                                'ticketData',
                                'sourceTicketData',
                                'sedcustData'
                            ];

                            let loadedData = null;

                            for (const key of possibleKeys) {
                                const storedData = localStorage.getItem(key);
                                if (storedData) {
                                    try {
                                        const parsed = JSON.parse(storedData);
                                        console.log(`Found data in localStorage key '${key}':`, parsed);
                                        loadedData = parsed;
                                        break;
                                    } catch (e) {
                                        console.warn(`Failed to parse data from localStorage key '${key}'`, e);
                                    }
                                }
                            }

                            return loadedData;
                        } catch (error) {
                            console.error("Error loading ticket data from storage:", error);
                            return null;
                        }
                    }

                    // Function to force update of VIP status field
                    function forceUpdateVipStatus(isVip) {
                        const vipField = document.getElementById('vipStatus');
                        if (vipField) {
                            vipField.value = isVip ? 'Yes' : 'No';
                            console.log(`VIP status set to: ${vipField.value}`);

                            // Trigger change event to update any dependent fields
                            const event = new Event('change');
                            vipField.dispatchEvent(event);
                        }
                    }

                    // Function to force update of priority
                    function forceUpdatePriority(priority) {
                        const priorityField = document.getElementById('priority');
                        if (priorityField) {
                            // Convert to string if it's a number
                            const priorityValue = typeof priority === 'number' ? priority.toString() : priority;
                            priorityField.value = priorityValue || '1';
                            console.log(`Priority set to: ${priorityField.value}`);
                        }
                    }

                    // Function to force update related tickets
                    function forceUpdateRelatedTickets(ticketId) {
                        const relatedTicketsField = document.getElementById('relatedTickets');
                        if (relatedTicketsField && ticketId) {
                            relatedTicketsField.value = ticketId;
                            console.log(`Related tickets set to: ${relatedTicketsField.value}`);
                        }
                    }

                    // Get the loaded data
                    const loadedData = loadTicketDataFromStorage();
                    if (loadedData) {
                        // Update VIP status if present
                        if (loadedData.isVip !== undefined) {
                            forceUpdateVipStatus(loadedData.isVip);
                        }

                        // Update priority if present
                        if (loadedData.priority !== undefined) {
                            forceUpdatePriority(loadedData.priority);
                        }

                        // Update related tickets if present
                        if (loadedData.currentTicketId !== undefined) {
                            forceUpdateRelatedTickets(loadedData.currentTicketId);
                        }

                        // Update district name if present
                        const districtNameField = document.getElementById('districtName');
                        const districtField = document.getElementById('districtField');

                        if (loadedData.districtName && districtNameField) {
                            districtNameField.value = loadedData.districtName;
                        }

                        if (loadedData.districtName && districtField) {
                            districtField.value = loadedData.districtName;
                        }
                    }

                    // After delay, check and fix the group dropdown
                    setTimeout(function () {
                        const groupField = document.getElementById('groupField');
                        if (groupField && groupField.options.length <= 1 && groupField.innerHTML.includes('Loading groups...')) {
                            console.log("Loading fallback groups because API groups didn't load");

                            // Load fallback groups
                            groupField.innerHTML = "";

                            // Add default option
                            const defaultOption = document.createElement('option');
                            defaultOption.value = "";
                            defaultOption.textContent = "-- Select a Group --";
                            groupField.appendChild(defaultOption);

                            // Add fallback groups
                            const fallbackGroups = [
                                { id: "67000396680", name: "Escalations" },
                                { id: "67000396681", name: "Support" },
                                { id: "67000396682", name: "Technical" }
                            ];

                            fallbackGroups.forEach(group => {
                                const option = document.createElement('option');
                                option.value = group.id;
                                option.textContent = group.name;
                                groupField.appendChild(option);
                            });

                            // Set default selected value
                            groupField.value = "67000396680"; // Escalations

                            // Also load fallback agents
                            const agentField = document.getElementById('agentField');
                            if (agentField) {
                                agentField.innerHTML = "";

                                // Add default option
                                const defaultAgentOption = document.createElement('option');
                                defaultAgentOption.value = "";
                                defaultAgentOption.textContent = "-- Select an Agent --";
                                agentField.appendChild(defaultAgentOption);

                                // Add fallback agents
                                const fallbackAgents = [
                                    { id: "67025683491", name: "Mohammad Azeem" },
                                    { id: "67030529218", name: "Jordan Fields" },
                                    { id: "67031011668", name: "Suriya Iqbal" },
                                    { id: "67040597168", name: "Anson Li" },
                                    { id: "67051499418", name: "Drita Lulgjuraj" }
                                ];

                                fallbackAgents.forEach(agent => {
                                    const option = document.createElement('option');
                                    option.value = agent.id;
                                    option.textContent = agent.name;
                                    agentField.appendChild(option);
                                });
                            }
                        }
                    }, 2000);
                }

                // Initialize fixes when DOM is fully loaded
                document.addEventListener('DOMContentLoaded', function () {
                    console.log("Initializing SIM Assignment form fixes");
                    // Setup file upload handling
                    setupFileUploadHandling();

                    // Fix ticket data population
                    enhanceTicketDataPopulation();
                });
            </script>

            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    setTimeout(function () {
                        var createBtn = document.getElementById('createTracker');
                        if (createBtn) {
                            createBtn.onclick = function (e) {
                                e.preventDefault();
                                document.getElementById('trackerForm').dispatchEvent(new Event('submit'));
                            };
                        }
                        var cancelBtn = document.getElementById('cancelTracker');
                        if (cancelBtn) {
                            cancelBtn.onclick = function () {
                                if (window.client) {
                                    window.client.instance.close();
                                }
                            };
                        }
                        console.log('Extra event handlers attached to buttons');
                    }, 500);
                });
            </script>

            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    // Call setupEventListeners function
                    setupEventListeners();

                    // Initialize Quill for rich text editors


                    function setupFormHandlers(client) {
                        window.client = client;
                        console.log("Setting up form handlers");

                        // Safe element getter function


                        // Add the handleSubmitForm function that was missing
                        async function handleSubmitForm(e) {
                            e.preventDefault();

                            // Check if client is available
                            if (!window.client) {
                                console.error("Client not initialized. Cannot submit form.");
                                alert("Error: Form submission failed because the client isn't initialized. Please try again.");
                                return;
                            }

                            try {
                                // Show loading spinner
                                const loadingOverlay = document.getElementById('loadingOverlay');
                                if (loadingOverlay) {
                                    loadingOverlay.style.display = 'flex';
                                }

                                // Disable create button to prevent double submission
                                const createBtn = document.getElementById('createTracker');
                                if (createBtn) createBtn.disabled = true;

                                // Get subdomain info
                                let subdomainCheck;
                                try {
                                    subdomainCheck = await client.iparams.get("freshdesk_subdomain");
                                    console.log("Subdomain check:", subdomainCheck);
                                    if (!subdomainCheck || !subdomainCheck.freshdesk_subdomain || !subdomainCheck.freshdesk_subdomain.trim()) {
                                        throw new Error("Missing Freshdesk subdomain configuration");
                                    }
                                } catch (configError) {
                                    console.error("Configuration error:", configError);
                                    client.interface.trigger("showNotify", {
                                        type: "danger",
                                        message: "App configuration error: Freshdesk subdomain is missing or invalid."
                                    });
                                    document.getElementById('createTracker').disabled = false;
                                    return;
                                }

                                const subject = document.getElementById('subject').value;
                                const description = generateDescription();
                                const agentEmail = document.getElementById('email').value || "agent@freshdesk.com";
                                const relatedTicketsStr = document.getElementById('relatedTickets').value;
                                const priority = document.getElementById('priority').value;
                                const status = document.getElementById('status').value;

                                // Get screenshots from the global helper or fallback to empty array
                                const screenshotFiles = window.ticketFormHelpers ?
                                    window.ticketFormHelpers.getAttachments() :
                                    (window.aggregatedScreenshotFiles || []);

                                const groupId = document.getElementById('groupField').value;
                                const agentId = document.getElementById('agentField').value;

                                // Get the product value but DON'T add it as a custom field
                                const productImpacted = document.getElementById('productImpacted') ?
                                    (document.getElementById('productImpacted').dataset.fullValue ||
                                        document.getElementById('productImpacted').value || '') : '';

                                const relatedTicketIds = relatedTicketsStr.split(',')
                                    .map(id => id.trim())
                                    .filter(id => id !== '' && !isNaN(parseInt(id, 10)))
                                    .map(id => parseInt(id, 10));

                                if (relatedTicketIds.length === 0) {
                                    alert('Please enter at least one valid related ticket ID');

                                    // Hide spinner if visible
                                    if (loadingOverlay) {
                                        loadingOverlay.style.display = 'none';
                                    }

                                    if (createBtn) createBtn.disabled = false;
                                    return;
                                }

                                console.log("Form values:", {
                                    subject,
                                    description: description.substring(0, 50) + "...",
                                    email: agentEmail,
                                    relatedTickets: relatedTicketsStr,
                                    relatedTicketIds: relatedTicketIds,
                                    priority,
                                    status,
                                    groupId,
                                    agentId,
                                    productImpacted,
                                    attachments: screenshotFiles.length > 0 ? `${screenshotFiles.length} files selected` : 'No files'
                                });

                                // STEP 1: First create the ticket without attachments
                                const ticketData = {
                                    email: agentEmail,
                                    subject: subject,
                                    description: description,
                                    related_ticket_ids: relatedTicketIds,
                                    priority: parseInt(priority, 10),
                                    status: parseInt(status, 10),
                                    type: "Incident",
                                    source: 101  // Setting source to "internal" (101)
                                };

                                // Add district field to ticket data
                                const districtField = document.getElementById('districtField');
                                if (districtField && districtField.value) {
                                    ticketData.custom_fields = ticketData.custom_fields || {};
                                    ticketData.custom_fields.cf_district509811 = districtField.value;
                                    ticketData.custom_fields.cf_district = districtField.value; // Set both for compatibility
                                }

                                // Add group ID if selected
                                if (groupId) {
                                    ticketData.group_id = parseInt(groupId, 10);
                                    console.log(`Setting group_id: ${groupId}`);
                                }

                                // Add agent ID if selected
                                if (agentId) {
                                    ticketData.responder_id = parseInt(agentId, 10);
                                    console.log(`Setting responder_id: ${agentId}`);
                                }

                                console.log("Creating ticket with data:", ticketData);

                                // Update spinner message if it exists
                                const spinnerMessage = loadingOverlay ? loadingOverlay.querySelector('.spinner-text') : null;
                                if (spinnerMessage) {
                                    spinnerMessage.textContent = "Creating tracker ticket...";
                                }

                                const createResponse = await client.request.invokeTemplate("createfdTicket", {
                                    body: JSON.stringify(ticketData)
                                });

                                const newTicket = JSON.parse(createResponse.response);
                                console.log("Created ticket:", newTicket);
                                const newTicketId = newTicket.id;

                                if (!newTicketId) {
                                    throw new Error("Failed to get ID of newly created ticket");
                                }

                                // Get ticket URL for opening in new tab
                                const subdomain = subdomainCheck.freshdesk_subdomain || "benchmarkeducationcompany";
                                const newTicketUrl = `https://${subdomain}.freshdesk.com/a/tickets/${newTicketId}`;

                                // STEP 2: Add attachments as a private note to the ticket if there are any
                                if (screenshotFiles && screenshotFiles.length > 0) {
                                    console.log(`Adding ${screenshotFiles.length} attachments as note to ticket #${newTicketId}`);

                                    // Update spinner message if it exists
                                    if (spinnerMessage) {
                                        spinnerMessage.textContent = `Adding ${screenshotFiles.length} attachments...`;
                                    }

                                    try {
                                        // API credentials
                                        const subdomain = "benchmarkeducationcompany";
                                        const apiKey = "5TMgbcZdRFY70hSpEdj";

                                        console.log(`Using subdomain: ${subdomain} to upload attachments`);

                                        // Create FormData for the attachment upload
                                        const formData = new FormData();
                                        formData.append('body', 'Additional Screenshots and other file attachments');
                                        formData.append('private', 'true');

                                        // Add each file to the form data
                                        for (let i = 0; i < screenshotFiles.length; i++) {
                                            const file = screenshotFiles[i];
                                            formData.append('attachments[]', file, file.name);
                                        }

                                        // Use XMLHttpRequest for direct API access
                                        const xhr = new XMLHttpRequest();
                                        xhr.open('POST', `https://${subdomain}.freshdesk.com/api/v2/tickets/${newTicketId}/notes`, true);

                                        // Set up Basic Auth using the API key
                                        xhr.setRequestHeader('Authorization', 'Basic ' + btoa(`${apiKey}:X`));

                                        // Handle response
                                        xhr.onload = function () {
                                            if (xhr.status >= 200 && xhr.status < 300) {
                                                console.log("Attachments added successfully:", xhr.responseText);
                                                client.interface.trigger("showNotify", {
                                                    type: "success",
                                                    message: `Tracker #${newTicketId} created successfully with attachment`
                                                });
                                            } else {
                                                console.error("Error from API:", xhr.status, xhr.responseText);
                                                client.interface.trigger("showNotify", {
                                                    type: "warning",
                                                    message: `Tracker #${newTicketId} created, but attachment upload failed`
                                                });
                                            }
                                            // Close the modal with a slight delay
                                            setTimeout(() => {
                                                if (loadingOverlay) loadingOverlay.style.display = 'none';
                                                client.instance.close({ refreshTickets: true });
                                            }, 300);
                                        };

                                        // Handle network errors
                                        xhr.onerror = function () {
                                            console.error("Network error while uploading attachments");
                                            client.interface.trigger("showNotify", {
                                                type: "warning",
                                                message: `Tracker #${newTicketId} created, but attachment upload failed due to network error`
                                            });
                                            // Close modal after a delay
                                            setTimeout(() => {
                                                if (loadingOverlay) loadingOverlay.style.display = 'none';
                                                client.instance.close({ refreshTickets: true });
                                            }, 300);
                                        };

                                        // Send the form data
                                        xhr.send(formData);
                                        console.log("Attachment request sent via direct XMLHttpRequest");

                                    } catch (attachmentError) {
                                        // Log attachment error but don't fail the overall process
                                        console.error("Error adding attachments as note:", attachmentError);
                                        console.warn("Continuing without attachments");

                                        client.interface.trigger("showNotify", {
                                            type: "warning",
                                            message: `Tracker #${newTicketId} created, but attachment handling failed: ${attachmentError.message}`
                                        });
                                        // Close modal after a delay
                                        setTimeout(() => {
                                            if (loadingOverlay) loadingOverlay.style.display = 'none';
                                            client.instance.close({ refreshTickets: true });
                                        }, 300);
                                    }
                                } else {
                                    // No attachments, just show success and open the new ticket
                                    client.interface.trigger("showNotify", {
                                        type: "success",
                                        message: `Tracker #${newTicketId} created successfully`
                                    });

                                    // Open the new ticket in a new tab
                                    window.open(newTicketUrl, '_blank');

                                    // Close the modal with a slight delay
                                    setTimeout(() => {
                                        if (loadingOverlay) loadingOverlay.style.display = 'none';
                                        client.instance.close({ refreshTickets: true });
                                    }, 300);
                                }
                            } catch (error) {
                                console.error("Error creating tracker:", error);
                                console.error("Error details:", JSON.stringify(error, null, 2));

                                let errorMessage = "Failed to create tracker: ";
                                if (error.response) {
                                    console.log("Raw error response:", error.response);
                                    try {
                                        const errorData = JSON.parse(error.response);
                                        console.log("Parsed error data:", errorData);
                                        errorMessage += errorData.description || error.response;
                                    } catch (e) {
                                        errorMessage += error.response;
                                    }
                                } else if (error.errors && error.errors.length) {
                                    errorMessage += error.errors.map(e => e.message || JSON.stringify(e)).join("; ");
                                } else {
                                    errorMessage += error.message || "Unknown error";
                                }

                                client.interface.trigger("showNotify", {
                                    type: "danger",
                                    message: errorMessage
                                });

                                // Hide loading spinner if it exists
                                const loadingOverlay = document.getElementById('loadingOverlay');
                                if (loadingOverlay) {
                                    loadingOverlay.style.display = 'none';
                                }

                                const createButton = document.getElementById('createTracker');
                                if (createButton) createButton.disabled = false;
                            }
                        }

                        function generateDescription() {
                            // Get values from Quill editors
                            const reportedIssue = reportedIssueQuill ? reportedIssueQuill.root.innerText : '';
                            const stepsToReproduce = stepsToReproduceQuill ? stepsToReproduceQuill.root.innerText : '';
                            const expectedResults = expectedResultsQuill ? expectedResultsQuill.root.innerText : '';

                            // Get values from form fields
                            const subject = document.getElementById('subject').value.trim();
                            const username = document.getElementById('username').value.trim();
                            const role = document.getElementById('impactedRole').value;
                            const studentId = document.getElementById('studentId').value.trim();
                            const techAdminLink = document.getElementById('techAdminLink').value.trim();
                            const device = document.getElementById('device').value.trim();
                            const realm = document.getElementById('realm').value.trim();
                            const assignmentId = document.getElementById('assignmentId').value.trim();
                            const dateReported = document.getElementById('dateReported').value;
                            const harFile = document.getElementById('harFile').value;
                            const harReason = document.getElementById('harReason').value.trim();
                            const districtName = document.getElementById('districtName').value.trim();
                            const application = document.getElementById('application').value.trim();
                            const specificIssue = document.getElementById('specificIssue').value.trim();
                            const vipStatus = document.getElementById('vipStatus').value;

                            // Resource info
                            const xcodeInfo = document.getElementById('xcodeInfo').value.trim();
                            const resourceTitle = document.getElementById('resourceTitle').value.trim();

                            let formattedDate = '';
                            if (dateReported) {
                                const date = new Date(dateReported);
                                formattedDate = date.toLocaleDateString('en-US', {
                                    year: 'numeric', month: 'long', day: 'numeric'
                                });
                            }

                            // Create plain text description
                            let description = '';

                            // SUMMARY section
                            description += 'SUMMARY\n';
                            description += `${specificIssue}\n\n`;

                            // DESCRIPTION section
                            description += 'DESCRIPTION\n';
                            description += `Issue: ${specificIssue || ''}\n`;
                            description += `District Name: ${districtName || ''}\n`;
                            if (username) description += `Username: ${username}\n`;
                            if (role) description += `Role: ${role}\n`;
                            description += `Program/Product Impacted: ${application || ''}\n`;
                            if (xcodeInfo) description += `Resource xcode: ${xcodeInfo}\n`;
                            if (resourceTitle) description += `Resource title: ${resourceTitle}\n`;
                            if (formattedDate) description += `Date issue reported by user: ${formattedDate}\n`;
                            if (device) description += `Device: ${device}\n`;
                            if (realm) description += `Realm: ${realm}\n`;
                            if (studentId) description += `Student Internal ID: ${studentId}\n`;
                            if (assignmentId) description += `Assignment ID: ${assignmentId}\n`;
                            description += `VIP Customer: (${vipStatus})\n\n`;

                            // ISSUE DETAILS section
                            if (reportedIssue) {
                                description += 'ISSUE DETAILS\n';
                                description += `${reportedIssue}\n\n`;
                            }

                            // STEPS TO REPRODUCE section
                            if (stepsToReproduce) {
                                description += 'STEPS TO REPRODUCE\n';
                                description += `${stepsToReproduce}\n\n`;
                            }

                            // EXPECTED RESULTS section
                            if (expectedResults) {
                                description += 'EXPECTED RESULTS\n';
                                description += `${expectedResults}\n\n`;
                            }

                            // ADDITIONAL INFO section
                            description += 'ADDITIONAL INFO\n';
                            if (techAdminLink) description += `Tech Admin link: ${techAdminLink}\n`;

                            // HAR file info
                            let harInfo = harFile;
                            if (harFile === 'No' && harReason) {
                                harInfo += `: ${harReason}`;
                            }
                            description += `HAR file attached: ${harInfo}\n`;

                            return description;
                        }


                        // Make sure handleSubmitForm is accessible
                        window.handleSubmitForm = handleSubmitForm;



                        // Modify trySafelySetupSubjectGeneration to account for the removed User Role field
                        function trySafelySetupSubjectGeneration() {
                            try {
                                // Check if all required elements exist before setting up
                                const applicationEl = safeGetElement('application');
                                const specificIssueEl = safeGetElement('specificIssue');
                                const vipStatusEl = safeGetElement('vipStatus');
                                const districtNameEl = safeGetElement('districtName');
                                const subjectEl = safeGetElement('subject');

                                if (!applicationEl || !specificIssueEl ||
                                    !vipStatusEl || !districtNameEl || !subjectEl) {
                                    console.warn("Not all elements required for subject generation exist");
                                    return false;
                                }

                                // Set up event listeners for subject generation
                                applicationEl.addEventListener('input', generateSubject);
                                specificIssueEl.addEventListener('input', generateSubject);
                                vipStatusEl.addEventListener('change', generateSubject);
                                districtNameEl.addEventListener('input', generateSubject);

                                // Generate initial subject
                                generateSubject();
                                return true;
                            } catch (error) {
                                console.error("Error setting up subject generation:", error);
                                return false;
                            }
                        }

                        // Update generateSubject to work without User Role field
                        function generateSubject() {
                            try {
                                const vipStatusEl = safeGetElement('vipStatus');
                                const districtNameEl = safeGetElement('districtName');
                                const applicationEl = safeGetElement('application');
                                const specificIssueEl = safeGetElement('specificIssue');
                                const subjectEl = safeGetElement('subject');

                                if (!vipStatusEl || !districtNameEl || !applicationEl ||
                                    !specificIssueEl || !subjectEl) {
                                    console.warn("Cannot find required fields for subject generation");
                                    return;
                                }

                                const vipStatus = vipStatusEl.value;
                                const districtName = districtNameEl.value.trim();
                                const application = applicationEl.value.trim();
                                const specificIssue = specificIssueEl.value.trim();

                                let subject = '';

                                if (vipStatus === 'Yes') {
                                    subject = 'VIP* ';
                                }

                                if (districtName) {
                                    subject += districtName;
                                }

                                if (application) {
                                    subject += ' | ' + application;
                                }

                                if (specificIssue) {
                                    subject += ' - ' + specificIssue;
                                }

                                // Removed the User Role part

                                subjectEl.value = subject;
                            } catch (error) {
                                console.error("Error generating subject:", error);
                            }
                        }


                    }


                });
            </script>
            <script>
                // This script fixes the remaining issues in the SIM Assignment form

                document.addEventListener('DOMContentLoaded', function () {
                    // 1. Fix for handleSubmitForm not defined error
                    // We'll define it in the global scope and fix its implementation
                    window.handleSubmitForm = async function (e) {
                        e.preventDefault();

                        // Check if client is available
                        if (!window.client) {
                            console.error("Client not initialized. Cannot submit form.");
                            alert("Error: Form submission failed because the client isn't initialized. Please try again.");
                            return;
                        }

                        try {
                            // Get subdomain info
                            let subdomainCheck;
                            try {
                                subdomainCheck = await window.client.iparams.get("freshdesk_subdomain");
                                console.log("Subdomain check:", subdomainCheck);
                                if (!subdomainCheck || !subdomainCheck.freshdesk_subdomain || !subdomainCheck.freshdesk_subdomain.trim()) {
                                    throw new Error("Missing Freshdesk subdomain configuration");
                                }
                            } catch (configError) {
                                console.error("Configuration error:", configError);
                                window.client.interface.trigger("showNotify", {
                                    type: "danger",
                                    message: "App configuration error: Freshdesk subdomain is missing or invalid."
                                });
                                const createBtn = document.getElementById('createTracker');
                                if (createBtn) createBtn.disabled = false;
                                return;
                            }

                            // Get form field values
                            const subject = document.getElementById('subject').value;

                            // Generate the description HTML
                            const description = generateDescription();

                            const agentEmail = document.getElementById('email').value || "agent@freshdesk.com";
                            const relatedTicketsStr = document.getElementById('relatedTickets').value;
                            const priority = document.getElementById('priority').value;
                            const status = document.getElementById('status').value;

                            // Get screenshots from the ticketFormHelpers
                            const screenshotFiles = window.ticketFormHelpers ?
                                window.ticketFormHelpers.getAttachments() :
                                (window.aggregatedScreenshotFiles || []);

                            const groupId = document.getElementById('groupField').value;
                            const agentId = document.getElementById('agentField').value;

                            // Handle related ticket IDs
                            const relatedTicketIds = relatedTicketsStr.split(',')
                                .map(id => id.trim())
                                .filter(id => id !== '' && !isNaN(parseInt(id, 10)))
                                .map(id => parseInt(id, 10));

                            if (relatedTicketIds.length === 0) {
                                alert('Please enter at least one valid related ticket ID');
                                return;
                            }

                            console.log("Form values:", {
                                subject,
                                description: description.substring(0, 50) + "...",
                                email: agentEmail,
                                relatedTickets: relatedTicketsStr,
                                relatedTicketIds: relatedTicketIds,
                                priority,
                                status,
                                groupId,
                                agentId,
                                attachments: screenshotFiles.length > 0 ? `${screenshotFiles.length} files selected` : 'No files'
                            });

                            // Create the ticket data object
                            const ticketData = {
                                email: agentEmail,
                                subject: subject,
                                description: description,
                                related_ticket_ids: relatedTicketIds,
                                priority: parseInt(priority, 10),
                                status: parseInt(status, 10),
                                type: "Incident",
                                source: 101  // Setting source to "internal" (101)
                            };

                            // Add district field to ticket data
                            const districtField = document.getElementById('districtField');
                            if (districtField && districtField.value) {
                                ticketData.custom_fields = ticketData.custom_fields || {};
                                ticketData.custom_fields.cf_district509811 = districtField.value;
                                ticketData.custom_fields.cf_district = districtField.value; // Set both for compatibility
                            }

                            // Add group ID if selected
                            if (groupId) {
                                ticketData.group_id = parseInt(groupId, 10);
                                console.log(`Setting group_id: ${groupId}`);
                            }

                            // Add agent ID if selected
                            if (agentId) {
                                ticketData.responder_id = parseInt(agentId, 10);
                                console.log(`Setting responder_id: ${agentId}`);
                            }

                            console.log("Creating ticket with data:", ticketData);

                            // Create the ticket
                            const createResponse = await window.client.request.invokeTemplate("createfdTicket", {
                                body: JSON.stringify(ticketData)
                            });

                            const newTicket = JSON.parse(createResponse.response);
                            console.log("Created ticket:", newTicket);
                            const newTicketId = newTicket.id;

                            if (!newTicketId) {
                                throw new Error("Failed to get ID of newly created ticket");
                            }

                            // Add attachments if there are any
                            if (screenshotFiles && screenshotFiles.length > 0) {
                                console.log(`Adding ${screenshotFiles.length} attachments as note to ticket #${newTicketId}`);

                                try {
                                    // API credentials - these should be configured in your app settings
                                    const subdomain = "benchmarkeducationcompany"; // This should come from your configuration
                                    const apiKey = "5TMgbcZdRFY70hSpEdj"; // This should come from your configuration

                                    console.log(`Using subdomain: ${subdomain} to upload attachments`);

                                    // Create FormData for the attachment upload
                                    const formData = new FormData();
                                    formData.append('body', 'Additional Screenshots and other file attachments');
                                    formData.append('private', 'true');

                                    // Add each file to the form data
                                    for (let i = 0; i < screenshotFiles.length; i++) {
                                        const file = screenshotFiles[i];
                                        formData.append('attachments[]', file, file.name);
                                    }

                                    // Use XMLHttpRequest for direct API access
                                    const xhr = new XMLHttpRequest();
                                    xhr.open('POST', `https://${subdomain}.freshdesk.com/api/v2/tickets/${newTicketId}/notes`, true);

                                    // Set up Basic Auth using the API key
                                    xhr.setRequestHeader('Authorization', 'Basic ' + btoa(`${apiKey}:X`));

                                    // Handle response
                                    xhr.onload = function () {
                                        if (xhr.status >= 200 && xhr.status < 300) {
                                            console.log("Attachments added successfully:", xhr.responseText);
                                            window.client.interface.trigger("showNotify", {
                                                type: "success",
                                                message: `Tracker #${newTicketId} created successfully with attachment`
                                            });
                                        } else {
                                            console.error("Error from API:", xhr.status, xhr.responseText);
                                            window.client.interface.trigger("showNotify", {
                                                type: "warning",
                                                message: `Tracker #${newTicketId} created, but attachment upload failed`
                                            });
                                        }
                                        // Close the modal in either case
                                        window.client.instance.close({ refreshTickets: true });
                                    };

                                    // Handle network errors
                                    xhr.onerror = function () {
                                        console.error("Network error while uploading attachments");
                                        window.client.interface.trigger("showNotify", {
                                            type: "warning",
                                            message: `Tracker #${newTicketId} created, but attachment upload failed due to network error`
                                        });
                                        window.client.instance.close({ refreshTickets: true });
                                    };

                                    // Send the form data
                                    xhr.send(formData);
                                    console.log("Attachment request sent via direct XMLHttpRequest");

                                } catch (attachmentError) {
                                    // Log attachment error but don't fail the overall process
                                    console.error("Error adding attachments as note:", attachmentError);
                                    console.warn("Continuing without attachments");

                                    window.client.interface.trigger("showNotify", {
                                        type: "warning",
                                        message: `Tracker #${newTicketId} created, but attachment handling failed: ${attachmentError.message}`
                                    });
                                    window.client.instance.close({ refreshTickets: true });
                                }
                            } else {
                                // No attachments, just show success and close
                                window.client.interface.trigger("showNotify", {
                                    type: "success",
                                    message: `Tracker #${newTicketId} created successfully`
                                });
                                window.client.instance.close({ refreshTickets: true });
                            }
                        } catch (error) {
                            console.error("Error creating tracker:", error);
                            console.error("Error details:", JSON.stringify(error, null, 2));

                            let errorMessage = "Failed to create tracker: ";
                            if (error.response) {
                                console.log("Raw error response:", error.response);
                                try {
                                    const errorData = JSON.parse(error.response);
                                    console.log("Parsed error data:", errorData);
                                    errorMessage += errorData.description || error.response;
                                } catch (e) {
                                    errorMessage += error.response;
                                }
                            } else if (error.errors && error.errors.length) {
                                errorMessage += error.errors.map(e => e.message || JSON.stringify(e)).join("; ");
                            } else {
                                errorMessage += error.message || "Unknown error";
                            }

                            if (window.client) {
                                window.client.interface.trigger("showNotify", {
                                    type: "danger",
                                    message: errorMessage
                                });
                            } else {
                                alert("Error creating tracker: " + errorMessage);
                            }

                            const createButton = document.getElementById('createTracker');
                            if (createButton) createButton.disabled = false;
                        }
                    };

                });
            </script>

</body>

</html>