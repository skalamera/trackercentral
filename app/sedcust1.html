<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script async src="{{{appclient}}}"></script>
    <link rel="stylesheet" type="text/css" href="styles/style.css" />
    <link rel="stylesheet" type="text/css" href="styles/modal.css" />
    <link rel="stylesheet" type="text/css" href="styles/filepreview.css" />
    <link rel="stylesheet" type="text/css" href="styles/sedcust.css" />
    <link rel="stylesheet" type="text/css" href="styles/spinner.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Add Quill CSS and JS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<style>
    div.card-header {
        background-color: #2C3E50;
        color: white
       }
</style>

</head>

<body>
    <!-- Add the loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="spinner-text">Creating ticket...</div>
    </div>

    <div class="tracker-form-container">
        <div class="tracker-form-container">
            <!-- Add Debug Button at the top -->
            <div class="debug-container">
                <button id="debugFillForm" class="debug-button">Fill Form with Demo Data</button>
            </div>
            <!-- Replace the existing form-title div -->
            <div class="form-title">
                <h2>Content/Editorial Tracker</h2>
            </div>

            <div class="back-button-container">
                <fw-button id="backButton" color="secondary" size="small"
                    style="cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"
                    onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                    <i class="fas fa-arrow-left" style="margin-right: 8px;"></i>Back to Tracker Templates
                </fw-button>
            </div>
            <form id="trackerForm">
                <div class="cards-container">
                    <!-- Subject card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-pen-fancy fa-lg section-icon"></i>
                            <h3>SUBJECT</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="subject" class="required-field">Subject</label>
                                <input type="text" id="subject" name="subject" required>
                                <div class="hint"><i class="fas fa-info-circle"></i> Format: XCODE | Application Name |
                                    Resource
                                    Name > Grade > Unit > Week > Day > Lesson - Short Description of Issue</div>
                            </div>

                            <div class="form-group">
                                <label for="xcode" class="required-field">XCODE</label>
                                <input type="text" id="xcode" name="xcode" required placeholder="e.g. X56723">
                                <div class="hint"><i class="fas fa-info-circle"></i> Xcode for this resource</div>
                            </div>

                            <div class="form-group">
                                <label for="application" class="required-field">Application Name</label>
                                <input type="text" id="application" name="application" required
                                    placeholder="e.g. BAdvance -c2022">
                                <div class="hint"><i class="fas fa-info-circle"></i> The application or program name
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="resourcePath" class="required-field">Resource Path</label>
                                <input type="text" id="resourcePath" name="resourcePath" required
                                    placeholder="e.g. TRS: G5>U1>TRS>W2>L12">
                                <div class="hint"><i class="fas fa-info-circle"></i> Resource path with Grade > Unit >
                                    Week
                                    > Day >
                                    Lesson</div>
                            </div>

                            <div class="form-group">
                                <label for="specificIssue" class="required-field">Specific Issue</label>
                                <input type="text" id="specificIssue" name="specificIssue" required
                                    placeholder="e.g. Title Missing">
                                <div class="hint"><i class="fas fa-info-circle"></i> Brief description of the specific
                                    issue
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-file-alt fa-lg section-icon"></i>
                            <h3>SUMMARY</h3>
                        </div>
                        <div class="card-body">
                            <div class="quill-editor-container">
                                <div id="issueSummaryEditor" style="height: 120px; background-color: white;"></div>
                                <textarea id="issueSummary" name="issueSummary" style="display: none;"></textarea>
                            </div>
                            <div class="hint"><i class="fas fa-lightbulb"></i> Provide a clear, concise summary of the
                                issue
                            </div>
                        </div>
                    </div>

                    <!-- Issue Details card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-clipboard-list fa-lg section-icon"></i>
                            <h3>ISSUE DETAILS</h3>
                        </div>
                        <div class="card-body">
                            <div class="quill-editor-container">
                                <div id="issueDetailsEditor" style="height: 150px; background-color: white;"></div>
                                <textarea id="issueDetails" name="issueDetails" style="display: none;"></textarea>
                            </div>
                            <div class="hint"><i class="fas fa-info-circle"></i> Detailed description of the issue</div>
                        </div>
                    </div>

                    <!-- Impacted User Info card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-user fa-lg section-icon"></i>
                            <h3>IMPACTED USER INFO</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="isVIP">VIP Customer:</label>
                                    <select id="isVIP" name="isVIP">
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Is this a VIP customer?</div>
                                </div>

                                <div class="form-group">
                                    <label for="username">Username:</label>
                                    <input type="text" id="username" name="username" placeholder="e.g. j.smith">
                                    <div class="hint"><i class="fas fa-info-circle"></i> User's login username</div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="userEmail">Email:</label>
                                    <input type="email" id="userEmail" name="userEmail"
                                        placeholder="e.g. john.smith@school.edu">
                                    <div class="hint"><i class="fas fa-info-circle"></i> User's email address</div>
                                </div>

                                <div class="form-group">
                                    <label for="userRole">Role:</label>
                                    <select id="userRole" name="userRole">
                                        <option value="">-- Select --</option>
                                        <option value="Teacher">Teacher</option>
                                        <option value="Student">Student</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Other">Other</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> User's role in the system</div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="productImpacted">Application/Program Impacted:</label>
                                <select id="productImpacted" name="productImpacted">
                                    <!-- Options will be loaded from the custom field cf_product_type -->
                                </select>
                                <div class="hint"><i class="fas fa-info-circle"></i> Select the application or program
                                    impacted
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="xcodeInfo">Xcode:</label>
                                    <input type="text" id="xcodeInfo" name="xcodeInfo">
                                    <div class="hint"><i class="fas fa-info-circle"></i> Xcode for the resource</div>
                                </div>

                                <div class="form-group">
                                    <label for="districtState">District state:</label>
                                    <input type="text" id="districtState" name="districtState">
                                    <div class="hint"><i class="fas fa-info-circle"></i> State where the district is
                                        located
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="impactType">Digital and/or Print Impact:</label>
                                    <select id="impactType" name="impactType">
                                        <option value="">-- Select --</option>
                                        <option value="Digital Only">Digital Only</option>
                                        <option value="Print Only">Print Only</option>
                                        <option value="Both Digital and Print">Both Digital and Print</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Type of materials affected
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="dateReported">Date Issue reported by user:</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-calendar-alt icon-prefix"></i>
                                        <input type="date" id="dateReported" name="dateReported">
                                    </div>
                                    <div class="hint"><i class="fas fa-info-circle"></i> When the user reported this
                                        issue
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="impactScope">Teacher and/or Student impact:</label>
                                    <select id="impactScope" name="impactScope">
                                        <option value="">-- Select --</option>
                                        <option value="Teacher Only">Teacher Only</option>
                                        <option value="Student Only">Student Only</option>
                                        <option value="Both Teacher and Student">Both Teacher and Student</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Who is affected by this issue
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Program Components card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-puzzle-piece fa-lg section-icon"></i>
                            <h3>PROGRAM COMPONENTS</h3>
                        </div>
                        <div class="card-body">
                            <div class="quill-editor-container">
                                <div id="componentsEditor" style="height: 100px; background-color: white;"></div>
                                <textarea id="components" name="components" style="display: none;"></textarea>
                            </div>
                            <div class="hint"><i class="fas fa-info-circle"></i> Enter program components affected by
                                this
                                issue
                            </div>
                        </div>
                    </div>

                    <!-- Steps to Reproduce card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-list-ol fa-lg section-icon"></i>
                            <h3>STEPS TO REPRODUCE</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="pathField">Path:</label>
                                <input type="text" id="pathField" name="pathField"
                                    placeholder="e.g. Login > Click Resources > Select Grade 5">
                                <div class="hint"><i class="fas fa-info-circle"></i> Navigation path to reproduce the
                                    issue
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="actualResultsEditor">Actual results:</label>
                                <div id="actualResultsEditor" style="height: 100px; background-color: white;"></div>
                                <textarea id="actualResults" name="actualResults" style="display: none;"></textarea>
                                <div class="hint"><i class="fas fa-info-circle"></i> (screenshots and/or videos should
                                    include the
                                    URL in screen capture)</div>
                            </div>

                            <div class="form-group">
                                <label for="expectedResultsEditor">Expected results:</label>
                                <div id="expectedResultsEditor" style="height: 100px; background-color: white;"></div>
                                <textarea id="expectedResults" name="expectedResults" style="display: none;"></textarea>
                                <div class="hint"><i class="fas fa-info-circle"></i> What should have happened instead
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ticket Properties card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-tasks fa-lg section-icon"></i>
                            <h3>TICKET PROPERTIES</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="email" class="required-field">Requester Email</label>
                                <div class="input-with-icon">
                                    <input type="email" id="email" name="email" required>
                                </div>
                                <div class="hint"><i class="fas fa-info-circle"></i> This ticket will be created by you
                                    (the
                                    logged-in agent)</div>
                                <div id="emailStatus" class="email-status"></div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="relatedTickets" class="required-field">Related Ticket IDs</label>
                                    <div class="input-with-icon">
                                        <input type="text" id="relatedTickets" name="relatedTickets" required>
                                    </div>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Comma-separated ticket IDs
                                        (e.g.,
                                        1,2,3)
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="priority">Priority</label>
                                    <select id="priority" name="priority">
                                        <option value="1">Low</option>
                                        <option value="2">Medium</option>
                                        <option value="3">High</option>
                                        <option value="4">Urgent</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Select ticket priority</div>
                                </div>

                                <div class="form-group">
                                    <label for="status">Status</label>
                                    <select id="status" name="status">
                                        <option value="2">Open</option>
                                        <option value="3">Pending</option>
                                        <option value="4">Resolved</option>
                                        <option value="5">Closed</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Select ticket status</div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="groupField">Group</label>
                                    <select id="groupField" name="groupField">
                                        <option>Loading groups...</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Select a support group</div>
                                </div>

                                <div class="form-group">
                                    <label for="agentField">Agent</label>
                                    <select id="agentField" name="agentField"></select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Select an agent</div>
                                </div>

                                <div class="form-group">
                                    <label for="districtField">District</label>
                                    <input type="text" id="districtField" name="districtField" readonly>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Auto-populated from source
                                        ticket
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Attachments card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-paperclip fa-lg section-icon"></i>
                            <h3>ATTACHMENTS</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <div class="attachment-input-container">
                                    <div class="custom-file-input">
                                        <div class="file-upload-btn">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <span>Choose files</span>
                                            <input type="file" id="screenshots" name="screenshots" multiple
                                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                                        </div>
                                    </div>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Upload files to include in the
                                        ticket (15MB
                                        total)</div>
                                </div>
                                <div id="screenshotPreview" class="screenshot-preview"></div>
                                <div id="attachmentCounter" class="attachment-counter"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: none;">
                    <textarea id="description" name="description"></textarea>
                </div>

                <div class="form-actions">
                    <fw-button id="cancelTracker" color="secondary" size="medium"
                        style="display: flex; justify-content: center; align-items: center;">
                        <i class="fas fa-times"></i> Cancel
                    </fw-button>
                    <fw-button id="createTracker" color="primary" type="submit" size="medium"
                        style="display: flex; justify-content: center; align-items: center;">
                        <i class="fas fa-check"></i> Create Tracker
                    </fw-button>
                </div>
            </form>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    // Wait for the Freshworks SDK to be available
                    let initRetries = 0;
                    const maxRetries = 10;

                    // Store ticket data from parent
                    let ticketData = {
                        isVip: false,
                        districtName: '',
                        currentTicketId: null,
                        requesterEmail: ''
                    };

                    // Back button functionality
                    const backButton = document.getElementById('backButton');
                    if (backButton) {
                        backButton.addEventListener('click', function () {
                            window.location.href = "template-selector.html";
                        });
                    }

                    function initializeClient() {
                        if (typeof client !== 'undefined') {
                            setupFormHandlers(client);
                        } else if (typeof app !== 'undefined') {
                            app.initialized().then(function (clientObj) {
                                setupFormHandlers(clientObj);
                            }).catch(handleInitError);
                        } else if (typeof window.frsh !== 'undefined' && window.frsh.init) {
                            window.frsh.init().then(function (clientObj) {
                                setupFormHandlers(clientObj);
                            }).catch(handleInitError);
                        } else if (initRetries < maxRetries) {
                            initRetries++;
                            setTimeout(initializeClient, 100);
                        } else {
                            handleInitError(new Error("Could not initialize client after multiple attempts"));
                        }
                    }

                    function handleInitError(error) {
                        console.error("Modal initialization error:", error);
                        document.querySelector('.tracker-form-container').innerHTML =
                            '<div class="error-card">Failed to initialize app client. Please close and try again.</div>';
                    }

                    function setupFormHandlers(client) {
                        window.client = client;
                        console.log("Setting up form handlers");

                        // Add helper functions for localStorage management
                        window.storageManager = {
                            clearAllDistrictData: function () {
                                console.log("🧹 Clearing all cached district data from localStorage");
                                const keysToCheck = ['sourceTicketData', 'sedcustData', 'assemblyData', 'districtCache'];

                                keysToCheck.forEach(key => {
                                    try {
                                        if (localStorage.getItem(key)) {
                                            console.log(`Clearing cached data from ${key}`);
                                            localStorage.removeItem(key);
                                        }
                                    } catch (e) {
                                        console.error(`Error clearing ${key}:`, e);
                                    }
                                });
                            },

                            storeDistrictData: function (districtName, source) {
                                if (!districtName || districtName === "VOLUSIA CO SCHOOL DISTRICT") {
                                    console.log(`⚠️ Not storing invalid district: "${districtName}"`);
                                    return false;
                                }

                                console.log(`✅ Storing valid district: "${districtName}" from ${source}`);

                                // First clear existing data to avoid any merged/old data issues
                                this.clearAllDistrictData();

                                // Then store the new clean data
                                try {
                                    localStorage.setItem('districtCache', JSON.stringify({
                                        districtName: districtName,
                                        timestamp: new Date().getTime(),
                                        source: source
                                    }));
                                    return true;
                                } catch (e) {
                                    console.error("Error storing district data:", e);
                                    return false;
                                }
                            },

                            getDistrictData: function () {
                                try {
                                    const cache = localStorage.getItem('districtCache');
                                    if (cache) {
                                        const data = JSON.parse(cache);

                                        // Check if the data is valid
                                        if (data.districtName && data.districtName !== "VOLUSIA CO SCHOOL DISTRICT") {
                                            console.log(`🔍 Retrieved district from cache: "${data.districtName}" (from ${data.source})`);
                                            return data.districtName;
                                        } else {
                                            console.log("🚫 Invalid district in cache, removing");
                                            localStorage.removeItem('districtCache');
                                        }
                                    }
                                } catch (e) {
                                    console.error("Error getting district data:", e);
                                }
                                return null;
                            }
                        };

                        // Clear all district data at initialization to avoid staleness
                        window.storageManager.clearAllDistrictData();

                        async function getLoggedInUserEmail() {
                            try {
                                console.log("Fetching agent email directly from modal");
                                const userData = await client.data.get("loggedInUser");
                                console.log("Agent data:", userData);
                                if (userData && userData.loggedInUser && userData.loggedInUser.contact && userData.loggedInUser.contact.email) {
                                    const agentEmail = userData.loggedInUser.contact.email;
                                    console.log("Found agent email:", agentEmail);
                                    document.getElementById('email').value = agentEmail;
                                    document.getElementById('emailStatus').innerHTML =
                                        `<span style="color: green">✓ Email loaded: ${agentEmail}</span>`;
                                    return agentEmail;
                                } else {
                                    console.warn("Could not get agent email from userData");
                                    document.getElementById('emailStatus').innerHTML =
                                        '<span style="color: orange">⚠️ Email not found in user data</span>';
                                    return null;
                                }
                            } catch (error) {
                                console.error("Error getting logged-in user data:", error);
                                document.getElementById('emailStatus').innerHTML =
                                    '<span style="color: red">✗ Error loading email</span>';
                                return null;
                            }
                        }

                        async function getAssignedAgentEmail(ticketId) {
                            try {
                                const ticketResponse = await client.request.invokeTemplate("getTicketDetails", {
                                    context: { ticketId: ticketId }
                                });
                                const ticketData = JSON.parse(ticketResponse.response);
                                console.log("Related ticket data:", ticketData);
                                if (!ticketData.responder_id) {
                                    console.warn("Ticket doesn't have an assigned agent");
                                    return null;
                                }
                                const agentResponse = await client.request.invokeTemplate("getAgentDetails", {
                                    context: { agentId: ticketData.responder_id }
                                });
                                const agentData = JSON.parse(agentResponse.response);
                                console.log("Assigned agent data:", agentData);
                                if (agentData && agentData.contact && agentData.contact.email) {
                                    console.log("Found assigned agent email:", agentData.contact.email);
                                    document.getElementById('email').value = agentData.contact.email;
                                    document.getElementById('emailStatus').innerHTML =
                                        `<span style="color: green">✓ Using assigned agent's email: ${agentData.contact.email}</span>`;
                                    return agentData.contact.email;
                                } else {
                                    console.warn("Could not get assigned agent email");
                                    return null;
                                }
                            } catch (error) {
                                console.error("Error getting assigned agent email:", error);
                                return null;
                            }
                        }

                        client.instance.context().then(async function (context) {
                            console.log("Modal context:", context);
                            if (context && context.data) {
                                ticketData = {
                                    isVip: context.data.isVip || false,
                                    districtName: context.data.districtName || '',
                                    currentTicketId: context.data.currentTicketId || null,
                                    requesterEmail: context.data.requesterEmail || '',
                                    ticketRequesterEmail: context.data.ticketRequesterEmail || ''
                                };
                                console.log("Received ticket data:", ticketData);

                                // Set VIP dropdown based on ticket data
                                if (ticketData.isVip) {
                                    document.getElementById('isVIP').value = 'Yes';
                                } else {
                                    document.getElementById('isVIP').value = 'No';
                                }

                                // MODIFIED: Check if context provides a valid district name
                                if (ticketData.districtName && ticketData.districtName !== "VOLUSIA CO SCHOOL DISTRICT") {
                                    console.log("Setting district from context:", ticketData.districtName);
                                    document.getElementById('districtField').value = ticketData.districtName;

                                    // Store in our centralized cache
                                    window.storageManager.storeDistrictData(ticketData.districtName, 'context');
                                } else {
                                    // Use the enhanced function to populate district field
                                    await populateDistrictField();
                                }

                                if (ticketData.currentTicketId) {
                                    document.getElementById('relatedTickets').value = ticketData.currentTicketId;
                                    const assignedAgentEmail = await getAssignedAgentEmail(ticketData.currentTicketId);
                                    if (!assignedAgentEmail) {
                                        await getLoggedInUserEmail();
                                    }
                                } else {
                                    await getLoggedInUserEmail();
                                }

                                // Auto-populate ticket fields from source ticket
                                populateTicketFields();

                                const today = new Date().toISOString().split('T')[0];
                                document.getElementById('dateReported').value = today;
                            } else {
                                console.log("No context data, fetching agent email directly");
                                await getLoggedInUserEmail();
                                await populateDistrictField();
                                populateTicketFields();
                                const today = new Date().toISOString().split('T')[0];
                                document.getElementById('dateReported').value = today;
                            }
                            setupSubjectGeneration();
                        }).catch(async function (error) {
                            console.error("Error getting modal context:", error);
                            await getLoggedInUserEmail();
                            await populateDistrictField();
                            populateTicketFields();
                            setupSubjectGeneration();
                        });

                        if (!document.getElementById('email').value) {
                            document.getElementById('email').value = "freshdesk_agent@example.com";
                            document.getElementById('emailStatus').innerHTML =
                                '<span style="color: blue">ℹ️ Using placeholder email</span>';
                        }

                        function setupSubjectGeneration() {
                            const xcodeField = document.getElementById('xcode');
                            const applicationField = document.getElementById('application');
                            const resourcePathField = document.getElementById('resourcePath');
                            const specificIssueField = document.getElementById('specificIssue');

                            xcodeField.addEventListener('input', generateSubject);
                            applicationField.addEventListener('input', generateSubject);
                            resourcePathField.addEventListener('input', generateSubject);
                            specificIssueField.addEventListener('input', generateSubject);

                            generateSubject();
                        }

                        // Update the generateSubject function
                        function generateSubject() {
                            const xcode = document.getElementById('xcode').value.trim();
                            const application = document.getElementById('application').value.trim();
                            const resourcePath = document.getElementById('resourcePath').value.trim();
                            const specificIssue = document.getElementById('specificIssue').value.trim();

                            // Format: XCODE | Application Name | Resource Name > Grade > Unit > Week > Day > Lesson - Short Description of Issue
                            let subject = '';

                            if (xcode) {
                                subject += xcode;
                            }

                            if (application) {
                                subject += ' | ' + application;
                            }

                            if (resourcePath) {
                                subject += ' | ' + resourcePath;
                            }

                            if (specificIssue) {
                                subject += ' | ' + specificIssue;
                            }

                            document.getElementById('subject').value = subject;
                        }
                        function generateDescription() {
                            const issueSummary = document.getElementById('issueSummary').value.trim();

                            // User info fields
                            const isVIP = document.getElementById('isVIP').value;
                            const username = document.getElementById('username').value.trim();
                            const userEmail = document.getElementById('userEmail').value.trim();
                            const userRole = document.getElementById('userRole').value;

                            // Get the product value
                            const productImpacted = document.getElementById('productImpacted').dataset.fullValue ||
                                document.getElementById('productImpacted').value || '';

                            // Other fields
                            const xcodeInfo = document.getElementById('xcodeInfo').value.trim();
                            const districtState = document.getElementById('districtState').value.trim();
                            const impactType = document.getElementById('impactType').value;
                            const dateReported = document.getElementById('dateReported').value;
                            const impactScope = document.getElementById('impactScope').value;
                            const components = document.getElementById('components').value.trim();
                            const pathField = document.getElementById('pathField').value.trim();
                            const actualResults = document.getElementById('actualResults').value.trim();
                            const expectedResults = document.getElementById('expectedResults').value.trim();
                            const issueDetails = document.getElementById('issueDetails').value.trim();

                            let formattedDate = '';
                            if (dateReported) {
                                const date = new Date(dateReported);
                                formattedDate = date.toLocaleDateString('en-US', {
                                    year: 'numeric', month: 'long', day: 'numeric'
                                });
                            }

                            let description = '';

                            // SUMMARY section
                            description += '<div style="color: #000000"><span style="text-decoration: underline; background-color: #c1e9d9;">SUMMARY</span></div>';
                            if (issueSummary) {
                                description += `<div>${issueSummary}</div>`;
                            }

                            // Add blank space
                            description += '<div style="margin-bottom: 20px;"></div>';

                            // DESCRIPTION section
                            description += '<div style="color: #000000;"><span style="text-decoration: underline; background-color: #c1e9d9;">DESCRIPTION</span></div>';

                            // Add issue details if available
                            if (issueDetails) {
                                description += `<div>${issueDetails}</div><br>`;
                            }

                            // Add all the fields with proper spacing
                            description += `VIP Customer: (${isVIP || 'No'})<br>`;
                            if (username) description += `Username: ${username}<br>`;
                            if (userEmail) description += `Email: ${userEmail}<br>`;
                            if (userRole) description += `Role: ${userRole}<br>`;
                            if (productImpacted) description += `Application/Program Impacted: ${productImpacted}<br>`;
                            if (xcodeInfo) description += `Xcode: ${xcodeInfo}<br>`;
                            if (districtState) description += `District state: ${districtState}<br>`;
                            if (impactType) description += `Digital and/or Print Impact: ${impactType}<br>`;
                            if (formattedDate) description += `Date issue reported by user: ${formattedDate}<br>`;
                            if (impactScope) description += `Teacher and/or Student impact: ${impactScope}<br>`;

                            // Add blank space
                            description += '<div style="margin-bottom: 20px;"></div>';

                            // PROGRAM COMPONENTS section if available
                            if (components) {
                                description += '<div style="color: #000000;"><span style="text-decoration: underline; background-color: #c1e9d9;">PROGRAM COMPONENTS</span></div>';
                                description += `<div>${components}</div>`;
                                description += '<div style="margin-bottom: 20px;"></div>';
                            }

                            // STEPS TO REPRODUCE section
                            description += '<div style="color: #000000;"><span style="text-decoration: underline; background-color: #c1e9d9;">STEPS TO REPRODUCE</span></div>';
                            if (pathField) {
                                description += `Path: ${pathField}<br>`;
                            }

                            // Add blank space
                            description += '<div style="margin-bottom: 10px;"></div>';

                            // ACTUAL RESULTS section if available
                            if (actualResults) {
                                description += '<div style="color: #000000;"><span style="text-decoration: underline; background-color: #c1e9d9;">ACTUAL RESULTS</span></div>';
                                description += `<div>${actualResults}</div>`;
                                description += '<div style="margin-bottom: 20px;"></div>';
                            }

                            // EXPECTED RESULTS section if available
                            if (expectedResults) {
                                description += '<div style="color: #000000;"><span style="text-decoration: underline; background-color: #c1e9d9;">EXPECTED RESULTS</span></div>';
                                description += `<div>${expectedResults}</div>`;
                            }

                            return description;
                        }

                        // New function to upload screenshot files to ImgBB and return an array of public URLs
                        async function getScreenshotUrls() {
                            // Use our aggregated collection instead of the file input's files
                            const urls = [];
                            const IMGBB_API_KEY = "b3da8c974bc40dd87d896d84436dd76e"; // Your ImgBB API key
                            for (let i = 0; i < aggregatedScreenshotFiles.length; i++) {
                                const file = aggregatedScreenshotFiles[i];
                                const formData = new FormData();
                                formData.append('image', file);
                                try {
                                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                                        method: 'POST',
                                        body: formData
                                    });
                                    const data = await response.json();
                                    if (data && data.success) {
                                        urls.push(data.data.display_url);
                                    }
                                } catch (error) {
                                    console.error("Error uploading screenshot:", error);
                                }
                            }
                            return urls;
                        }

                        // New async function that uses the existing generateDescription() output
                        // and injects the inline screenshots into designated sections
                        async function generateDescriptionWithScreenshots() {
                            const baseDescription = generateDescription();
                            const screenshotUrls = await getScreenshotUrls();
                            let enhancedDescription = baseDescription;
                            if (screenshotUrls.length > 0) {
                                const imgTags = screenshotUrls.map(url => `<img src="${url}" alt="Screenshot" style="max-width:100%;display:block;margin:10px 0;">`).join("");
                                // For each designated section, append the image tags after the primary content.
                                enhancedDescription = enhancedDescription.replace(
                                    /(<h3[^>]*>\s*SUMMARY\s*<\/h3>[\s\S]*?<p[^>]*>.*?<\/p>)/i,
                                    "$1" + imgTags
                                );
                                enhancedDescription = enhancedDescription.replace(
                                    /(<h4[^>]*>\s*Actual results\s*<\/h4>[\s\S]*?(<div|<p)[^>]*>.*?(<\/div>|<\/p>))/i,
                                    "$1" + imgTags
                                );
                                enhancedDescription = enhancedDescription.replace(
                                    /(<h4[^>]*>\s*Expected results\s*<\/h4>[\s\S]*?(<div|<p)[^>]*>.*?(<\/div>|<\/p>))/i,
                                    "$1" + imgTags
                                );
                            }
                            return enhancedDescription;
                        }



                        <!-- 3. Modify the form submission handler to show the loading overlay and redirect to the new ticket -->

                        // Handle form submission with fixed file upload sequence
                        document.getElementById('trackerForm').addEventListener('submit', async function (e) {
                            e.preventDefault();
                            try {
                                let subdomainCheck;
                                try {
                                    subdomainCheck = await client.iparams.get("freshdesk_subdomain");
                                    console.log("Subdomain check:", subdomainCheck);
                                } catch (ipError) {
                                    console.error("Error getting subdomain from iparams:", ipError);
                                    alert("Error accessing Freshdesk API settings. Please contact your administrator.");
                                    return;
                                }

                                // Get form values
                                const agentEmail = document.getElementById('email').value;
                                const subject = document.getElementById('subject').value;
                                const relatedTicketsStr = document.getElementById('relatedTickets').value;
                                const priority = document.getElementById('priority').value;
                                const status = document.getElementById('status').value;
                                const groupId = document.getElementById('groupField').value;
                                const agentId = document.getElementById('agentField').value;

                                // Show loading overlay while processing
                                const loadingOverlay = document.getElementById('loadingOverlay');
                                if (loadingOverlay) {
                                    loadingOverlay.style.display = 'flex';
                                }

                                // Disable create button to prevent duplicate submissions
                                const createTrackerButton = document.getElementById('createTracker');
                                if (createTrackerButton) createTrackerButton.disabled = true;

                                // Generate description based on form fields
                                const description = generateDescription();

                                // Get the product value but DON'T add it as a custom field
                                // We already include this in the description via the generateDescription function
                                const productImpacted = document.getElementById('productImpacted').dataset.fullValue ||
                                    document.getElementById('productImpacted').value || '';

                                const relatedTicketIds = relatedTicketsStr.split(',')
                                    .map(id => id.trim())
                                    .filter(id => id !== '' && !isNaN(parseInt(id, 10)))
                                    .map(id => parseInt(id, 10));

                                if (relatedTicketIds.length === 0) {
                                    alert('Please enter at least one valid related ticket ID');
                                    // Hide loading overlay if validation fails
                                    if (loadingOverlay) {
                                        loadingOverlay.style.display = 'none';
                                    }
                                    if (createTrackerButton) createTrackerButton.disabled = false;
                                    return;
                                }

                                // Validate related ticket IDs before creating tracker
                                try {
                                    // Check if at least one of the related tickets exists
                                    for (const ticketId of relatedTicketIds) {
                                        try {
                                            // Try to get ticket details to verify it exists
                                            const ticketResponse = await client.request.invokeTemplate("getTicketDetails", {
                                                context: { ticketId }
                                            });

                                            // If we get here, the ticket exists
                                            console.log(`Verified ticket ${ticketId} exists`);

                                            // Break after finding at least one valid ticket
                                            break;
                                        } catch (ticketError) {
                                            console.warn(`Failed to verify ticket ${ticketId}:`, ticketError);
                                            // Continue checking other tickets if this one failed
                                        }
                                    }
                                } catch (validationError) {
                                    console.error("Error validating ticket IDs:", validationError);
                                    // Don't stop the process if validation fails, the API will return proper errors
                                }

                                console.log("Form values:", {
                                    subject,
                                    description: description.substring(0, 50) + "...",
                                    email: agentEmail,
                                    relatedTickets: relatedTicketsStr,
                                    relatedTicketIds: relatedTicketIds,
                                    priority,
                                    status,
                                    groupId,
                                    agentId,
                                    productImpacted, // Log it but don't send as custom field

                                });

                                // Use aggregatedScreenshotFiles for attachments
                                const screenshotFiles = aggregatedScreenshotFiles;
                                console.log("Attachments:", screenshotFiles.length > 0 ? `${screenshotFiles.length} files selected` : 'No files');

                                // STEP 1: First create the ticket without attachments
                                const ticketData = {
                                    email: agentEmail,
                                    subject: subject,
                                    description: description,
                                    related_ticket_ids: relatedTicketIds,
                                    priority: parseInt(priority, 10),
                                    status: parseInt(status, 10),
                                    type: "Incident"
                                };

                                // Add district field to ticket data
                                const districtField = document.getElementById('districtField').value;
                                if (districtField) {
                                    ticketData.custom_fields = ticketData.custom_fields || {};
                                    ticketData.custom_fields.cf_district509811 = districtField;
                                    ticketData.custom_fields.cf_district = districtField; // Set both for compatibility
                                }

                                // Add group ID if selected
                                if (groupId) {
                                    ticketData.group_id = parseInt(groupId, 10);
                                    console.log(`Setting group_id: ${groupId}`);
                                }

                                // Add agent ID if selected
                                if (agentId) {
                                    ticketData.responder_id = parseInt(agentId, 10);
                                    console.log(`Setting responder_id: ${agentId}`);
                                }

                                console.log("Creating ticket with data:", ticketData);

                                console.log("First creating ticket without attachments");

                                const createResponse = await client.request.invokeTemplate("createfdTicket", {
                                    body: JSON.stringify(ticketData)
                                });

                                const newTicket = JSON.parse(createResponse.response);
                                console.log("Created ticket:", newTicket);
                                const newTicketId = newTicket.id;

                                if (!newTicketId) {
                                    throw new Error("Failed to get ID of newly created ticket");
                                }

                                // Prepare for redirect - construct the ticket URL
                                const ticketUrl = `https://benchmarkeducationcompany.freshdesk.com/a/tickets/${newTicketId}`;

                                // STEP 2: Add attachments as a private note to the ticket
                                console.log(`Adding ${aggregatedScreenshotFiles.length} attachments as note to ticket #${newTicketId}`);

                                if (aggregatedScreenshotFiles.length > 0) {
                                    try {
                                        // API credentials
                                        const subdomain = "benchmarkeducationcompany";
                                        const apiKey = "5TMgbcZdRFY70hSpEdj";

                                        console.log(`Using subdomain: ${subdomain} to upload attachments`);

                                        // Create FormData for the attachment upload
                                        const formData = new FormData();
                                        formData.append('body', 'Additional Screenshots and other file attachments');
                                        formData.append('private', 'true');

                                        // Add each file to the form data
                                        for (let i = 0; i < aggregatedScreenshotFiles.length; i++) {
                                            const file = aggregatedScreenshotFiles[i];
                                            formData.append('attachments[]', file, file.name);
                                        }

                                        // Use XMLHttpRequest for direct API access
                                        const xhr = new XMLHttpRequest();
                                        xhr.open('POST', `https://${subdomain}.freshdesk.com/api/v2/tickets/${newTicketId}/notes`, true);

                                        // Set up Basic Auth using the API key
                                        xhr.setRequestHeader('Authorization', 'Basic ' + btoa(`${apiKey}:X`));

                                        // Handle response
                                        xhr.onload = function () {
                                            if (xhr.status >= 200 && xhr.status < 300) {
                                                console.log("Attachments added successfully:", xhr.responseText);
                                                client.interface.trigger("showNotify", {
                                                    type: "success",
                                                    message: `Content/Editorial Tracker #${newTicketId} created with attachments`
                                                });
                                            } else {
                                                console.error("Error from API:", xhr.status, xhr.responseText);
                                                client.interface.trigger("showNotify", {
                                                    type: "warning",
                                                    message: `Content/Editorial Tracker #${newTicketId} created, but attachment upload failed`
                                                });
                                            }

                                            // Call finishTicketCreation to handle redirect
                                            if (typeof window.finishTicketCreation === 'function') {
                                                window.finishTicketCreation(newTicketId, ticketUrl);
                                            } else {
                                                console.error("finishTicketCreation function not available");
                                                // Basic fallback behavior
                                                const loadingOverlay = document.getElementById('loadingOverlay');
                                                if (loadingOverlay) loadingOverlay.style.display = 'none';

                                                if (window.client && client.instance) {
                                                    setTimeout(() => client.instance.close({ refreshTickets: true }), 1000);
                                                }
                                            }
                                        };

                                        // Handle network errors
                                        xhr.onerror = function () {
                                            console.error("Network error while uploading attachments");
                                            client.interface.trigger("showNotify", {
                                                type: "warning",
                                                message: `Content/Editorial Tracker #${newTicketId} created, but attachment upload failed due to network error`
                                            });

                                            // Call finishTicketCreation even on error
                                            if (typeof window.finishTicketCreation === 'function') {
                                                window.finishTicketCreation(newTicketId, ticketUrl);
                                            } else {
                                                console.error("finishTicketCreation function not available");
                                                // Basic fallback behavior
                                                const loadingOverlay = document.getElementById('loadingOverlay');
                                                if (loadingOverlay) loadingOverlay.style.display = 'none';

                                                if (window.client && client.instance) {
                                                    setTimeout(() => client.instance.close({ refreshTickets: true }), 1000);
                                                }
                                            }
                                        };

                                        // Send the form data
                                        xhr.send(formData);
                                        console.log("Attachment request sent via direct XMLHttpRequest");

                                        // Set a timeout as a fallback in case the XHR doesn't complete
                                        setTimeout(() => {
                                            if (loadingOverlay && loadingOverlay.style.display === 'flex') {
                                                console.warn("XHR timed out, forcing completion");
                                                if (typeof window.finishTicketCreation === 'function') {
                                                    window.finishTicketCreation(newTicketId, ticketUrl);
                                                } else {
                                                    console.error("finishTicketCreation function not available");
                                                    // Basic fallback behavior
                                                    const loadingOverlay = document.getElementById('loadingOverlay');
                                                    if (loadingOverlay) loadingOverlay.style.display = 'none';

                                                    if (window.client && client.instance) {
                                                        setTimeout(() => client.instance.close({ refreshTickets: true }), 1000);
                                                    }
                                                }
                                            }
                                        }, 8000);

                                    } catch (attachmentError) {
                                        // Log attachment error but don't fail the overall process
                                        console.error("Error adding attachments as note:", attachmentError);
                                        console.warn("Continuing without attachments");

                                        client.interface.trigger("showNotify", {
                                            type: "warning",
                                            message: `Content/Editorial Tracker #${newTicketId} created, but attachment handling failed: ${attachmentError.message}`
                                        });

                                        // Call finishTicketCreation even on attachment error
                                        if (typeof window.finishTicketCreation === 'function') {
                                            window.finishTicketCreation(newTicketId, ticketUrl);
                                        } else {
                                            console.error("finishTicketCreation function not available");
                                            // Basic fallback behavior
                                            const loadingOverlay = document.getElementById('loadingOverlay');
                                            if (loadingOverlay) loadingOverlay.style.display = 'none';

                                            if (window.client && client.instance) {
                                                setTimeout(() => client.instance.close({ refreshTickets: true }), 1000);
                                            }
                                        }
                                    }
                                } else {
                                    // No attachments to add, show success message and finish
                                    client.interface.trigger("showNotify", {
                                        type: "success",
                                        message: `Content/Editorial Tracker #${newTicketId} created successfully`
                                    });

                                    // Call finishTicketCreation
                                    if (typeof window.finishTicketCreation === 'function') {
                                        window.finishTicketCreation(newTicketId, ticketUrl);
                                    } else {
                                        console.error("finishTicketCreation function not available");
                                        // Basic fallback behavior
                                        const loadingOverlay = document.getElementById('loadingOverlay');
                                        if (loadingOverlay) loadingOverlay.style.display = 'none';

                                        if (window.client && client.instance) {
                                            setTimeout(() => client.instance.close({ refreshTickets: true }), 1000);
                                        }
                                    }
                                }
                            } catch (error) {
                                console.error("Error creating tracker:", error);
                                console.error("Error details:", JSON.stringify(error, null, 2));

                                // Hide loading overlay on error
                                const loadingOverlay = document.getElementById('loadingOverlay');
                                if (loadingOverlay) {
                                    loadingOverlay.style.display = 'none';
                                }

                                let errorMessage = "Failed to create tracker: ";
                                if (error.response) {
                                    console.log("Raw error response:", error.response);
                                    try {
                                        const errorData = JSON.parse(error.response);
                                        console.log("Parsed error data:", errorData);

                                        // Handle specific error codes with more helpful messages
                                        if (errorData.code === "cannot_create_tracker" &&
                                            errorData.message?.includes("related_ticket_ids are invalid")) {
                                            errorMessage = "Cannot create tracker: The ticket ID you provided is not valid. " +
                                                "Please ensure the ticket exists and can be associated with a tracker. " +
                                                "Note: tickets already associated with another tracker cannot be linked again.";
                                        } else {
                                            errorMessage += errorData.message || errorData.description || error.response;
                                        }
                                    } catch (e) {
                                        errorMessage += error.response;
                                    }
                                } else if (error.errors && error.errors.length) {
                                    errorMessage += error.errors.map(e => e.message || JSON.stringify(e)).join("; ");
                                } else {
                                    errorMessage += error.message || "Unknown error";
                                }
                                client.interface.trigger("showNotify", {
                                    type: "danger",
                                    message: errorMessage
                                });
                                document.getElementById('createTracker').disabled = false;
                            }
                        });


                        let aggregatedScreenshotFiles = [];

                        /**
                         * Enhanced file type detection for better previews
                         */
                        function getFileTypeInfo(file) {
                            // Extract file extension
                            const fileName = file.name || '';
                            const fileExtension = fileName.split('.').pop().toLowerCase();
                            const mimeType = file.type || '';

                            // Default file type info
                            let iconClass = 'fa-file';
                            let fileTypeLabel = 'File';
                            let colorClass = '';

                            // Common document types
                            if (['doc', 'docx', 'odt', 'rtf'].includes(fileExtension) ||
                                mimeType.includes('word') || mimeType.includes('opendocument.text')) {
                                iconClass = 'fa-file-word';
                                fileTypeLabel = 'Document';
                                colorClass = 'word-color';
                            }
                            // Spreadsheet types
                            else if (['xls', 'xlsx', 'xlsm', 'csv', 'ods'].includes(fileExtension) ||
                                mimeType.includes('excel') || mimeType.includes('spreadsheet') ||
                                mimeType.includes('csv')) {
                                iconClass = 'fa-file-excel';
                                fileTypeLabel = 'Spreadsheet';
                                colorClass = 'excel-color';
                            }
                            // Presentation types
                            else if (['ppt', 'pptx', 'odp'].includes(fileExtension) ||
                                mimeType.includes('powerpoint') || mimeType.includes('presentation')) {
                                iconClass = 'fa-file-powerpoint';
                                fileTypeLabel = 'Presentation';
                                colorClass = 'powerpoint-color';
                            }
                            // PDF files
                            else if (fileExtension === 'pdf' || mimeType.includes('pdf')) {
                                iconClass = 'fa-file-pdf';
                                fileTypeLabel = 'PDF';
                                colorClass = 'pdf-color';
                            }
                            // Archive files
                            else if (['zip', 'rar', 'tar', 'gz', '7z'].includes(fileExtension) ||
                                mimeType.includes('zip') || mimeType.includes('compressed')) {
                                iconClass = 'fa-file-archive';
                                fileTypeLabel = 'Archive';
                                colorClass = 'archive-color';
                            }
                            // Plain text files
                            else if (['txt', 'log', 'md'].includes(fileExtension) ||
                                mimeType.includes('text/plain')) {
                                iconClass = 'fa-file-alt';
                                fileTypeLabel = 'Text';
                                colorClass = 'text-color';
                            }
                            // Code files
                            else if (['html', 'htm', 'xml', 'json', 'js', 'css', 'php', 'py', 'java', 'c', 'cpp'].includes(fileExtension) ||
                                mimeType.includes('code') || mimeType.includes('javascript') || mimeType.includes('html')) {
                                iconClass = 'fa-file-code';
                                fileTypeLabel = 'Code';
                                colorClass = 'code-color';
                            }
                            // Audio files
                            else if (['mp3', 'wav', 'ogg', 'flac', 'm4a'].includes(fileExtension) ||
                                mimeType.includes('audio')) {
                                iconClass = 'fa-file-audio';
                                fileTypeLabel = 'Audio';
                                colorClass = 'audio-color';
                            }
                            // Video files
                            else if (['mp4', 'mov', 'avi', 'wmv', 'flv', 'mkv', 'webm'].includes(fileExtension) ||
                                mimeType.includes('video')) {
                                iconClass = 'fa-file-video';
                                fileTypeLabel = 'Video';
                                colorClass = 'video-color';
                            }
                            // HAR files (HTTP Archive)
                            else if (fileExtension === 'har') {
                                iconClass = 'fa-file-code';
                                fileTypeLabel = 'HAR';
                                colorClass = 'har-color';
                            }

                            // Image files are handled differently with actual thumbnails
                            const isImage = file.type.match('image.*');

                            // Get file size in appropriate units
                            const fileSizeBytes = file.size;
                            let fileSize = '';

                            if (fileSizeBytes < 1024) {
                                fileSize = fileSizeBytes + ' B';
                            } else if (fileSizeBytes < 1024 * 1024) {
                                fileSize = (fileSizeBytes / 1024).toFixed(1) + ' KB';
                            } else {
                                fileSize = (fileSizeBytes / (1024 * 1024)).toFixed(1) + ' MB';
                            }

                            return {
                                iconClass,
                                fileTypeLabel,
                                colorClass,
                                isImage,
                                fileSize,
                                fileSizeBytes,
                                extension: fileExtension,
                                mimeType
                            };
                        }

                        /**
                         * Function to create a file preview element
                         */
                        function createFilePreviewElement(file, index) {
                            const fileInfo = getFileTypeInfo(file);
                            const previewDiv = document.createElement('div');
                            previewDiv.className = 'file-thumbnail';
                            previewDiv.dataset.fileIndex = index;

                            if (fileInfo.isImage) {
                                // For image files, create a thumbnail preview
                                const reader = new FileReader();
                                reader.onload = function (e) {
                                    previewDiv.innerHTML = `
                                <div class="thumbnail-container">
                                    <img src="${e.target.result}" title="${file.name}" alt="${file.name}"/>
                                </div>
                                <div class="file-filename" title="${file.name}">${file.name}</div>
                                <div class="file-size">${fileInfo.fileSize}</div>
                                <div class="file-remove" data-index="${index}">✕</div>`;

                                    // Add event listener to the remove button
                                    previewDiv.querySelector('.file-remove').addEventListener('click', function (e) {
                                        e.stopPropagation();
                                        const index = parseInt(this.dataset.index);
                                        removeFile(index);
                                    });
                                };
                                reader.readAsDataURL(file);
                            } else {
                                // For non-image files, show appropriate icon based on file type
                                previewDiv.innerHTML = `
                            <div class="thumbnail-container file-icon-container ${fileInfo.colorClass}">
                                <i class="fas ${fileInfo.iconClass} file-icon"></i>
                                <div class="file-type-label">${fileInfo.fileTypeLabel}</div>
                            </div>
                            <div class="file-filename" title="${file.name}">${file.name}</div>
                            <div class="file-size">${fileInfo.fileSize}</div>
                            <div class="file-remove" data-index="${index}">✕</div>`;

                                // Add event listener to the remove button
                                previewDiv.querySelector('.file-remove').addEventListener('click', function (e) {
                                    e.stopPropagation();
                                    const index = parseInt(this.dataset.index);
                                    removeFile(index);
                                });
                            }

                            // Make the whole preview clickable to view file details
                            previewDiv.addEventListener('click', function () {
                                showFileDetails(file, index);
                            });

                            return previewDiv;
                        }

                        /**
                         * Function to show file details when a preview is clicked
                         */
                        function showFileDetails(file, index) {
                            const fileInfo = getFileTypeInfo(file);
                            const detailsHtml = `
                        <div class="file-details-header">
                            <h3>File Details</h3>
                            <div class="file-details-close">✕</div>
                        </div>
                        <div class="file-details-content">
                            <div class="file-details-icon">
                                <i class="fas ${fileInfo.iconClass} file-icon-large"></i>
                            </div>
                            <div class="file-details-info">
                                <p><strong>Name:</strong> ${file.name}</p>
                                <p><strong>Type:</strong> ${file.type || 'Unknown'}</p>
                                <p><strong>Size:</strong> ${fileInfo.fileSize}</p>
                                <p><strong>Last Modified:</strong> ${new Date(file.lastModified).toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="file-details-actions">
                            <button class="file-details-remove" data-index="${index}">Remove File</button>
                        </div>
                    `;

                            // Create or update the details modal
                            let detailsModal = document.getElementById('fileDetailsModal');
                            if (!detailsModal) {
                                detailsModal = document.createElement('div');
                                detailsModal.id = 'fileDetailsModal';
                                detailsModal.className = 'file-details-modal';
                                document.body.appendChild(detailsModal);
                            }

                            detailsModal.innerHTML = detailsHtml;
                            detailsModal.style.display = 'block';

                            // Add event listeners
                            detailsModal.querySelector('.file-details-close').addEventListener('click', function () {
                                detailsModal.style.display = 'none';
                            });

                            detailsModal.querySelector('.file-details-remove').addEventListener('click', function () {
                                const index = parseInt(this.dataset.index);
                                removeFile(index);
                                detailsModal.style.display = 'none';
                            });
                        }

                        // Enhanced file preview functionality with attachment totals
                        document.getElementById('screenshots').addEventListener('change', function (e) {
                            const previewContainer = document.getElementById('screenshotPreview');
                            if (this.files.length > 0) {
                                // Add new files to our aggregated collection
                                for (let i = 0; i < this.files.length; i++) {
                                    aggregatedScreenshotFiles.push(this.files[i]);
                                }

                                // Clear the preview container first to show all files
                                previewContainer.innerHTML = '';

                                // Add attachments summary at the top
                                updateAttachmentsSummary(previewContainer);

                                // Preview up to 5 files to avoid overwhelming the UI
                                const fileCount = Math.min(aggregatedScreenshotFiles.length, 5);
                                for (let i = 0; i < fileCount; i++) {
                                    const filePreview = createFilePreviewElement(aggregatedScreenshotFiles[i], i);
                                    previewContainer.appendChild(filePreview);
                                }

                                // Show note if there are more files than we're showing
                                if (aggregatedScreenshotFiles.length > 5) {
                                    const noteDiv = document.createElement('div');
                                    noteDiv.className = 'file-note';
                                    noteDiv.textContent = `Note: Only showing the first 5 files. All ${aggregatedScreenshotFiles.length} files will be uploaded.`;
                                    previewContainer.appendChild(noteDiv);
                                }

                                // Add a clear all button if there are files
                                if (aggregatedScreenshotFiles.length > 0) {
                                    const clearAllDiv = document.createElement('div');
                                    clearAllDiv.className = 'clear-files';
                                    clearAllDiv.innerHTML = `<button type="button">Clear All Attachments (${aggregatedScreenshotFiles.length})</button>`;
                                    clearAllDiv.querySelector('button').addEventListener('click', function () {
                                        clearAllFiles();
                                    });
                                    previewContainer.appendChild(clearAllDiv);
                                }

                                // Update the attachment count indicator
                                updateAttachmentCountIndicator();

                                // Clear the file input so the same files can be selected again
                                this.value = '';
                            }
                        });

                        /**
                         * Calculate and display attachment totals information
                         */
                        function updateAttachmentsSummary(container) {
                            if (!container) container = document.getElementById('screenshotPreview');

                            // Calculate total size
                            let totalSizeBytes = 0;
                            let fileTypes = new Set();

                            aggregatedScreenshotFiles.forEach(file => {
                                totalSizeBytes += file.size;
                                const extension = file.name.split('.').pop().toLowerCase();
                                fileTypes.add(extension);
                            });

                            // Format size for display
                            let formattedSize;
                            if (totalSizeBytes < 1024) {
                                formattedSize = totalSizeBytes + ' B';
                            } else if (totalSizeBytes < 1024 * 1024) {
                                formattedSize = (totalSizeBytes / 1024).toFixed(1) + ' KB';
                            } else {
                                formattedSize = (totalSizeBytes / (1024 * 1024)).toFixed(2) + ' MB';
                            }

                            // Create the summary element
                            const summaryDiv = document.createElement('div');
                            summaryDiv.className = 'attachments-summary';
                            if (totalSizeBytes > 10 * 1024 * 1024) { // Mark as large if over 10MB
                                summaryDiv.classList.add('large-size');
                            }

                            summaryDiv.innerHTML = `
                        <div class="attachments-count">
                            <strong>${aggregatedScreenshotFiles.length}</strong> file${aggregatedScreenshotFiles.length !== 1 ? 's' : ''} attached
                            ${fileTypes.size > 1 ? `(${fileTypes.size} different types)` : ''}
                        </div>
                        <div class="attachments-size">Total: ${formattedSize}</div>
                    `;

                            // Insert at the beginning of the container
                            if (container.firstChild) {
                                container.insertBefore(summaryDiv, container.firstChild);
                            } else {
                                container.appendChild(summaryDiv);
                            }

                            return summaryDiv;
                        }

                        // Function to remove a file by index
                        function removeFile(index) {
                            if (index >= 0 && index < aggregatedScreenshotFiles.length) {
                                // Remove the file from our collection
                                aggregatedScreenshotFiles.splice(index, 1);

                                // Refresh the preview to reflect the change
                                const previewContainer = document.getElementById('screenshotPreview');
                                previewContainer.innerHTML = '';

                                // Re-add the summary information
                                if (aggregatedScreenshotFiles.length > 0) {
                                    updateAttachmentsSummary(previewContainer);
                                }

                                // Rebuild the preview display
                                const fileCount = Math.min(aggregatedScreenshotFiles.length, 5);
                                for (let i = 0; i < fileCount; i++) {
                                    const filePreview = createFilePreviewElement(aggregatedScreenshotFiles[i], i);
                                    previewContainer.appendChild(filePreview);
                                }

                                // Show note if there are more files than we're showing
                                if (aggregatedScreenshotFiles.length > 5) {
                                    const noteDiv = document.createElement('div');
                                    noteDiv.className = 'file-note';
                                    noteDiv.textContent = `Note: Only showing the first 5 files. All ${aggregatedScreenshotFiles.length} files will be uploaded.`;
                                    previewContainer.appendChild(noteDiv);
                                }

                                // Add a clear all button if there are files
                                if (aggregatedScreenshotFiles.length > 0) {
                                    const clearAllDiv = document.createElement('div');
                                    clearAllDiv.className = 'clear-files';
                                    clearAllDiv.innerHTML = `<button type="button">Clear All Attachments (${aggregatedScreenshotFiles.length})</button>`;
                                    clearAllDiv.querySelector('button').addEventListener('click', function () {
                                        clearAllFiles();
                                    });
                                    previewContainer.appendChild(clearAllDiv);
                                }

                                // Update the attachment count indicator
                                updateAttachmentCountIndicator();
                            }
                        }

                        // Function to clear all files
                        function clearAllFiles() {
                            aggregatedScreenshotFiles = [];
                            document.getElementById('screenshotPreview').innerHTML = '';
                            updateAttachmentCountIndicator();
                        }

                        // Function to update the attachment count
                        function updateAttachmentCountIndicator() {
                            const counter = document.getElementById('attachmentCounter');
                            if (counter) {
                                const count = aggregatedScreenshotFiles.length;
                                if (count > 0) {
                                    counter.textContent = `${count} file(s) selected`;
                                    counter.style.display = 'block';
                                } else {
                                    counter.style.display = 'none';
                                }
                            }
                        }

                        // Initialize the original label text when DOM is loaded
                        const screenshotsLabel = document.querySelector('label[for="screenshots"]');
                        if (screenshotsLabel) {
                            screenshotsLabel.setAttribute('data-original-text', screenshotsLabel.textContent);
                        }

                        document.getElementById('debugFillForm').addEventListener('click', function (e) {
                            e.preventDefault();
                            fillFormWithDemoData();
                        });

                        function fillFormWithDemoData() {
                            document.getElementById('xcode').value = 'X56723';
                            document.getElementById('application').value = 'BAdvance -c2022';
                            document.getElementById('resourcePath').value = 'TRS: G5>U1>TRS>W2>L12';
                            document.getElementById('specificIssue').value = 'Title Missing';
                            document.getElementById('issueSummary').value = 'The title is missing from the TRS resource';
                            document.getElementById('isVIP').value = 'No';
                            document.getElementById('username').value = 'jsmith';
                            document.getElementById('userEmail').value = 'jsmith@school.edu';
                            document.getElementById('userRole').value = 'Teacher';
                            document.getElementById('productImpacted').value = 'Benchmark Advance - c2022';
                            document.getElementById('xcodeInfo').value = 'X56723';
                            document.getElementById('districtState').value = 'Florida';
                            document.getElementById('impactType').selectedIndex = 1;
                            const today = new Date().toISOString().split('T')[0];
                            document.getElementById('dateReported').value = today;
                            document.getElementById('impactScope').selectedIndex = 1;
                            document.getElementById('components').value = 'TRS, Reading Materials';
                            document.getElementById('pathField').value = 'Login > Resources > Grade 5 > Unit 1 > Week 2 > Lesson 12';
                            document.getElementById('actualResults').value = 'The TRS title is missing completely from the lesson page';
                            document.getElementById('expectedResults').value = 'TRS title should be visible at the top of the lesson page';

                            // Use actual ticket ID if available, otherwise use demo value
                            const existingTicketId = document.getElementById('relatedTickets').value;
                            document.getElementById('relatedTickets').value = existingTicketId || '1234, 5678';

                            // Preserve existing priority if set
                            if (!document.getElementById('priority').value) {
                                document.getElementById('priority').selectedIndex = 1;
                            }

                            document.getElementById('status').selectedIndex = 0;

                            // Fill the issue details too
                            const quillIssueDetails = Quill.find(document.getElementById('issueDetailsEditor'));
                            if (quillIssueDetails) {
                                quillIssueDetails.setText('The TRS title is completely missing from the lesson page. This affects teacher visibility and makes navigation difficult.');
                            }

                            client.interface.trigger("showNotify", {
                                type: "success",
                                message: "Form filled with demo data"
                            });
                        }

                        // Initialize Quill editors for rich text fields
                        const quillSummary = new Quill("#issueSummaryEditor", { theme: "snow", placeholder: "Enter the summary..." });
                        const quillIssueDetails = new Quill("#issueDetailsEditor", { theme: "snow", placeholder: "Enter the issue details..." });
                        const quillComponents = new Quill("#componentsEditor", { theme: "snow", placeholder: "Enter program components..." });
                        const quillActual = new Quill("#actualResultsEditor", { theme: "snow", placeholder: "Enter actual results..." });
                        const quillExpected = new Quill("#expectedResultsEditor", { theme: "snow", placeholder: "Enter expected results..." });

                        // Before form submission, copy Quill HTML into hidden textareas
                        document.getElementById('trackerForm').addEventListener('submit', async function (e) {
                            // Update hidden textareas with editor content
                            document.getElementById('issueSummary').value = quillSummary.root.innerHTML;
                            document.getElementById('issueDetails').value = quillIssueDetails.root.innerHTML;
                            document.getElementById('components').value = quillComponents.root.innerHTML;
                            document.getElementById('actualResults').value = quillActual.root.innerHTML;
                            document.getElementById('expectedResults').value = quillExpected.root.innerHTML;
                            // Form submission continues with the normal flow
                        });

                        // Helper: Upload an image file to ImgBB and return its URL
                        function uploadImageToImgbb(file) {
                            const formData = new FormData();
                            formData.append('image', file);
                            const IMGBB_API_KEY = "b3da8c974bc40dd87d896d84436dd76e";
                            return fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                                method: 'POST',
                                body: formData
                            })
                                .then(response => response.json())
                                .then(result => {
                                    if (result.success) {
                                        return result.data.display_url;
                                    }
                                    throw new Error("Image upload failed");
                                });
                        }

                        // Handles paste events on a Quill editor and processes image files
                        function handlePasteImage(e, quill) {
                            const clipboardData = e.clipboardData || window.clipboardData;
                            if (!clipboardData) return;
                            const items = clipboardData.items;
                            if (!items) return;
                            for (let i = 0; i < items.length; i++) {
                                if (items[i].type.indexOf("image") !== -1) {
                                    e.preventDefault();
                                    const file = items[i].getAsFile();
                                    uploadImageToImgbb(file)
                                        .then(url => {
                                            const range = quill.getSelection();
                                            quill.insertEmbed(range.index, 'image', url);
                                        })
                                        .catch(error => console.error("Image upload error:", error));
                                    return;
                                }
                            }
                        }

                        // Attach paste listener on each Quill editor so pasted images are uploaded automatically
                        quillSummary.root.addEventListener('paste', function (e) {
                            handlePasteImage(e, quillSummary);
                        });
                        quillComponents.root.addEventListener('paste', function (e) {
                            handlePasteImage(e, quillComponents);
                        });
                        quillActual.root.addEventListener('paste', function (e) {
                            handlePasteImage(e, quillActual);
                        });
                        quillExpected.root.addEventListener('paste', function (e) {
                            handlePasteImage(e, quillExpected);
                        });

                        // Handle paste events for the new Issue Details editor
                        quillIssueDetails.root.addEventListener('paste', function (e) {
                            handlePasteImage(e, quillIssueDetails);
                        });

                        // API-based dropdown functionality
                        // Function to fetch groups from Freshdesk API
                        async function fetchGroups() {
                            try {
                                console.log("Fetching groups from Freshdesk API");
                                // Add a UI indicator that API is being called
                                const groupSelect = document.getElementById("groupField");
                                groupSelect.innerHTML = "<option>Loading groups...</option>";

                                const response = await client.request.invokeTemplate("getGroups", {});

                                if (!response || !response.response) {
                                    throw new Error("Empty response from groups API");
                                }

                                const groups = JSON.parse(response.response);
                                console.log("Fetched groups:", groups);

                                groupSelect.innerHTML = ""; // Clear existing options

                                // Add a blank option
                                const blankOption = document.createElement("option");
                                blankOption.value = "";
                                blankOption.textContent = "-- Select a Group --";
                                groupSelect.appendChild(blankOption);

                                groups.forEach(group => {
                                    const option = document.createElement("option");
                                    option.value = group.id;
                                    option.textContent = group.name;
                                    groupSelect.appendChild(option);

                                    // Set Escalations group as default
                                    if (group.id === 67000396680) {
                                        option.selected = true;
                                    }
                                });

                                // After loading groups, instead of fetching agents, 
                                // always use the hardcoded agent list directly
                                loadHardcodedAgents();

                            } catch (error) {
                                console.error("Error fetching groups:", error);
                                console.error(error.stack);
                                // Fallback with hardcoded groups in case of API error
                                loadFallbackGroups();
                            }
                        }

                        // Function to always load the hardcoded agents instead of using the API
                        function loadHardcodedAgents() {
                            console.log("Loading hardcoded agents list");
                            const agents = [
                                { id: 67025683491, name: "Mohammad Azeem" },
                                { id: 67030529218, name: "Jordan Fields" },
                                { id: 67031011668, name: "Suriya Iqbal" },
                                { id: 67040597168, name: "Anson Li" },
                                { id: 67051499418, name: "Drita Lulgjuraj" }
                            ];

                            const agentSelect = document.getElementById("agentField");
                            agentSelect.innerHTML = ""; // Clear existing options

                            // Add a blank option
                            const blankOption = document.createElement("option");
                            blankOption.value = "";
                            blankOption.textContent = "-- Select an Agent --";
                            agentSelect.appendChild(blankOption);

                            agents.forEach(agent => {
                                const option = document.createElement("option");
                                option.value = agent.id;
                                option.textContent = agent.name;
                                agentSelect.appendChild(option);
                            });
                        }

                        // Modified to use hardcoded agents instead of API
                        function fetchAgentsForGroup(groupId) {
                            console.log(`Group selection changed, loading hardcoded agents for group: ${groupId}`);
                            // Always use the hardcoded list regardless of group
                            loadHardcodedAgents();
                        }

                        // Function to fetch product types
                        function fetchProductTypes() {
                            console.log("Using hardcoded product types data");

                            // Set up the hardcoded product hierarchy
                            const productTypeHierarchy = {
                                "Not Product Specific": {},
                                "Assess 360": {},
                                "Benchmark Advance": {
                                    "c2026": [],
                                    "- c2022": [],
                                    "c2022": [],
                                    "c2021": [],
                                    "c2018": [],
                                    "c2017": [],
                                    "Florida c2026": [],
                                    "Florida": [],
                                    "Intervention Resources": [],
                                    "Pilots": [
                                        "National Pilot",
                                        "Units 1-4 Pilot - c2022",
                                        "Units 1-4 Pilot c2022",
                                        "Units 1-2 Pilot - c2022",
                                        "Units 1-2 Pilot c2022",
                                        "Units 3-4 Pilot - c2022",
                                        "Units 3-4 Pilot c2022",
                                        "Units 5-7 Pilot - c2022",
                                        "Units 5-7 Pilot c2022",
                                        "Units 8-10 Pilot - c2022",
                                        "Units 8-10 Pilot c2022",
                                        "Unknown"
                                    ],
                                    "Benchmark Advance": [],
                                    "California c2017": [],
                                    "California": []
                                },
                                "Benchmark Adelante": {
                                    "c2026": [],
                                    "c2023": [],
                                    "- c2023": [],
                                    "c2022": [],
                                    "c2018": [],
                                    "c2017": [],
                                    "Florida c2026": [],
                                    "California c2017": [],
                                    "Utah": [],
                                    "Pilots": [
                                        "National Pilot",
                                        "Units 1-4 Pilot - c2023",
                                        "Units 1-4 Pilot c2023",
                                        "Units 1-2 Pilot - c2023",
                                        "Units 1-2 Pilot c2023",
                                        "Units 3-4 Pilot - c2023",
                                        "Units 3-4 Pilot c2023",
                                        "Units 5-7 Pilot - c2023",
                                        "Units 5-7 Pilot c2023",
                                        "Units 8-10 Pilot - c2023",
                                        "Units 8-10 Pilot c2023",
                                        "Unknown"
                                    ],
                                    "Adelante": []
                                },
                                "Benchmark Workshop": {},
                                "Benchmark Taller": {},
                                "Ready To Advance": {},
                                "Listos Y Adelante": {
                                    "Listos y Adelante Aprendizaje emergente": [],
                                    "c2022": [],
                                    "Edicion Texas": [],
                                    "Listos Y Adelante": []
                                },
                                "Supplemental": {
                                    "Foundational Skills Assessment": [],
                                    "Oral Reading Records": [],
                                    "Registros de lectura en voz alta™": [],
                                    "Hello": [],
                                    "Writer's Workshop": [],
                                    "Reader's Workshop": [],
                                    "4,500+ eBook Library": [],
                                    "123 Andres": [],
                                    "ACT Now!": [],
                                    "Advance ALL": [],
                                    "Advancing Language Learning": [],
                                    "Anchor Comprehension Workshop": [],
                                    "Authentic Voices": [],
                                    "BEC Decodables": [],
                                    "Benchmark Literacy": [],
                                    "Benchmark Literacy 2016": [],
                                    "Steps to Advance": [],
                                    "Benchmark Common Core": [],
                                    "Benchmark Phonics": [],
                                    "SpiralUp Phonics": [],
                                    "BuildUp Phonics": [],
                                    "Phonics Intervention": [],
                                    "Benchmark Phonics & Word Study Workshop": [],
                                    "RIGOR": [],
                                    "Benchmark Writer's Universe": [],
                                    "Comprehension Skill Bags": [],
                                    "Decodable Fluency Builders": [],
                                    "Decodable Readers": [],
                                    "Dynamite Decodables": [],
                                    "Express": [],
                                    "MySELF": [],
                                    "Represent!": [],
                                    "Fonética y gramática": [],
                                    "Avanse": [],
                                    "Mis libros de fonetica": [],
                                    "Soluciones": [],
                                    "Sound Spelling Cards and Videos/Transfer Kits": [],
                                    "Spring Forward": [],
                                    "PD Essentials": [
                                        "Collections",
                                        "Courses and Books"
                                    ],
                                    "PD Training: Curriculum Resources": []
                                }
                            };

                            // Create the dropdown structure in the DOM
                            const productContainer = document.querySelector('.form-group:has(#productImpacted)');

                            // Clean out the existing container
                            productContainer.innerHTML = '';

                            // Create label
                            const label = document.createElement('label');
                            label.setAttribute('for', 'productImpacted');
                            label.textContent = 'Application/Program Impacted:';
                            productContainer.appendChild(label);

                            // Create main product select
                            const mainSelect = document.createElement('select');
                            mainSelect.id = 'productImpacted';
                            mainSelect.name = 'productImpacted';

                            // Initialize the dataset property to store the full value
                            mainSelect.dataset.fullValue = '';

                            // Add the blank option
                            const blankOption = document.createElement('option');
                            blankOption.value = '';
                            blankOption.textContent = '-- Select a Product --';
                            mainSelect.appendChild(blankOption);

                            // Add product options
                            Object.keys(productTypeHierarchy).forEach(productName => {
                                const option = document.createElement('option');
                                option.value = productName;
                                option.textContent = productName;
                                mainSelect.appendChild(option);
                            });

                            productContainer.appendChild(mainSelect);

                            // Create a container for the second level dropdown (initially hidden)
                            const secondLevelContainer = document.createElement('div');
                            secondLevelContainer.id = 'secondLevelContainer';
                            secondLevelContainer.style.display = 'none';
                            secondLevelContainer.style.marginTop = '10px';

                            const secondLevelSelect = document.createElement('select');
                            secondLevelSelect.id = 'secondLevelSelect';
                            secondLevelSelect.name = 'secondLevelSelect';
                            secondLevelContainer.appendChild(secondLevelSelect);

                            productContainer.appendChild(secondLevelContainer);

                            // Create a container for the third level dropdown (initially hidden)
                            const thirdLevelContainer = document.createElement('div');
                            thirdLevelContainer.id = 'thirdLevelContainer';
                            thirdLevelContainer.style.display = 'none';
                            thirdLevelContainer.style.marginTop = '10px';

                            const thirdLevelSelect = document.createElement('select');
                            thirdLevelSelect.id = 'thirdLevelSelect';
                            thirdLevelSelect.name = 'thirdLevelSelect';
                            thirdLevelContainer.appendChild(thirdLevelSelect);

                            productContainer.appendChild(thirdLevelContainer);

                            // Add the hint text
                            const hintText = document.createElement('div');
                            hintText.className = 'hint';
                            hintText.textContent = 'Select the product type';
                            productContainer.appendChild(hintText);

                            // Event listener for the main product dropdown
                            mainSelect.addEventListener('change', function () {
                                const selectedProduct = this.value;
                                const secondLevel = productTypeHierarchy[selectedProduct];

                                // Update the full product value to include the first level
                                document.getElementById('productImpacted').dataset.fullValue = selectedProduct;

                                // Reset and hide third level
                                thirdLevelContainer.style.display = 'none';
                                thirdLevelSelect.innerHTML = '';

                                // Reset second level
                                secondLevelSelect.innerHTML = '';

                                if (selectedProduct && Object.keys(secondLevel).length > 0) {
                                    // Add a blank option
                                    const blankOption = document.createElement('option');
                                    blankOption.value = '';
                                    blankOption.textContent = '-- Select a Subcategory --';
                                    secondLevelSelect.appendChild(blankOption);

                                    // Add options for second level
                                    Object.keys(secondLevel).forEach(subCategory => {
                                        const option = document.createElement('option');
                                        option.value = subCategory;
                                        option.textContent = subCategory;
                                        secondLevelSelect.appendChild(option);
                                    });

                                    // Show second level
                                    secondLevelContainer.style.display = 'block';
                                } else {
                                    // Hide second level if no subcategories
                                    secondLevelContainer.style.display = 'none';
                                }
                            });

                            // Event listener for the second level dropdown
                            secondLevelSelect.addEventListener('change', function () {
                                const selectedProduct = mainSelect.value;
                                const selectedSubCategory = this.value;
                                const thirdLevel = productTypeHierarchy[selectedProduct][selectedSubCategory];

                                // Update the full product value to include first and second levels
                                document.getElementById('productImpacted').dataset.fullValue =
                                    selectedProduct + ' - ' + selectedSubCategory;

                                // Reset third level
                                thirdLevelSelect.innerHTML = '';

                                if (selectedSubCategory && Array.isArray(thirdLevel) && thirdLevel.length > 0) {
                                    // Add a blank option
                                    const blankOption = document.createElement('option');
                                    blankOption.value = '';
                                    blankOption.textContent = '-- Select a Specific Item --';
                                    thirdLevelSelect.appendChild(blankOption);

                                    // Add options for third level
                                    thirdLevel.forEach(item => {
                                        const option = document.createElement('option');
                                        option.value = item;
                                        option.textContent = item;
                                        thirdLevelSelect.appendChild(option);
                                    });

                                    // Show third level
                                    thirdLevelContainer.style.display = 'block';
                                } else {
                                    // Hide third level if no items
                                    thirdLevelContainer.style.display = 'none';
                                }
                            });

                            // Event listener for the third level dropdown
                            thirdLevelSelect.addEventListener('change', function () {
                                const selectedProduct = mainSelect.value;
                                const selectedSubCategory = secondLevelSelect.value;
                                const selectedItem = this.value;

                                // Update the full product value to include all three levels
                                document.getElementById('productImpacted').dataset.fullValue =
                                    selectedProduct + ' - ' + selectedSubCategory + ' - ' + selectedItem;
                            });

                            // Override the form submission to use the full hierarchical value
                            const originalSubmitHandler = document.getElementById('trackerForm').onsubmit;
                            document.getElementById('trackerForm').onsubmit = function (e) {
                                // Get the full value from all dropdown levels
                                const fullProductValue = document.getElementById('productImpacted').dataset.fullValue;
                                if (fullProductValue) {
                                    // Set the product value to the full hierarchical value
                                    document.getElementById('productImpacted').value = fullProductValue;
                                }

                                // Call the original handler if it exists
                                if (originalSubmitHandler) {
                                    return originalSubmitHandler.call(this, e);
                                }
                            };
                        }

                        // Replace the API-based fetchProductTypes with our hardcoded version
                        // Use the loadFallbackProductTypes as a backup method in case of issues
                        function loadFallbackProductTypes() {
                            // Call the main function to ensure we always use the hardcoded version
                            fetchProductTypes();
                        }

                        // Fallback functions in case the API calls fail
                        function loadFallbackGroups() {
                            console.log("Using fallback groups data");
                            const groups = [
                                { id: 67000396680, name: "Escalations" },
                                { id: 67000396681, name: "Support" },
                                { id: 67000396682, name: "Technical" }
                            ];

                            const groupSelect = document.getElementById("groupField");
                            groupSelect.innerHTML = ""; // Clear existing options

                            // Add a blank option
                            const blankOption = document.createElement("option");
                            blankOption.value = "";
                            blankOption.textContent = "-- Select a Group --";
                            groupSelect.appendChild(blankOption);

                            groups.forEach(group => {
                                const option = document.createElement("option");
                                option.value = group.id;
                                option.textContent = group.name;
                                groupSelect.appendChild(option);

                                // Set Escalations group as default
                                if (group.id === 67000396680) {
                                    option.selected = true;
                                }
                            });

                            // Load fallback agents for the default group
                            loadFallbackAgents();
                        }

                        function loadFallbackAgents() {
                            console.log("Using fallback agents data");
                            const agents = [
                                { id: 67025683491, name: "Mohammad Azeem" },
                                { id: 67030529218, name: "Jordan Fields" },
                                { id: 67031011668, name: "Suriya Iqbal" },
                                { id: 67040597168, name: "Anson Li" },
                                { id: 67051499418, name: "Drita Lulgjuraj" }
                            ];

                            const agentSelect = document.getElementById("agentField");
                            agentSelect.innerHTML = ""; // Clear existing options

                            // Add a blank option
                            const blankOption = document.createElement("option");
                            blankOption.value = "";
                            blankOption.textContent = "-- Select an Agent --";
                            agentSelect.appendChild(blankOption);

                            agents.forEach(agent => {
                                const option = document.createElement("option");
                                option.value = agent.id;
                                option.textContent = agent.name;
                                agentSelect.appendChild(option);
                            });
                        }

                        function loadFallbackProductTypes() {
                            console.log("Using fallback product types data");
                            const productTypes = [
                                { id: "book", name: "Book" },
                                { id: "software", name: "Software" },
                                { id: "digital_content", name: "Digital Content" },
                                { id: "print_content", name: "Print Content" },
                                { id: "assessment", name: "Assessment" }
                            ];

                            const productSelect = document.getElementById("productImpacted");
                            productSelect.innerHTML = ""; // Clear existing options

                            // Add a blank option
                            const blankOption = document.createElement("option");
                            blankOption.value = "";
                            blankOption.textContent = "-- Select a Product --";
                            productSelect.appendChild(blankOption);

                            productTypes.forEach(product => {
                                const option = document.createElement("option");
                                option.value = product.id;
                                option.textContent = product.name;
                                productSelect.appendChild(option);
                            });
                        }

                        // When group changes, still call the function but it will always load hardcoded agents
                        document.getElementById("groupField").addEventListener("change", function () {
                            const groupId = this.value;
                            if (groupId) {
                                // This will now load the hardcoded agents instead of doing an API call
                                fetchAgentsForGroup(parseInt(groupId, 10));
                            } else {
                                // Clear agents dropdown if no group selected
                                const agentSelect = document.getElementById("agentField");
                                agentSelect.innerHTML = "";
                                const blankOption = document.createElement("option");
                                blankOption.value = "";
                                blankOption.textContent = "-- Select a Group First --";
                                agentSelect.appendChild(blankOption);
                            }
                        });

                        // Enhanced function to check and populate district field
                        async function populateDistrictField() {
                            try {
                                console.log("Running enhanced populateDistrictField()");

                                // Clear the field first to avoid showing stale data
                                document.getElementById('districtField').value = '';

                                // First purge any old cached data completely
                                window.storageManager.clearAllDistrictData();

                                // Check for cached data in our clean centralized cache
                                const cachedDistrict = window.storageManager.getDistrictData();
                                if (cachedDistrict) {
                                    document.getElementById('districtField').value = cachedDistrict;
                                    console.log(`Set district from clean cache: ${cachedDistrict}`);
                                    return;
                                }

                                // If not found in cache, try to get from current ticket context
                                if (window.client) {
                                    try {
                                        const ticketData = await client.data.get("ticket");
                                        console.log("Retrieved ticket data for district:", ticketData);

                                        if (ticketData && ticketData.ticket && ticketData.ticket.custom_fields) {
                                            // Try all possible district field names
                                            const districtFields = [
                                                'cf_district509811', 'cf_district', 'district',
                                                'cf_school_district', 'cf_district_name'
                                            ];

                                            for (const field of districtFields) {
                                                if (ticketData.ticket.custom_fields[field]) {
                                                    const districtValue = ticketData.ticket.custom_fields[field];
                                                    console.log(`Found district in field ${field}:`, districtValue);

                                                    // Verify this isn't a default value
                                                    if (districtValue !== "VOLUSIA CO SCHOOL DISTRICT") {
                                                        document.getElementById('districtField').value = districtValue;
                                                        console.log("Set district from ticket field:", districtValue);

                                                        // Store in our centralized cache
                                                        window.storageManager.storeDistrictData(districtValue, `ticket.${field}`);
                                                        return;
                                                    } else {
                                                        console.warn(`Found default VOLUSIA value in ${field}, ignoring it`);
                                                    }
                                                }
                                            }

                                            // If we haven't returned yet, try to extract district from ticket subject or description
                                            if (ticketData.ticket.subject || ticketData.ticket.description) {
                                                const contentToSearch = (ticketData.ticket.subject || '') + ' ' + (ticketData.ticket.description || '');
                                                console.log("Searching for district in ticket content");

                                                // Try to find mentions of School District
                                                const districtRegex = /([A-Za-z\s\.]+(?:School|County|Public)\s*(?:District|Schools))/i;
                                                const match = contentToSearch.match(districtRegex);

                                                if (match && match[1] && match[1] !== "VOLUSIA CO SCHOOL DISTRICT") {
                                                    const extractedDistrict = match[1].trim();
                                                    document.getElementById('districtField').value = extractedDistrict;
                                                    console.log("Extracted district from ticket content:", extractedDistrict);

                                                    // Store in our centralized cache
                                                    window.storageManager.storeDistrictData(extractedDistrict, 'ticket.content');
                                                    return;
                                                }
                                            }
                                        }
                                    } catch (error) {
                                        console.error("Error getting ticket data for district:", error);
                                    }
                                }

                                // If we reach here, no valid district was found
                                console.log("No valid district found, leaving field empty");
                                document.getElementById('districtField').value = '';

                            } catch (error) {
                                console.error("Error in populateDistrictField():", error);
                                // Clear the field in case of error
                                document.getElementById('districtField').value = '';
                            }
                        }

                        // Function to populate district field
                        async function populateDistrictField() {
                            try {
                                // First check localStorage
                                const storedData = localStorage.getItem('sedcustData') || localStorage.getItem('assemblyData');

                                if (storedData) {
                                    const parsedData = JSON.parse(storedData);
                                    if (parsedData.districtName) {
                                        document.getElementById('districtField').value = parsedData.districtName;
                                        console.log("Set district from localStorage:", parsedData.districtName);
                                        return;
                                    }
                                }

                                // If not found in localStorage, try to get from current ticket context
                                if (window.client) {
                                    try {
                                        const ticketData = await client.data.get("ticket");
                                        if (ticketData && ticketData.ticket && ticketData.ticket.custom_fields) {
                                            // Try all possible district field names
                                            const districtFields = [
                                                'cf_district509811', 'cf_district', 'district',
                                                'cf_school_district', 'cf_district_name'
                                            ];

                                            for (const field of districtFields) {
                                                if (ticketData.ticket.custom_fields[field]) {
                                                    document.getElementById('districtField').value =
                                                        ticketData.ticket.custom_fields[field];
                                                    console.log(`Found district in field ${field}:`,
                                                        ticketData.ticket.custom_fields[field]);
                                                    break;
                                                }
                                            }
                                        }
                                    } catch (error) {
                                        console.error("Error getting ticket data:", error);
                                    }
                                }
                            } catch (error) {
                                console.error("Error populating district field:", error);
                            }
                        }

                        // Function to populate ticket fields from source ticket
                        async function populateTicketFields() {
                            try {
                                if (window.client) {
                                    const ticketData = await client.data.get("ticket");
                                    console.log("Source ticket data for fields:", ticketData);

                                    if (ticketData && ticketData.ticket) {
                                        // Populate related ticket ID
                                        if (ticketData.ticket.id) {
                                            document.getElementById('relatedTickets').value = ticketData.ticket.id;
                                            console.log("Set related ticket ID:", ticketData.ticket.id);
                                        }

                                        // Populate priority
                                        if (ticketData.ticket.priority) {
                                            document.getElementById('priority').value = ticketData.ticket.priority;
                                            console.log("Set priority:", ticketData.ticket.priority);
                                        }

                                        // Populate VIP status from custom fields
                                        if (ticketData.ticket.custom_fields) {
                                            // Check for VIP status in various possible custom field names
                                            const vipFields = ['cf_vip', 'vip', 'cf_is_vip', 'is_vip'];

                                            for (const field of vipFields) {
                                                const vipValue = ticketData.ticket.custom_fields[field];
                                                if (vipValue) {
                                                    // Convert various possible VIP values to Yes/No
                                                    let isVip = false;

                                                    if (typeof vipValue === 'boolean') {
                                                        isVip = vipValue;
                                                    } else if (typeof vipValue === 'string') {
                                                        const normalizedValue = vipValue.toLowerCase().trim();
                                                        isVip = ['yes', 'true', '1', 'y'].includes(normalizedValue);
                                                    } else if (typeof vipValue === 'number') {
                                                        isVip = vipValue > 0;
                                                    }

                                                    document.getElementById('isVIP').value = isVip ? 'Yes' : 'No';
                                                    console.log(`Set VIP status from field ${field}:`, isVip ? 'Yes' : 'No');
                                                    break;
                                                }
                                            }
                                        }

                                        // Get current district value from field before saving
                                        const currentDistrict = document.getElementById('districtField').value;

                                        // If we have a valid district, store it in our centralized cache too
                                        if (currentDistrict && currentDistrict !== "VOLUSIA CO SCHOOL DISTRICT") {
                                            window.storageManager.storeDistrictData(currentDistrict, 'populateTicketFields');
                                        }
                                    }
                                }
                            } catch (error) {
                                console.error("Error populating ticket fields:", error);
                            }
                        }

                        // Enhanced function to check and populate district field
                        async function populateDistrictField() {
                            try {
                                // First check localStorage for cached data
                                const storedData = localStorage.getItem('sourceTicketData') ||
                                    localStorage.getItem('sedcustData') ||
                                    localStorage.getItem('assemblyData');

                                if (storedData) {
                                    const parsedData = JSON.parse(storedData);
                                    if (parsedData.districtName || parsedData.district) {
                                        const districtValue = parsedData.districtName || parsedData.district;
                                        document.getElementById('districtField').value = districtValue;
                                        console.log("Set district from localStorage:", districtValue);
                                        return;
                                    }
                                }

                                // If not found in localStorage, try to get from current ticket context
                                if (window.client) {
                                    try {
                                        const ticketData = await client.data.get("ticket");
                                        if (ticketData && ticketData.ticket && ticketData.ticket.custom_fields) {
                                            // Try all possible district field names
                                            const districtFields = [
                                                'cf_district509811', 'cf_district', 'district',
                                                'cf_school_district', 'cf_district_name'
                                            ];

                                            for (const field of districtFields) {
                                                if (ticketData.ticket.custom_fields[field]) {
                                                    document.getElementById('districtField').value =
                                                        ticketData.ticket.custom_fields[field];
                                                    console.log(`Found district in field ${field}:`,
                                                        ticketData.ticket.custom_fields[field]);
                                                    break;
                                                }
                                            }
                                        }
                                    } catch (error) {
                                        console.error("Error getting ticket data:", error);
                                    }
                                }
                            } catch (error) {
                                console.error("Error populating district field:", error);
                            }
                        }

                        // Initialize the dropdowns when the form loads
                        fetchGroups();
                        fetchProductTypes();
                    }

                    initializeClient();
                });
            </script>

            <script>
                // Helper function to finish the ticket creation process
                window.finishTicketCreation = function (ticketId, ticketUrl) {
                    console.log(`finishTicketCreation called for ticket ${ticketId}`);
                    // Hide loading overlay
                    const loadingOverlay = document.getElementById('loadingOverlay');
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'none';
                    }

                    // Hide modal loading indicator if present
                    const modalLoadingIndicator = document.getElementById('modalLoadingIndicator');
                    if (modalLoadingIndicator) {
                        modalLoadingIndicator.style.display = 'none';
                    }

                    // Open the new ticket in a new tab
                    try {
                        window.open(ticketUrl, '_blank');
                    } catch (navError) {
                        console.error("Error opening ticket page:", navError);
                    }

                    // Close the current modal with a delay to ensure notifications are visible
                    try {
                        setTimeout(() => {
                            if (window.client && client.instance) {
                                client.instance.close({ refreshTickets: true });
                            }
                        }, 1000);
                    } catch (closeError) {
                        console.error("Error closing modal:", closeError);
                    }
                }

                document.addEventListener('DOMContentLoaded', function () {
                    setTimeout(function () {
                        var createBtn = document.getElementById('createTracker');
                        if (createBtn) {
                            createBtn.onclick = function (e) {
                                e.preventDefault();
                                document.getElementById('trackerForm').dispatchEvent(new Event('submit'));
                            };
                        }
                        var cancelBtn = document.getElementById('cancelTracker');
                        if (cancelBtn) {
                            cancelBtn.onclick = function () {
                                if (window.client) {
                                    window.client.instance.close();
                                }
                            };
                        }
                        console.log('Extra event handlers attached to buttons');
                    }, 500);
                });
            </script>


</body>

</html>