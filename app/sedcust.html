<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script async src="{{{appclient}}}"></script>
    <link rel="stylesheet" type="text/css" href="styles/style.css" />
    <link rel="stylesheet" type="text/css" href="styles/modal.css" />
    <link rel="stylesheet" type="text/css" href="styles/filepreview.css" />
    <link rel="stylesheet" type="text/css" href="styles/sedcust.css" />
    <link rel="stylesheet" type="text/css" href="styles/spinner.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Add Quill CSS and JS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
        div.card-header {
            background-color: #2C3E50;
            color: white
        }
    </style>
</head>

<body>
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="spinner-text">Creating ticket...</div>
    </div>

    <div class="tracker-form-container">
        <!-- Debug Button -->
            <div class="debug-container">
                <button id="debugFillForm" class="debug-button">Fill Form with Demo Data</button>
            </div>
        <!-- Form Title -->
            <div class="form-title">
                <h2>Content/Editorial Tracker</h2>
            </div>

        <!-- Back Button -->
            <div class="back-button-container">
                <fw-button id="backButton" color="secondary" size="small"
                    style="cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"
                    onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                    <i class="fas fa-arrow-left" style="margin-right: 8px;"></i>Back to Tracker Templates
                </fw-button>
            </div>

            <form id="trackerForm">
                <div class="cards-container">
                    <!-- Subject card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-pen-fancy fa-lg section-icon"></i>
                            <h3>SUBJECT</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="subject" class="required-field">Subject</label>
                                <input type="text" id="subject" name="subject" required>
                                <div class="hint"><i class="fas fa-info-circle"></i> Format: XCODE | Application Name |
                                Resource Name > Grade > Unit > Week > Day > Lesson - Short Description of Issue</div>
                            </div>

                            <div class="form-group">
                                <label for="xcode" class="required-field">XCODE</label>
                                <input type="text" id="xcode" name="xcode" required placeholder="e.g. X56723">
                                <div class="hint"><i class="fas fa-info-circle"></i> Xcode for this resource</div>
                            </div>

                            <div class="form-group">
                                <label for="application" class="required-field">Application Name</label>
                                <input type="text" id="application" name="application" required
                                    placeholder="e.g. BAdvance -c2022">
                                <div class="hint"><i class="fas fa-info-circle"></i> The application or program name
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="resourcePath" class="required-field">Resource Path</label>
                                <input type="text" id="resourcePath" name="resourcePath" required
                                    placeholder="e.g. TRS: G5>U1>TRS>W2>L12">
                                <div class="hint"><i class="fas fa-info-circle"></i> Resource path with Grade > Unit >
                                Week > Day > Lesson</div>
                            </div>

                            <div class="form-group">
                                <label for="specificIssue" class="required-field">Specific Issue</label>
                                <input type="text" id="specificIssue" name="specificIssue" required
                                    placeholder="e.g. Title Missing">
                                <div class="hint"><i class="fas fa-info-circle"></i> Brief description of the specific
                                issue</div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-file-alt fa-lg section-icon"></i>
                            <h3>SUMMARY</h3>
                        </div>
                        <div class="card-body">
                            <div class="quill-editor-container">
                                <div id="issueSummaryEditor" style="height: 120px; background-color: white;"></div>
                                <textarea id="issueSummary" name="issueSummary" style="display: none;"></textarea>
                            </div>
                            <div class="hint"><i class="fas fa-lightbulb"></i> Provide a clear, concise summary of the
                            issue</div>
                        </div>
                    </div>

                    <!-- Issue Details card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-clipboard-list fa-lg section-icon"></i>
                            <h3>ISSUE DETAILS</h3>
                        </div>
                        <div class="card-body">
                            <div class="quill-editor-container">
                                <div id="issueDetailsEditor" style="height: 150px; background-color: white;"></div>
                                <textarea id="issueDetails" name="issueDetails" style="display: none;"></textarea>
                            </div>
                            <div class="hint"><i class="fas fa-info-circle"></i> Detailed description of the issue</div>
                        </div>
                    </div>

                    <!-- Impacted User Info card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-user fa-lg section-icon"></i>
                            <h3>IMPACTED USER INFO</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="isVIP">VIP Customer:</label>
                                    <select id="isVIP" name="isVIP">
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Is this a VIP customer?</div>
                                </div>

                                <div class="form-group">
                                    <label for="username">Username:</label>
                                    <input type="text" id="username" name="username" placeholder="e.g. j.smith">
                                    <div class="hint"><i class="fas fa-info-circle"></i> User's login username</div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="userEmail">Email:</label>
                                    <input type="email" id="userEmail" name="userEmail"
                                        placeholder="e.g. john.smith@school.edu">
                                    <div class="hint"><i class="fas fa-info-circle"></i> User's email address</div>
                                </div>

                                <div class="form-group">
                                    <label for="userRole">Role:</label>
                                    <select id="userRole" name="userRole">
                                        <option value="">-- Select --</option>
                                        <option value="Teacher">Teacher</option>
                                        <option value="Student">Student</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Other">Other</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> User's role in the system</div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="productImpacted">Application/Program Impacted:</label>
                                <select id="productImpacted" name="productImpacted">
                                <!-- Options will be loaded dynamically -->
                                </select>
                            <div id="secondLevelContainer" style="display: none; margin-top: 10px">
                                <select id="secondLevelSelect" name="secondLevelSelect"></select>
                                </div>
                            <div id="thirdLevelContainer" style="display: none; margin-top: 10px">
                                <select id="thirdLevelSelect" name="thirdLevelSelect"></select>
                            </div>
                            <div class="hint"><i class="fas fa-info-circle"></i> Select the application or program
                                impacted</div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="xcodeInfo">Xcode:</label>
                                    <input type="text" id="xcodeInfo" name="xcodeInfo">
                                    <div class="hint"><i class="fas fa-info-circle"></i> Xcode for the resource</div>
                                </div>

                                <div class="form-group">
                                    <label for="districtState">District state:</label>
                                    <input type="text" id="districtState" name="districtState">
                                    <div class="hint"><i class="fas fa-info-circle"></i> State where the district is
                                    located</div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="impactType">Digital and/or Print Impact:</label>
                                    <select id="impactType" name="impactType">
                                        <option value="">-- Select --</option>
                                        <option value="Digital Only">Digital Only</option>
                                        <option value="Print Only">Print Only</option>
                                        <option value="Both Digital and Print">Both Digital and Print</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Type of materials affected
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="dateReported">Date Issue reported by user:</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-calendar-alt icon-prefix"></i>
                                        <input type="date" id="dateReported" name="dateReported">
                                    </div>
                                    <div class="hint"><i class="fas fa-info-circle"></i> When the user reported this
                                    issue</div>
                                </div>

                                <div class="form-group">
                                    <label for="impactScope">Teacher and/or Student impact:</label>
                                    <select id="impactScope" name="impactScope">
                                        <option value="">-- Select --</option>
                                        <option value="Teacher Only">Teacher Only</option>
                                        <option value="Student Only">Student Only</option>
                                        <option value="Both Teacher and Student">Both Teacher and Student</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Who is affected by this issue
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Program Components card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-puzzle-piece fa-lg section-icon"></i>
                            <h3>PROGRAM COMPONENTS</h3>
                        </div>
                        <div class="card-body">
                            <div class="quill-editor-container">
                                <div id="componentsEditor" style="height: 100px; background-color: white;"></div>
                                <textarea id="components" name="components" style="display: none;"></textarea>
                            </div>
                            <div class="hint"><i class="fas fa-info-circle"></i> Enter program components affected by
                            this issue</div>
                        </div>
                    </div>

                    <!-- Steps to Reproduce card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-list-ol fa-lg section-icon"></i>
                            <h3>STEPS TO REPRODUCE</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="pathField">Path:</label>
                                <input type="text" id="pathField" name="pathField"
                                    placeholder="e.g. Login > Click Resources > Select Grade 5">
                                <div class="hint"><i class="fas fa-info-circle"></i> Navigation path to reproduce the
                                issue</div>
                            </div>

                            <div class="form-group">
                                <label for="actualResultsEditor">Actual results:</label>
                                <div id="actualResultsEditor" style="height: 100px; background-color: white;"></div>
                                <textarea id="actualResults" name="actualResults" style="display: none;"></textarea>
                                <div class="hint"><i class="fas fa-info-circle"></i> (screenshots and/or videos should
                                include the URL in screen capture)</div>
                            </div>

                            <div class="form-group">
                                <label for="expectedResultsEditor">Expected results:</label>
                                <div id="expectedResultsEditor" style="height: 100px; background-color: white;"></div>
                                <textarea id="expectedResults" name="expectedResults" style="display: none;"></textarea>
                                <div class="hint"><i class="fas fa-info-circle"></i> What should have happened instead
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ticket Properties card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-tasks fa-lg section-icon"></i>
                            <h3>TICKET PROPERTIES</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="email" class="required-field">Requester Email</label>
                                <div class="input-with-icon">
                                    <input type="email" id="email" name="email" required>
                                </div>
                                <div class="hint"><i class="fas fa-info-circle"></i> This ticket will be created by you
                                (the logged-in agent)</div>
                                <div id="emailStatus" class="email-status"></div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="relatedTickets" class="required-field">Related Ticket IDs</label>
                                    <div class="input-with-icon">
                                        <input type="text" id="relatedTickets" name="relatedTickets" required>
                                    </div>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Comma-separated ticket IDs
                                    (e.g., 1,2,3)</div>
                                </div>

                                <div class="form-group">
                                    <label for="priority">Priority</label>
                                    <select id="priority" name="priority">
                                        <option value="1">Low</option>
                                        <option value="2">Medium</option>
                                        <option value="3">High</option>
                                        <option value="4">Urgent</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Select ticket priority</div>
                                </div>

                                <div class="form-group">
                                    <label for="status">Status</label>
                                    <select id="status" name="status">
                                        <option value="2">Open</option>
                                        <option value="3">Pending</option>
                                        <option value="4">Resolved</option>
                                        <option value="5">Closed</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Select ticket status</div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="groupField">Group</label>
                                    <select id="groupField" name="groupField">
                                        <option>Loading groups...</option>
                                    </select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Select a support group</div>
                                </div>

                                <div class="form-group">
                                    <label for="agentField">Agent</label>
                                    <select id="agentField" name="agentField"></select>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Select an agent</div>
                                </div>

                                <div class="form-group">
                                    <label for="districtField">District</label>
                                    <input type="text" id="districtField" name="districtField" readonly>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Auto-populated from source
                                    ticket</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Attachments card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-paperclip fa-lg section-icon"></i>
                            <h3>ATTACHMENTS</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <div class="attachment-input-container">
                                    <div class="custom-file-input">
                                        <div class="file-upload-btn">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <span>Choose files</span>
                                            <input type="file" id="screenshots" name="screenshots" multiple
                                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                                        </div>
                                    </div>
                                    <div class="hint"><i class="fas fa-info-circle"></i> Upload files to include in the
                                    ticket (15MB total)</div>
                                </div>
                                <div id="screenshotPreview" class="screenshot-preview"></div>
                                <div id="attachmentCounter" class="attachment-counter"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: none;">
                    <textarea id="description" name="description"></textarea>
                </div>

                <div class="form-actions">
                    <fw-button id="cancelTracker" color="secondary" size="medium"
                        style="display: flex; justify-content: center; align-items: center;">
                        <i class="fas fa-times"></i> Cancel
                    </fw-button>
                    <fw-button id="createTracker" color="primary" type="submit" size="medium"
                        style="display: flex; justify-content: center; align-items: center;">
                        <i class="fas fa-check"></i> Create Tracker
                    </fw-button>
                </div>
            </form>
    </div>

    <script>
        /**
         * Main Application Class 
         * Encapsulates the tracker form functionality
         */
        class TrackerApp {
            constructor() {
                this.client = null;
                this.quillEditors = {};
                this.aggregatedScreenshotFiles = [];
                this.ticketData = {
                        isVip: false,
                        districtName: '',
                        currentTicketId: null,
                    requesterEmail: '',
                    ticketRequesterEmail: ''
                };
                this.productTypeHierarchy = this.getProductTypeHierarchy();
                this.predefinedAgents = [
                    { id: 67025683491, name: "Mohammad Azeem" },
                    { id: 67030529218, name: "Jordan Fields" },
                    { id: 67031011668, name: "Suriya Iqbal" },
                    { id: 67040597168, name: "Anson Li" },
                    { id: 67051499418, name: "Drita Lulgjuraj" }
                ];
            }

            /**
             * Initialize the application
             */
            async init() {
                try {
                    console.log('Initializing TrackerApp');
                    await this.initClient();
                    this.initEventListeners();
                    this.initQuillEditors();
                    this.initFormData();
                    await this.loadInitialData();
                    console.log('TrackerApp initialized successfully');
                } catch (error) {
                    console.error('Failed to initialize TrackerApp:', error);
                    this.showError('Failed to initialize app. Please try again.');
                }
            }

            /**
             * Initialize Freshworks client
             */
            async initClient() {
                return new Promise((resolve, reject) => {
                    let attempts = 0;
                    const maxAttempts = 10;

                    const tryInit = () => {
                        attempts++;
                        console.log(`Attempt ${attempts} to initialize Freshworks client`);

                        if (typeof client !== 'undefined') {
                            this.client = client;
                            resolve(client);
                        } else if (typeof app !== 'undefined') {
                            app.initialized().then(clientObj => {
                                this.client = clientObj;
                                resolve(clientObj);
                            }).catch(reject);
                        } else if (typeof window.frsh !== 'undefined' && window.frsh.init) {
                            window.frsh.init().then(clientObj => {
                                this.client = clientObj;
                                resolve(clientObj);
                            }).catch(reject);
                        } else if (attempts < maxAttempts) {
                            setTimeout(tryInit, 100);
                        } else {
                            reject(new Error('Could not initialize client after multiple attempts'));
                        }
                    };

                    tryInit();
                });
            }

            /**
             * Load initial data for the form
             */
            async loadInitialData() {
                try {
                    // Set today's date for dateReported field
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('dateReported').value = today;

                    // Load context data if available
                    await this.loadTicketContext();

                    // Load product types
                    this.loadProductTypes();

                    // Load groups and agents
                    await this.loadGroups();

                    // Generate the initial subject
                    this.generateSubject();

                } catch (error) {
                    console.error('Error loading initial data:', error);
                }
            }

            /**
             * Load context data from parent ticket
             */
            async loadTicketContext() {
                try {
                    // Get context from instance
                    if (this.client && this.client.instance) {
                        const context = await this.client.instance.context();
                        console.log("Modal context:", context);

                        if (context && context.data) {
                            this.ticketData = {
                                isVip: context.data.isVip || false,
                                districtName: context.data.districtName || '',
                                currentTicketId: context.data.currentTicketId || null,
                                requesterEmail: context.data.requesterEmail || '',
                                ticketRequesterEmail: context.data.ticketRequesterEmail || ''
                            };
                            console.log("Received ticket data:", this.ticketData);

                            // Apply context data to form
                            this.applyTicketContextToForm();
                        }
                    }

                    // Load agent email
                    await this.loadAgentEmail();

                    // Load district info
                    await this.populateDistrictField();

                    // Load ticket fields
                    await this.populateTicketFields();

                } catch (error) {
                    console.error("Error loading ticket context:", error);
                    // Continue with defaults
                    await this.loadAgentEmail();
                    await this.populateDistrictField();
                    await this.populateTicketFields();
                }
            }

            /**
             * Apply ticket context data to form fields
             */
            applyTicketContextToForm() {
                // Set VIP dropdown
                document.getElementById('isVIP').value = this.ticketData.isVip ? 'Yes' : 'No';

                // Set district if valid
                if (this.ticketData.districtName && this.ticketData.districtName !== "VOLUSIA CO SCHOOL DISTRICT") {
                    console.log("Setting district from context:", this.ticketData.districtName);
                    document.getElementById('districtField').value = this.ticketData.districtName;

                    // Store in centralized cache
                    this.storageManager.storeDistrictData(this.ticketData.districtName, 'context');
                }

                // Set related ticket ID
                if (this.ticketData.currentTicketId) {
                    document.getElementById('relatedTickets').value = this.ticketData.currentTicketId;
                }
            }

            /**
             * Load agent email
             */
            async loadAgentEmail() {
                try {
                    const emailField = document.getElementById('email');
                    const emailStatus = document.getElementById('emailStatus');

                    // Try to get assigned agent email if we have a related ticket
                    if (this.ticketData.currentTicketId) {
                        const assignedAgentEmail = await this.getAssignedAgentEmail(this.ticketData.currentTicketId);
                        if (assignedAgentEmail) {
                            emailField.value = assignedAgentEmail;
                            emailStatus.innerHTML = `<span style="color: green">✓ Using assigned agent's email: ${assignedAgentEmail}</span>`;
                            return;
                        }
                    }

                    // Fallback to logged in user's email
                    const userData = await this.client.data.get("loggedInUser");
                                console.log("Agent data:", userData);

                                if (userData && userData.loggedInUser && userData.loggedInUser.contact && userData.loggedInUser.contact.email) {
                                    const agentEmail = userData.loggedInUser.contact.email;
                                    console.log("Found agent email:", agentEmail);
                        emailField.value = agentEmail;
                        emailStatus.innerHTML = `<span style="color: green">✓ Email loaded: ${agentEmail}</span>`;
                        return;
                    }

                    // Use default placeholder as last resort
                    emailField.value = "freshdesk_agent@example.com";
                    emailStatus.innerHTML = '<span style="color: blue">ℹ️ Using placeholder email</span>';

                            } catch (error) {
                    console.error("Error getting agent email:", error);
                    // Set default value
                    document.getElementById('email').value = "freshdesk_agent@example.com";
                    document.getElementById('emailStatus').innerHTML = '<span style="color: red">✗ Error loading email, using placeholder</span>';
                }
            }

            /**
             * Get assigned agent email for ticket
             */
            async getAssignedAgentEmail(ticketId) {
                try {
                    const ticketResponse = await this.client.request.invokeTemplate("getTicketDetails", {
                                    context: { ticketId: ticketId }
                                });

                                const ticketData = JSON.parse(ticketResponse.response);
                                console.log("Related ticket data:", ticketData);

                                if (!ticketData.responder_id) {
                                    console.warn("Ticket doesn't have an assigned agent");
                                    return null;
                                }

                    const agentResponse = await this.client.request.invokeTemplate("getAgentDetails", {
                                    context: { agentId: ticketData.responder_id }
                                });

                                const agentData = JSON.parse(agentResponse.response);
                                console.log("Assigned agent data:", agentData);

                                if (agentData && agentData.contact && agentData.contact.email) {
                                    console.log("Found assigned agent email:", agentData.contact.email);
                                    return agentData.contact.email;
                                }

                    return null;
                            } catch (error) {
                                console.error("Error getting assigned agent email:", error);
                                return null;
                            }
                        }

            /**
             * Populate district field
             */
            async populateDistrictField() {
                try {
                    // Clear the field first to avoid showing stale data
                    document.getElementById('districtField').value = '';

                    // First check cache
                    const cachedDistrict = this.storageManager.getDistrictData();
                    if (cachedDistrict) {
                        document.getElementById('districtField').value = cachedDistrict;
                        console.log(`Set district from clean cache: ${cachedDistrict}`);
                        return;
                    }

                    // Then check localStorage
                    const storedData = localStorage.getItem('sourceTicketData') ||
                        localStorage.getItem('sedcustData') ||
                        localStorage.getItem('assemblyData');

                    if (storedData) {
                        const parsedData = JSON.parse(storedData);
                        if (parsedData.districtName || parsedData.district) {
                            const districtValue = parsedData.districtName || parsedData.district;
                            if (districtValue !== "VOLUSIA CO SCHOOL DISTRICT") {
                                document.getElementById('districtField').value = districtValue;
                                console.log("Set district from localStorage:", districtValue);

                                // Cache this value
                                this.storageManager.storeDistrictData(districtValue, 'localStorage');
                                return;
                            }
                        }
                    }

                    // If not found in localStorage, try to get from current ticket context
                    if (this.client) {
                        try {
                            const ticketData = await this.client.data.get("ticket");
                            if (ticketData && ticketData.ticket && ticketData.ticket.custom_fields) {
                                // Try all possible district field names
                                const districtFields = [
                                    'cf_district509811', 'cf_district', 'district',
                                    'cf_school_district', 'cf_district_name'
                                ];

                                for (const field of districtFields) {
                                    const districtValue = ticketData.ticket.custom_fields[field];
                                    if (districtValue && districtValue !== "VOLUSIA CO SCHOOL DISTRICT") {
                                        document.getElementById('districtField').value = districtValue;
                                        console.log(`Found district in field ${field}:`, districtValue);

                                        // Cache this value
                                        this.storageManager.storeDistrictData(districtValue, `ticket.${field}`);
                                        return;
                                    }
                                }

                                // Try to extract from ticket content as last resort
                                if (ticketData.ticket.subject || ticketData.ticket.description) {
                                    const contentToSearch = (ticketData.ticket.subject || '') + ' ' + (ticketData.ticket.description || '');
                                    console.log("Searching for district in ticket content");

                                    // Try to find mentions of School District
                                    const districtRegex = /([A-Za-z\s\.]+(?:School|County|Public)\s*(?:District|Schools))/i;
                                    const match = contentToSearch.match(districtRegex);

                                    if (match && match[1] && match[1] !== "VOLUSIA CO SCHOOL DISTRICT") {
                                        const extractedDistrict = match[1].trim();
                                        document.getElementById('districtField').value = extractedDistrict;
                                        console.log("Extracted district from ticket content:", extractedDistrict);

                                    // Store in our centralized cache
                                        this.storageManager.storeDistrictData(extractedDistrict, 'ticket.content');
                                        return;
                                    }
                                }
                            }
                        } catch (error) {
                            console.error("Error getting ticket data for district:", error);
                        }
                    }

                    console.log("No valid district found, leaving field empty");
                } catch (error) {
                    console.error("Error in populateDistrictField():", error);
                }
            }

            /**
             * Populate ticket fields from source ticket
             */
            async populateTicketFields() {
                try {
                    if (!this.client) return;

                    const ticketData = await this.client.data.get("ticket");
                    console.log("Source ticket data for fields:", ticketData);

                    if (ticketData && ticketData.ticket) {
                        // Populate related ticket ID if not already set
                        if (ticketData.ticket.id && !document.getElementById('relatedTickets').value) {
                            document.getElementById('relatedTickets').value = ticketData.ticket.id;
                            console.log("Set related ticket ID:", ticketData.ticket.id);
                        }

                        // Populate priority if not already set
                        if (ticketData.ticket.priority && !document.getElementById('priority').value) {
                            document.getElementById('priority').value = ticketData.ticket.priority;
                            console.log("Set priority:", ticketData.ticket.priority);
                        }

                        // Populate VIP status from custom fields if not already set
                        if (ticketData.ticket.custom_fields && document.getElementById('isVIP').value === 'No') {
                            // Check for VIP status in various possible custom field names
                            const vipFields = ['cf_vip', 'vip', 'cf_is_vip', 'is_vip'];

                            for (const field of vipFields) {
                                const vipValue = ticketData.ticket.custom_fields[field];
                                if (vipValue) {
                                    // Convert various possible VIP values to Yes/No
                                    let isVip = false;

                                    if (typeof vipValue === 'boolean') {
                                        isVip = vipValue;
                                    } else if (typeof vipValue === 'string') {
                                        const normalizedValue = vipValue.toLowerCase().trim();
                                        isVip = ['yes', 'true', '1', 'y'].includes(normalizedValue);
                                    } else if (typeof vipValue === 'number') {
                                        isVip = vipValue > 0;
                                    }

                                    document.getElementById('isVIP').value = isVip ? 'Yes' : 'No';
                                    console.log(`Set VIP status from field ${field}:`, isVip ? 'Yes' : 'No');
                                    break;
                                }
                            }
                        }

                        // Store district in cache if valid
                        const currentDistrict = document.getElementById('districtField').value;
                        if (currentDistrict && currentDistrict !== "VOLUSIA CO SCHOOL DISTRICT") {
                            this.storageManager.storeDistrictData(currentDistrict, 'populateTicketFields');
                        }
                    }
                } catch (error) {
                    console.error("Error populating ticket fields:", error);
                }
            }

            /**
             * Generate formatted subject from field values
             */
            generateSubject() {
                            const xcode = document.getElementById('xcode').value.trim();
                            const application = document.getElementById('application').value.trim();
                            const resourcePath = document.getElementById('resourcePath').value.trim();
                            const specificIssue = document.getElementById('specificIssue').value.trim();

                // Format: XCODE | Application Name | Resource Path | Specific Issue
                            let subject = '';

                            if (xcode) {
                                subject += xcode;
                            }

                            if (application) {
                                subject += ' | ' + application;
                            }

                            if (resourcePath) {
                                subject += ' | ' + resourcePath;
                            }

                            if (specificIssue) {
                                subject += ' | ' + specificIssue;
                            }

                            document.getElementById('subject').value = subject;
                        }

            /**
             * Generate formatted description with all form fields
             */
            generateDescription() {
                // Get values from Quill editors
                Object.keys(this.quillEditors).forEach(id => {
                    const editor = this.quillEditors[id];
                    document.getElementById(id).value = editor.root.innerHTML;
                });

                            const issueSummary = document.getElementById('issueSummary').value.trim();
                const issueDetails = document.getElementById('issueDetails').value.trim();
                const components = document.getElementById('components').value.trim();
                const actualResults = document.getElementById('actualResults').value.trim();
                const expectedResults = document.getElementById('expectedResults').value.trim();

                            // User info fields
                            const isVIP = document.getElementById('isVIP').value;
                            const username = document.getElementById('username').value.trim();
                            const userEmail = document.getElementById('userEmail').value.trim();
                            const userRole = document.getElementById('userRole').value;

                // Product info
                            const productImpacted = document.getElementById('productImpacted').dataset.fullValue ||
                                document.getElementById('productImpacted').value || '';

                            // Other fields
                            const xcodeInfo = document.getElementById('xcodeInfo').value.trim();
                            const districtState = document.getElementById('districtState').value.trim();
                            const impactType = document.getElementById('impactType').value;
                            const dateReported = document.getElementById('dateReported').value;
                            const impactScope = document.getElementById('impactScope').value;
                            const pathField = document.getElementById('pathField').value.trim();

                // Format date
                            let formattedDate = '';
                            if (dateReported) {
                                const date = new Date(dateReported);
                                formattedDate = date.toLocaleDateString('en-US', {
                                    year: 'numeric', month: 'long', day: 'numeric'
                                });
                            }

                // Build HTML description
                            let description = '';

                            // SUMMARY section
                            description += '<div style="color: #000000"><span style="text-decoration: underline; background-color: #c1e9d9;">SUMMARY</span></div>';
                            if (issueSummary) {
                                description += `<div>${issueSummary}</div>`;
                            }
                            description += '<div style="margin-bottom: 20px;"></div>';

                            // DESCRIPTION section
                            description += '<div style="color: #000000;"><span style="text-decoration: underline; background-color: #c1e9d9;">DESCRIPTION</span></div>';
                            if (issueDetails) {
                                description += `<div>${issueDetails}</div><br>`;
                            }

                // User info fields
                            description += `VIP Customer: (${isVIP || 'No'})<br>`;
                            if (username) description += `Username: ${username}<br>`;
                            if (userEmail) description += `Email: ${userEmail}<br>`;
                            if (userRole) description += `Role: ${userRole}<br>`;
                            if (productImpacted) description += `Application/Program Impacted: ${productImpacted}<br>`;
                            if (xcodeInfo) description += `Xcode: ${xcodeInfo}<br>`;
                            if (districtState) description += `District state: ${districtState}<br>`;
                            if (impactType) description += `Digital and/or Print Impact: ${impactType}<br>`;
                            if (formattedDate) description += `Date issue reported by user: ${formattedDate}<br>`;
                            if (impactScope) description += `Teacher and/or Student impact: ${impactScope}<br>`;
                            description += '<div style="margin-bottom: 20px;"></div>';

                            // PROGRAM COMPONENTS section if available
                            if (components) {
                                description += '<div style="color: #000000;"><span style="text-decoration: underline; background-color: #c1e9d9;">PROGRAM COMPONENTS</span></div>';
                                description += `<div>${components}</div>`;
                                description += '<div style="margin-bottom: 20px;"></div>';
                            }

                            // STEPS TO REPRODUCE section
                            description += '<div style="color: #000000;"><span style="text-decoration: underline; background-color: #c1e9d9;">STEPS TO REPRODUCE</span></div>';
                            if (pathField) {
                                description += `Path: ${pathField}<br>`;
                            }
                            description += '<div style="margin-bottom: 10px;"></div>';

                            // ACTUAL RESULTS section if available
                            if (actualResults) {
                                description += '<div style="color: #000000;"><span style="text-decoration: underline; background-color: #c1e9d9;">ACTUAL RESULTS</span></div>';
                                description += `<div>${actualResults}</div>`;
                                description += '<div style="margin-bottom: 20px;"></div>';
                            }

                            // EXPECTED RESULTS section if available
                            if (expectedResults) {
                                description += '<div style="color: #000000;"><span style="text-decoration: underline; background-color: #c1e9d9;">EXPECTED RESULTS</span></div>';
                                description += `<div>${expectedResults}</div>`;
                            }

                            return description;
                        }

            /**
             * Load product types into dropdown
             */
            loadProductTypes() {
                const mainSelect = document.getElementById('productImpacted');
                if (!mainSelect) return;

                // Clear any existing options
                mainSelect.innerHTML = '';

                // Add blank option
                mainSelect.appendChild(this.createOption('', '-- Select a Product --'));

                // Add product options
                Object.keys(this.productTypeHierarchy).forEach(productName => {
                    mainSelect.appendChild(this.createOption(productName, productName));
                });
            }

            /**
             * Load groups from Freshdesk API
             */
            async loadGroups() {
                try {
                    console.log("Fetching groups from Freshdesk API");
                    // Add UI indicator that API is being called
                    const groupSelect = document.getElementById("groupField");
                    groupSelect.innerHTML = "<option>Loading groups...</option>";

                    const response = await this.client.request.invokeTemplate("getGroups", {});

                    if (!response || !response.response) {
                        throw new Error("Empty response from groups API");
                    }

                    const groups = JSON.parse(response.response);
                    console.log("Fetched groups:", groups);

                    groupSelect.innerHTML = ""; // Clear existing options

                    // Add a blank option
                    groupSelect.appendChild(this.createOption('', '-- Select a Group --'));

                    groups.forEach(group => {
                        const option = this.createOption(group.id, group.name);
                        groupSelect.appendChild(option);

                        // Set Escalations group as default
                        if (group.id === 67000396680) {
                            option.selected = true;
                        }
                    });

                    // Load agents after groups are loaded
                    this.loadAgentsForSelectedGroup();

                } catch (error) {
                    console.error("Error fetching groups:", error);
                    this.loadFallbackGroups();
                }
            }

            /**
             * Load agents for selected group (using hardcoded list)
             */
            loadAgentsForSelectedGroup() {
                console.log("Loading agents for selected group");
                const agentSelect = document.getElementById("agentField");
                agentSelect.innerHTML = ""; // Clear existing options

                // Add a blank option
                agentSelect.appendChild(this.createOption('', '-- Select an Agent --'));

                // Add hardcoded agents
                this.predefinedAgents.forEach(agent => {
                    agentSelect.appendChild(this.createOption(agent.id, agent.name));
                });
            }

            /**
             * Load fallback groups (when API fails)
             */
            loadFallbackGroups() {
                console.log("Using fallback groups data");
                const groups = [
                    { id: 67000396680, name: "Escalations" },
                    { id: 67000396681, name: "Support" },
                    { id: 67000396682, name: "Technical" }
                ];

                const groupSelect = document.getElementById("groupField");
                groupSelect.innerHTML = ""; // Clear existing options

                // Add a blank option
                groupSelect.appendChild(this.createOption('', '-- Select a Group --'));

                groups.forEach(group => {
                    const option = this.createOption(group.id, group.name);
                    groupSelect.appendChild(option);

                    // Set Escalations group as default
                    if (group.id === 67000396680) {
                        option.selected = true;
                    }
                });

                // Load agents after groups
                this.loadAgentsForSelectedGroup();
            }

            /**
             * Create an option element for select dropdowns
             */
            createOption(value, text) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                return option;
            }

            /**
             * Handle paste events for image uploads
             */
            handlePasteImage(e, quill) {
                const clipboardData = e.clipboardData || window.clipboardData;
                if (!clipboardData) return;

                const items = clipboardData.items;
                if (!items) return;

                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf("image") !== -1) {
                        e.preventDefault();
                        const file = items[i].getAsFile();
                        this.uploadImageToImgbb(file)
                            .then(url => {
                                const range = quill.getSelection();
                                quill.insertEmbed(range.index, 'image', url);
                            })
                            .catch(error => console.error("Image upload error:", error));
                        return;
                    }
                }
            }

            /**
             * Upload image to ImgBB and return URL
             */
            async uploadImageToImgbb(file) {
                const formData = new FormData();
                formData.append('image', file);
                const IMGBB_API_KEY = "b3da8c974bc40dd87d896d84436dd76e";

                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    return result.data.display_url;
                }
                throw new Error("Image upload failed");
            }

            /**
             * Handle file selection for attachments
             */
            handleFileSelection(e) {
                const files = e.target.files;
                if (files.length === 0) return;

                // Add new files to aggregated collection
                for (let i = 0; i < files.length; i++) {
                    this.aggregatedScreenshotFiles.push(files[i]);
                }

                // Update the file preview display
                this.updateFilePreview();

                // Clear the file input for reuse
                e.target.value = '';
            }

            /**
             * Update file preview display
             */
            updateFilePreview() {
                const previewContainer = document.getElementById('screenshotPreview');
                if (!previewContainer) return;

                // Clear the preview container
                previewContainer.innerHTML = '';

                if (this.aggregatedScreenshotFiles.length === 0) {
                    // No files to preview
                    return;
                }

                // Add attachments summary
                this.updateAttachmentsSummary(previewContainer);

                // Preview up to 5 files
                const fileCount = Math.min(this.aggregatedScreenshotFiles.length, 5);
                for (let i = 0; i < fileCount; i++) {
                    const filePreview = this.createFilePreviewElement(this.aggregatedScreenshotFiles[i], i);
                    previewContainer.appendChild(filePreview);
                }

                // Show note if there are more files than shown
                if (this.aggregatedScreenshotFiles.length > 5) {
                    const noteDiv = document.createElement('div');
                    noteDiv.className = 'file-note';
                    noteDiv.textContent = `Note: Only showing the first 5 files. All ${this.aggregatedScreenshotFiles.length} files will be uploaded.`;
                    previewContainer.appendChild(noteDiv);
                }

                // Add a clear all button
                const clearAllDiv = document.createElement('div');
                clearAllDiv.className = 'clear-files';
                clearAllDiv.innerHTML = `<button type="button">Clear All Attachments (${this.aggregatedScreenshotFiles.length})</button>`;
                clearAllDiv.querySelector('button').addEventListener('click', () => this.clearAllFiles());
                previewContainer.appendChild(clearAllDiv);

                // Update the counter
                this.updateAttachmentCountIndicator();
            }

            /**
             * Create file preview element
             */
            createFilePreviewElement(file, index) {
                const fileInfo = this.getFileTypeInfo(file);
                            const previewDiv = document.createElement('div');
                            previewDiv.className = 'file-thumbnail';
                            previewDiv.dataset.fileIndex = index;

                            if (fileInfo.isImage) {
                                // For image files, create a thumbnail preview
                                const reader = new FileReader();
                    reader.onload = e => {
                                    previewDiv.innerHTML = `
                                <div class="thumbnail-container">
                                    <img src="${e.target.result}" title="${file.name}" alt="${file.name}"/>
                                </div>
                                <div class="file-filename" title="${file.name}">${file.name}</div>
                                <div class="file-size">${fileInfo.fileSize}</div>
                                <div class="file-remove" data-index="${index}">✕</div>`;

                        // Add remove button handler
                        previewDiv.querySelector('.file-remove').addEventListener('click', e => {
                                        e.stopPropagation();
                            this.removeFile(index);
                                    });
                                };
                                reader.readAsDataURL(file);
                            } else {
                    // For non-image files, show icon based on type
                                previewDiv.innerHTML = `
                            <div class="thumbnail-container file-icon-container ${fileInfo.colorClass}">
                                <i class="fas ${fileInfo.iconClass} file-icon"></i>
                                <div class="file-type-label">${fileInfo.fileTypeLabel}</div>
                            </div>
                            <div class="file-filename" title="${file.name}">${file.name}</div>
                            <div class="file-size">${fileInfo.fileSize}</div>
                            <div class="file-remove" data-index="${index}">✕</div>`;

                    // Add remove button handler
                    previewDiv.querySelector('.file-remove').addEventListener('click', e => {
                                    e.stopPropagation();
                        this.removeFile(index);
                    });
                }

                // Make preview clickable to view details
                previewDiv.addEventListener('click', () => this.showFileDetails(file, index));

                            return previewDiv;
                        }

                        /**
             * Get file type information for previews
             */
            getFileTypeInfo(file) {
                // Extract file extension
                const fileName = file.name || '';
                const fileExtension = fileName.split('.').pop().toLowerCase();

                // Determine file size for display
                const bytes = file.size;
                let fileSize = '';

                if (bytes < 1024) {
                    fileSize = bytes + ' B';
                } else if (bytes < 1024 * 1024) {
                    fileSize = (bytes / 1024).toFixed(1) + ' KB';
                } else {
                    fileSize = (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                }

                // Set defaults
                let fileTypeLabel = fileExtension ? fileExtension.toUpperCase() : 'FILE';
                let iconClass = 'fa-file';
                let colorClass = 'file-other';
                let isImage = false;

                // Determine file type
                const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
                const documentExtensions = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt'];

                if (imageExtensions.includes(fileExtension)) {
                    iconClass = 'fa-file-image';
                    colorClass = 'file-image';
                    isImage = true;
                } else if (documentExtensions.includes(fileExtension)) {
                    iconClass = 'fa-file-alt';
                    colorClass = 'file-document';
                } else if (fileExtension === 'zip' || fileExtension === 'rar') {
                    iconClass = 'fa-file-archive';
                    colorClass = 'file-archive';
                }

                return {
                    fileExtension,
                    fileSize,
                    fileTypeLabel,
                    iconClass,
                    colorClass,
                    isImage
                };
            }

            /**
             * Initialize all page event listeners
             */
            initEventListeners() {
                // Back button
                document.getElementById('backButton')?.addEventListener('click', () => {
                    window.location.href = "template-selector.html";
                });

                // Demo data button
                document.getElementById('debugFillForm')?.addEventListener('click', e => {
                    e.preventDefault();
                    this.fillFormWithDemoData();
                });

                // Form submit
                document.getElementById('trackerForm')?.addEventListener('submit', e => {
                            e.preventDefault();
                    this.handleFormSubmit();
                });

                // Cancel button
                document.getElementById('cancelTracker')?.addEventListener('click', () => {
                    if (this.client) {
                        this.client.instance.close();
                    }
                });

                // Create button - ensure it submits the form
                document.getElementById('createTracker')?.addEventListener('click', e => {
                    e.preventDefault();
                    document.getElementById('trackerForm').dispatchEvent(new Event('submit'));
                });

                // Subject field generation
                const subjectFields = ['xcode', 'application', 'resourcePath', 'specificIssue'];
                subjectFields.forEach(field => {
                    document.getElementById(field)?.addEventListener('input', () => this.generateSubject());
                });

                // Screenshots upload
                document.getElementById('screenshots')?.addEventListener('change', e => {
                    this.handleFileSelection(e);
                });

                // Group selection
                document.getElementById('groupField')?.addEventListener('change', () => {
                    this.loadAgentsForSelectedGroup();
                });

                // Product type selector events
                this.setupProductTypeEvents();
            }

            /**
             * Initialize all Quill rich text editors
             */
            initQuillEditors() {
                // Create Quill editors and store references
                const editorIds = [
                    'issueSummary',
                    'issueDetails',
                    'components',
                    'actualResults',
                    'expectedResults'
                ];

                editorIds.forEach(id => {
                    const editorId = `${id}Editor`;
                    const editorElement = document.getElementById(editorId);

                    // Skip if element doesn't exist
                    if (!editorElement) {
                        console.warn(`Editor element #${editorId} not found`);
                        return;
                    }

                    // Create Quill editor with proper configuration
                    const editor = new Quill(`#${editorId}`, {
                        theme: 'snow',
                        placeholder: `Enter ${id.replace(/([A-Z])/g, ' $1').toLowerCase()}...`,
                        modules: {
                            toolbar: [
                                ['bold', 'italic', 'underline', 'strike'],
                                ['blockquote', 'code-block'],
                                [{ 'header': 1 }, { 'header': 2 }],
                                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                                [{ 'script': 'sub' }, { 'script': 'super' }],
                                [{ 'indent': '-1' }, { 'indent': '+1' }],
                                [{ 'direction': 'rtl' }],
                                [{ 'size': ['small', false, 'large', 'huge'] }],
                                [{ 'color': [] }, { 'background': [] }],
                                [{ 'font': [] }],
                                [{ 'align': [] }],
                                ['clean'],
                                ['link', 'image']
                            ]
                        }
                    });

                    // Store reference
                    this.quillEditors[id] = editor;

                    // Ensure the editor is visible and editable
                    editorElement.style.backgroundColor = '#ffffff';
                    editorElement.style.minHeight = '100px';

                    // Add paste image handling
                    editor.root.addEventListener('paste', e => this.handlePasteImage(e, editor));

                    console.log(`Initialized Quill editor for ${id}`);
                });
            }

            /**
             * Setup product type dropdown events
             */
            setupProductTypeEvents() {
                const mainSelect = document.getElementById('productImpacted');
                const secondLevelSelect = document.getElementById('secondLevelSelect');
                const thirdLevelSelect = document.getElementById('thirdLevelSelect');

                if (!mainSelect || !secondLevelSelect || !thirdLevelSelect) return;

                // Initialize dataset property to store full value
                            mainSelect.dataset.fullValue = '';

                // Main product dropdown change
                mainSelect.addEventListener('change', () => {
                    const selectedProduct = mainSelect.value;
                    const secondLevel = this.productTypeHierarchy[selectedProduct];

                    // Update full value
                    mainSelect.dataset.fullValue = selectedProduct;

                                // Reset and hide third level
                    document.getElementById('thirdLevelContainer').style.display = 'none';
                                thirdLevelSelect.innerHTML = '';

                                // Reset second level
                                secondLevelSelect.innerHTML = '';

                                if (selectedProduct && Object.keys(secondLevel).length > 0) {
                        // Add blank option
                        secondLevelSelect.appendChild(this.createOption('', '-- Select a Subcategory --'));

                                    // Add options for second level
                                    Object.keys(secondLevel).forEach(subCategory => {
                            secondLevelSelect.appendChild(this.createOption(subCategory, subCategory));
                                    });

                                    // Show second level
                        document.getElementById('secondLevelContainer').style.display = 'block';
                                } else {
                        // Hide second level
                        document.getElementById('secondLevelContainer').style.display = 'none';
                                }
                            });

                // Second level dropdown change
                secondLevelSelect.addEventListener('change', () => {
                                const selectedProduct = mainSelect.value;
                    const selectedSubCategory = secondLevelSelect.value;
                    const thirdLevel = this.productTypeHierarchy[selectedProduct][selectedSubCategory];

                    // Update full value
                    mainSelect.dataset.fullValue = selectedProduct + ' - ' + selectedSubCategory;

                                // Reset third level
                                thirdLevelSelect.innerHTML = '';

                                if (selectedSubCategory && Array.isArray(thirdLevel) && thirdLevel.length > 0) {
                        // Add blank option
                        thirdLevelSelect.appendChild(this.createOption('', '-- Select a Specific Item --'));

                                    // Add options for third level
                                    thirdLevel.forEach(item => {
                            thirdLevelSelect.appendChild(this.createOption(item, item));
                                    });

                                    // Show third level
                        document.getElementById('thirdLevelContainer').style.display = 'block';
                                } else {
                        // Hide third level
                        document.getElementById('thirdLevelContainer').style.display = 'none';
                                }
                            });

                // Third level dropdown change
                thirdLevelSelect.addEventListener('change', () => {
                                const selectedProduct = mainSelect.value;
                                const selectedSubCategory = secondLevelSelect.value;
                    const selectedItem = thirdLevelSelect.value;

                    // Update full value
                    mainSelect.dataset.fullValue = selectedProduct + ' - ' + selectedSubCategory + ' - ' + selectedItem;
                });
            }

            /**
             * Initialize form data structure
             */
            initFormData() {
                // Create a central storage manager for consistent data handling
                this.storageManager = {
                    clearAllDistrictData: () => {
                        console.log("🧹 Clearing all cached district data from localStorage");
                        const keysToCheck = ['sourceTicketData', 'sedcustData', 'assemblyData', 'districtCache'];

                        keysToCheck.forEach(key => {
                            try {
                                if (localStorage.getItem(key)) {
                                    console.log(`Clearing cached data from ${key}`);
                                    localStorage.removeItem(key);
                                }
                            } catch (e) {
                                console.error(`Error clearing ${key}:`, e);
                            }
                        });
                    },

                    storeDistrictData: (districtName, source) => {
                        if (!districtName || districtName === "VOLUSIA CO SCHOOL DISTRICT") {
                            console.log(`⚠️ Not storing invalid district: "${districtName}"`);
                            return false;
                        }

                        console.log(`✅ Storing valid district: "${districtName}" from ${source}`);

                        // First clear existing data to avoid any merged/old data issues
                        this.storageManager.clearAllDistrictData();

                        // Store new clean data
                        try {
                            localStorage.setItem('districtCache', JSON.stringify({
                                districtName: districtName,
                                timestamp: new Date().getTime(),
                                source: source
                            }));
                            return true;
                        } catch (e) {
                            console.error("Error storing district data:", e);
                            return false;
                        }
                    },

                    getDistrictData: () => {
                        try {
                            const cache = localStorage.getItem('districtCache');
                            if (cache) {
                                const data = JSON.parse(cache);

                                // Check if the data is valid
                                if (data.districtName && data.districtName !== "VOLUSIA CO SCHOOL DISTRICT") {
                                    console.log(`🔍 Retrieved district from cache: "${data.districtName}" (from ${data.source})`);
                                    return data.districtName;
                                                    } else {
                                    console.log("🚫 Invalid district in cache, removing");
                                    localStorage.removeItem('districtCache');
                                }
                            }
                        } catch (e) {
                            console.error("Error getting district data:", e);
                        }
                        return null;
                    }
                };
            }
        }
    </script>
    <script>
        // Initialize the TrackerApp immediately when the document is ready
        document.addEventListener('DOMContentLoaded', function () {
            console.log("Initializing sedcust template");

            // Create and initialize the tracker app
            const trackerApp = new TrackerApp();

            // Store the app instance globally
            window.trackerApp = trackerApp;

            // Initialize the app
            trackerApp.init().then(() => {
                console.log("TrackerApp initialization complete");

                // Load data from localStorage if available
                const storedData = localStorage.getItem('sedcustData');
                                if (storedData) {
                    try {
                                    const parsedData = JSON.parse(storedData);
                        console.log("Found stored data:", parsedData);

                        // Populate fields from stored data
                        if (parsedData.currentTicketId) {
                            document.getElementById('relatedTickets').value = parsedData.currentTicketId;
                        }

                                    if (parsedData.districtName) {
                                        document.getElementById('districtField').value = parsedData.districtName;
                        }

                        if (parsedData.priority) {
                            document.getElementById('priority').value = parsedData.priority;
                        }

                        if (parsedData.isVip !== undefined) {
                            document.getElementById('isVIP').value = parsedData.isVip ? 'Yes' : 'No';
                        }

                        if (parsedData.requesterEmail) {
                            document.getElementById('email').value = parsedData.requesterEmail;
                        }

                        // Clear localStorage to avoid reusing stale data
                        localStorage.removeItem('sedcustData');
                                    } catch (error) {
                        console.error("Error parsing stored data:", error);
                    }
                }
            }).catch(error => {
                console.error("Error initializing TrackerApp:", error);
            });

            // Fix file selection display
            const fileInput = document.getElementById('screenshots');
            if (fileInput) {
                fileInput.addEventListener('change', function (event) {
                    handleFileSelection(event);
                });
            }

            // Function to handle file selection
            function handleFileSelection(event) {
                const files = event.target.files;
                const previewContainer = document.getElementById('screenshotPreview');
                const attachmentCounter = document.getElementById('attachmentCounter');

                if (!previewContainer || !attachmentCounter) return;

                if (files.length === 0) return;

                // Store files globally for form submission
                window.aggregatedScreenshotFiles = window.aggregatedScreenshotFiles || [];

                // Add new files to the collection
                for (let i = 0; i < files.length; i++) {
                    window.aggregatedScreenshotFiles.push(files[i]);
                }

                // Clear preview container
                previewContainer.innerHTML = '';

                // Update counter
                attachmentCounter.textContent = `${window.aggregatedScreenshotFiles.length} file(s) selected`;

                // Display file previews (up to 5)
                const displayCount = Math.min(window.aggregatedScreenshotFiles.length, 5);
                for (let i = 0; i < displayCount; i++) {
                    const file = window.aggregatedScreenshotFiles[i];
                    const fileType = file.type;
                    const isImage = fileType.startsWith('image/');

                    const fileContainer = document.createElement('div');
                    fileContainer.className = 'file-thumbnail';

                    if (isImage) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            fileContainer.innerHTML = `
                                <div class="thumbnail-container">
                                    <img src="${e.target.result}" alt="${file.name}">
                                </div>
                                <div class="file-filename">${file.name}</div>
                                <div class="file-remove" data-index="${i}">✕</div>
                            `;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        // For non-image files
                        let fileIcon = 'fa-file';
                        let fileTypeLabel = 'File';

                        // Determine file type icon
                        if (file.name.endsWith('.pdf')) {
                            fileIcon = 'fa-file-pdf';
                            fileTypeLabel = 'PDF';
                        }
                        else if (file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
                            fileIcon = 'fa-file-word';
                            fileTypeLabel = 'Document';
                        }
                        else if (file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) {
                            fileIcon = 'fa-file-excel';
                            fileTypeLabel = 'Spreadsheet';
                        }
                        else if (file.name.endsWith('.zip') || file.name.endsWith('.rar')) {
                            fileIcon = 'fa-file-archive';
                            fileTypeLabel = 'Archive';
                        }

                        fileContainer.innerHTML = `
                            <div class="thumbnail-container file-icon-container">
                                <i class="fas ${fileIcon} file-icon"></i>
                                <div class="file-type-label">${fileTypeLabel}</div>
                            </div>
                            <div class="file-filename">${file.name}</div>
                            <div class="file-remove" data-index="${i}">✕</div>
                        `;
                    }

                    previewContainer.appendChild(fileContainer);

                    // Add remove functionality after the element is in the DOM
                    setTimeout(() => {
                        const removeBtn = fileContainer.querySelector('.file-remove');
                        if (removeBtn) {
                            removeBtn.addEventListener('click', function (e) {
                                e.stopPropagation();
                                const index = parseInt(this.getAttribute('data-index'));
                                removeFile(index);
                            });
                        }
                    }, 10);
                }

                // Add "Clear All" button if there are files
                if (window.aggregatedScreenshotFiles.length > 0) {
                    const clearAllDiv = document.createElement('div');
                    clearAllDiv.className = 'clear-files';
                    clearAllDiv.innerHTML = `<button type="button">Clear All Files</button>`;
                    clearAllDiv.querySelector('button').addEventListener('click', clearAllFiles);
                    previewContainer.appendChild(clearAllDiv);
                }

                // Show message if there are more files than shown
                if (window.aggregatedScreenshotFiles.length > 5) {
                    const noteElement = document.createElement('div');
                    noteElement.className = 'file-note';
                    noteElement.textContent = `Note: Only showing ${displayCount} of ${window.aggregatedScreenshotFiles.length} files.`;
                    previewContainer.appendChild(noteElement);
                }

                // Clear the file input for reuse
                event.target.value = '';
            }

            // Function to remove a file
            function removeFile(index) {
                if (!window.aggregatedScreenshotFiles) return;

                window.aggregatedScreenshotFiles.splice(index, 1);

                // Update the display
                const event = { target: { files: [] } };
                handleFileSelection(event);
            }

            // Function to clear all files
            function clearAllFiles() {
                window.aggregatedScreenshotFiles = [];

                // Clear preview container
                const previewContainer = document.getElementById('screenshotPreview');
                if (previewContainer) {
                    previewContainer.innerHTML = '';
                }

                // Clear counter
                const attachmentCounter = document.getElementById('attachmentCounter');
                if (attachmentCounter) {
                    attachmentCounter.textContent = '';
                }
            }

            // Override getProductTypeHierarchy method to ensure it's defined
            TrackerApp.prototype.getProductTypeHierarchy = TrackerApp.prototype.getProductTypeHierarchy || function () {
                return {
                    "Benchmark": {
                        "Advance": ["K", "1", "2", "3", "4", "5"],
                        "Universe": ["K", "1", "2", "3", "4", "5"],
                        "Literacy": ["All"]
                    },
                    "SIM": {
                        "Reading": ["All"],
                        "Assessment": ["All"]
                    },
                    "Other": {
                        "General": ["All"]
                    }
                };
            };
                });
            </script>
</body>

</html>